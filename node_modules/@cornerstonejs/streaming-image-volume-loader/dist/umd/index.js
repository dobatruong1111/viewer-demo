!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@cornerstonejs/core"),require("gl-matrix")):"function"==typeof define&&define.amd?define(["@cornerstonejs/core","gl-matrix"],t):"object"==typeof exports?exports.cornerstoneStreamingImageVolumeLoader=t(require("@cornerstonejs/core"),require("gl-matrix")):e.cornerstoneStreamingImageVolumeLoader=t(e.cornerstone3D,e.window)}(self,((e,t)=>(()=>{"use strict";var a={953:t=>{t.exports=e},976:e=>{e.exports=t}},r={};function s(e){var t=r[e];if(void 0!==t)return t.exports;var n=r[e]={exports:{}};return a[e](n,n.exports,s),n.exports}s.d=(e,t)=>{for(var a in t)s.o(t,a)&&!s.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};return(()=>{s.r(n),s.d(n,{Enums:()=>e,StreamingDynamicImageVolume:()=>_,StreamingImageVolume:()=>p,cornerstoneStreamingDynamicImageVolumeLoader:()=>F,cornerstoneStreamingImageVolumeLoader:()=>w,helpers:()=>R});var e={};s.r(e),s.d(e,{Events:()=>T});var t=s(953),a=s(976);function r(e){const a=e[0],{pixelRepresentation:r,bitsAllocated:s,bitsStored:n,highBit:i,photometricInterpretation:o,samplesPerPixel:c}=t.metaData.get("imagePixelModule",a),l=[],m=t.metaData.get("voiLutModule",a);let d;if(m){const{windowWidth:e,windowCenter:t}=m;if(d=null==m?void 0:m.voiLUTFunction,Array.isArray(e))for(let a=0;a<e.length;a++)l.push({windowWidth:e[a],windowCenter:t[a]});else l.push({windowWidth:e,windowCenter:t})}else l.push({windowWidth:void 0,windowCenter:void 0});const{modality:g,seriesInstanceUID:u}=t.metaData.get("generalSeriesModule",a),{imageOrientationPatient:h,pixelSpacing:I,frameOfReferenceUID:f,columns:p,rows:v}=t.metaData.get("imagePlaneModule",a);return{BitsAllocated:s,BitsStored:n,SamplesPerPixel:c,HighBit:i,PhotometricInterpretation:o,PixelRepresentation:r,Modality:g,ImageOrientationPatient:h,PixelSpacing:I,FrameOfReferenceUID:f,Columns:p,Rows:v,voiLut:l,VOILUTFunction:d,SeriesInstanceUID:u}}function i(e,r){const{imagePositionPatient:s}=t.metaData.get("imagePlaneModule",e[0]),n=a.vec3.create(),i="wadouri"===e[0].split(":")[0];let o,c;function l(e){const{imagePositionPatient:n}=t.metaData.get("imagePlaneModule",e),i=a.vec3.create();return a.vec3.sub(i,s,n),a.vec3.dot(i,r)}if(a.vec3.set(n,s[0],s[1],s[2]),i){const n=[e[0],e[Math.floor(e.length/2)]];o=e,l(n[0])-l(n[1])<0&&o.reverse();const i=t.metaData.get("imagePlaneModule",n[1]);if(!i)throw new Error("Incomplete metadata required for volume construction.");const m=a.vec3.create();a.vec3.sub(m,s,i.imagePositionPatient);const d=a.vec3.dot(m,r);c=Math.abs(d)/Math.floor(e.length/2)}else{const t=e.map((e=>({distance:l(e),imageId:e})));t.sort(((e,t)=>t.distance-e.distance)),o=t.map((e=>e.imageId));const a=t.length;c=Math.abs(t[a-1].distance-t[0].distance)/(a-1)}const{imagePositionPatient:m,sliceThickness:d}=t.metaData.get("imagePlaneModule",o[0]),{strictZSpacingForVolumeViewport:g}=(0,t.getConfiguration)().rendering;return 0!==c||g||(d?(console.log("Could not calculate zSpacing. Using sliceThickness"),c=d):(console.log("Could not calculate zSpacing. The VolumeViewport visualization is compromised. Setting zSpacing to 1 to render"),c=1)),{zSpacing:c,origin:m,sortedImageIds:o}}function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function c(e,t,a){return(t=function(e){var t=function(e,t){if("object"!==o(e)||null===e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var r=a.call(e,"string");if("object"!==o(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"===o(t)?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}const l=e=>{const a=function(e){const a=(0,t.getRenderingEngines)(),r=[];for(let s=0;s<a.length;s++){const n=a[s],i=t.utilities.getViewportsWithVolumeId(e,n.id);i.length&&r.push({renderingEngine:n,viewportIds:i.map((e=>e.id))})}return r}(e);a&&a.length&&a.forEach((e=>{let{renderingEngine:t,viewportIds:a}=e;t.hasBeenDestroyed||t.renderViewports(a)}))};function m(e,t){const a=e.length,{rescaleSlope:r,rescaleIntercept:s,suvbw:n}=t;if("PT"===t.modality&&"number"==typeof n)for(let t=0;t<a;t++)e[t]=n*(e[t]*r+s);else for(let t=0;t<a;t++)e[t]=e[t]*r+s;return e}const d=t.Enums.RequestType.Prefetch,{getMinMax:g,ProgressiveIterator:u}=t.utilities,{ImageQualityStatus:h}=t.Enums,{imageRetrieveMetadataProvider:I}=t.utilities;class f extends t.ImageVolume{constructor(e,a){super(e),c(this,"framesLoaded",0),c(this,"framesProcessed",0),c(this,"framesUpdated",0),c(this,"numFrames",void 0),c(this,"totalNumFrames",void 0),c(this,"cornerstoneImageMetaData",null),c(this,"autoRenderOnLoad",!0),c(this,"cachedFrames",[]),c(this,"reRenderTarget",0),c(this,"reRenderFraction",2),c(this,"loadStatus",void 0),c(this,"imagesLoader",this),c(this,"cancelLoading",(()=>{const{loadStatus:e}=this;e&&e.loading&&(e.loading=!1,e.cancelled=!0,this.clearLoadCallbacks(),t.imageLoadPoolManager.filterRequests((e=>{let{additionalDetails:t}=e;return t.volumeId!==this.volumeId})))})),c(this,"load",(e=>{const{imageIds:a,loadStatus:r,numFrames:s}=this,{transferSyntaxUID:n}=t.metaData.get("transferSyntax",a[0])||{},i=t.metaData.get(I.IMAGE_RETRIEVE_CONFIGURATION,this.volumeId,n,"volume");if(this.imagesLoader=i?(i.create||t.ProgressiveRetrieveImages.createProgressive)(i):this,!0===r.loading)return;const{loaded:o}=this.loadStatus,c=a.length;o?e&&e({success:!0,framesLoaded:c,framesProcessed:c,numFrames:s,totalNumFrames:c}):(e&&this.loadStatus.callbacks.push(e),this._prefetchImageIds())})),this.imageIds=a.imageIds,this.loadStatus=a.loadStatus,this.numFrames=this._getNumFrames(),this._createCornerstoneImageMetaData()}_getNumFrames(){const{imageIds:e,scalarData:t}=this,a=this.isDynamicVolume()?t.length:1;return e.length/a}_getScalarDataLength(){const{scalarData:e}=this;return this.isDynamicVolume()?e[0].length:e.length}_createCornerstoneImageMetaData(){const{numFrames:e}=this;if(0===e)return;const t=this.sizeInBytes/e,a=this._getScalarDataLength()/this.numVoxels,r=this.dimensions[0]*this.dimensions[1]*a,{PhotometricInterpretation:s,voiLut:n,VOILUTFunction:i}=this.metadata;let o=[],c=[];n&&n.length&&(o=n.map((e=>e.windowCenter)),c=n.map((e=>e.windowWidth)));const l=a>1;this.cornerstoneImageMetaData={bytesPerImage:t,numComponents:a,pixelsPerImage:r,windowCenter:o,windowWidth:c,color:l,rgba:!1,spacing:this.spacing,dimensions:this.dimensions,photometricInterpretation:s,voiLUTFunction:i,invert:"MONOCHROME1"===s}}_imageIdIndexToFrameIndex(e){return e%this.numFrames}getScalarDataArrays(){return this.isDynamicVolume()?this.scalarData:[this.scalarData]}_getScalarDataByImageIdIndex(e){if(e<0||e>=this.imageIds.length)throw new Error("imageIdIndex out of range");return this.getScalarDataArrays()[Math.floor(e/this.numFrames)]}invalidateVolume(e){const{imageData:t,vtkOpenGLTexture:a}=this,{numFrames:r}=this;for(let e=0;e<r;e++)a.setUpdatedFrame(e);t.modified(),e&&l(this.volumeId)}clearLoadCallbacks(){this.loadStatus.callbacks=[]}callLoadStatusCallback(e){const{framesUpdated:a,framesProcessed:r,totalNumFrames:s}=e,{volumeId:n,reRenderFraction:i,loadStatus:o,metadata:c}=this,{FrameOfReferenceUID:m}=c;if(this.autoRenderOnLoad&&(a>this.reRenderTarget||r===s)&&(this.reRenderTarget+=i,l(n)),r===s){o.callbacks.forEach((t=>t(e)));const a={FrameOfReferenceUID:m,volumeId:n};(0,t.triggerEvent)(t.eventTarget,t.Enums.Events.IMAGE_VOLUME_LOADING_COMPLETED,a)}}updateTextureAndTriggerEvents(e,a){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:h.FULL_RESOLUTION;const s=this._imageIdIndexToFrameIndex(e),{cachedFrames:n,numFrames:i,totalNumFrames:o}=this,{FrameOfReferenceUID:c}=this.metadata;if(n[s]>r)return;if(n[s]===h.FULL_RESOLUTION)return;const l=r===h.FULL_RESOLUTION;n[e]=r,this.framesUpdated++,l&&(this.framesLoaded++,this.framesProcessed++),this.vtkOpenGLTexture.setUpdatedFrame(s),this.imageData.modified();const m={FrameOfReferenceUID:c,imageVolume:this};(0,t.triggerEvent)(t.eventTarget,t.Enums.Events.IMAGE_VOLUME_MODIFIED,m),l&&this.framesProcessed===this.totalNumFrames&&(this.loadStatus.loaded=!0,this.loadStatus.loading=!1),this.callLoadStatusCallback({success:!0,imageIdIndex:e,imageId:a,framesLoaded:this.framesLoaded,framesProcessed:this.framesProcessed,framesUpdated:this.framesUpdated,numFrames:i,totalNumFrames:o,complete:l,imageQualityStatus:r}),this.loadStatus.loaded&&(this.loadStatus.callbacks=[])}successCallback(e,a){const r=this.getImageIdIndex(e),s=this.getLoaderImageOptions(e),n=this._getScalarDataByImageIdIndex(r);!function(e,t,a){if(!(e.buffer instanceof ArrayBuffer))return;const r=a.targetBuffer.offset,s=a.targetBuffer.length,n=t.pixelData?t.pixelData:t.getPixelData();try{if(e instanceof Float32Array){const t=4,a=new Float32Array(n);if(a.length!==s)throw"Error pixelData length does not match frame length";e.set(a,r/t)}if(e instanceof Int16Array){const t=2,a=new Int16Array(n);if(a.length!==s)throw"Error pixelData length does not match frame length";e.set(a,r/t)}if(e instanceof Uint16Array){const t=2,a=new Uint16Array(n);if(a.length!==s)throw"Error pixelData length does not match frame length";e.set(a,r/t)}if(e instanceof Uint8Array){const t=1,a=new Uint8Array(n);if(a.length!==s)throw"Error pixelData length does not match frame length";e.set(a,r/t)}}catch(e){console.error(e)}}(n,a,s);const{scalingParameters:i}=a.preScale||{},{imageQualityStatus:o}=a,c=this._imageIdIndexToFrameIndex(r),l=t.cache.getCachedImageBasedOnImageURI(e),m=t.cache.getVolumeContainingImageId(e);if(this.loadStatus.cancelled)return void console.warn("volume load cancelled, returning for imageIdIndex: ",r);if(!(l||m&&m.volume!==this))return this.updateTextureAndTriggerEvents(r,e,o);const d=!!l,g=l||m.volume;this.handleImageComingFromCache(g,d,i,n,c,n.buffer,r,e)}errorCallback(e,a,r){if(!a)return;const{totalNumFrames:s,numFrames:n}=this,i=this.getImageIdIndex(e);this.framesProcessed++,this.framesProcessed===s&&(this.loadStatus.loaded=!0,this.loadStatus.loading=!1),this.callLoadStatusCallback({success:!1,imageId:e,imageIdIndex:i,error:r,framesLoaded:this.framesLoaded,framesProcessed:this.framesProcessed,framesUpdated:this.framesUpdated,numFrames:n,totalNumFrames:s}),this.loadStatus.loaded&&(this.loadStatus.callbacks=[]);const o={error:r,imageIdIndex:i,imageId:e};(0,t.triggerEvent)(t.eventTarget,t.Enums.Events.IMAGE_LOAD_ERROR,o)}getLoaderImageOptions(e){const{transferSyntaxUID:a}=t.metaData.get("transferSyntax",e)||{},r=t.metaData.get("imagePlaneModule",e)||{},{rows:s,columns:n}=r,i=this.getImageIdIndex(e),o=this._getScalarDataByImageIdIndex(i);if(!o)return null;const c=o.buffer,{type:l,length:m,lengthInBytes:d}=function(e,t){let a,r;if(e instanceof Uint8Array)a="Uint8Array",r=1;else if(e instanceof Float32Array)a="Float32Array",r=4;else if(e instanceof Uint16Array)a="Uint16Array",r=2;else{if(!(e instanceof Int16Array))throw new Error("Unsupported array type");a="Int16Array",r=2}const s=e.length/t;return{type:a,byteSize:r,length:s,lengthInBytes:s*r}}(o,this.numFrames),g=t.metaData.get("modalityLutModule",e)||{},u=t.metaData.get("generalSeriesModule",e)||{},h={rescaleSlope:g.rescaleSlope,rescaleIntercept:g.rescaleIntercept,modality:u.modality};if("PT"===h.modality){const a=t.metaData.get("scalingModule",e);a&&(this._addScalingToVolume(a),h.suvbw=a.suvbw)}const I="number"==typeof h.rescaleSlope&&"number"==typeof h.rescaleIntercept;this.isPreScaled=I;const f=this._imageIdIndexToFrameIndex(i);return{targetBuffer:{arrayBuffer:c instanceof ArrayBuffer?void 0:c,offset:f*d,length:m,type:l,rows:s,columns:n},skipCreateImage:!0,preScale:{enabled:!0,scalingParameters:h},transferPixelData:!0,transferSyntaxUID:a,loader:t.imageLoader.loadImage,additionalDetails:{imageId:e,imageIdIndex:i,volumeId:this.volumeId}}}callLoadImage(e,a,r){const{cachedFrames:s}=this;if(s[a]!==h.FULL_RESOLUTION)return u.as(t.imageLoader.loadImage(e,r)).forEach((t=>{this.successCallback(e,t)}),this.errorCallback.bind(this,a,e))}getImageIdsRequests(e,t){return this.totalNumFrames=this.imageIds.length,this.autoRenderOnLoad&&(this.reRenderFraction=.02*this.totalNumFrames,this.reRenderTarget=this.reRenderFraction),e.map((e=>{const a=this.getImageIdIndex(e),r=d,s=t,n=this.getLoaderImageOptions(e);return{callLoadImage:this.callLoadImage.bind(this),imageId:e,imageIdIndex:a,options:n,priority:s,requestType:r,additionalDetails:{volumeId:this.volumeId}}}))}handleImageComingFromCache(e,t,a,r,s,n,i,o){(t?e.imageLoadObject:e.convertToCornerstoneImage(o,i)).promise.then((e=>{const t=this._scaleIfNecessary(e,a),{pixelsPerImage:c,bytesPerImage:l}=this.cornerstoneImageMetaData,m=r.constructor;let d=l*s;const g=l/c;r.BYTES_PER_ELEMENT!==g&&(d*=r.BYTES_PER_ELEMENT/g),new m(n,d,c).set(t),this.updateTextureAndTriggerEvents(i,o,e.imageQualityStatus)})).catch((e=>{this.errorCallback(o,!0,e)}))}getImageLoadRequests(e){throw new Error("Abstract method")}getImageIdsToLoad(){throw new Error("Abstract method")}loadImages(e,a){return this.loadStatus.loading=!0,this.getImageLoadRequests(5).reverse().forEach((e=>{if(!e)return;const{callLoadImage:a,imageId:r,imageIdIndex:s,options:n,priority:i,requestType:o,additionalDetails:c}=e;t.imageLoadPoolManager.addRequest(a.bind(this,r,s,n),o,c,i)})),Promise.resolve(!0)}_prefetchImageIds(){this.loadStatus.loading=!0;const e=[...this.getImageIdsToLoad()];return e.reverse(),this.totalNumFrames=this.imageIds.length,this.autoRenderOnLoad&&(this.reRenderFraction=.02*this.totalNumFrames,this.reRenderTarget=this.reRenderFraction),this.imagesLoader.loadImages(e,this).catch((e=>{console.debug("progressive loading failed to complete",e)}))}_scaleIfNecessary(e,t){var a;const r=null===(a=e.preScale)||void 0===a?void 0:a.scaled,s=!t||!t.rescaleIntercept||!t.rescaleSlope;if(!r&&s)return e.getPixelData().slice(0);if(!r&&t&&void 0!==t.rescaleIntercept&&void 0!==t.rescaleSlope)return m(e.getPixelData().slice(0),t);const{rescaleSlope:n,rescaleIntercept:i,suvbw:o}=t,{rescaleSlope:c,rescaleIntercept:l,suvbw:d}=e.preScale.scalingParameters;if(n===c&&i===l&&o===d)return e.getPixelData();const g=o/d,u=n/c,h=i-l*u;return m(e.getPixelData().slice(0),{...t,rescaleSlope:u,rescaleIntercept:h,suvbw:g})}_addScalingToVolume(e){if(this.scaling)return;const{suvbw:t,suvlbm:a,suvbsa:r}=e,s={};a&&(s.suvbwToSuvlbm=a/t),r&&(s.suvbwToSuvbsa=r/t),t&&(s.suvbw=t),this.scaling={PT:s}}_removeFromCache(){t.cache.removeVolumeLoadObject(this.volumeId)}getCornerstoneImage(e,a){const{imageIds:r}=this,s=this._imageIdIndexToFrameIndex(a),{bytesPerImage:n,pixelsPerImage:i,windowCenter:o,windowWidth:c,numComponents:l,color:m,dimensions:d,spacing:u,invert:h,voiLUTFunction:I,photometricInterpretation:f}=this.cornerstoneImageMetaData,p=this._getScalarDataByImageIdIndex(a),v=p.buffer,y=p.constructor,P=n/i;let S=n*s;p.BYTES_PER_ELEMENT!==P&&(S*=p.BYTES_PER_ELEMENT/P);const w=new y(i),D=new y(v,S,i);w.set(D);const E=r[a],b=t.metaData.get("modalityLutModule",E)||{},x=g(w);return{imageId:e,intercept:b.rescaleIntercept?b.rescaleIntercept:0,windowCenter:o,windowWidth:c,voiLUTFunction:I,color:m,rgba:!1,numComps:l,rows:d[1],columns:d[0],sizeInBytes:w.byteLength,getPixelData:()=>w,minPixelValue:x.min,maxPixelValue:x.max,slope:b.rescaleSlope?b.rescaleSlope:1,getCanvas:void 0,height:d[0],width:d[1],columnPixelSpacing:u[0],rowPixelSpacing:u[1],invert:h,photometricInterpretation:f}}convertToCornerstoneImage(e,t){return this.getCornerstoneImageLoadObject(e,t)}getCornerstoneImageLoadObject(e,t){const a=this.getCornerstoneImage(e,t);return{promise:Promise.resolve(a)}}getCornerstoneImages(){const{imageIds:e}=this;return e.map(((e,t)=>this.getCornerstoneImage(e,t)))}_convertToImages(){const e=this.sizeInBytes,a=this.imageIds.length,{bytesPerImage:r}=this.cornerstoneImageMetaData;let s=t.cache.decacheIfNecessaryUntilBytesAvailable(e,this.imageIds);for(let e=0;e<a;e++){const a=this.imageIds[e];s-=r;const n=this.convertToCornerstoneImage(a,e);if(t.cache.getImageLoadObject(a)||t.cache.putImageLoadObject(a,n).catch((e=>{console.error(e)})),s<=r)break}this._removeFromCache()}decache(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]?this._removeFromCache():this._convertToImages()}}class p extends f{constructor(e,t){super(e,t),c(this,"getImageIdsToLoad",(()=>{const{imageIds:e}=this;return this.numFrames=e.length,e}))}getScalarData(){return this.scalarData}getImageLoadRequests(e){const{imageIds:t}=this;return this.getImageIdsRequests(t,e)}}const{createUint8SharedArray:v,createFloat32SharedArray:y,createUint16SharedArray:P,createInt16SharedArray:S}=t.utilities,w=function(e,s){if(!s||!s.imageIds||!s.imageIds.length)throw new Error("ImageIds must be provided to create a streaming image volume");const{useNorm16Texture:n,preferSizeOverAccuracy:o}=(0,t.getConfiguration)().rendering,c=n||o,l=async function(){if("wadouri"===s.imageIds[0].split(":")[0]){const[a,r]=[Math.floor(s.imageIds.length/2),s.imageIds.length-1],n=[0,a,r];await Promise.all(n.map((a=>new Promise(((r,n)=>{const i=s.imageIds[a];t.imageLoadPoolManager.addRequest((async()=>{t.imageLoader.loadImage(i).then((()=>{console.log("Prefetched imageId: ".concat(i)),r(!0)})).catch((e=>{n(e)}))}),t.Enums.RequestType.Prefetch,{volumeId:e},1)}))))).catch(console.error)}const{imageIds:n,progressiveRendering:o}=s,l=r(n),m=n[Math.floor(n.length/2)],d=t.utilities.getScalingParameters(m),g=d.rescaleIntercept<0||d.rescaleSlope<0,u=d.rescaleIntercept%1!=0||d.rescaleSlope%1!=0,{BitsAllocated:h,PixelRepresentation:I,PhotometricInterpretation:f,ImageOrientationPatient:w,PixelSpacing:D,Columns:E,Rows:b}=l,x=a.vec3.fromValues(w[0],w[1],w[2]),L=a.vec3.fromValues(w[3],w[4],w[5]),T=a.vec3.create();a.vec3.cross(T,x,L);const{zSpacing:_,origin:F,sortedImageIds:R}=i(n,T),C=n.length,A=[D[1],D[0],_],O=[E,b,C],U=[...x,...L,...T],M=1===I,N="RGB"===f?3:1,V=(0,t.getShouldUseSharedArrayBuffer)(),B=O[0]*O[1]*O[2],k=e=>{if(!t.cache.isCacheable(e))throw new Error(t.Enums.Events.CACHE_SIZE_EXCEEDED);t.cache.decacheIfNecessaryUntilBytesAvailable(e)};let q,j;switch(h){case 8:if(M)throw new Error("8 Bit signed images are not yet supported by this plugin.");j=B*N,k(j),q=V?v(B*N):new Uint8Array(B*N);break;case 16:if(!c||u){j=4*B,q=V?y(B):new Float32Array(B);break}if(j=2*B,M||g){k(j),q=V?S(B):new Int16Array(B);break}if(!M&&!g){k(j),q=V?P(B):new Uint16Array(B);break}j=4*B,k(j),q=V?y(B):new Float32Array(B);break;case 24:j=B*N,k(j),q=V?v(B*N):new Uint8Array(B*N)}return new p({volumeId:e,metadata:l,dimensions:O,spacing:A,origin:F,direction:U,scalarData:q,sizeInBytes:j},{imageIds:R,loadStatus:{loaded:!1,loading:!1,cancelled:!1,cachedFrames:[],callbacks:[]}})}();return{promise:l,decache:()=>{l.then((e=>{e.destroy(),e=null}))},cancel:()=>{l.then((e=>{e.cancelLoading()}))}}};function D(e){const a=e.map((e=>{const a=t.metaData.get("petImageModule",e),{frameReferenceTime:r=0}=null!=a?a:{};return{imageId:e,frameReferenceTime:r}})),r=(s="frameReferenceTime",a.reduce(((e,t)=>((e[t[s]]=e[t[s]]||[]).push(t),e)),{}));var s;return Object.keys(r).map(Number.parseFloat).sort(((e,t)=>e-t)).map((e=>r[e].map((e=>e.imageId))))}const E=function(e){const t=[D];for(let a=0;a<t.length;a++){const r=t[a](e);if(!r||r.length<=1)continue;const s=r[0].length;if(r.every((e=>e.length===s)))return r}return[e]},{createUint8SharedArray:b,createFloat32SharedArray:x}=t.utilities;var L=function(e){return e.DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED="DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED",e}(L||{});const T=L;class _ extends f{constructor(e,t){_._ensureValidData(e,t),super(e,t),c(this,"_numTimePoints",void 0),c(this,"_timePoints",void 0),c(this,"_timePointIndex",0),c(this,"_getTimePointRequests",((e,t)=>{const{imageIds:a}=e;return this.getImageIdsRequests(a,t)})),c(this,"_getTimePointsRequests",(e=>{const t=this._getTimePointsToLoad();let a=[];return t.forEach((t=>{const r=this._getTimePointRequests(t,e);a=a.concat(r)})),a})),c(this,"getImageLoadRequests",(e=>this._getTimePointsRequests(e))),this._numTimePoints=this.scalarData.length,this._timePoints=this._getTimePointsData()}static _ensureValidData(e,t){const a=t.imageIds,r=e.scalarData;if(a.length%r.length!=0)throw new Error("Number of imageIds is not a multiple of ".concat(r.length))}_getTimePointsData(){const{imageIds:e}=this,t=this.scalarData,{numFrames:a}=this,r=t.length,s=[];for(let n=0;n<r;n++){const r=n*a,i=r+a;s.push({imageIds:e.slice(r,i),scalarData:t[n]})}return s}_getTimePointsToLoad(){const e=this._timePoints,t=this._timePointIndex,a=[e[t]];let r=t-1,s=t+1;for(;r>=0||s<e.length;)r>=0&&a.push(e[r--]),s<e.length&&a.push(e[s++]);return a}getImageIdsToLoad(){const e=this._getTimePointsToLoad();let t=[];return e.forEach((e=>{const{imageIds:a}=e;t=t.concat(a)})),t}isDynamicVolume(){return!0}get timePointIndex(){return this._timePointIndex}set timePointIndex(e){if(e<0||e>=this.numTimePoints)throw new Error("Invalid timePointIndex (".concat(e,")"));if(this._timePointIndex===e)return;const{imageData:a}=this;this._timePointIndex=e,a.getPointData().setActiveScalars("timePoint-".concat(e)),this.invalidateVolume(!0),(0,t.triggerEvent)(t.eventTarget,T.DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED,{volumeId:this.volumeId,timePointIndex:e})}get numTimePoints(){return this._numTimePoints}getScalarData(){return this.scalarData[this._timePointIndex]}}const F=function(e,s){if(!s||!s.imageIds||!s.imageIds.length)throw new Error("ImageIds must be provided to create a 4D streaming image volume");const{imageIds:n}=s,o=function(e){return E(e).map((e=>function(e){const s=r(e),{BitsAllocated:n,PixelRepresentation:o,PhotometricInterpretation:c,ImageOrientationPatient:l,PixelSpacing:m,Columns:d,Rows:g}=s,u=a.vec3.fromValues(l[0],l[1],l[2]),h=a.vec3.fromValues(l[3],l[4],l[5]),I=a.vec3.create();a.vec3.cross(I,u,h);const{zSpacing:f,origin:p,sortedImageIds:v}=i(e,I),y=e.length,P=[m[1],m[0],f],S=[d,g,y],w=[...u,...h,...I],D=1===o;let E=1;"RGB"===c&&(E=3);const L=(16===n?4:1)*S[0]*S[1]*S[2]*E;if(!t.cache.isCacheable(L))throw new Error(t.Enums.Events.CACHE_SIZE_EXCEEDED);let T;switch(t.cache.decacheIfNecessaryUntilBytesAvailable(L),n){case 8:if(D)throw new Error("8 Bit signed images are not yet supported by this plugin.");T=b(S[0]*S[1]*S[2]);break;case 16:T=x(S[0]*S[1]*S[2]);break;case 24:T=b(S[0]*S[1]*S[2]*E)}return{metadata:s,sortedImageIds:v,dimensions:S,spacing:P,origin:p,direction:w,scalarData:T,sizeInBytes:L}}(e)))}(n),{metadata:c,dimensions:l,spacing:m,origin:d,direction:g,sizeInBytes:u}=o[0],h=[],I=[];o.forEach((e=>{h.push(e.sortedImageIds),I.push(e.scalarData)}));let f=new _({volumeId:e,metadata:c,dimensions:l,spacing:m,origin:d,direction:g,scalarData:I,sizeInBytes:u},{imageIds:h.flat(),loadStatus:{loaded:!1,loading:!1,cancelled:!1,cachedFrames:[],callbacks:[]}});return{promise:Promise.resolve(f),decache:()=>{f.destroy(),f=null},cancel:()=>{f.cancelLoading()}}},R={getDynamicVolumeInfo:function(e){const t=E(e);return{isDynamicVolume:t.length>1,timePoints:t}},sortImageIdsAndGetSpacing:i}})(),n})()));
//# sourceMappingURL=index.js.map