!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("gl-matrix"),require("@cornerstonejs/core"),require("@kitware/vtk.js/Common/DataModel/PiecewiseFunction"),require("@kitware/vtk.js/Rendering/Core/ColorTransferFunction"),require("@kitware/vtk.js/Common/Core/CellArray"),require("@kitware/vtk.js/Common/Core/Points"),require("@kitware/vtk.js/Common/DataModel/PolyData"),require("@kitware/vtk.js/Common/Core/DataArray"),require("@kitware/vtk.js/Filters/General/AppendPolyData"),require("@kitware/vtk.js/Rendering/Core/Actor"),require("@kitware/vtk.js/Rendering/Core/Mapper"),require("@kitware/vtk.js/Filters/General/ClipClosedSurface"),require("@kitware/vtk.js/Common/Core/Math"),require("@kitware/vtk.js/Common/Core/MatrixBuilder"),require("@kitware/vtk.js/Interaction/Widgets/OrientationMarkerWidget"),require("@kitware/vtk.js/Rendering/Core/AnnotatedCubeActor"),require("@kitware/vtk.js/Rendering/Core/AxesActor"),require("@kitware/vtk.js/IO/XML/XMLPolyDataReader")):"function"==typeof define&&define.amd?define(["gl-matrix","@cornerstonejs/core","@kitware/vtk.js/Common/DataModel/PiecewiseFunction","@kitware/vtk.js/Rendering/Core/ColorTransferFunction","@kitware/vtk.js/Common/Core/CellArray","@kitware/vtk.js/Common/Core/Points","@kitware/vtk.js/Common/DataModel/PolyData","@kitware/vtk.js/Common/Core/DataArray","@kitware/vtk.js/Filters/General/AppendPolyData","@kitware/vtk.js/Rendering/Core/Actor","@kitware/vtk.js/Rendering/Core/Mapper","@kitware/vtk.js/Filters/General/ClipClosedSurface","@kitware/vtk.js/Common/Core/Math","@kitware/vtk.js/Common/Core/MatrixBuilder","@kitware/vtk.js/Interaction/Widgets/OrientationMarkerWidget","@kitware/vtk.js/Rendering/Core/AnnotatedCubeActor","@kitware/vtk.js/Rendering/Core/AxesActor","@kitware/vtk.js/IO/XML/XMLPolyDataReader"],t):"object"==typeof exports?exports.cornerstoneTools3D=t(require("gl-matrix"),require("@cornerstonejs/core"),require("@kitware/vtk.js/Common/DataModel/PiecewiseFunction"),require("@kitware/vtk.js/Rendering/Core/ColorTransferFunction"),require("@kitware/vtk.js/Common/Core/CellArray"),require("@kitware/vtk.js/Common/Core/Points"),require("@kitware/vtk.js/Common/DataModel/PolyData"),require("@kitware/vtk.js/Common/Core/DataArray"),require("@kitware/vtk.js/Filters/General/AppendPolyData"),require("@kitware/vtk.js/Rendering/Core/Actor"),require("@kitware/vtk.js/Rendering/Core/Mapper"),require("@kitware/vtk.js/Filters/General/ClipClosedSurface"),require("@kitware/vtk.js/Common/Core/Math"),require("@kitware/vtk.js/Common/Core/MatrixBuilder"),require("@kitware/vtk.js/Interaction/Widgets/OrientationMarkerWidget"),require("@kitware/vtk.js/Rendering/Core/AnnotatedCubeActor"),require("@kitware/vtk.js/Rendering/Core/AxesActor"),require("@kitware/vtk.js/IO/XML/XMLPolyDataReader")):e.cornerstoneTools3D=t(e.window,e.cornerstone3D,e["@kitware/vtk.js/Common/DataModel/PiecewiseFunction"],e["@kitware/vtk.js/Rendering/Core/ColorTransferFunction"],e["@kitware/vtk.js/Common/Core/CellArray"],e["@kitware/vtk.js/Common/Core/Points"],e["@kitware/vtk.js/Common/DataModel/PolyData"],e["@kitware/vtk.js/Common/Core/DataArray"],e["@kitware/vtk.js/Filters/General/AppendPolyData"],e["@kitware/vtk.js/Rendering/Core/Actor"],e["@kitware/vtk.js/Rendering/Core/Mapper"],e["@kitware/vtk.js/Filters/General/ClipClosedSurface"],e["@kitware/vtk.js/Common/Core/Math"],e["@kitware/vtk.js/Common/Core/MatrixBuilder"],e["@kitware/vtk.js/Interaction/Widgets/OrientationMarkerWidget"],e["@kitware/vtk.js/Rendering/Core/AnnotatedCubeActor"],e["@kitware/vtk.js/Rendering/Core/AxesActor"],e["@kitware/vtk.js/IO/XML/XMLPolyDataReader"])}(self,((e,t,n,i,o,a,r,s,l,d,c,h,u,g,v,m,p,f)=>(()=>{var E={907:(e,t,n)=>{e=n.nmd(e);var i="__lodash_hash_undefined__",o=9007199254740991,a="[object Arguments]",r="[object Boolean]",s="[object Date]",l="[object Function]",d="[object GeneratorFunction]",c="[object Map]",h="[object Number]",u="[object Object]",g="[object Promise]",v="[object RegExp]",m="[object Set]",p="[object String]",f="[object Symbol]",E="[object WeakMap]",w="[object ArrayBuffer]",I="[object DataView]",C="[object Float32Array]",_="[object Float64Array]",T="[object Int8Array]",b="[object Int16Array]",D="[object Int32Array]",S="[object Uint8Array]",y="[object Uint8ClampedArray]",O="[object Uint16Array]",M="[object Uint32Array]",x=/\w*$/,N=/^\[object .+?Constructor\]$/,k=/^(?:0|[1-9]\d*)$/,R={};R[a]=R["[object Array]"]=R[w]=R[I]=R[r]=R[s]=R[C]=R[_]=R[T]=R[b]=R[D]=R[c]=R[h]=R[u]=R[v]=R[m]=R[p]=R[f]=R[S]=R[y]=R[O]=R[M]=!0,R["[object Error]"]=R[l]=R[E]=!1;var P="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,L="object"==typeof self&&self&&self.Object===Object&&self,A=P||L||Function("return this")(),U=t&&!t.nodeType&&t,V=U&&e&&!e.nodeType&&e,W=V&&V.exports===U;function F(e,t){return e.set(t[0],t[1]),e}function H(e,t){return e.add(t),e}function B(e,t,n,i){var o=-1,a=e?e.length:0;for(i&&a&&(n=e[++o]);++o<a;)n=t(n,e[o],o,e);return n}function G(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function q(e){var t=-1,n=Array(e.size);return e.forEach((function(e,i){n[++t]=[i,e]})),n}function j(e,t){return function(n){return e(t(n))}}function z(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}var K,Y=Array.prototype,X=Function.prototype,Z=Object.prototype,J=A["__core-js_shared__"],$=(K=/[^.]+$/.exec(J&&J.keys&&J.keys.IE_PROTO||""))?"Symbol(src)_1."+K:"",Q=X.toString,ee=Z.hasOwnProperty,te=Z.toString,ne=RegExp("^"+Q.call(ee).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),ie=W?A.Buffer:void 0,oe=A.Symbol,ae=A.Uint8Array,re=j(Object.getPrototypeOf,Object),se=Object.create,le=Z.propertyIsEnumerable,de=Y.splice,ce=Object.getOwnPropertySymbols,he=ie?ie.isBuffer:void 0,ue=j(Object.keys,Object),ge=Ae(A,"DataView"),ve=Ae(A,"Map"),me=Ae(A,"Promise"),pe=Ae(A,"Set"),fe=Ae(A,"WeakMap"),Ee=Ae(Object,"create"),we=He(ge),Ie=He(ve),Ce=He(me),_e=He(pe),Te=He(fe),be=oe?oe.prototype:void 0,De=be?be.valueOf:void 0;function Se(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function ye(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function Oe(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function Me(e){this.__data__=new ye(e)}function xe(e,t,n){var i=e[t];ee.call(e,t)&&Be(i,n)&&(void 0!==n||t in e)||(e[t]=n)}function Ne(e,t){for(var n=e.length;n--;)if(Be(e[n][0],t))return n;return-1}function ke(e,t,n,i,o,g,E){var N;if(i&&(N=g?i(e,o,g,E):i(e)),void 0!==N)return N;if(!Ke(e))return e;var k=Ge(e);if(k){if(N=function(e){var t=e.length,n=e.constructor(t);return t&&"string"==typeof e[0]&&ee.call(e,"index")&&(n.index=e.index,n.input=e.input),n}(e),!t)return function(e,t){var n=-1,i=e.length;for(t||(t=Array(i));++n<i;)t[n]=e[n];return t}(e,N)}else{var P=Ve(e),L=P==l||P==d;if(je(e))return function(e,t){if(t)return e.slice();var n=new e.constructor(e.length);return e.copy(n),n}(e,t);if(P==u||P==a||L&&!g){if(G(e))return g?e:{};if(N=function(e){return"function"!=typeof e.constructor||Fe(e)?{}:Ke(t=re(e))?se(t):{};var t}(L?{}:e),!t)return function(e,t){return Pe(e,Ue(e),t)}(e,function(e,t){return e&&Pe(t,Ye(t),e)}(N,e))}else{if(!R[P])return g?e:{};N=function(e,t,n,i){var o,a=e.constructor;switch(t){case w:return Re(e);case r:case s:return new a(+e);case I:return function(e,t){var n=t?Re(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}(e,i);case C:case _:case T:case b:case D:case S:case y:case O:case M:return function(e,t){var n=t?Re(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}(e,i);case c:return function(e,t,n){return B(t?n(q(e),!0):q(e),F,new e.constructor)}(e,i,n);case h:case p:return new a(e);case v:return function(e){var t=new e.constructor(e.source,x.exec(e));return t.lastIndex=e.lastIndex,t}(e);case m:return function(e,t,n){return B(t?n(z(e),!0):z(e),H,new e.constructor)}(e,i,n);case f:return o=e,De?Object(De.call(o)):{}}}(e,P,ke,t)}}E||(E=new Me);var A=E.get(e);if(A)return A;if(E.set(e,N),!k)var U=n?function(e){return function(e,t,n){var i=t(e);return Ge(e)?i:function(e,t){for(var n=-1,i=t.length,o=e.length;++n<i;)e[o+n]=t[n];return e}(i,n(e))}(e,Ye,Ue)}(e):Ye(e);return function(e,t){for(var n=-1,i=e?e.length:0;++n<i&&!1!==t(e[n],n););}(U||e,(function(o,a){U&&(o=e[a=o]),xe(N,a,ke(o,t,n,i,a,e,E))})),N}function Re(e){var t=new e.constructor(e.byteLength);return new ae(t).set(new ae(e)),t}function Pe(e,t,n,i){n||(n={});for(var o=-1,a=t.length;++o<a;){var r=t[o],s=i?i(n[r],e[r],r,n,e):void 0;xe(n,r,void 0===s?e[r]:s)}return n}function Le(e,t){var n,i,o=e.__data__;return("string"==(i=typeof(n=t))||"number"==i||"symbol"==i||"boolean"==i?"__proto__"!==n:null===n)?o["string"==typeof t?"string":"hash"]:o.map}function Ae(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return function(e){return!(!Ke(e)||(t=e,$&&$ in t))&&(ze(e)||G(e)?ne:N).test(He(e));var t}(n)?n:void 0}Se.prototype.clear=function(){this.__data__=Ee?Ee(null):{}},Se.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},Se.prototype.get=function(e){var t=this.__data__;if(Ee){var n=t[e];return n===i?void 0:n}return ee.call(t,e)?t[e]:void 0},Se.prototype.has=function(e){var t=this.__data__;return Ee?void 0!==t[e]:ee.call(t,e)},Se.prototype.set=function(e,t){return this.__data__[e]=Ee&&void 0===t?i:t,this},ye.prototype.clear=function(){this.__data__=[]},ye.prototype.delete=function(e){var t=this.__data__,n=Ne(t,e);return!(n<0||(n==t.length-1?t.pop():de.call(t,n,1),0))},ye.prototype.get=function(e){var t=this.__data__,n=Ne(t,e);return n<0?void 0:t[n][1]},ye.prototype.has=function(e){return Ne(this.__data__,e)>-1},ye.prototype.set=function(e,t){var n=this.__data__,i=Ne(n,e);return i<0?n.push([e,t]):n[i][1]=t,this},Oe.prototype.clear=function(){this.__data__={hash:new Se,map:new(ve||ye),string:new Se}},Oe.prototype.delete=function(e){return Le(this,e).delete(e)},Oe.prototype.get=function(e){return Le(this,e).get(e)},Oe.prototype.has=function(e){return Le(this,e).has(e)},Oe.prototype.set=function(e,t){return Le(this,e).set(e,t),this},Me.prototype.clear=function(){this.__data__=new ye},Me.prototype.delete=function(e){return this.__data__.delete(e)},Me.prototype.get=function(e){return this.__data__.get(e)},Me.prototype.has=function(e){return this.__data__.has(e)},Me.prototype.set=function(e,t){var n=this.__data__;if(n instanceof ye){var i=n.__data__;if(!ve||i.length<199)return i.push([e,t]),this;n=this.__data__=new Oe(i)}return n.set(e,t),this};var Ue=ce?j(ce,Object):function(){return[]},Ve=function(e){return te.call(e)};function We(e,t){return!!(t=null==t?o:t)&&("number"==typeof e||k.test(e))&&e>-1&&e%1==0&&e<t}function Fe(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||Z)}function He(e){if(null!=e){try{return Q.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function Be(e,t){return e===t||e!=e&&t!=t}(ge&&Ve(new ge(new ArrayBuffer(1)))!=I||ve&&Ve(new ve)!=c||me&&Ve(me.resolve())!=g||pe&&Ve(new pe)!=m||fe&&Ve(new fe)!=E)&&(Ve=function(e){var t=te.call(e),n=t==u?e.constructor:void 0,i=n?He(n):void 0;if(i)switch(i){case we:return I;case Ie:return c;case Ce:return g;case _e:return m;case Te:return E}return t});var Ge=Array.isArray;function qe(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=o}(e.length)&&!ze(e)}var je=he||function(){return!1};function ze(e){var t=Ke(e)?te.call(e):"";return t==l||t==d}function Ke(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function Ye(e){return qe(e)?function(e,t){var n=Ge(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&qe(e)}(e)&&ee.call(e,"callee")&&(!le.call(e,"callee")||te.call(e)==a)}(e)?function(e,t){for(var n=-1,i=Array(e);++n<e;)i[n]=t(n);return i}(e.length,String):[],i=n.length,o=!!i;for(var r in e)!t&&!ee.call(e,r)||o&&("length"==r||We(r,i))||n.push(r);return n}(e):function(e){if(!Fe(e))return ue(e);var t=[];for(var n in Object(e))ee.call(e,n)&&"constructor"!=n&&t.push(n);return t}(e)}e.exports=function(e){return ke(e,!0,!0)}},485:(e,t,n)=>{var i,o="__lodash_hash_undefined__",a=1/0,r="[object Function]",s="[object GeneratorFunction]",l="[object Symbol]",d=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,c=/^\w*$/,h=/^\./,u=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,g=/\\(\\)?/g,v=/^\[object .+?Constructor\]$/,m="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,p="object"==typeof self&&self&&self.Object===Object&&self,f=m||p||Function("return this")(),E=Array.prototype,w=Function.prototype,I=Object.prototype,C=f["__core-js_shared__"],_=(i=/[^.]+$/.exec(C&&C.keys&&C.keys.IE_PROTO||""))?"Symbol(src)_1."+i:"",T=w.toString,b=I.hasOwnProperty,D=I.toString,S=RegExp("^"+T.call(b).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),y=f.Symbol,O=E.splice,M=V(f,"Map"),x=V(Object,"create"),N=y?y.prototype:void 0,k=N?N.toString:void 0;function R(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function P(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function L(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function A(e,t){for(var n,i,o=e.length;o--;)if((n=e[o][0])===(i=t)||n!=n&&i!=i)return o;return-1}function U(e,t){var n,i,o=e.__data__;return("string"==(i=typeof(n=t))||"number"==i||"symbol"==i||"boolean"==i?"__proto__"!==n:null===n)?o["string"==typeof t?"string":"hash"]:o.map}function V(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return function(e){if(!G(e)||_&&_ in e)return!1;var t=function(e){var t=G(e)?D.call(e):"";return t==r||t==s}(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e)?S:v;return t.test(function(e){if(null!=e){try{return T.call(e)}catch(e){}try{return e+""}catch(e){}}return""}(e))}(n)?n:void 0}R.prototype.clear=function(){this.__data__=x?x(null):{}},R.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},R.prototype.get=function(e){var t=this.__data__;if(x){var n=t[e];return n===o?void 0:n}return b.call(t,e)?t[e]:void 0},R.prototype.has=function(e){var t=this.__data__;return x?void 0!==t[e]:b.call(t,e)},R.prototype.set=function(e,t){return this.__data__[e]=x&&void 0===t?o:t,this},P.prototype.clear=function(){this.__data__=[]},P.prototype.delete=function(e){var t=this.__data__,n=A(t,e);return!(n<0||(n==t.length-1?t.pop():O.call(t,n,1),0))},P.prototype.get=function(e){var t=this.__data__,n=A(t,e);return n<0?void 0:t[n][1]},P.prototype.has=function(e){return A(this.__data__,e)>-1},P.prototype.set=function(e,t){var n=this.__data__,i=A(n,e);return i<0?n.push([e,t]):n[i][1]=t,this},L.prototype.clear=function(){this.__data__={hash:new R,map:new(M||P),string:new R}},L.prototype.delete=function(e){return U(this,e).delete(e)},L.prototype.get=function(e){return U(this,e).get(e)},L.prototype.has=function(e){return U(this,e).has(e)},L.prototype.set=function(e,t){return U(this,e).set(e,t),this};var W=H((function(e){var t;e=null==(t=e)?"":function(e){if("string"==typeof e)return e;if(q(e))return k?k.call(e):"";var t=e+"";return"0"==t&&1/e==-a?"-0":t}(t);var n=[];return h.test(e)&&n.push(""),e.replace(u,(function(e,t,i,o){n.push(i?o.replace(g,"$1"):t||e)})),n}));function F(e){if("string"==typeof e||q(e))return e;var t=e+"";return"0"==t&&1/e==-a?"-0":t}function H(e,t){if("function"!=typeof e||t&&"function"!=typeof t)throw new TypeError("Expected a function");var n=function(){var i=arguments,o=t?t.apply(this,i):i[0],a=n.cache;if(a.has(o))return a.get(o);var r=e.apply(this,i);return n.cache=a.set(o,r),r};return n.cache=new(H.Cache||L),n}H.Cache=L;var B=Array.isArray;function G(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function q(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&D.call(e)==l}e.exports=function(e,t,n){var i=null==e?void 0:function(e,t){var n;t=function(e,t){if(B(e))return!1;var n=typeof e;return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!q(e))||c.test(e)||!d.test(e)||null!=t&&e in Object(t)}(t,e)?[t]:B(n=t)?n:W(n);for(var i=0,o=t.length;null!=e&&i<o;)e=e[F(t[i++])];return i&&i==o?e:void 0}(e,t);return void 0===i?n:i}},396:e=>{"use strict";e.exports=o},785:e=>{"use strict";e.exports=s},807:e=>{"use strict";e.exports=u},847:e=>{"use strict";e.exports=g},348:e=>{"use strict";e.exports=a},441:e=>{"use strict";e.exports=n},70:e=>{"use strict";e.exports=r},127:e=>{"use strict";e.exports=l},448:e=>{"use strict";e.exports=h},614:e=>{"use strict";e.exports=f},518:e=>{"use strict";e.exports=v},474:e=>{"use strict";e.exports=d},744:e=>{"use strict";e.exports=m},424:e=>{"use strict";e.exports=p},795:e=>{"use strict";e.exports=i},610:e=>{"use strict";e.exports=c},953:e=>{"use strict";e.exports=t},976:t=>{"use strict";t.exports=e}},w={};function I(e){var t=w[e];if(void 0!==t)return t.exports;var n=w[e]={id:e,loaded:!1,exports:{}};return E[e](n,n.exports,I),n.loaded=!0,n.exports}I.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return I.d(t,{a:t}),t},I.d=(e,t)=>{for(var n in t)I.o(t,n)&&!I.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},I.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),I.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),I.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},I.nmd=e=>(e.paths=[],e.children||(e.children=[]),e);var C={};return(()=>{"use strict";I.r(C),I.d(C,{AdvancedMagnifyTool:()=>Mv,AngleTool:()=>hv,AnnotationDisplayTool:()=>Jl,AnnotationTool:()=>Ql,ArrowAnnotateTool:()=>lv,BaseTool:()=>la,BidirectionalTool:()=>ov,BrushTool:()=>Nl,CONSTANTS:()=>h,CircleROITool:()=>ev,CircleScissorsTool:()=>Bv,CobbAngleTool:()=>mv,CrosshairsTool:()=>Rg,DragProbeTool:()=>og,EllipticalROITool:()=>Yg,Enums:()=>Z,KeyImageTool:()=>wv,LengthTool:()=>bg,MIPJumpToClickTool:()=>Ig,MagnifyTool:()=>_v,OrientationMarkerTool:()=>tm,OverlayGridTool:()=>Wg,PaintFillTool:()=>am,PanTool:()=>Xu,PlanarFreehandROITool:()=>Jh,PlanarRotateTool:()=>gg,ProbeTool:()=>tg,RectangleROIStartEndThresholdTool:()=>Cd,RectangleROIThresholdTool:()=>Ed,RectangleROITool:()=>pd,RectangleScissorsTool:()=>Fv,ReferenceCursors:()=>Nv,ReferenceLines:()=>Ag,ReferenceLinesTool:()=>Ag,ScaleOverlayTool:()=>Pv,SegmentationDisplayTool:()=>Ya,SegmentationIntersectionTool:()=>Gg,SphereScissorsTool:()=>qv,StackScrollMouseWheelTool:()=>mg,StackScrollTool:()=>cg,Synchronizer:()=>vr,SynchronizerManager:()=>l,ToolGroupManager:()=>c,TrackballRotateTool:()=>Ju,Types:()=>j,VideoRedactionTool:()=>sm,VolumeRotateMouseWheelTool:()=>Eg,WindowLevelTool:()=>rg,ZoomTool:()=>lg,addTool:()=>dr,annotation:()=>K,cancelActiveManipulations:()=>hr,cursors:()=>q,destroy:()=>rr,drawing:()=>g,init:()=>ar,removeTool:()=>cr,segmentation:()=>X,state:()=>He,synchronizers:()=>u,utilities:()=>G});var e={};I.r(e),I.d(e,{checkAndDefineIsLockedProperty:()=>ce,getAnnotationsLocked:()=>se,getAnnotationsLockedCount:()=>de,isAnnotationLocked:()=>le,setAnnotationLocked:()=>ae,unlockAllAnnotations:()=>re});var t={};I.r(t),I.d(t,{deselectAnnotation:()=>Ee,getAnnotationsSelected:()=>we,getAnnotationsSelectedByToolName:()=>Ie,getAnnotationsSelectedCount:()=>_e,isAnnotationSelected:()=>Ce,setAnnotationSelected:()=>fe});var n={};I.r(n),I.d(n,{checkAndDefineIsVisibleProperty:()=>xe,isAnnotationVisible:()=>Me,setAnnotationVisibility:()=>ye,showAllAnnotations:()=>Oe});var i={};I.r(i),I.d(i,{addAnnotation:()=>Je,getAnnotation:()=>et,getAnnotationManager:()=>Ke,getAnnotations:()=>Ze,getNumberOfAnnotations:()=>$e,removeAllAnnotations:()=>tt,removeAnnotation:()=>Qe,resetAnnotationManager:()=>Xe,setAnnotationManager:()=>Ye});var o={};I.r(o),I.d(o,{triggerSegmentationDataModified:()=>pt,triggerSegmentationModified:()=>mt,triggerSegmentationRemoved:()=>ut,triggerSegmentationRepresentationModified:()=>vt,triggerSegmentationRepresentationRemoved:()=>gt});var a={};I.r(a),I.d(a,{addColorLUT:()=>Wt,addSegmentation:()=>Ct,addSegmentationRepresentation:()=>Nt,getAllSegmentationRepresentations:()=>Tt,getColorLUT:()=>Vt,getDefaultSegmentationStateManager:()=>Et,getGlobalConfig:()=>kt,getSegmentSpecificRepresentationConfig:()=>Mt,getSegmentation:()=>wt,getSegmentationRepresentationByUID:()=>Pt,getSegmentationRepresentationSpecificConfig:()=>Ot,getSegmentationRepresentations:()=>_t,getSegmentations:()=>It,getToolGroupIdsWithSegmentation:()=>bt,getToolGroupSpecificConfig:()=>Dt,removeColorLUT:()=>Ut,removeSegmentation:()=>Lt,removeSegmentationRepresentation:()=>At,setGlobalConfig:()=>Rt,setSegmentSpecificRepresentationConfig:()=>xt,setSegmentationRepresentationSpecificConfig:()=>yt,setToolGroupSpecificConfig:()=>St});var r={};I.r(r),I.d(r,{copyPoints:()=>Wn,copyPointsList:()=>Vn,getDeltaDistance:()=>Ln,getDeltaDistanceBetweenIPoints:()=>Un,getDeltaPoints:()=>Pn,getDeltaRotation:()=>An,getMeanPoints:()=>Fn,getMeanTouchPoints:()=>Hn});var s={};I.r(s),I.d(s,{getSegmentationVisibility:()=>oa,setSegmentVisibility:()=>ra,setSegmentationVisibility:()=>ia,setSegmentsVisibility:()=>aa});var l={};I.r(l),I.d(l,{createSynchronizer:()=>mr,destroy:()=>pr,destroySynchronizer:()=>wr,getAllSynchronizers:()=>Er,getSynchronizer:()=>fr,getSynchronizersForViewport:()=>Fo});var d={};I.r(d),I.d(d,{hideElementCursor:()=>Qr,initElementCursor:()=>Zr,resetElementCursor:()=>$r,setElementCursor:()=>Jr});var c={};I.r(c),I.d(c,{createToolGroup:()=>rs,destroy:()=>ir,destroyToolGroup:()=>nr,getAllToolGroups:()=>ss,getToolGroup:()=>zo,getToolGroupForViewport:()=>Si,getToolGroupsWithToolName:()=>je});var h={};I.r(h),I.d(h,{COLOR_LUT:()=>nt});var u={};I.r(u),I.d(u,{createCameraPositionSynchronizer:()=>cs,createStackImageSynchronizer:()=>Ts,createVOISynchronizer:()=>us,createZoomPanSynchronizer:()=>ms});var g={};I.r(g),I.d(g,{draw:()=>Di,drawArrow:()=>Vs,drawCircle:()=>ys,drawEllipse:()=>Os,drawHandles:()=>Ms,drawLine:()=>xs,drawLinkedTextBox:()=>As,drawPolyline:()=>Ns,drawRect:()=>Us,drawRedactionRect:()=>Ws,drawTextBox:()=>Ps,setAttributesIfNecessary:()=>Ds,setNewAttributesIfValid:()=>Ss});var v={};I.r(v),I.d(v,{getActiveSegmentationRepresentation:()=>wl,setActiveSegmentationRepresentation:()=>Il});var m={};I.r(m),I.d(m,{getLockedSegments:()=>Tl,isSegmentIndexLocked:()=>Cl,setSegmentIndexLocked:()=>_l});var p={};I.r(p),I.d(p,{getActiveSegmentIndex:()=>Dl,setActiveSegmentIndex:()=>bl});var f={};I.r(f),I.d(f,{addColorLUT:()=>Sl,getColorForSegmentIndex:()=>Ol,setColorForSegmentIndex:()=>Ml,setColorLUT:()=>yl});var E={};I.r(E),I.d(E,{createLabelmapVolumeForViewport:()=>Od,createMergedLabelmapForIndex:()=>Dd,floodFill:()=>Nd,getBrushSizeForToolGroup:()=>Rd,getBrushThresholdForToolGroup:()=>Ld,getDefaultRepresentationConfig:()=>yd,isValidRepresentationConfig:()=>Sd,rectangleROIThresholdVolumeByRange:()=>bd,setBrushSizeForToolGroup:()=>kd,setBrushThresholdForToolGroup:()=>Pd,thresholdSegmentationByRange:()=>Ad,thresholdVolumeByRange:()=>Ll,triggerSegmentationRender:()=>Za});var w={};I.r(w),I.d(w,{getTextBoxCoordsCanvas:()=>od});var _={};I.r(_),I.d(_,{findClosestPoint:()=>Ls,liangBarksyClip:()=>Hd});var T={};I.r(T),I.d(T,{getCanvasEllipseCorners:()=>ul,pointInEllipse:()=>gl});var b={};I.r(b),I.d(b,{distanceToPoint:()=>nd,distanceToPointSquared:()=>td,intersectLine:()=>Gd});var D={};I.r(D),I.d(D,{distanceToPoint:()=>id});var S={};I.r(S),I.d(S,{addCanvasPointsToArray:()=>ec,calculateAreaOfPoints:()=>nc,getClosestIntersectionWithPolyline:()=>zd,getFirstIntersectionWithPolyline:()=>jd,getSubPixelSpacingAndXYDirections:()=>$d,pointCanProjectOnLine:()=>tc,pointsAreWithinCloseContourProximity:()=>Qd});var y={};I.r(y),I.d(y,{distanceToPoint:()=>ic});var O={};I.r(O),I.d(O,{BasicStatsCalculator:()=>hd,Calculator:()=>dd});var M={};I.r(M),I.d(M,{BasicStatsCalculator:()=>O,ellipse:()=>T,lineSegment:()=>b,point:()=>y,polyline:()=>S,rectangle:()=>D,vec2:()=>_});var x={};I.r(x),I.d(x,{default:()=>lc,filterAnnotationsForDisplay:()=>Yl,filterAnnotationsWithinSlice:()=>zl,getPointInLineOfSightWithCriteria:()=>rc,getWorldWidthAndHeightFromCorners:()=>ad});var N={};I.r(N),I.d(N,{filterViewportsWithFrameOfReferenceUID:()=>Al,filterViewportsWithParallelNormals:()=>Bl,filterViewportsWithToolEnabled:()=>Fl,getViewportIdsWithToolToRender:()=>Gl});var k={};I.r(k),I.d(k,{getOrientationStringLPS:()=>dc,invertOrientationStringLPS:()=>cc});var R={};I.r(R),I.d(R,{Events:()=>uc,addToolState:()=>vc,getToolState:()=>mc,playClip:()=>Cc,stopClip:()=>_c});var P={};I.r(P),I.d(P,{extend2DBoundingBoxInViewAxis:()=>_d,getBoundingBoxAroundShape:()=>nl});var L={};I.r(L),I.d(L,{default:()=>Qh,interpolateAnnotation:()=>$h});var A={};I.r(A),I.d(A,{getBoundsIJKFromRectangleAnnotations:()=>Td});var U={};I.r(U),I.d(U,{isViewportPreScaled:()=>sd,jumpToSlice:()=>ws,jumpToWorld:()=>Iu});var V={};I.r(V),I.d(V,{generateImageFromTimeData:()=>_u,getDataInTime:()=>Cu});var W={};I.r(W),I.d(W,{getPoint:()=>Tu,getPolyDataPointIndexes:()=>bu,getPolyDataPoints:()=>Du});var F={};I.r(F),I.d(F,{ColorbarRangeTextPosition:()=>Su});var H={};I.r(H),I.d(H,{Colorbar:()=>Uu,Enums:()=>F,ViewportColorbar:()=>Fu});var B={};I.r(B),I.d(B,{colorbar:()=>H});var G={};I.r(G),I.d(G,{annotationFrameRange:()=>rl,boundingBox:()=>P,calibrateImageSpacing:()=>Ks,cine:()=>R,clip:()=>fs,debounce:()=>qs,drawing:()=>w,dynamicVolume:()=>V,getAnnotationNearPoint:()=>Fs,getAnnotationNearPointOnEnabledElement:()=>Hs,getCalibratedLengthUnits:()=>el,getCalibratedScale:()=>$s,isObject:()=>Gs,jumpToSlice:()=>ws,math:()=>M,orientation:()=>k,planar:()=>x,planarFreehandROITool:()=>L,pointInShapeCallback:()=>tl,pointInSurroundingSphereCallback:()=>ol,pointToString:()=>Ia,polyDataUtils:()=>W,rectangleROITool:()=>A,roundNumber:()=>al,scroll:()=>Es,segmentation:()=>E,stackContextPrefetch:()=>wu,stackPrefetch:()=>gu,throttle:()=>js,touch:()=>r,triggerAnnotationRender:()=>ki,triggerAnnotationRenderForViewportIds:()=>Bo,triggerEvent:()=>J.triggerEvent,viewport:()=>U,viewportFilters:()=>N,voi:()=>B});var q={};I.r(q),I.d(q,{CursorNames:()=>Bu,CursorSVG:()=>Ur,ImageMouseCursor:()=>Mr,MouseCursor:()=>br,SVGMouseCursor:()=>jr,elementCursor:()=>d,registerCursor:()=>Wr,setCursorForElement:()=>Hu});var j={};I.r(j);var z={};I.r(z),I.d(z,{getFont:()=>Gu,getState:()=>Xl,style:()=>Hr});var K={};I.r(K),I.d(K,{AnnotationGroup:()=>qu,FrameOfReferenceSpecificAnnotationManager:()=>Ve,config:()=>z,locking:()=>e,selection:()=>t,state:()=>i,visibility:()=>n});var Y={};I.r(Y),I.d(Y,{color:()=>f,getGlobalConfig:()=>Ko,getGlobalRepresentationConfig:()=>Xo,getSegmentSpecificConfig:()=>ta,getSegmentationRepresentationSpecificConfig:()=>Qo,getToolGroupSpecificConfig:()=>Jo,setGlobalConfig:()=>Yo,setGlobalRepresentationConfig:()=>Zo,setSegmentSpecificConfig:()=>na,setSegmentationRepresentationSpecificConfig:()=>ea,setToolGroupSpecificConfig:()=>$o,visibility:()=>s});var X={};I.r(X),I.d(X,{activeSegmentation:()=>v,addSegmentationRepresentations:()=>Ku,addSegmentations:()=>zu,config:()=>Y,removeSegmentationsFromToolGroup:()=>tr,segmentIndex:()=>p,segmentLocking:()=>m,state:()=>a,triggerSegmentationEvents:()=>o});var Z={};I.r(Z),I.d(Z,{AnnotationStyleStates:()=>Or,Events:()=>Q,KeyboardBindings:()=>Qi,MouseBindings:()=>$i,SegmentationRepresentations:()=>ot,Swipe:()=>kn,ToolModes:()=>Ge});var J=I(953),$=function(e){return e.TOOL_ACTIVATED="CORNERSTONE_TOOLS_TOOL_ACTIVATED",e.TOOL_MODE_CHANGED="CORNERSTONE_TOOLS_TOOL_MODE_CHANGED",e.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",e.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",e.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",e.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",e.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",e.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",e.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",e.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",e.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",e.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",e.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",e.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",e.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",e.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",e.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",e.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",e.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",e.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",e.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",e.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",e.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",e.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",e.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",e.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",e.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",e.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",e.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",e.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",e.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",e.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",e.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE",e}($||{});const Q=$;function ee(e){return ee="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ee(e)}function te(e,t,n){return(t=function(e){var t=function(e,t){if("object"!==ee(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,"string");if("object"!==ee(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"===ee(t)?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ne=I(907),ie=I.n(ne);const oe=new Set;function ae(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const n=he();e&&(t?function(e,t,n){t.has(e)||(t.add(e),n.added.push(e))}(e,oe,n):ue(e,oe,n)),ge(n,oe)}function re(){const e=he();!function(e,t){e.forEach((n=>{ue(n,e,t)}))}(oe,e),ge(e,oe)}function se(){return Array.from(oe)}function le(e){return oe.has(e)}function de(){return oe.size}function ce(e){if(e){const t=!!e.isLocked;(function(e){const t=Object.getOwnPropertyDescriptor(e,"isLocked");return t?t.configurable&&(t.set!==ve||t.get!==me):Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isLocked",{configurable:!1,enumerable:!0,set:ve,get:me}),ae(e,t)}}function he(){return Object.freeze({added:[],removed:[],locked:[]})}function ue(e,t,n){t.delete(e)&&n.removed.push(e)}function ge(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((t=>{e.locked.push(t)})),(0,J.triggerEvent)(J.eventTarget,Q.ANNOTATION_LOCK_CHANGE,e))}function ve(e){ae(this,e)}function me(){return le(this)}const pe=new Set;function fe(e){arguments.length>1&&void 0!==arguments[1]&&!arguments[1]?Ee(e):function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=Te();t||be(pe,n),e&&!pe.has(e)&&(pe.add(e),n.added.push(e)),De(n,pe)}(e,arguments.length>2&&void 0!==arguments[2]&&arguments[2])}function Ee(e){const t=Te();e?pe.delete(e)&&t.removed.push(e):be(pe,t),De(t,pe)}function we(){return Array.from(pe)}function Ie(e){return we().filter((t=>et(t).metadata.toolName===e))}function Ce(e){return pe.has(e)}function _e(){return pe.size}function Te(){return Object.freeze({added:[],removed:[],selection:[]})}function be(e,t){e.forEach((n=>{e.delete(n)&&t.removed.push(n)}))}function De(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((t=>{e.selection.push(t)})),(0,J.triggerEvent)(J.eventTarget,Q.ANNOTATION_SELECTION_CHANGE,e))}const Se=new Set;function ye(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const n=Ne();e&&(t?ke(e,Se,n):function(e,t,n){t.has(e)||(t.add(e),Ce(e)&&Ee(e),n.lastHidden.push(e))}(e,Se,n)),Re(n)}function Oe(){const e=Ne();Se.forEach((t=>{ke(t,Se,e)})),Re(e)}function Me(e){if(et(e))return!Se.has(e)}function xe(e){if(e){var t;const n=null===(t=e.isVisible)||void 0===t||t;(function(e){const t=Object.getOwnPropertyDescriptor(e,"isVisible");return t?t.configurable&&(t.set!==Pe||t.get!==Le):Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isVisible",{configurable:!1,enumerable:!0,set:Pe,get:Le}),ye(e.annotationUID,n)}}function Ne(){return Object.freeze({lastVisible:[],lastHidden:[],hidden:[]})}function ke(e,t,n){t.delete(e)&&n.lastVisible.push(e)}function Re(e){(e.lastHidden.length>0||e.lastVisible.length>0)&&(Se.forEach((t=>{e.hidden.push(t)})),(0,J.triggerEvent)(J.eventTarget,Q.ANNOTATION_VISIBILITY_CHANGE,e))}function Pe(e){ye(this.annotationUID,e)}function Le(){return Me(this.annotationUID)}class Ae{constructor(e){te(this,"annotations",void 0),te(this,"uid",void 0),te(this,"getGroupKey",(e=>{if("string"==typeof e)return e;const t=e,n=(0,J.getEnabledElement)(t);if(!n)throw new Error("Element not enabled, you must have an enabled element if you are not providing a FrameOfReferenceUID");return n.FrameOfReferenceUID})),te(this,"_imageVolumeModifiedHandler",(e=>{const t=e.detail,{FrameOfReferenceUID:n}=t,i=this.annotations[n];i&&Object.keys(i).forEach((e=>{i[e].forEach((e=>{void 0!==e.invalidated&&(e.invalidated=!0)}))}))})),te(this,"getFramesOfReference",(()=>Object.keys(this.annotations))),te(this,"getAnnotations",((e,t)=>{const n=this.annotations;return n[e]?t?n[e][t]:n[e]:[]})),te(this,"getAnnotation",(e=>{const t=this.annotations;for(const n in t){const i=t[n];for(const t in i){const n=i[t];for(const t of n)if(e===t.annotationUID)return t}}})),te(this,"getNumberOfAnnotations",((e,t)=>{const n=this.getAnnotations(e,t);if(!n.length)return 0;if(t)return n.length;let i=0;for(const e in n)i+=n[e].length;return i})),te(this,"addAnnotation",((e,t)=>{const{metadata:n}=e,{FrameOfReferenceUID:i,toolName:o}=n;t=t||i;const a=this.annotations;let r=a[t];r||(a[t]={},r=a[t]);let s=r[o];s||(r[o]=[],s=r[o]),s.push(e),ce(e),xe(e)})),te(this,"removeAnnotation",(e=>{const{annotations:t}=this;for(const n in t){const i=t[n];for(const t in i){const n=i[t],o=n.findIndex((t=>t.annotationUID===e));-1!==o&&(n.splice(o,1),0===n.length&&delete i[t])}0===Object.keys(i).length&&delete t[n]}})),te(this,"removeAnnotations",((e,t)=>{const n=this.annotations;n[e]&&(t?delete n[e][t]:delete n[e])})),te(this,"saveAnnotations",((e,t)=>{const n=this.annotations;if(e&&t){const i=n[e];if(!i)return;const o=i[t];return ie()(o)}if(e){const t=n[e];return ie()(t)}return ie()(n)})),te(this,"restoreAnnotations",((e,t,n)=>{const i=this.annotations;if(t&&n){let o=i[t];o||(i[t]={},o=i[t]),o[n]=e}else t?i[t]=e:this.annotations=ie()(e)})),te(this,"getNumberOfAllAnnotations",(()=>{let e=0;const t=this.annotations;for(const n in t){const i=t[n];for(const t in i)e+=i[t].length}return e})),te(this,"removeAllAnnotations",(()=>{this.annotations={}})),e||(e=J.utilities.uuidv4()),this.annotations={},this.uid=e,J.eventTarget.addEventListener(J.Enums.Events.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedHandler)}}const Ue=new Ae("DEFAULT"),Ve=Ae;let We={};const Fe={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:We,enabledElements:[],handleRadius:6};let He={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:We,enabledElements:[],handleRadius:6};var Be=function(e){return e.Active="Active",e.Passive="Passive",e.Enabled="Enabled",e.Disabled="Disabled",e}(Be||{});const Ge=Be,qe=[Ge.Active,Ge.Passive,Ge.Enabled],je=function(e){return He.toolGroups.filter((t=>{let{toolOptions:n}=t;const i=Object.keys(n);for(let t=0;t<i.length;t++)if(e===i[t]&&n[e]&&qe.includes(n[e].mode))return!0;return!1}))};let ze=Ue;function Ke(){return ze}function Ye(e){ze=e}function Xe(){ze=Ue}function Ze(e,t){const n=Ke(),i=n.getGroupKey(t);return n.getAnnotations(i,e)}function Je(e,t){e.annotationUID||(e.annotationUID=J.utilities.uuidv4());const n=Ke(),i=n.getGroupKey(t);return n.addAnnotation(e,i),t instanceof HTMLDivElement?function(e,t){const n=(0,J.getEnabledElement)(t),{renderingEngine:i,viewportId:o}=n,a=Q.ANNOTATION_ADDED,r={annotation:e,viewportId:o,renderingEngineId:i.id};(0,J.triggerEvent)(J.eventTarget,a,r)}(e,t):function(e){const{toolName:t}=e.metadata,n=je(t);if(!n.length)return;const i=[];if(n.forEach((t=>{t.viewportsInfo.forEach((t=>{const{renderingEngineId:n,viewportId:o}=t,{FrameOfReferenceUID:a}=(0,J.getEnabledElementByIds)(o,n);e.metadata.FrameOfReferenceUID===a&&i.push(t)}))})),!i.length)return;const o=Q.ANNOTATION_ADDED;i.forEach((t=>{let{renderingEngineId:n,viewportId:i}=t;const a={annotation:e,viewportId:i,renderingEngineId:n};(0,J.triggerEvent)(J.eventTarget,o,a)}))}(e),e.annotationUID}function $e(e,t){const n=Ke(),i=n.getGroupKey(t);return n.getNumberOfAnnotations(i,e)}function Qe(e){const t=Ke(),n=t.getAnnotation(e);if(!n)return;t.removeAnnotation(e);const i=Q.ANNOTATION_REMOVED,o={annotation:n,annotationManagerUID:t.uid};(0,J.triggerEvent)(J.eventTarget,i,o)}function et(e){return Ke().getAnnotation(e)}function tt(){Ke().removeAllAnnotations()}const nt=[[0,0,0,0],[221,84,84,255],[77,228,121,255],[166,70,235,255],[189,180,116,255],[109,182,196,255],[204,101,157,255],[123,211,94,255],[93,87,218,255],[225,128,80,255],[73,232,172,255],[181,119,186,255],[176,193,112,255],[105,153,200,255],[208,97,120,255],[90,215,101,255],[135,83,222,255],[229,178,76,255],[122,183,181,255],[190,115,171,255],[149,197,108,255],[100,118,205,255],[212,108,93,255],[86,219,141,255],[183,79,226,255],[233,233,72,255],[118,167,187,255],[194,111,146,255],[116,201,104,255],[115,96,209,255],[216,147,89,255],[82,223,188,255],[230,75,224,255],[163,184,121,255],[114,143,191,255],[198,107,114,255],[99,206,122,255],[153,92,213,255],[220,192,85,255],[78,215,227,255],[234,71,173,255],[141,188,117,255],[110,113,195,255],[202,128,103,255],[95,210,157,255],[195,88,217,255],[206,224,81,255],[74,166,231,255],[185,120,139,255],[113,192,113,255],[133,106,199,255],[207,162,98,255],[91,214,198,255],[221,84,198,255],[159,228,77,255],[70,111,235,255],[189,119,116,255],[109,196,138,255],[165,101,204,255],[211,201,94,255],[87,191,218,255],[225,80,153,255],[106,232,73,255],[124,119,186,255],[193,142,112,255],[105,200,168,255],[203,97,208,255],[184,215,90,255],[83,147,222,255],[229,76,101,255],[122,183,130,255],[146,115,190,255],[197,171,108,255],[100,205,205,255],[212,93,177,255],[141,219,86,255],[79,97,226,255],[233,99,72,255],[118,187,150,255],[173,111,194,255],[197,201,104,255],[96,171,209,255],[216,89,137,255],[94,223,82,255],[107,75,230,255],[184,153,121,255],[114,191,175,255],[198,107,191,255],[166,206,99,255],[92,132,213,255],[220,85,91,255],[78,227,115,255],[159,71,234,255],[188,176,117,255],[110,185,195,255],[202,103,161,255],[129,210,95,255],[88,88,217,255],[224,123,81,255],[74,231,166,255],[177,120,185,255],[179,192,113,255],[106,156,199,255],[207,98,125,255],[91,214,96,255],[130,84,221,255],[228,171,77,255],[70,235,221,255],[189,116,174,255],[153,196,109,255],[101,123,204,255],[211,104,94,255],[87,218,136,255],[177,80,225,255],[232,225,73,255],[119,169,186,255],[193,112,149,255],[121,200,105,255],[111,97,208,255],[215,142,90,255],[83,222,181,255],[229,76,229,255],[165,183,122,255],[115,146,190,255],[197,108,119,255],[100,205,118,255],[148,93,212,255],[219,186,86,255],[79,220,226,255],[233,72,179,255],[144,187,118,255],[111,118,194,255],[201,124,104,255],[96,209,153,255],[189,89,216,255],[211,223,82,255],[75,172,230,255],[184,121,142,255],[117,191,114,255],[130,107,198,255],[206,157,99,255],[92,213,193,255],[220,85,203,255],[165,227,78,255],[71,118,234,255],[188,117,117,255],[110,195,135,255],[161,103,202,255],[210,195,95,255],[88,195,217,255],[224,81,158,255],[113,231,74,255],[123,120,185,255],[192,139,113,255],[106,199,164,255],[198,98,207,255],[188,214,91,255],[84,153,221,255],[228,77,108,255],[70,235,84,255],[143,116,189,255],[196,167,109,255],[101,204,199,255],[211,94,182,255],[147,218,87,255],[80,104,225,255],[232,93,73,255],[119,186,147,255],[170,112,193,255],[200,200,105,255],[97,175,208,255],[215,90,142,255],[100,222,83,255],[101,76,229,255],[183,150,122,255],[115,190,171,255],[197,108,194,255],[170,205,100,255],[93,138,212,255],[219,86,97,255],[79,226,110,255],[153,72,233,255],[187,173,118,255],[111,187,194,255],[201,104,165,255],[134,209,96,255],[89,95,216,255],[223,117,82,255],[75,230,159,255],[174,121,184,255],[182,191,114,255],[107,160,198,255],[206,99,130,255],[92,213,92,255],[124,85,220,255],[227,165,78,255],[71,234,214,255],[188,117,176,255],[156,195,110,255],[103,128,202,255],[210,100,95,255],[88,217,131,255],[170,81,224,255],[231,218,74,255],[120,172,185,255],[192,113,153,255],[125,199,106,255],[107,98,207,255],[214,137,91,255],[84,221,175,255],[222,77,228,255],[194,235,70,255],[116,149,189,255],[196,109,123,255],[101,204,114,255],[143,94,211,255],[218,180,87,255],[80,225,225,255],[232,73,186,255],[147,186,119,255],[112,122,193,255],[200,121,105,255],[97,208,148,255],[184,90,215,255],[216,222,83,255],[76,178,229,255],[183,122,145,255],[121,190,115,255],[126,108,197,255],[205,153,100,255],[93,212,187,255],[219,86,208,255],[171,226,79,255],[72,126,233,255],[187,118,121,255],[111,194,132,255],[157,104,201,255],[209,190,96,255],[89,200,216,255],[223,82,164,255],[120,230,75,255],[121,121,184,255],[191,136,114,255],[107,198,160,255],[192,99,206,255],[193,213,92,255],[85,158,220,255],[227,78,115,255],[71,234,78,255],[141,117,188,255],[195,163,110,255],[103,202,194,255],[210,95,186,255],[153,217,88,255],[81,111,224,255]];var it=function(e){return e.Labelmap="LABELMAP",e.Contour="CONTOUR",e.Surface="SURFACE",e}(it||{});const ot=it,at={renderOutline:!0,outlineWidthActive:2,outlineWidthInactive:2,outlineOpacity:1,outlineOpacityInactive:.85,renderFill:!0,fillAlpha:1,fillAlphaInactive:0},rt={renderOutline:!0,outlineWidthActive:3,outlineWidthInactive:2,renderFill:!0,renderFillInactive:!0,fillAlpha:.7,fillAlphaInactive:.65,outlineOpacity:1,outlineOpacityInactive:.85},st=function(){return rt},lt=st(),dt=at,ct={colorLUT:[],segmentations:[],globalConfig:{renderInactiveSegmentations:!0,representations:{[ot.Labelmap]:lt,[ot.Contour]:dt}},toolGroups:{}},ht=new class{constructor(e){te(this,"state",void 0),te(this,"uid",void 0),e||(e=J.utilities.uuidv4()),this.state=ie()(ct),this.uid=e}getState(){return this.state}getToolGroups(){return Object.keys(this.state.toolGroups)}getColorLUT(e){return this.state.colorLUT[e]}resetState(){this.state=ie()(ct)}getSegmentation(e){return this.state.segmentations.find((t=>t.segmentationId===e))}addSegmentation(e){if(this._initDefaultColorLUTIfNecessary(),this.getSegmentation(e.segmentationId))throw new Error("Segmentation with id ".concat(e.segmentationId," already exists"));this.state.segmentations.push(e)}getSegmentationRepresentations(e){const t=this.state.toolGroups[e];if(t)return t.segmentationRepresentations}getAllSegmentationRepresentations(){const e={};return Object.entries(this.state.toolGroups).forEach((t=>{let[n,i]=t;e[n]=i.segmentationRepresentations})),e}addSegmentationRepresentation(e,t){this.state.toolGroups[e]||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{}}),this.state.toolGroups[e].segmentationRepresentations.push(t),this._handleActiveSegmentation(e,t)}getGlobalConfig(){return this.state.globalConfig}setGlobalConfig(e){this.state.globalConfig=e}getSegmentationRepresentationByUID(e,t){return this.getSegmentationRepresentations(e).find((e=>e.segmentationRepresentationUID===t))}removeSegmentation(e){this.state.segmentations=this.state.segmentations.filter((t=>t.segmentationId!==e))}removeSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error("No viewport specific segmentation state found for viewport ".concat(e));const i=n.findIndex((e=>e.segmentationRepresentationUID===t));-1===i&&console.warn("No viewport specific segmentation state data found for viewport ".concat(e," and segmentation data UID ").concat(t));const o=n[i];n.splice(i,1),this._handleActiveSegmentation(e,o)}setActiveSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error("No segmentation data found for toolGroupId: ".concat(e));const i=n.find((e=>e.segmentationRepresentationUID===t));if(!i)throw new Error("No segmentation data found for segmentation data UID ".concat(t));i.active=!0,this._handleActiveSegmentation(e,i)}getToolGroupSpecificConfig(e){const t=this.state.toolGroups[e];if(t)return t.config}getSegmentationRepresentationSpecificConfig(e,t){const n=this.getSegmentationRepresentationByUID(e,t);if(n)return n.segmentationRepresentationSpecificConfig}setSegmentationRepresentationSpecificConfig(e,t,n){const i=this.getSegmentationRepresentationByUID(e,t);i&&(i.segmentationRepresentationSpecificConfig=n)}getSegmentSpecificConfig(e,t,n){const i=this.getSegmentationRepresentationByUID(e,t);if(i)return i.segmentSpecificConfig[n]}setSegmentSpecificConfig(e,t,n){const i=this.getSegmentationRepresentationByUID(e,t);i&&(i.segmentSpecificConfig=n)}setSegmentationRepresentationConfig(e,t){let n=this.state.toolGroups[e];n||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{renderInactiveSegmentations:!0,representations:{}}},n=this.state.toolGroups[e]),n.config={...n.config,...t}}addColorLUT(e,t){this.state.colorLUT[t]&&console.log("Color LUT table already exists, overwriting"),this.state.colorLUT[t]=e}removeColorLUT(e){delete this.state.colorLUT[e]}_handleActiveSegmentation(e,t){const n=this.getSegmentationRepresentations(e);0!==n.length&&(1!==n.length&&0!==n.filter((e=>e.active)).length?t.active&&n.forEach((e=>{e.segmentationRepresentationUID!==t.segmentationRepresentationUID&&(e.active=!1)})):n[0].active=!0)}_initDefaultColorLUTIfNecessary(){0!==this.state.colorLUT.length&&this.state.colorLUT[0]||this.addColorLUT(nt,0)}}("DEFAULT");function ut(e){const t={segmentationId:e};(0,J.triggerEvent)(J.eventTarget,Q.SEGMENTATION_REMOVED,t)}function gt(e,t){const n={toolGroupId:e,segmentationRepresentationUID:t};(0,J.triggerEvent)(J.eventTarget,Q.SEGMENTATION_REPRESENTATION_REMOVED,n)}function vt(e,t){const n={toolGroupId:e,segmentationRepresentationUID:t};t?(0,J.triggerEvent)(J.eventTarget,Q.SEGMENTATION_REPRESENTATION_MODIFIED,n):(_t(e)||[]).forEach((t=>{const{segmentationRepresentationUID:n}=t,i={toolGroupId:e,segmentationRepresentationUID:n};(0,J.triggerEvent)(J.eventTarget,Q.SEGMENTATION_REPRESENTATION_MODIFIED,i)}))}function mt(e){let t;t=e?[e]:It().map((e=>{let{segmentationId:t}=e;return t})),t.forEach((e=>{const t={segmentationId:e};(0,J.triggerEvent)(J.eventTarget,Q.SEGMENTATION_MODIFIED,t)}))}function pt(e,t){const n={segmentationId:e,modifiedSlicesToUse:t};(0,J.triggerEvent)(J.eventTarget,Q.SEGMENTATION_DATA_MODIFIED,n)}const ft=function(e){const{segmentationId:t,representation:n}=e;return{segmentationId:t,cachedStats:{},segmentLabels:{},label:null,segmentsLocked:new Set,type:n.type,activeSegmentIndex:1,representationData:{[n.type]:{...n.data}}}};function Et(){return ht}function wt(e){return Et().getSegmentation(e)}function It(){return Et().getState().segmentations}function Ct(e,t){const n=Et(),i=ft(e);n.addSegmentation(i),t||mt(i.segmentationId)}function _t(e){return Et().getSegmentationRepresentations(e)}function Tt(){return Et().getAllSegmentationRepresentations()}function bt(e){if(!e)throw new Error("getToolGroupIdsWithSegmentation: segmentationId is empty");const t=Et(),n=t.getState(),i=Object.keys(n.toolGroups),o=[];return i.forEach((n=>{t.getSegmentationRepresentations(n).forEach((t=>{t.segmentationId===e&&o.push(n)}))})),o}function Dt(e){return Et().getToolGroupSpecificConfig(e)}function St(e,t,n){Et().setSegmentationRepresentationConfig(e,t),n||vt(e)}function yt(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];Et().setSegmentationRepresentationSpecificConfig(e,t,n),i||vt(e,t)}function Ot(e,t){return Et().getSegmentationRepresentationSpecificConfig(e,t)}function Mt(e,t,n){return Et().getSegmentSpecificConfig(e,t,n)}function xt(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];Et().setSegmentSpecificConfig(e,t,n),i||vt(e,t)}function Nt(e,t,n){Et().addSegmentationRepresentation(e,t),n||vt(e,t.segmentationRepresentationUID)}function kt(){return Et().getGlobalConfig()}function Rt(e,t){Et().setGlobalConfig(e),t||mt()}function Pt(e,t){return Et().getSegmentationRepresentationByUID(e,t)}function Lt(e){Et().removeSegmentation(e),ut(e)}function At(e,t){Et().removeSegmentationRepresentation(e,t),gt(e,t)}function Ut(e){Et().removeColorLUT(e)}function Vt(e){return Et().getColorLUT(e)}function Wt(e,t){Et().addColorLUT(e,t)}function Ft(e,t){const n=t||e.currentTarget,{viewport:i}=(0,J.getEnabledElement)(n),o=function(e){return[e.clientX,e.clientY]}(e),a=function(e){return[e.pageX,e.pageY]}(e),r=function(e,t){const n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,a);return{page:a,client:o,canvas:r,world:i.canvasToWorld(r)}}const Ht=function(e){const t=e.currentTarget,{viewportId:n,renderingEngineId:i}=(0,J.getEnabledElement)(t),o=Ft(e,t),a={event:e,eventName:Q.MOUSE_DOUBLE_CLICK,viewportId:n,renderingEngineId:i,camera:{},element:t,startPoints:o,lastPoints:o,currentPoints:o,deltaPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};!(0,J.triggerEvent)(t,Q.MOUSE_DOUBLE_CLICK,a)&&(e.stopImmediatePropagation(),e.preventDefault())},Bt=Q.MOUSE_MOVE,Gt=function(e){const t=e.currentTarget,n=(0,J.getEnabledElement)(t),{renderingEngineId:i,viewportId:o}=n,a={renderingEngineId:i,viewportId:o,camera:{},element:t,currentPoints:Ft(e),eventName:Bt,event:e};!(0,J.triggerEvent)(t,Bt,a)&&(e.stopImmediatePropagation(),e.preventDefault())},{MOUSE_DOWN:qt,MOUSE_DOWN_ACTIVATE:jt,MOUSE_CLICK:zt,MOUSE_UP:Kt,MOUSE_DRAG:Yt}=Q,Xt=3,Zt={mouseButton:void 0,element:null,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};let Jt={mouseButton:void 0,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,element:null,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};const $t={doubleClickTimeout:null,mouseDownEvent:null,mouseUpEvent:null,ignoreDoubleClick:!1};function Qt(e){const t=Ft(e,Jt.element),n=dn(Jt.element,Jt.lastPoints),i=cn(t,n);if($t.doubleClickTimeout){if(!nn(i.canvas))return;an()}const o={event:e,eventName:Yt,mouseButton:Jt.mouseButton,renderingEngineId:Jt.renderingEngineId,viewportId:Jt.viewportId,camera:{},element:Jt.element,startPoints:ln(Jt.startPoints),lastPoints:ln(n),currentPoints:t,deltaPoints:i};!(0,J.triggerEvent)(Jt.element,Yt,o)&&(e.stopImmediatePropagation(),e.preventDefault()),Jt.lastPoints=ln(t)}function en(e){if(clearTimeout(Jt.preventClickTimeout),$t.doubleClickTimeout)$t.mouseUpEvent?sn():($t.mouseUpEvent=e,Jt.element.addEventListener("mousemove",tn));else{const t=Jt.isClickEvent?zt:Kt,n=Ft(e,Jt.element),i=cn(n,Jt.lastPoints),o={event:e,eventName:t,mouseButton:Jt.mouseButton,element:Jt.element,renderingEngineId:Jt.renderingEngineId,viewportId:Jt.viewportId,camera:{},startPoints:ln(Jt.startPoints),lastPoints:ln(Jt.lastPoints),currentPoints:n,deltaPoints:i};(0,J.triggerEvent)(o.element,t,o),sn()}document.removeEventListener("mousemove",Qt)}function tn(e){nn(cn(Ft(e,Jt.element),dn(Jt.element,Jt.lastPoints)).canvas)&&(an(),Gt(e))}function nn(e){return Math.abs(e[0])+Math.abs(e[1])>Xt}function on(){Jt.isClickEvent=!1}function an(){$t.ignoreDoubleClick=!0;const e=$t.mouseDownEvent,t=$t.mouseUpEvent;rn(),function(e){const t=cn(Jt.startPoints,Jt.startPoints),n={event:e,eventName:qt,element:Jt.element,mouseButton:Jt.mouseButton,renderingEngineId:Jt.renderingEngineId,viewportId:Jt.viewportId,camera:{},startPoints:Jt.startPoints,lastPoints:Jt.startPoints,currentPoints:Jt.startPoints,deltaPoints:t};Jt.lastPoints=ln(n.lastPoints),(0,J.triggerEvent)(n.element,qt,n)&&(0,J.triggerEvent)(n.element,jt,n)}(e),t&&en(t)}function rn(){$t.doubleClickTimeout&&(clearTimeout($t.doubleClickTimeout),$t.doubleClickTimeout=null),$t.mouseDownEvent=null,$t.mouseUpEvent=null}function sn(){var e,t;document.removeEventListener("mouseup",en),null===(e=Jt.element)||void 0===e||e.removeEventListener("mousemove",tn),null===(t=Jt.element)||void 0===t||t.addEventListener("mousemove",Gt),rn(),Jt=JSON.parse(JSON.stringify(Zt))}function ln(e){return JSON.parse(JSON.stringify(e))}function dn(e,t){const{viewport:n}=(0,J.getEnabledElement)(e),i=n.canvasToWorld(t.canvas);return{page:t.page,client:t.client,canvas:t.canvas,world:i}}function cn(e,t){return{page:hn(e.page,t.page),client:hn(e.client,t.client),canvas:hn(e.canvas,t.canvas),world:(n=e.world,i=t.world,[n[0]-i[0],n[1]-i[1],n[2]-i[2]])};var n,i}function hn(e,t){return[e[0]-t[0],e[1]-t[1]]}function un(e){$t.ignoreDoubleClick?($t.ignoreDoubleClick=!1,e.stopImmediatePropagation(),e.preventDefault()):sn()}const gn=function(e){if($t.doubleClickTimeout){if(e.buttons===$t.mouseDownEvent.buttons)return;return $t.mouseDownEvent=e,void an()}$t.doubleClickTimeout=setTimeout(an,1===e.buttons?400:150),$t.mouseDownEvent=e,$t.ignoreDoubleClick=!1,Jt.element=e.currentTarget,Jt.mouseButton=e.buttons;const t=(0,J.getEnabledElement)(Jt.element),{renderingEngineId:n,viewportId:i}=t;Jt.renderingEngineId=n,Jt.viewportId=i,Jt.preventClickTimeout=setTimeout(on,Jt.clickDelay),Jt.element.removeEventListener("mousemove",Gt);const o=Ft(e,Jt.element);Jt.startPoints=ln(o),Jt.lastPoints=ln(o),document.addEventListener("mouseup",en),document.addEventListener("mousemove",Qt)};function vn(e){e.removeEventListener("dblclick",Ht),e.removeEventListener("mousedown",gn),e.removeEventListener("mousemove",Gt),e.removeEventListener("dblclick",un,{capture:!0})}const mn={enable:function(e){vn(e),e.addEventListener("dblclick",Ht),e.addEventListener("mousedown",gn),e.addEventListener("mousemove",Gt),e.addEventListener("dblclick",un,{capture:!0})},disable:vn},pn=function(e){const t=e.currentTarget,n=(0,J.getEnabledElement)(t),{renderingEngineId:i,viewportId:o}=n;if(e.deltaY>-1&&e.deltaY<1)return;e.preventDefault();const{spinX:a,spinY:r,pixelX:s,pixelY:l}=function(e){let t=0,n=0,i=0,o=0;return"detail"in e&&(n=e.detail),"wheelDelta"in e&&(n=-e.wheelDelta/120),"wheelDeltaY"in e&&(n=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),i=10*t,o=10*n,"deltaY"in e&&(o=e.deltaY),"deltaX"in e&&(i=e.deltaX),(i||o)&&e.deltaMode&&(1===e.deltaMode?(i*=40,o*=40):(i*=800,o*=800)),i&&!t&&(t=i<1?-1:1),o&&!n&&(n=o<1?-1:1),{spinX:t,spinY:n,pixelX:i,pixelY:o}}(e),d=r<0?-1:1,c={event:e,eventName:Q.MOUSE_WHEEL,renderingEngineId:i,viewportId:o,element:t,camera:{},detail:e,wheel:{spinX:a,spinY:r,pixelX:s,pixelY:l,direction:d},points:Ft(e)};(0,J.triggerEvent)(t,Q.MOUSE_WHEEL,c)};function fn(e){e.removeEventListener("wheel",pn)}const En={enable:function(e){fn(e),e.addEventListener("wheel",pn,{passive:!1})},disable:fn},wn=0,In=1;let Cn,_n;function Tn(e,t){const n=Date.now();if(e!==Cn){if(n-_n<=2e3)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1;Cn=e}_n=n}const bn=Tn.bind(null,wn),Dn=Tn.bind(null,In);function Sn(e,t,n){const i=n?bn:Dn;t.forEach((function(t){e.addEventListener(t,i,{passive:!1})}))}function yn(e,t,n){const i=n?bn:Dn;t.forEach((function(t){e.removeEventListener(t,i)}))}const On=["mousedown","mouseup","mousemove"],Mn=["touchstart","touchend"];function xn(e){yn(e,On,wn),yn(e,Mn,In)}const Nn={enable:function(e){xn(e),Sn(e,On,wn),Sn(e,Mn,In)},disable:xn};var kn=function(e){return e.UP="UP",e.DOWN="DOWN",e.LEFT="LEFT",e.RIGHT="RIGHT",e}(kn||{});function Rn(e,t){const n=t||e.currentTarget,i="touchend"===e.type?e.changedTouches:e.touches;return Object.keys(i).map((e=>{const t=function(e){return[e.clientX,e.clientY]}(i[e]),o=function(e){return[e.pageX,e.pageY]}(i[e]),a=function(e,t){const n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,o),{viewport:r}=(0,J.getEnabledElement)(n);return{page:o,client:t,canvas:a,world:r.canvasToWorld(a),touch:{identifier:e,radiusX:i[e].radiusX,radiusY:i[e].radiusY,force:i[e].force,rotationAngle:i[e].rotationAngle}}}))}function Pn(e,t){const n=Fn(e),i=Fn(t);return{page:Bn(n.page,i.page),client:Bn(n.client,i.client),canvas:Bn(n.canvas,i.canvas),world:(o=n.world,a=i.world,[o[0]-a[0],o[1]-a[1],o[2]-a[2]])};var o,a}function Ln(e,t){const n=Fn(e),i=Fn(t);return{page:qn(n.page,i.page),client:qn(n.client,i.client),canvas:qn(n.canvas,i.canvas),world:jn(n.world,i.world)}}function An(e,t){}function Un(e,t){const n=Gn(e),i=Gn(t);return{page:n.page-i.page,client:n.client-i.client,canvas:n.canvas-i.canvas,world:n.world-i.world}}function Vn(e){return JSON.parse(JSON.stringify(e))}function Wn(e){return JSON.parse(JSON.stringify(e))}function Fn(e){return e.reduce(((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length]})),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]})}function Hn(e){return e.reduce(((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length],touch:{identifier:null,radiusX:t.touch.radiusX+n.touch.radiusX/e.length,radiusY:t.touch.radiusY+n.touch.radiusY/e.length,force:t.touch.force+n.touch.force/e.length,rotationAngle:t.touch.rotationAngle+n.touch.rotationAngle/e.length}})),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0],touch:{identifier:null,radiusX:0,radiusY:0,force:0,rotationAngle:0}})}function Bn(e,t){return[e[0]-t[0],e[1]-t[1]]}function Gn(e){const t=[];for(let n=0;n<e.length;n++)for(let i=0;i<e.length;i++)n<i&&t.push({page:qn(e[n].page,e[i].page),client:qn(e[n].client,e[i].client),canvas:qn(e[n].canvas,e[i].canvas),world:jn(e[n].world,e[i].world)});return t.reduce(((e,n)=>({page:e.page+n.page/t.length,client:e.client+n.client/t.length,canvas:e.canvas+n.canvas/t.length,world:e.world+n.world/t.length})),{page:0,client:0,canvas:0,world:0})}function qn(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))}function jn(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}J.Settings.getRuntimeSettings();const{TOUCH_START:zn,TOUCH_START_ACTIVATE:Kn,TOUCH_PRESS:Yn,TOUCH_DRAG:Xn,TOUCH_END:Zn,TOUCH_TAP:Jn,TOUCH_SWIPE:$n}=Q,Qn={page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},ei={page:0,client:0,canvas:0,world:0},ti={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[{...Qn,touch:null}],lastPointsList:[{...Qn,touch:null}],isTouchStart:!1,startTime:null,pressTimeout:null,pressDelay:700,pressMaxDistance:5,accumulatedDistance:ei,swipeDistanceThreshold:48,swiped:!1,swipeToleranceMs:300},ni={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[{...Qn,touch:null}],taps:0,tapTimeout:null,tapMaxDistance:24,tapToleranceMs:300};let ii=JSON.parse(JSON.stringify(ti)),oi=JSON.parse(JSON.stringify(ni));function ai(e,t,n){return(0,J.triggerEvent)(e,t,n)}function ri(e){const t=Rn(e,ii.element),n=li(ii.element,ii.lastPointsList),i=t.length===n.length?Pn(t,n):Qn,o=t.length===n.length?Un(t,n):ei,a=t.length===n.length?Ln(t,ii.lastPointsList):ei;ii.accumulatedDistance={page:ii.accumulatedDistance.page+a.page,client:ii.accumulatedDistance.client+a.client,canvas:ii.accumulatedDistance.canvas+a.canvas,world:ii.accumulatedDistance.world+a.world};const r={event:e,eventName:Xn,renderingEngineId:ii.renderingEngineId,viewportId:ii.viewportId,camera:{},element:ii.element,startPoints:Hn(ii.startPointsList),lastPoints:Hn(n),currentPoints:Hn(t),startPointsList:Vn(ii.startPointsList),lastPointsList:Vn(n),currentPointsList:t,deltaPoints:i,deltaDistance:o};ai(ii.element,Xn,r),function(e,t){const n=(new Date).getTime(),i=ii.startTime.getTime();if(ii.swiped||n-i>ii.swipeToleranceMs)return;const[o,a]=t.canvas,r={event:e,eventName:$n,renderingEngineId:ii.renderingEngineId,viewportId:ii.viewportId,camera:{},element:ii.element,swipe:null};Math.abs(o)>ii.swipeDistanceThreshold&&(r.swipe=o>0?kn.RIGHT:kn.LEFT,ai(r.element,$n,r),ii.swiped=!0),Math.abs(a)>ii.swipeDistanceThreshold&&(r.swipe=a>0?kn.DOWN:kn.UP,ai(r.element,$n,r),ii.swiped=!0)}(e,i),ii.lastPointsList=Vn(t)}function si(e){clearTimeout(ii.pressTimeout);const t=Rn(e,ii.element),n=li(ii.element,ii.lastPointsList),i=t.length===n.length?Pn(t,n):Pn(t,t),o=t.length===n.length?Un(t,n):Un(t,t),a={event:e,eventName:Zn,element:ii.element,renderingEngineId:ii.renderingEngineId,viewportId:ii.viewportId,camera:{},startPointsList:Vn(ii.startPointsList),lastPointsList:Vn(n),currentPointsList:t,startPoints:Hn(ii.startPointsList),lastPoints:Hn(n),currentPoints:Hn(t),deltaPoints:i,deltaDistance:o};ai(a.element,Zn,a),function(e){if((new Date).getTime()-ii.startTime.getTime()>oi.tapToleranceMs)return;if(0===oi.taps&&(oi.element=ii.element,oi.renderingEngineId=ii.renderingEngineId,oi.viewportId=ii.viewportId,oi.startPointsList=ii.startPointsList),oi.taps>0&&(oi.element!=ii.element||oi.renderingEngineId!=ii.renderingEngineId||oi.viewportId!=ii.viewportId))return;const t=Rn(e,oi.element);Ln(t,oi.startPointsList).canvas>oi.tapMaxDistance||(clearTimeout(oi.tapTimeout),oi.taps+=1,oi.tapTimeout=setTimeout((()=>{const n={event:e,eventName:Jn,element:oi.element,renderingEngineId:oi.renderingEngineId,viewportId:oi.viewportId,camera:{},currentPointsList:t,currentPoints:Hn(t),taps:oi.taps};ai(n.element,Jn,n),oi=JSON.parse(JSON.stringify(ni))}),oi.tapToleranceMs))}(e),ii=JSON.parse(JSON.stringify(ti)),document.removeEventListener("touchmove",ri),document.removeEventListener("touchend",si)}function li(e,t){const{viewport:n}=(0,J.getEnabledElement)(e);return t.map((e=>{const t=n.canvasToWorld(e.canvas);return{page:e.page,client:e.client,canvas:e.canvas,world:t,touch:e.touch}}))}const di=function(e){ii.element=e.currentTarget;const t=(0,J.getEnabledElement)(ii.element),{renderingEngineId:n,viewportId:i}=t;ii.renderingEngineId=n,ii.viewportId=i,ii.isTouchStart||(clearTimeout(ii.pressTimeout),ii.pressTimeout=setTimeout((()=>function(e){if(ii.accumulatedDistance.canvas>ii.pressMaxDistance)return;const t={event:e,eventName:Yn,renderingEngineId:ii.renderingEngineId,viewportId:ii.viewportId,camera:{},element:ii.element,startPointsList:Vn(ii.startPointsList),lastPointsList:Vn(ii.lastPointsList),startPoints:Wn(Hn(ii.startPointsList)),lastPoints:Wn(Hn(ii.lastPointsList))};ai(t.element,Yn,t)}(e)),ii.pressDelay),function(e){ii.isTouchStart=!0,ii.startTime=new Date;const t=Rn(e,ii.element),n=Hn(t),i=Qn,o=ei,a={event:e,eventName:zn,element:ii.element,renderingEngineId:ii.renderingEngineId,viewportId:ii.viewportId,camera:{},startPointsList:t,lastPointsList:t,currentPointsList:t,startPoints:n,lastPoints:n,currentPoints:n,deltaPoints:i,deltaDistance:o};ii.startPointsList=Vn(a.startPointsList),ii.lastPointsList=Vn(a.lastPointsList),ai(a.element,zn,a)&&ai(a.element,Kn,a)}(e),document.addEventListener("touchmove",ri),document.addEventListener("touchend",si))};function ci(e){Nn.disable(e),e.removeEventListener("touchstart",di)}const hi={enable:function(e){ci(e),Nn.enable(e),e.addEventListener("touchstart",di,{passive:!1})},disable:ci},ui={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null};let gi={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null};function vi(e){gi.element=e.currentTarget;const t=(0,J.getEnabledElement)(gi.element),{renderingEngineId:n,viewportId:i}=t;gi.renderingEngineId=n,gi.viewportId=i,gi.key=e.key,gi.keyCode=e.keyCode,e.preventDefault();const o={renderingEngineId:gi.renderingEngineId,viewportId:gi.viewportId,element:gi.element,key:gi.key,keyCode:gi.keyCode};(0,J.triggerEvent)(o.element,Q.KEY_DOWN,o),document.addEventListener("keyup",pi),document.addEventListener("visibilitychange",mi),gi.element.removeEventListener("keydown",vi)}function mi(){document.removeEventListener("visibilitychange",mi),"hidden"===document.visibilityState&&fi()}function pi(e){const t={renderingEngineId:gi.renderingEngineId,viewportId:gi.viewportId,element:gi.element,key:gi.key,keyCode:gi.keyCode};document.removeEventListener("keyup",pi),document.removeEventListener("visibilitychange",mi),gi.element.addEventListener("keydown",vi),gi=ie()(ui),(0,J.triggerEvent)(t.element,Q.KEY_UP,t)}function fi(){gi.keyCode=void 0}const Ei=vi;function wi(e){e.removeEventListener("keydown",Ei)}const Ii={enable:function(e){wi(e),e.addEventListener("keydown",Ei)},disable:wi,getModifierKey:function(){return gi.keyCode}};function Ci(e,t){if(He.svgNodeCache[e])return He.svgNodeCache[e][t]?He.svgNodeCache[e][t].domRef:void 0}function _i(e,t,n,i){if(!He.svgNodeCache[t])return null;He.svgNodeCache[t][i]={touched:!0,domRef:n},e.appendChild(n)}function Ti(e,t){He.svgNodeCache[e]&&He.svgNodeCache[e][t]&&(He.svgNodeCache[e][t].touched=!0)}function bi(e,t){He.svgNodeCache[t]&&Object.keys(He.svgNodeCache[t]).forEach((n=>{const i=He.svgNodeCache[t][n];!i.touched&&i.domRef&&(e.removeChild(i.domRef),delete He.svgNodeCache[t][n])}))}const Di=function(e,t){const n=function(e){const t=(0,J.getEnabledElement)(e),{viewportId:n,renderingEngineId:i}=t,o="".concat(n,":").concat(i),a=function(e){const t=".".concat("viewport-element");return e.querySelector(t).querySelector(":scope > .svg-layer")}(e);return Object.keys(He.svgNodeCache[o]).forEach((e=>{He.svgNodeCache[o][e].touched=!1})),{svgLayerElement:a,svgNodeCacheForCanvas:He.svgNodeCache,getSvgNode:Ci.bind(this,o),appendNode:_i.bind(this,a,o),setNodeTouched:Ti.bind(this,o),clearUntouched:bi.bind(this,a,o)}}(e);t(n),n.clearUntouched()},Si=function(e,t){const n=He.toolGroups.filter((n=>n.viewportsInfo.some((n=>n.renderingEngineId===t&&(!n.viewportId||n.viewportId===e)))));if(n.length){if(n.length>1)throw new Error("Multiple tool groups found for renderingEngineId: ".concat(t," and viewportId: ").concat(e,". You should only\n      have one tool group per viewport in a renderingEngine."));return n[0]}};function yi(e,t){const n=(0,J.getEnabledElement)(e),{renderingEngineId:i,viewportId:o}=n,a=Si(o,i);if(!a)return[];const r=[],s=Object.keys(a.toolOptions);for(let e=0;e<s.length;e++){const n=s[e],i=a.toolOptions[n];if(i&&t.includes(i.mode)){const e=a.getToolInstance(n);r.push(e)}}return r}const{Active:Oi,Passive:Mi,Enabled:xi}=Ge,Ni=new class{constructor(){te(this,"hasBeenDestroyed",void 0),te(this,"_needsRender",new Set),te(this,"_animationFrameSet",!1),te(this,"_animationFrameHandle",null),te(this,"_viewportElements",void 0),te(this,"_renderFlaggedViewports",(()=>{this._throwIfDestroyed();const e=Array.from(this._viewportElements.values());for(let t=0;t<e.length;t++){const n=e[t];if(this._needsRender.has(n)&&(this._triggerRender(n),this._needsRender.delete(n),0===this._needsRender.size))return this._animationFrameSet=!1,void(this._animationFrameHandle=null)}})),this._viewportElements=new Map}addViewportElement(e,t){this._viewportElements.set(e,t)}removeViewportElement(e,t){this._viewportElements.delete(e),this._needsRender.delete(t),this._reset()}renderViewport(e){this._setViewportsToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setAllViewportsToBeRenderedNextFrame(){[...this._viewportElements.values()].forEach((e=>{this._needsRender.add(e)})),this._renderFlaggedViewports()}_setViewportsToBeRenderedNextFrame(e){const t=[...this._viewportElements.values()];e.forEach((e=>{-1!==t.indexOf(e)&&this._needsRender.add(e)})),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedViewports),this._animationFrameSet=!0)}_triggerRender(e){const t=(0,J.getEnabledElement)(e);if(!t)return void console.warn("Element has been disabled");if(!(0,J.getRenderingEngine)(t.renderingEngineId))return void console.warn("rendering Engine has been destroyed");const n=yi(e,[Oi,Mi,xi]),{renderingEngineId:i,viewportId:o}=t,a={element:e,renderingEngineId:i,viewportId:o};Di(e,(i=>{let o=!1;n.forEach((e=>{if(e.renderAnnotation){const n=e.renderAnnotation(t,i);o=o||n}})),o&&(0,J.triggerEvent)(e,Q.ANNOTATION_RENDERED,{...a})}))}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._setAllViewportsToBeRenderedNextFrame()}},ki=function(e){Ni.renderViewport(e)},Ri=function(e){ki(e.detail.element)},Pi={enable:function(e){e.addEventListener(J.Enums.Events.IMAGE_RENDERED,Ri)},disable:function(e){e.removeEventListener(J.Enums.Events.IMAGE_RENDERED,Ri)}};function Li(e,t,n){const{renderingEngineId:i,viewportId:o}=e.detail,a=Si(o,i);if(!a)return[];const r=[],s=Object.keys(a.toolOptions);for(let e=0;e<s.length;e++){const i=s[e],o=a.toolOptions[i],l=null!=n&&o.bindings.length&&o.bindings.some((e=>e.mouseButton===n));if(t.includes(o.mode)&&(!n||l)){const e=a.getToolInstance(i);r.push(e)}}return r}const{Active:Ai,Passive:Ui,Enabled:Vi}=Ge,Wi=function(e){Li(e,[Ai,Ui,Vi]).forEach((t=>{t.onCameraModified&&t.onCameraModified(e)}))},Fi={enable:function(e){e.addEventListener(J.Enums.Events.CAMERA_MODIFIED,Wi)},disable:function(e){e.removeEventListener(J.Enums.Events.CAMERA_MODIFIED,Wi)}},{Active:Hi,Passive:Bi,Enabled:Gi}=Ge,qi=function(e){Li(e,[Hi,Bi,Gi]).forEach((t=>{t.onImageSpacingCalibrated&&t.onImageSpacingCalibrated(e)}))},ji={enable:function(e){e.addEventListener(J.Enums.Events.IMAGE_SPACING_CALIBRATED,qi)},disable:function(e){e.removeEventListener(J.Enums.Events.IMAGE_SPACING_CALIBRATED,qi)}},{Active:zi}=Ge;function Ki(e,t,n){if(He.isInteractingWithTool)return!1;const{renderingEngineId:i,viewportId:o}=n.detail,a=Si(o,i);if(!a)return!1;let r;const s=Object.keys(a.toolOptions);for(let e=0;e<s.length;e++){const n=s[e],i=a.toolOptions[n],o=a.getToolInstance(n);if(i.mode===zi&&"function"==typeof o[t]){r=a.getToolInstance(n);break}}r&&r[t](n)}const Yi=Ki.bind(null,"Mouse","mouseClickCallback");function Xi(e,t,n){const i="touch"===(arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse")?36:6,o=[];return t.forEach((t=>{let{tool:a,annotations:r}=t;for(const t of r){if(t.isLocked||!t.isVisible)continue;const r=a.getHandleNearImagePoint(e,t,n,i);if(r){o.push({tool:a,annotation:t,handle:r});break}}})),o}function Zi(e,t){const n=[];for(let o=0;o<t.length;o++){var i;const a=t[o];if(!a){console.warn("undefined tool in filterToolsWithAnnotationsForElement");continue}let r=Ze(a.constructor.toolName,e);null!==(i=r)&&void 0!==i&&i.length&&("function"==typeof a.filterInteractableAnnotationsForElement&&(r=a.filterInteractableAnnotationsForElement(e,r)),r.length>0&&n.push({tool:a,annotations:r}))}return n}function Ji(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse";const o="touch"===i?36:6,a=[];return t.forEach((t=>{let{tool:r,annotations:s}=t;for(const t of s)if(!t.isLocked&&t.isVisible&&r.isPointNearTool(e,t,n,o,i)){a.push({tool:r,annotation:t});break}})),a}var $i=function(e){return e[e.Primary=1]="Primary",e[e.Secondary=2]="Secondary",e[e.Primary_And_Secondary=3]="Primary_And_Secondary",e[e.Auxiliary=4]="Auxiliary",e[e.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",e[e.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",e[e.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",e[e.Fourth_Button=8]="Fourth_Button",e[e.Fifth_Button=16]="Fifth_Button",e}($i||{}),Qi=function(e){return e[e.Shift=16]="Shift",e[e.Ctrl=17]="Ctrl",e[e.Alt=18]="Alt",e[e.Meta=91]="Meta",e[e.ShiftCtrl=1617]="ShiftCtrl",e[e.ShiftAlt=1618]="ShiftAlt",e[e.ShiftMeta=1691]="ShiftMeta",e[e.CtrlAlt=1718]="CtrlAlt",e[e.CtrlMeta=1791]="CtrlMeta",e[e.AltMeta=1891]="AltMeta",e}(Qi||{});const eo=e=>e.shiftKey?e.ctrlKey?Qi.ShiftCtrl:e.altKey?Qi.ShiftAlt:e.metaKey?Qi.ShiftMeta:Qi.Shift:e.ctrlKey?e.altKey?Qi.CtrlAlt:e.metaKey?Qi.CtrlMeta:Qi.Ctrl:e.altKey?e.metaKey&&Qi.AltMeta||Qi.Alt:e.metaKey?Qi.Meta:void 0,{Active:to}=Ge;function no(e){const{renderingEngineId:t,viewportId:n}=e.detail,i=e.detail.event,o=eo(i)||Ii.getModifierKey(),a=Si(n,t);if(!a)return null;const r=Object.keys(a.toolOptions),s=a.getDefaultMousePrimary();for(let e=0;e<r.length;e++){const t=r[e],n=a.toolOptions[t],l=n.bindings.length&&n.bindings.some((e=>e.mouseButton===(i?i.buttons:s)&&e.modifierKey===o));if(n.mode===to&&l)return a.getToolInstance(t)}}const{Active:io,Passive:oo}=Ge;const{Active:ao,Passive:ro}=Ge;function so(e){if(He.isInteractingWithTool)return;const t=no(e);if(t&&"function"==typeof t.preMouseDownCallback&&t.preMouseDownCallback(e))return;const n=1===e.detail.event.buttons,i=[...Li(e,[ao],e.detail.event.buttons)||[],...(n?Li(e,[ro]):void 0)||[]],o=e.detail,{element:a}=o,r=Zi(a,i),s=o.currentPoints.canvas,l=Xi(a,r,s,"mouse"),d=!!e.detail.event.shiftKey;if(l.length>0){const{tool:t,annotation:n,handle:i}=lo(l);return co(n.annotationUID,d),void t.handleSelectedCallback(e,n,i,"Mouse")}const c=Ji(a,r,s,"mouse");if(c.length>0){const{tool:t,annotation:n}=lo(c);return co(n.annotationUID,d),void t.toolSelectedCallback(e,n,"Mouse",s)}t&&"function"==typeof t.postMouseDownCallback&&t.postMouseDownCallback(e)||function(e){if(He.isInteractingWithTool)return!1;const t=e.detail,{element:n}=t,i=(0,J.getEnabledElement)(n),{canvas:o}=t.currentPoints;if(!i)return!1;const a=function(e,t){var n;const i=new Map,{renderingEngineId:o,viewportId:a}=e.detail,r=Si(a,o);if(!r)return i;const s=Object.keys(r.toolOptions),l=r.getDefaultMousePrimary(),d=e.detail.event,c=null!==(n=null==d?void 0:d.buttons)&&void 0!==n?n:l,h=eo(d)||Ii.getModifierKey();for(let e=0;e<s.length;e++){var u;const n=s[e],o=r.getToolInstance(n),a=null===(u=o.configuration)||void 0===u?void 0:u.actions;if(null==a||!a.length||!t.includes(o.mode))continue;const l=a.find((e=>e.bindings.length&&e.bindings.some((e=>e.mouseButton===c&&e.modifierKey===h))));l&&i.set(o,l)}return i}(e,[io,oo]),r=Ji(n,Zi(n,Array.from(a.keys())),o);if(r.length>0){const{tool:t,annotation:n}=r[0],i=a.get(t);return("string"==typeof i.method?t[i.method]:i.method).call(t,e,n),!0}}(e)}function lo(e){return e.length>1&&e.find((e=>!le(e.annotation)&&Me(e.annotation.annotationUID)))||e[0]}function co(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?Ce(e)?fe(e,!1):fe(e,!0,!0):fe(e,!0,!1)}function ho(e){if(He.isInteractingWithTool)return;const t=no(e);t&&!He.isMultiPartToolActive&&t.addNewAnnotation&&fe(t.addNewAnnotation(e,"mouse").annotationUID)}const uo=Ki.bind(null,"Mouse","doubleClickCallback");function go(e){if(He.isInteractingWithTool)return;const t=no(e);!t||"function"!=typeof t.mouseDragCallback||t.mouseDragCallback(e)}const{Active:vo,Passive:mo}=Ge;function po(e){if(He.isInteractingWithTool||He.isMultiPartToolActive)return;const t=Li(e,[vo,mo]),n=e.detail,{element:i}=n,o=Zi(i,t),a=t.filter((e=>!o.some((t=>t.tool.getToolName()===e.getToolName()))));let r=!1;for(const{tool:t,annotations:n}of o)"function"==typeof t.mouseMoveCallback&&(r=t.mouseMoveCallback(e,n)||r);a.forEach((t=>{"function"==typeof t.mouseMoveCallback&&t.mouseMoveCallback(e)})),!0===r&&ki(i)}const fo=Ki.bind(null,"Mouse","mouseUpCallback"),Eo=Ki.bind(null,"MouseWheel","mouseWheelCallback"),wo={enable:function(e){e.addEventListener(Q.MOUSE_CLICK,Yi),e.addEventListener(Q.MOUSE_DOWN,so),e.addEventListener(Q.MOUSE_DOWN_ACTIVATE,ho),e.addEventListener(Q.MOUSE_DOUBLE_CLICK,uo),e.addEventListener(Q.MOUSE_DRAG,go),e.addEventListener(Q.MOUSE_MOVE,po),e.addEventListener(Q.MOUSE_UP,fo),e.addEventListener(Q.MOUSE_WHEEL,Eo)},disable:function(e){e.removeEventListener(Q.MOUSE_CLICK,Yi),e.removeEventListener(Q.MOUSE_DOWN,so),e.removeEventListener(Q.MOUSE_DOWN_ACTIVATE,ho),e.removeEventListener(Q.MOUSE_DOUBLE_CLICK,uo),e.removeEventListener(Q.MOUSE_DRAG,go),e.removeEventListener(Q.MOUSE_MOVE,po),e.removeEventListener(Q.MOUSE_UP,fo),e.removeEventListener(Q.MOUSE_WHEEL,Eo)}},{Active:Io}=Ge;function Co(e){const{renderingEngineId:t,viewportId:n}=e.detail,i=Jt.mouseButton,o=Ii.getModifierKey(),a=Si(n,t);if(!a)return null;const r=Object.keys(a.toolOptions),s=a.getDefaultMousePrimary();for(let e=0;e<r.length;e++){const t=r[e],n=a.toolOptions[t],l=n.bindings.length&&n.bindings.some((e=>e.mouseButton===(null!=i?i:s)&&e.modifierKey===o));if(n.mode===Io&&l)return a.getToolInstance(t)}}function _o(e){const t=Co(e);if(!t)return;const{renderingEngineId:n,viewportId:i}=e.detail,o=Si(i,n),a=t.getToolName();Object.keys(o.toolOptions).includes(a)&&o.setViewportsCursorByToolName(a)}function To(e){const t=Co(e);if(!t)return;const{renderingEngineId:n,viewportId:i}=e.detail,o=Si(i,n);fi();const a=t.getToolName();Object.keys(o.toolOptions).includes(a)&&o.setViewportsCursorByToolName(a)}const bo={enable:function(e){e.addEventListener(Q.KEY_DOWN,_o),e.addEventListener(Q.KEY_UP,To)},disable:function(e){e.removeEventListener(Q.KEY_DOWN,_o),e.removeEventListener(Q.KEY_UP,To)}},{Active:Do}=Ge;function So(e){const{renderingEngineId:t,viewportId:n}=e.detail,i=e.detail.event,o=Si(n,t);if(!o)return null;const a=Object.keys(o.toolOptions),r=Object.keys(i.touches).length,s=eo(i)||Ii.getModifierKey(),l=o.getDefaultMousePrimary();for(let e=0;e<a.length;e++){const t=a[e],n=o.toolOptions[t],i=n.bindings.length&&n.bindings.some((e=>(e.numTouchPoints===r||1===r&&e.mouseButton===l)&&e.modifierKey===s));if(n.mode===Do&&i)return o.getToolInstance(t)}}function yo(e,t,n){const{renderingEngineId:i,viewportId:o}=e.detail,a=Si(o,i);if(!a)return[];const r=[],s=Object.keys(a.toolOptions);for(let e=0;e<s.length;e++){const i=s[e],o=a.toolOptions[i],l=null!=n&&o.bindings.length&&o.bindings.some((e=>e.numTouchPoints===n));if(t.includes(o.mode)&&(!n||l)){const e=a.getToolInstance(i);r.push(e)}}return r}const{Active:Oo,Passive:Mo}=Ge;function xo(e){if(He.isInteractingWithTool)return;const t=So(e);if(t&&"function"==typeof t.preTouchStartCallback&&t.preTouchStartCallback(e))return;const n=1===Object.keys(e.detail.event.touches).length,i=[...yo(e,[Oo],Object.keys(e.detail.event.touches).length)||[],...(n?yo(e,[Mo]):void 0)||[],t],o=e.detail,{element:a}=o,r=Zi(a,i),s=o.currentPoints.canvas,l=Xi(a,r,s,"touch");if(l.length>0){const{tool:t,annotation:n,handle:i}=No(l);return ko(n.annotationUID,!1),void t.handleSelectedCallback(e,n,i,"Touch")}const d=Ji(a,r,s,"touch");if(d.length>0){const{tool:t,annotation:n}=No(d);return ko(n.annotationUID,!1),void t.toolSelectedCallback(e,n,"Touch")}!t||"function"!=typeof t.postTouchStartCallback||t.postTouchStartCallback(e)}function No(e){return e.length>1&&e.find((e=>!le(e.annotation)&&Me(e.annotation.annotationUID)))||e[0]}function ko(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?Ce(e)?fe(e,!1):fe(e,!0,!0):fe(e,!0,!1)}function Ro(e){if(He.isInteractingWithTool)return;const t=So(e);t&&!He.isMultiPartToolActive&&t.addNewAnnotation&&fe(t.addNewAnnotation(e,"touch").annotationUID)}function Po(e){if(He.isInteractingWithTool)return;const t=So(e);!t||"function"!=typeof t.touchDragCallback||t.touchDragCallback(e)}const Lo=Ki.bind(null,"Touch","touchEndCallback"),Ao=Ki.bind(null,"Touch","touchTapCallback"),Uo=Ki.bind(null,"Touch","touchPressCallback"),Vo={enable:function(e){e.addEventListener(Q.TOUCH_START,xo),e.addEventListener(Q.TOUCH_START_ACTIVATE,Ro),e.addEventListener(Q.TOUCH_DRAG,Po),e.addEventListener(Q.TOUCH_END,Lo),e.addEventListener(Q.TOUCH_TAP,Ao),e.addEventListener(Q.TOUCH_PRESS,Uo)},disable:function(e){e.removeEventListener(Q.TOUCH_START,xo),e.removeEventListener(Q.TOUCH_START_ACTIVATE,Ro),e.removeEventListener(Q.TOUCH_DRAG,Po),e.removeEventListener(Q.TOUCH_END,Lo),e.removeEventListener(Q.TOUCH_PRESS,Uo)}};function Wo(e){const{element:t,viewportId:n}=e.detail,i=function(e){const t="http://www.w3.org/2000/svg",n=document.createElementNS(t,"svg"),i="svg-layer-".concat(e);n.classList.add("svg-layer"),n.setAttribute("id",i),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",n.style.position="absolute";const o=document.createElementNS(t,"defs"),a=document.createElementNS(t,"filter"),r=document.createElementNS(t,"feOffset"),s=document.createElementNS(t,"feColorMatrix"),l=document.createElementNS(t,"feBlend");return a.setAttribute("id","shadow-".concat(i)),a.setAttribute("filterUnits","userSpaceOnUse"),r.setAttribute("result","offOut"),r.setAttribute("in","SourceGraphic"),r.setAttribute("dx","0.5"),r.setAttribute("dy","0.5"),s.setAttribute("result","matrixOut"),s.setAttribute("in","offOut"),s.setAttribute("in2","matrix"),s.setAttribute("values","0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"),l.setAttribute("in","SourceGraphic"),l.setAttribute("in2","matrixOut"),l.setAttribute("mode","normal"),a.appendChild(r),a.appendChild(s),a.appendChild(l),o.appendChild(a),n.appendChild(o),n}(n);var o;!function(e){const{viewportUid:t,renderingEngineUid:n}=e.dataset,i="".concat(t,":").concat(n);He.svgNodeCache[i]={}}(t),o=i,t.querySelector("div.viewport-element").appendChild(o),Ni.addViewportElement(n,t),mn.enable(t),En.enable(t),hi.enable(t),Ii.enable(t),Pi.enable(t),Fi.enable(t),ji.enable(t),wo.enable(t),bo.enable(t),Vo.enable(t),He.enabledElements.push(t)}const Fo=function(e,t){const n=[];if(!t&&!e)throw new Error("At least one of renderingEngineId or viewportId should be given");for(let i=0;i<He.synchronizers.length;i++){const o=He.synchronizers[i],a=!o.isDisabled(),r=o.hasSourceViewport(t,e),s=o.hasTargetViewport(t,e);a&&(r||s)&&n.push(o)}return n},Ho=function(e){const{element:t,viewportId:n}=e.detail;!function(e){const{viewportUid:t,renderingEngineUid:n}=e.dataset,i="".concat(t,":").concat(n);delete He.svgNodeCache[i]}(t),function(e){const t=e.querySelector("div.".concat("viewport-element")),n=t.querySelector("svg");n&&t.removeChild(n)}(t),Ni.removeViewportElement(n,t),mn.disable(t),En.disable(t),hi.disable(t),Ii.disable(t),Pi.disable(t),Fi.disable(t),ji.disable(t),wo.disable(t),bo.disable(t),Vo.disable(t),(e=>{const t=(0,J.getEnabledElement)(e);Fo(t.viewportId,t.renderingEngineId).forEach((e=>{e.remove(t)}))})(t),(e=>{const{renderingEngineId:t,viewportId:n}=(0,J.getEnabledElement)(e),i=Si(n,t);i&&i.removeViewports(t,n)})(t),function(e){const t=He.enabledElements.findIndex((t=>t===e));t>-1&&He.enabledElements.splice(t,1)}(t)},Bo=function(e,t){t.length&&t.forEach((t=>{const{element:n}=e.getViewport(t);ki(n)}))},Go=function(e){const{viewportId:t,renderingEngineId:n}=e.detail,i=(0,J.getRenderingEngine)(n);Bo(i,[t])},qo=function(e){e.detail.removed.length&&(0,J.getRenderingEngines)().forEach((e=>{const t=e.getViewports().map((e=>e.id));Bo(e,t)}))},jo=function(e){const{segmentationId:t}=e.detail;bt(t).forEach((e=>{_t(e).forEach((n=>{n.segmentationId===t&&vt(e,n.segmentationRepresentationUID)}))}))},zo=function(e){return He.toolGroups.find((t=>t.id===e))};function Ko(){return kt()}function Yo(e){Rt(e)}function Xo(e){return Ko().representations[e]}function Zo(e,t){const n=Ko();Yo({...n,representations:{...n.representations,[e]:{...n.representations[e],...t}}})}function Jo(e){return Dt(e)}function $o(e,t){St(e,t)}function Qo(e,t){return Ot(e,t)}function ea(e,t,n){yt(e,t,n)}function ta(e,t,n){return Mt(e,t,n)}function na(e,t,n){xt(e,t,n)}function ia(e,t,n){const i=_t(e);if(!i)return;const o=i.find((e=>e.segmentationRepresentationUID===t));if(!o)return;const{segmentsHidden:a,segmentationId:r}=o,s=function(e){const t=wt(e);if(t.type===ot.Labelmap){const t=J.cache.getVolume(e).getScalarData(),n={};for(let e=0;e<t.length;e++){const i=t[e];0===i||n[i]||(n[i]=!0)}return Object.keys(n).map((e=>parseInt(e,10)))}if(t.type===ot.Contour){var n;const i=null===(n=t.representationData.CONTOUR)||void 0===n?void 0:n.geometryIds;if(!i)throw new Error("No geometryIds found for segmentationId ".concat(e));return i.map((e=>J.cache.getGeometry(e).data.getSegmentIndex()))}}(r);n?a.clear():s.forEach((e=>{a.add(e)})),vt(e,o.segmentationRepresentationUID)}function oa(e,t){const n=_t(e).find((e=>e.segmentationRepresentationUID===t));if(!n)return;const{segmentsHidden:i}=n;return 0===i.size}function aa(e,t,n,i){const o=Pt(e,t);o&&(n.forEach((e=>{i?o.segmentsHidden.delete(e):o.segmentsHidden.add(e)})),vt(e,t))}function ra(e,t,n,i){const o=Pt(e,t);o&&(i?o.segmentsHidden.delete(n):o.segmentsHidden.add(n),vt(e,t))}class sa{constructor(e,t){te(this,"supportedInteractionTypes",void 0),te(this,"configuration",void 0),te(this,"toolGroupId",void 0),te(this,"mode",void 0);const n=J.utilities.deepMerge(t,e),{configuration:i={},supportedInteractionTypes:o,toolGroupId:a}=n;i.strategies||(i.strategies={},i.defaultStrategy=void 0,i.activeStrategy=void 0,i.strategyOptions={}),this.toolGroupId=a,this.supportedInteractionTypes=o||[],this.configuration=Object.assign({},i),this.mode=Ge.Disabled}getToolName(){return this.constructor.toolName}applyActiveStrategy(e,t){const{strategies:n,activeStrategy:i}=this.configuration;return n[i].call(this,e,t)}setConfiguration(e){this.configuration=J.utilities.deepMerge(this.configuration,e)}setActiveStrategy(e){this.setConfiguration({activeStrategy:e})}getTargetVolumeId(e){var t;if(this.configuration.volumeId)return this.configuration.volumeId;const n=e.getActors();return n?null===(t=n.find((e=>"vtkVolume"===e.actor.getClassName())))||void 0===t?void 0:t.uid:void 0}getTargetIdImage(e,t){if(e.startsWith("imageId:")){const n=e.split("imageId:")[1],i=J.utilities.imageIdToURI(n);let o=J.utilities.getViewportsWithImageURI(i,t.id);if(!o||!o.length)return;if(o=o.filter((e=>e.getCurrentImageId()===n)),!o||!o.length)return;return o[0].getImageData()}if(e.startsWith("volumeId:")){const n=e.split("volumeId:")[1],i=J.utilities.getViewportsWithVolumeId(n,t.id);if(!i||!i.length)return;return i[0].getImageData()}if(e.startsWith("videoId:")){const n=J.utilities.imageIdToURI(e),i=J.utilities.getViewportsWithImageURI(n,t.id);if(!i||!i.length)return;return i[0].getImageData()}throw new Error('getTargetIdImage: targetId must start with "imageId:" or "volumeId:"')}getTargetId(e){if(e instanceof J.StackViewport)return"imageId:".concat(e.getCurrentImageId());if(e instanceof J.BaseVolumeViewport)return"volumeId:".concat(this.getTargetVolumeId(e));if(e instanceof J.VideoViewport)return"videoId:".concat(e.getCurrentImageId());throw new Error("getTargetId: viewport must be a StackViewport or VolumeViewport")}}te(sa,"toolName",void 0),sa.toolName="BaseTool";const la=sa,da=function(e,t){const n=(0,J.getEnabledElement)(e),{viewport:i}=n,o=i.getActors().map((e=>{let{uid:n}=e;return n.startsWith(t)?n:void 0})).filter(Boolean);i.removeActors(o)};var ca=I(610),ha=I.n(ca),ua=I(474),ga=I.n(ua),va=I(448),ma=I.n(va),pa=I(70),fa=I.n(pa),Ea=I(396),wa=I.n(Ea);function Ia(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;return parseFloat(e[0]).toFixed(t)+","+parseFloat(e[1]).toFixed(t)+","+parseFloat(e[2]).toFixed(t)+","}const Ca=new Map;function _a(e){const{actorEntry:t,vtkPlanes:n,viewport:i}=e.detail;if(null==t||!t.clippingFilter)return;const o=t.actor.getMapper(),{viewPlaneNormal:a}=i.getCamera(),r=i.getCurrentImageIdIndex(),s="".concat(i.id,"-").concat(Ia(a),"-").concat(r);let l=Ca.get(t.uid);l||(l=new Map,Ca.set(t.uid,l));let d=l.get(s);if(!d){const e=t.clippingFilter;e.setClippingPlanes(n);try{e.update(),d=e.getOutputData(),l.set(s,d)}catch(e){console.error("Error clipping surface",e)}}o.setInputData(d)}const Ta={render:async function(e,t,n){const{colorLUTIndex:i,active:o,segmentationId:a,segmentationRepresentationUID:r,segmentsHidden:s}=t,l=wt(a).representationData[ot.Surface],{geometryId:d}=l;d||console.warn("No Surfaces found for segmentationId ".concat(a,". Skipping render."));const c=J.cache.getGeometry(d);if(!c)throw new Error("No Surfaces found for geometryId ".concat(d));if(c.type!==J.Enums.GeometryType.SURFACE)throw new Error("Geometry type ".concat(c.type," not supported for rendering."));if(!c.data)return void console.warn("No Surfaces found for geometryId ".concat(d,". Skipping render."));const h=c.data;!function(e,t,n){const i=n;if(e.getActor(i))throw new Error("Not implemented yet. (Update surface)");!function(e,t,n){const i=(0,J.getEnabledElement)(e),{viewport:o}=i,a=t.getPoints(),r=t.getPolys(),s=t.getColor(),l=fa().newInstance();l.getPoints().setData(a,3);const d=wa().newInstance({values:Float32Array.from(r)});l.setPolys(d);const c=ha().newInstance({});let h;if(o instanceof J.VolumeViewport3D)c.setInputData(l);else{h=ma().newInstance({clippingPlanes:[],activePlaneId:2,passPointData:!1}),h.setInputData(l),h.setGenerateOutline(!0),h.setGenerateFaces(!1),h.update();const e=h.getOutputData();c.setInputData(e)}const u=ga().newInstance();u.setMapper(c),u.getProperty().setColor(s[0]/255,s[1]/255,s[2]/255),o.addActor({actor:u,uid:n,clippingFilter:h}),e.addEventListener(J.Enums.Events.CLIPPING_PLANES_UPDATED,_a)}(e.element,t,i)}(e,h,"".concat(r,"_").concat(h.id,"}")),e.resetCamera(),e.render()},addSegmentationRepresentation:async function(e,t,n){const{segmentationId:i}=t,o=J.utilities.uuidv4(),a=new Set,r={segmentationId:i,segmentationRepresentationUID:o,type:ot.Surface,segmentsHidden:a,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{}};if(n){const t=Jo(e),i=J.utilities.deepMerge(t,n);$o(e,{renderInactiveSegmentations:i.renderInactiveSegmentations||!0,representations:{...i.representations}})}return Nt(e,r),o},removeSegmentationRepresentation:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];(function(e,t){const n=zo(e);if(void 0===n)throw new Error("ToolGroup with ToolGroupId ".concat(e," does not exist"));const{viewportsInfo:i}=n;for(const e of i){const{viewportId:n,renderingEngineId:i}=e,o=(0,J.getEnabledElementByIds)(n,i);da(o.viewport.element,t)}})(e,t),At(e,t),n&&zo(e).getViewportsInfo().forEach((e=>{let{viewportId:t,renderingEngineId:n}=e;(0,J.getEnabledElementByIds)(t,n).viewport.render()}))}};var ba=I(785),Da=I.n(ba),Sa=I(127),ya=I.n(Sa),Oa=I(348),Ma=I.n(Oa);function xa(e,t,n){var i;let o=null===(i=e.segmentSpecificConfig)||void 0===i?void 0:i[t];var a;return o||(o=null===(a=e.segmentSpecificConfig)||void 0===a?void 0:a[n]),o?o.CONTOUR:null}const Na=new Map;function ka(e){return Na.get(e)}function Ra(e,t){Na.set(e,t)}function Pa(e,t,n,i,o){const{segmentationRepresentationUID:a,segmentsHidden:r}=n,s=ya().newInstance(),l=new Map,d=new Map;t.forEach((e=>{const t=J.cache.getGeometry(e);if(!t)return void console.warn("No geometry found for geometryId ".concat(e,". Skipping render."));const i=t.data.getSegmentIndex();!function(e){if(!e)throw new Error("No contours found for geometryId ".concat(e.id));const t=e.id;if(e.type!==J.Enums.GeometryType.CONTOUR)throw new Error("Geometry type ".concat(e.type," not supported for rendering."));e.data||console.warn("No contours found for geometryId ".concat(t,". Skipping render."))}(t);const o=xa(n,e,i),a=t.data,c=function(e){const t=[],n=Ma().newInstance(),i=wa().newInstance();let o=0;e.getContours().forEach((e=>{const n=e.getPoints(),a=e.getFlatPointsArray(),r=e.getType(),s=n.map(((e,t)=>t+o));r===J.Enums.ContourType.CLOSED_PLANAR&&s.push(s[0]);const l=Float32Array.from(a);t.push(...l),i.insertNextCell([...s]),o+=n.length})),n.setData(t,3);const a=fa().newInstance();return a.setPoints(n),a.setLines(i),a}(a),h=a.getColor(),u=c.getPoints().getNumberOfPoints(),g=Da().newInstance({size:4*u,numberOfComponents:4,dataType:"Uint8Array"});for(let e=0;e<u;++e)g.setTuple(e,[...h,255]);c.getPointData().setScalars(g),o&&d.set(i,o),l.set(i,[...h,r.has(i)?0:255]),0===i?s.setInputData(c):s.addInputData(c)}));const c=s.getOutputData(),h=i.representations.CONTOUR.outlineWidthActive,u=ha().newInstance();u.setInputData(c);const g=ga().newInstance();g.setMapper(u),g.getProperty().setLineWidth(h),Ra(a,Object.assign({},ka(a),{segmentsHidden:new Set(r),segmentSpecificMap:d,outlineWidthActive:h})),g.setForceOpaque(!0),e.addActor({uid:o,actor:g}),e.resetCamera(),e.render()}function La(e,t,n,i,o){const{segmentationRepresentationUID:a,segmentsHidden:r}=n,s=i.representations.CONTOUR,l=ka(a),d=e.getActor(o);if(!d)return void console.warn("No contour actor found for actorUID ".concat(o,". Skipping render."));const{actor:c}=d,h=s.outlineWidthActive;(null==l?void 0:l.outlineWidthActive)!==h&&(c.getProperty().setLineWidth(h),Ra(a,Object.assign({},l,{outlineWidthActive:h})));const u=c.getMapper(),g=u.getLookupTable(),v=[],m=[];for(const e of r)l.segmentsHidden.has(e)||v.push(e);for(const e of l.segmentsHidden)r.has(e)||m.push(e);const p=Array.from(l.segmentsHidden).filter((e=>!m.includes(e))).concat(v),{contourSets:f,segmentSpecificConfigs:E}=t.reduce(((e,t)=>{const i=J.cache.getGeometry(t),{data:o}=i,a=o.getSegmentIndex(),r=xa(n,t,a);return e.contourSets.push(o),e.segmentSpecificConfigs[a]=null!=r?r:{},e}),{contourSets:[],segmentSpecificConfigs:{}}),w=[...p,...m],I=Object.values(E).some((e=>Object.keys(e).length>0));let C=!1;if(w.length||I){const e=u.getInputData(),t=e.getPointData().getScalars().getData();let n=0;f.forEach((e=>{var i;const o=e.getSegmentIndex(),a=e.getTotalNumberOfPoints();if(w.includes(o)||null!==(i=E[o])&&void 0!==i&&i.fillAlpha){const i=e.getColor();let r=p.includes(o)?0:255;const s=E[o];void 0!==s.fillAlpha&&(r=255*s.fillAlpha);for(let e=0;e<a;++e)t[n+4*e]=i[0],t[n+4*e+1]=i[1],t[n+4*e+2]=i[2],t[n+4*e+3]=r;C=!0}n+=4*a})),C&&e.modified(),Ra(a,Object.assign({},l,{segmentsHidden:new Set(r)})),u.setLookupTable(g)}e.render()}const Aa=function(e,t){const n=(0,J.getEnabledElement)(e),{viewport:i}=n,o=i.getActors().map((e=>{let{uid:n}=e;return n.includes(t)?n:void 0})).filter(Boolean);i.removeActors(o)},Ua={render:async function(e,t,n){const{segmentationId:i}=t,o=wt(i).representationData[ot.Contour],{geometryIds:a}=o;e instanceof J.StackViewport||(null!=a&&a.length||console.warn("No contours found for segmentationId ".concat(i,". Skipping render.")),function(e,t,n,i){const{segmentationRepresentationUID:o}=n,a="CONTOUR_".concat(o);(e.getActor(a)?La:Pa)(e,t,n,i,a)}(e,a,t,n))},addSegmentationRepresentation:async function(e,t,n){const{segmentationId:i}=t,o=J.utilities.uuidv4(),a=new Set,r={segmentationId:i,segmentationRepresentationUID:o,type:ot.Contour,segmentsHidden:a,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{}};if(n){const t=Jo(e),i=J.utilities.deepMerge(t,n);$o(e,{renderInactiveSegmentations:i.renderInactiveSegmentations||!0,representations:{...i.representations}})}return Nt(e,r),o},removeSegmentationRepresentation:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];(function(e,t){const n=zo(e);if(void 0===n)throw new Error("ToolGroup with ToolGroupId ".concat(e," does not exist"));const{viewportsInfo:i}=n;for(const e of i){const{viewportId:n,renderingEngineId:i}=e,o=(0,J.getEnabledElementByIds)(n,i);Aa(o.viewport.element,t)}})(e,t),At(e,t),function(e){Na.delete(e)}(t),n&&zo(e).getViewportsInfo().forEach((e=>{let{viewportId:t,renderingEngineId:n}=e;(0,J.getEnabledElementByIds)(t,n).viewport.render()}))}};var Va=I(441),Wa=I.n(Va),Fa=I(795),Ha=I.n(Fa);const Ba=function(e,t){const n=(0,J.getEnabledElement)(e),{viewport:i}=n;i instanceof J.StackViewport||i.removeVolumeActors([t])},Ga=new Map;function qa(e,t,n,i){const o={...e,...t,...i||{}};return{fillAlpha:n?o.fillAlpha:o.fillAlphaInactive,outlineWidth:n?o.outlineWidthActive:o.outlineWidthInactive,renderFill:n?o.renderFill:o.renderFillInactive,renderOutline:o.renderOutline,outlineOpacity:n?o.outlineOpacity:o.outlineOpacityInactive}}function ja(e,t,n,i){let{fillAlpha:o,renderFill:a,renderOutline:r,segmentColor:s,outlineWidth:l,segmentsHidden:d}=i;const c="".concat(e,"-").concat(t,"-").concat(n),h=Ga.get(c);if(!h)return Ga.set(c,{fillAlpha:o,renderFill:a,renderOutline:r,outlineWidth:l,segmentColor:s.slice(),segmentsHidden:new Set(d)}),{forceOpacityUpdate:!0,forceColorUpdate:!0};const{fillAlpha:u,renderFill:g,renderOutline:v,outlineWidth:m,segmentColor:p,segmentsHidden:f}=h,E=p[0]!==s[0]||p[1]!==s[1]||p[2]!==s[2],w=p[3]!==s[3]||u!==o||g!==a||v!==r||m!==l||f.has(n)!==d.has(n);return Ga.set(c,{fillAlpha:o,renderFill:a,renderOutline:r,outlineWidth:l,segmentColor:s.slice(),segmentsHidden:new Set(d)}),{forceOpacityUpdate:w,forceColorUpdate:E}}const za={render:async function(e,t,n){const{colorLUTIndex:i,active:o,segmentationId:a,segmentationRepresentationUID:r,segmentsHidden:s,config:l}=t,d=wt(a).representationData[ot.Labelmap],{volumeId:c}=d;if(!J.cache.getVolume(c))throw new Error("No Labelmap found for volumeId: ".concat(c));if(!function(e,t){if(!t)return!0;const n=e.getDefaultActor();if(!n)return!1;const{uid:i}=n,o=J.cache.getVolume(i);if(o){const e=J.cache.getVolume(t);if(e&&o.metadata.FrameOfReferenceUID===e.metadata.FrameOfReferenceUID)return!0}return!1}(e,null==d?void 0:d.referencedVolumeId))return;let h=e.getActor(r);if(!h){const t=wt(a),{volumeId:n}=t.representationData[ot.Labelmap];await async function(e,t,n){await async function(e,t,n){const i=(0,J.getEnabledElement)(e),{renderingEngine:o,viewport:a}=i,{id:r}=a,s=[{volumeId:t,actorUID:n,visibility:!0,blendMode:J.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND}];await(0,J.addVolumesToViewports)(o,s,[r],!1,!0)}(e.element,t,n)}(e,n,r),h=e.getActor(r)}if(!h)return;const{cfun:u,ofun:g}=l,v=n.renderInactiveSegmentations;!function(e,t,n,i,o,a,r,s,l,d){const{segmentSpecificConfig:c,segmentationRepresentationSpecificConfig:h}=r,u=h[ot.Labelmap],g=Vt(o),v=Math.min(256,g.length),m=t.actor,{uid:p}=t,{outlineWidth:f,renderOutline:E,outlineOpacity:w}=qa(a,u,s);for(let t=0;t<v;t++){var I;const o=t,r=g[o],l=null===(I=c[o])||void 0===I?void 0:I[ot.Labelmap],{fillAlpha:h,outlineWidth:v,renderFill:m,renderOutline:f}=qa(a,u,s,l),{forceOpacityUpdate:E,forceColorUpdate:w}=ja(e,p,o,{fillAlpha:h,renderFill:m,renderOutline:f,segmentColor:r,outlineWidth:v,segmentsHidden:d});if(w&&n.addRGBPoint(o,r[0]/255,r[1]/255,r[2]/255),E)if(m){const e=d.has(o)?0:r[3]/255*h;i.removePoint(o),i.addPointLong(o,e,.5,1)}else i.addPointLong(o,.01,.5,1)}m.getProperty().setRGBTransferFunction(0,n),i.setClamping(!1),m.getProperty().setScalarOpacity(0,i),m.getProperty().setInterpolationTypeToNearest(),m.getProperty().setUseLabelOutline(E),m.getProperty().setLabelOutlineOpacity(w),m.getProperty().setLabelOutlineThickness(f);const C=s||l;m.setVisibility(C)}(e.id,h,u,g,i,n.representations[ot.Labelmap],t,o,v,s)},addSegmentationRepresentation:async function(e,t,n){const{segmentationId:i}=t,o=J.utilities.uuidv4(),a=new Set,r=Ha().newInstance(),s=Wa().newInstance();s.addPoint(0,0);const l={segmentationId:i,segmentationRepresentationUID:o,type:ot.Labelmap,segmentsHidden:a,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{cfun:r,ofun:s}};if(n){const t=Jo(e),i=J.utilities.deepMerge(t,n);$o(e,{renderInactiveSegmentations:i.renderInactiveSegmentations||!0,representations:{...i.representations}})}return Nt(e,l),o},removeSegmentationRepresentation:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];(function(e,t){const n=zo(e);if(void 0===n)throw new Error("ToolGroup with ToolGroupId ".concat(e," does not exist"));const{viewportsInfo:i}=n;for(const e of i){const{viewportId:n,renderingEngineId:i}=e,o=(0,J.getEnabledElementByIds)(n,i);Ba(o.viewport.element,t)}})(e,t),At(e,t),n&&zo(e).getViewportsInfo().forEach((e=>{let{viewportId:t,renderingEngineId:n}=e;(0,J.getEnabledElementByIds)(t,n).viewport.render()}))}};class Ka extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{}}),te(this,"renderSegmentation",(e=>{const t=zo(e);if(!t)return;const n=_t(e);if(!n||0===n.length)return;const i=t.viewportsInfo.map((e=>{let{renderingEngineId:t,viewportId:n}=e;const i=(0,J.getEnabledElementByIds)(n,t);if(i)return i.viewport})),o=n.map((t=>{const n=this._getMergedRepresentationsConfig(e),o=[],a={[ot.Labelmap]:za,[ot.Contour]:Ua,[ot.Surface]:Ta}[t.type];for(const e of i){const i=a.render(e,t,n);o.push(i)}return o}));Promise.allSettled(o).then((()=>{i.forEach((e=>{e.render()}))}))}))}onSetToolEnabled(){const e=this.toolGroupId,t=_t(e);t&&0!==t.length&&t.forEach((t=>{ia(e,t.segmentationRepresentationUID,!0)}))}onSetToolDisabled(){const e=this.toolGroupId,t=_t(e);t&&0!==t.length&&t.forEach((t=>{ia(e,t.segmentationRepresentationUID,!1)}))}_getMergedRepresentationsConfig(e){const t=Jo(e),n=Ko();return J.utilities.deepMerge(n,t)}}te(Ka,"toolName",void 0),Ka.toolName="SegmentationDisplay";const Ya=Ka,Xa=new class{constructor(){te(this,"_needsRender",new Set),te(this,"_animationFrameSet",!1),te(this,"_animationFrameHandle",null),te(this,"hasBeenDestroyed",void 0),te(this,"_renderFlaggedToolGroups",(()=>{this._throwIfDestroyed();const e=Array.from(this._needsRender.values());for(const t of e)if(this._triggerRender(t),this._needsRender.delete(t),0===this._needsRender.size)return this._animationFrameSet=!1,void(this._animationFrameHandle=null)}))}removeToolGroup(e){this._needsRender.delete(e),0===this._needsRender.size&&this._reset()}renderToolGroupSegmentations(e){this._setToolGroupSegmentationToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setToolGroupSegmentationToBeRenderedNextFrame(e){e.forEach((e=>{this._needsRender.add(e)})),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedToolGroups),this._animationFrameSet=!0)}_triggerRender(e){const t=zo(e);if(!t)return void console.warn("No tool group found with toolGroupId: ".concat(e));const{viewportsInfo:n}=t,i=[];n.forEach((e=>{let{viewportId:t,renderingEngineId:n}=e;const o=(0,J.getRenderingEngine)(n);o?i.push(o.getViewport(t)):console.warn("rendering Engine has been destroyed")}));const o=t.getToolInstance(Ya.toolName);function a(e){const{element:t,viewportId:n,renderingEngineId:i}=e.detail;t.removeEventListener(J.Enums.Events.IMAGE_RENDERED,a);const o=Si(n,i);if(!o)return void console.warn("toolGroup has been destroyed");const r={toolGroupId:o.id,viewportId:n};(0,J.triggerEvent)(J.eventTarget,Q.SEGMENTATION_RENDERED,{...r})}o?(i.forEach((e=>{let{element:t}=e;t.addEventListener(J.Enums.Events.IMAGE_RENDERED,a)})),o.renderSegmentation(e)):console.warn("No segmentation tool found inside",e)}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null}};function Za(e){Xa.renderToolGroupSegmentations(e)}const Ja=Za,$a=function(e){const{segmentationId:t,modifiedSlicesToUse:n}=e.detail,{representationData:i,type:o}=wt(t);let a;if(o!==ot.Labelmap)throw new Error("onSegmentationDataModified: representationType ".concat(o," not supported yet"));{const e=J.cache.getVolume(i[o].volumeId);if(!e)return void console.warn("segmentation not found in cache");const{imageData:r,vtkOpenGLTexture:s}=e;let l;if(n&&Array.isArray(n))l=n;else{const e=r.getDimensions()[2];l=[...Array(e).keys()]}l.forEach((e=>{s.setUpdatedFrame(e)})),r.modified(),a=bt(t)}a.forEach((e=>{Ja(e)}))},Qa=function(e){const{toolGroupId:t}=e.detail;Ja(t)},er=function(e){const{toolGroupId:t,segmentationRepresentationUID:n}=e.detail;Ja(t)},tr=function(e,t,n){const i=_t(e);if(!i||0===i.length)return;const o=i.map((e=>e.segmentationRepresentationUID));let a=t;if(a){const e=t.filter((e=>!o.includes(e)));if(e.length>0)throw new Error("The following segmentationRepresentationUIDs are not part of the toolGroup: ".concat(JSON.stringify(e)))}else a=o;a.forEach((t=>{!function(e,t,n){const i=Pt(e,t),{type:o}=i;if(o===ot.Labelmap)za.removeSegmentationRepresentation(e,t,n);else{if(o!==ot.Contour)throw new Error("The representation ".concat(o," is not supported yet"));Ua.removeSegmentationRepresentation(e,t,n)}}(e,t,n)}))},nr=function(e){const t=He.toolGroups.findIndex((t=>t.id===e));t>-1&&(Xa.removeToolGroup(e),tr(e),He.toolGroups.splice(t,1))},ir=function(){const e=[...He.toolGroups];for(const t of e)nr(t.id);He.toolGroups=[]};let or=!1;function ar(){or||(function(){sr();const e=J.Enums.Events.ELEMENT_ENABLED,t=J.Enums.Events.ELEMENT_DISABLED;J.eventTarget.addEventListener(e,Wo),J.eventTarget.addEventListener(t,Ho)}(),lr(),J.eventTarget.addEventListener(Q.ANNOTATION_MODIFIED,Go),J.eventTarget.addEventListener(Q.ANNOTATION_SELECTION_CHANGE,qo),J.eventTarget.addEventListener(Q.ANNOTATION_SELECTION_CHANGE,qo),J.eventTarget.addEventListener(Q.SEGMENTATION_MODIFIED,jo),J.eventTarget.addEventListener(Q.SEGMENTATION_DATA_MODIFIED,$a),J.eventTarget.addEventListener(Q.SEGMENTATION_REPRESENTATION_MODIFIED,Qa),J.eventTarget.addEventListener(Q.SEGMENTATION_REPRESENTATION_REMOVED,er),or=!0)}function rr(){sr(),lr(),ir(),We={},He=ie()(Fe);const e=Ke(),t=Et();e.restoreAnnotations({}),t.resetState(),or=!1}function sr(){const e=J.Enums.Events.ELEMENT_ENABLED,t=J.Enums.Events.ELEMENT_DISABLED;J.eventTarget.removeEventListener(e,Wo),J.eventTarget.removeEventListener(t,Ho)}function lr(){J.eventTarget.removeEventListener(Q.ANNOTATION_MODIFIED,Go),J.eventTarget.removeEventListener(Q.ANNOTATION_SELECTION_CHANGE,qo),J.eventTarget.removeEventListener(Q.ANNOTATION_SELECTION_CHANGE,qo),J.eventTarget.removeEventListener(Q.SEGMENTATION_MODIFIED,jo),J.eventTarget.removeEventListener(Q.SEGMENTATION_DATA_MODIFIED,$a),J.eventTarget.removeEventListener(Q.SEGMENTATION_REPRESENTATION_MODIFIED,Qa),J.eventTarget.removeEventListener(Q.SEGMENTATION_REPRESENTATION_REMOVED,er)}function dr(e){const t=e.toolName,n=void 0!==He.tools[t];if(!t)throw new Error("No Tool Found for the ToolClass ".concat(e.name));if(n)throw new Error("".concat(t," has already been added globally"));He.tools[t]={toolClass:e}}function cr(e){const t=e.toolName;if(!t)throw new Error("No tool found for: ".concat(e.name));if(void 0===!He.tools[t])throw new Error("".concat(t," cannot be removed because it has not been added"));delete He.tools[t]}function hr(e){const t=Zi(e,yi(e,[Ge.Active,Ge.Passive]));for(const{tool:n}of t){const t=n.cancel(e);if(t)return t}}function ur(e,t){return e.findIndex((e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId))}function gr(e,t){return e.some((e=>e.renderingEngineId===t.renderingEngineId&&e.viewportId===t.viewportId))}const vr=class{constructor(e,t,n,i){te(this,"_enabled",void 0),te(this,"_eventName",void 0),te(this,"_eventHandler",void 0),te(this,"_ignoreFiredEvents",void 0),te(this,"_sourceViewports",void 0),te(this,"_targetViewports",void 0),te(this,"_viewportOptions",{}),te(this,"_options",void 0),te(this,"id",void 0),te(this,"_onEvent",(e=>{if(!0===this._ignoreFiredEvents)return;if(!this._targetViewports.length)return;const t=(0,J.getEnabledElement)(e.currentTarget);if(!t)return;const{renderingEngineId:n,viewportId:i}=t;this._sourceViewports.find((e=>e.viewportId===i))&&this.fireEvent({renderingEngineId:n,viewportId:i},e)})),this._enabled=!0,this._eventName=t,this._eventHandler=n,this._ignoreFiredEvents=!1,this._sourceViewports=[],this._targetViewports=[],this._options=i||{},this.id=e}isDisabled(){return!this._enabled||!this._hasSourceElements()}setOptions(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._viewportOptions[e]=t}getOptions(e){return this._viewportOptions[e]}add(e){this.addTarget(e),this.addSource(e)}addSource(e){if(gr(this._sourceViewports,e))return;const{renderingEngineId:t,viewportId:n}=e,{element:i}=(0,J.getRenderingEngine)(t).getViewport(n);i.addEventListener(this._eventName,this._onEvent.bind(this)),this._updateDisableHandlers(),this._sourceViewports.push(e)}addTarget(e){gr(this._targetViewports,e)||(this._targetViewports.push(e),this._updateDisableHandlers())}getSourceViewports(){return this._sourceViewports}getTargetViewports(){return this._targetViewports}destroy(){this._sourceViewports.forEach((e=>this.removeSource(e))),this._targetViewports.forEach((e=>this.removeTarget(e)))}remove(e){this.removeTarget(e),this.removeSource(e)}removeSource(e){const t=ur(this._sourceViewports,e);if(-1===t)return;const n=function(e){const t=(0,J.getRenderingEngine)(e.renderingEngineId);if(!t)throw new Error("No RenderingEngine for Id: ".concat(e.renderingEngineId));return t.getViewport(e.viewportId).element}(e);this._sourceViewports.splice(t,1),n.removeEventListener(this._eventName,this._eventHandler),this._updateDisableHandlers()}removeTarget(e){const t=ur(this._targetViewports,e);-1!==t&&(this._targetViewports.splice(t,1),this._updateDisableHandlers())}hasSourceViewport(e,t){return gr(this._sourceViewports,{renderingEngineId:e,viewportId:t})}hasTargetViewport(e,t){return gr(this._targetViewports,{renderingEngineId:e,viewportId:t})}fireEvent(e,t){if(this.isDisabled()||this._ignoreFiredEvents)return;this._ignoreFiredEvents=!0;const n=[];try{for(let i=0;i<this._targetViewports.length;i++){const o=this._targetViewports[i];if(e.viewportId===o.viewportId)continue;const a=this._eventHandler(this,e,o,t,this._options);a instanceof Promise&&n.push(a)}}catch(e){console.warn("Synchronizer, for: ".concat(this._eventName),e)}finally{n.length?Promise.allSettled(n).then((()=>{this._ignoreFiredEvents=!1})):this._ignoreFiredEvents=!1}}_hasSourceElements(){return 0!==this._sourceViewports.length}_updateDisableHandlers(){const e=function(e,t){const n=[],i=e.concat(t);for(let e=0;e<i.length;e++){const t=i[e];n.some((e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId))||n.push(t)}return n}(this._sourceViewports,this._targetViewports),t=this.remove,n=e=>{t(e.detail.element)};e.forEach((function(e){const t=(0,J.getRenderingEngine)(e.renderingEngineId).getViewport(e.viewportId);if(!t)return;const{element:i}=t;i.removeEventListener(J.Enums.Events.ELEMENT_DISABLED,n),i.addEventListener(J.Enums.Events.ELEMENT_DISABLED,n)}))}},mr=function(e,t,n,i){if(He.synchronizers.some((t=>t.id===e)))throw new Error("Synchronizer with id '".concat(e,"' already exists."));const o=new vr(e,t,n,i);return He.synchronizers.push(o),o},pr=function(){for(;He.synchronizers.length>0;)He.synchronizers.pop().destroy()},fr=function(e){return He.synchronizers.find((t=>t.id===e))},Er=function(){return He.synchronizers},wr=function(e){const t=He.synchronizers.findIndex((t=>t.id===e));t>-1&&(He.synchronizers[t].destroy(),He.synchronizers.splice(t,1))};var Ir=I(485),Cr=I.n(Ir);const _r=Symbol("DefinedCursors"),Tr=new Set(["alias","all-scroll","auto","cell","col-resize","context-menu","copy","crosshair","default","e-resize","ew-resize","grab","grabbing","help","move","ne-resize","nesw-resize","no-drop","none","not-allowed","n-resize","ns-resize","nw-resize","nwse-resize","pointer","progress","row-resize","se-resize","s-resize","sw-resize","text","vertical-text","wait","w-resize","zoom-in","zoom-out"]);class br{constructor(e,t){te(this,"name",void 0),te(this,"fallback",void 0),this.name=e+"",this.fallback=t}getName(){return this.name+""}addFallbackStyleProperty(e){const{fallback:t}=this;return t instanceof br?"".concat(e,", ").concat(t.getStyleProperty()):e+""}getStyleProperty(){return this.addFallbackStyleProperty(this.name)+""}static getDefinedCursor(e){const t=Dr(br,_r);let n=t.get(e);return n instanceof br?n:Tr.has(e)?(n=new br(e),t.set(e,n),n):void 0}static setDefinedCursor(e,t){return t instanceof br&&(Dr(br,_r).set(e,t),!0)}}function Dr(e,t){let n=e[t];return n instanceof Map||(n=new Map,Object.defineProperty(e,t,{value:n})),n}const Sr=Tr.values();var yr=function(e){return e.Default="",e.Highlighted="Highlighted",e.Selected="Selected",e.Locked="Locked",e}(yr||{});const Or=yr;class Mr extends br{constructor(e,t,n,i,o){super(i||Mr.getUniqueInstanceName("image-cursor"),o),te(this,"url",void 0),te(this,"x",void 0),te(this,"y",void 0),this.url=e,this.x=Number(t)||0,this.y=Number(n)||0}getStyleProperty(){const{url:e,x:t,y:n}=this;let i="url('".concat(e,"')");return t>=0&&n>=0&&(t>0||n>0)&&(i+=" ".concat(t," ").concat(n)),this.addFallbackStyleProperty(i)}static getUniqueInstanceName(e){return"".concat(e,"-").concat(J.utilities.getRuntimeId(Mr))}}const xr={iconContent:"",iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:'\n    <path stroke="{{color}}" d="M8 16L8 0"></path>\n    <path stroke="{{color}}" d="M16 8L0 8"></path>\n  '},Nr={x:127,y:60},kr='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n',Rr='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n<rect fill="{{color}}" x="95.84" y="9.38" width="15.85" height="47.14"/>\n',Pr='<path fill="{{color}}" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',Lr='<path fill="{{color}}" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',Ar='<path fill="{{color}}" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',Ur={Angle:Vr(xr,{iconContent:'<path fill="{{color}}" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50\n    50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23\n    10l50 50q10 10 10 23z" />',viewBox:{x:1792,y:1792}}),ArrowAnnotate:Vr(xr,{iconContent:'<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />\n  </g>',viewBox:{x:24,y:24}}),Bidirectional:Vr(xr,{iconContent:'<g fill="{{color}}" stroke-width="3" stroke="{{color}}">\n    <path d="M27.63 3.21L3.12 28.81"></path>\n    <path d="M27.63 15.75L15.27 4.43"></path>\n    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>\n    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>\n    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>\n    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>\n  </g>',viewBox:{x:48,y:48}}),CobbAngle:Vr(xr,{iconContent:'<g stroke="{{color}}" stroke-width="3">\n    <path d="M28.59 2.34L3.82 12.32"></path>\n    <path d="M28.59 29.66L3.82 19.68"></path>\n    <path stroke-dasharray="2" fill-opacity="0" d="M12.37\n      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15\n      9.33C13.11 9.24 13.02 9 12.88 8.63">\n    </path>\n  </g>',viewBox:{x:32,y:32}}),CircleROI:Vr(xr,{iconContent:'<circle stroke="{{color}}" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',viewBox:{x:32,y:32}}),EllipticalROI:Vr(xr,{iconContent:'<path stroke="{{color}}" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16\n    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14\n    6.3 30.74 10.54 30.74 15.76Z" />',viewBox:{x:32,y:32}}),FreehandROI:Vr(xr,{iconContent:'<g fill="{{color}}" stroke="{{color}}" stroke-width="2">\n    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>\n    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>\n    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>\n    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>\n    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>\n    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>\n    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>\n    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>\n    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>\n    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>\n    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>\n    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>\n    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>\n    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>\n    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>\n    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>\n    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>\n    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>\n    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>\n    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>\n    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>\n    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>\n    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>\n    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>\n    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>\n    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>\n    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>\n    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>\n    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>\n    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>\n  </g>',viewBox:{x:18,y:18}}),FreehandROISculptor:Vr(xr,{iconContent:'<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>\n    <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>\n    <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>\n    <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>\n    <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>\n    <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>\n    <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>\n    <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>\n    <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>\n    <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>\n    <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>\n    <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>\n    <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>\n    <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>\n    <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>\n    <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>\n    <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>\n    <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>\n    <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>\n    <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>\n    <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>\n    <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>\n    <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>\n    <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>\n    <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>\n    <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>\n    <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>\n    <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>\n    <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>\n    <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>\n    <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>\n    <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>\n  </g>',viewBox:{x:18,y:18}}),Length:Vr(xr,{iconContent:'<g id="length-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />\n  </g>',viewBox:{x:24,y:24}}),Probe:Vr(xr,{iconContent:'<path fill="{{color}}" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75\n    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73\n    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5\n    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5\n    385.5-103 385.5 103 279.5 279.5 103 385.5z" />',viewBox:{x:1792,y:1792}}),RectangleROI:Vr(xr,{iconContent:'<path fill="{{color}}" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47\n    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0\n    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119\n    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),TextMarker:Vr(xr,{iconContent:'<path fill="{{color}}" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0\n    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29\n    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15\n    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5\n    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0\n    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11\n    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0\n    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58\n    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z" />',viewBox:{x:1792,y:1792}}),Crosshairs:Vr(xr,{iconContent:'<path fill="{{color}}" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26\n    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45\n    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26\n    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5\n    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32\n    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5\n    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26\n    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26\n    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161\n    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161\n    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z" />',viewBox:{x:1792,y:1792}}),Eraser:Vr(xr,{iconContent:'<path transform="translate(0,1792) scale(1,-1)" fill="{{color}}" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15\n    34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38\n    0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38\n    0 69.5 20.5t47.5 54.5z" />',viewBox:{x:2048,y:1792}}),Magnify:Vr(xr,{iconContent:'<path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />',viewBox:{x:512,y:512}}),Pan:Vr(xr,{iconContent:'<path fill="{{color}}" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17\n    39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355\n    355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59\n    39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12\n    0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144\n    144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19\n    45v448q0 42-39 59-13 5-25 5-26 0-45-19z" />',viewBox:{x:1792,y:1792}}),Rotate:Vr(xr,{iconContent:'<path fill="{{color}}" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39\n    14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5\n    163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0\n    225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109\n    132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298\n    164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14\n    39 17 39 59z" />',viewBox:{x:1792,y:1792}}),StackScroll:Vr(xr,{iconContent:'<path fill="{{color}}" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0\n    0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547\n    0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z" />',viewBox:{x:24,y:28}}),WindowLevelRegion:Vr(xr,{iconContent:'<path fill="{{color}}" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119\n    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5\n    84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),WindowLevel:Vr(xr,{iconContent:'\n    <path fill="{{color}}" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />\n    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="{{color}}" />',viewBox:{x:18,y:18}}),Zoom:Vr(xr,{iconContent:'\n  <path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />\n  <path fill="{{color}}" transform="scale(0.22,0.22) translate(1400,0)" d="M1216\n    320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19\n    19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26\n    0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z" />',viewBox:{x:640,y:512}}),SegmentationFreeHandEraseInside:Vr(xr,{iconContent:"".concat(Pr," ").concat(kr),viewBox:Nr}),SegmentationFreeHandFillInside:Vr(xr,{iconContent:"".concat(Pr," ").concat(Rr),viewBox:Nr}),SegmentationFreeHandEraseOutside:Vr(xr,{iconContent:"".concat(Pr," ").concat(kr),viewBox:Nr}),SegmentationFreeHandFillOutside:Vr(xr,{iconContent:"".concat(Pr," ").concat(Rr),viewBox:Nr}),SegmentationRectangleEraseInside:Vr(xr,{iconContent:"".concat(Lr," ").concat(kr),viewBox:Nr}),RectangleScissor:Vr(xr,{iconContent:"".concat(Lr," ").concat(Rr),viewBox:Nr}),"RectangleScissor.FILL_INSIDE":Vr(xr,{iconContent:"".concat(Lr," ").concat(Rr),viewBox:Nr}),"RectangleScissor.FILL_OUTSIDE":Vr(xr,{iconContent:"".concat(Lr," ").concat(Rr),viewBox:Nr}),"RectangleScissor.ERASE_OUTSIDE":Vr(xr,{iconContent:"".concat(Lr," ").concat(kr),viewBox:Nr}),"RectangleScissor.ERASE_INSIDE":Vr(xr,{iconContent:"".concat(Lr," ").concat(kr),viewBox:Nr}),CircleScissor:Vr(xr,{iconContent:"".concat(Ar," ").concat(Rr),viewBox:Nr}),"CircleScissor.FILL_INSIDE":Vr(xr,{iconContent:"".concat(Ar," ").concat(Rr),viewBox:Nr}),"CircleScissor.ERASE_OUTSIDE":Vr(xr,{iconContent:"".concat(Ar," ").concat(kr),viewBox:Nr}),"CircleScissor.FILL_OUTSIDE":Vr(xr,{iconContent:"".concat(Ar," ").concat(Rr),viewBox:Nr})};function Vr(e,t){return Object.assign(Object.create(e),t)}function Wr(e,t,n){Ur[e]=Vr(xr,{iconContent:t,viewBox:n})}const Fr=Object.keys(Ur),Hr=new class{constructor(){te(this,"config",void 0),this._initializeConfig({color:"rgb(255, 255, 0)",colorHighlighted:"rgb(0, 255, 0)",colorSelected:"rgb(0, 220, 0)",colorLocked:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"",shadow:!0,textBoxVisibility:!0,textBoxFontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",textBoxFontSize:"14px",textBoxColor:"rgb(255, 255, 0)",textBoxColorHighlighted:"rgb(0, 255, 0)",textBoxColorSelected:"rgb(0, 255, 0)",textBoxColorLocked:"rgb(255, 255, 0)",textBoxBackground:"",textBoxLinkLineWidth:"1",textBoxLinkLineDash:"2,3",textBoxShadow:!0})}getAnnotationToolStyles(e){return this.config.annotations&&this.config.annotations[e]}getViewportToolStyles(e){return this.config.viewports&&this.config.viewports[e]}getToolGroupToolStyles(e){return this.config.toolGroups&&this.config.toolGroups[e]}getDefaultToolStyles(){return this.config.default}setAnnotationStyles(e,t){let n=this.config.annotations;n||(this.config={...this.config,annotations:{}},n=this.config.annotations),n[e]=t}setViewportToolStyles(e,t){let n=this.config.viewports;n||(this.config={...this.config,viewports:{}},n=this.config.viewports),n[e]=t}setToolGroupToolStyles(e,t){let n=this.config.toolGroups;n||(this.config={...this.config,toolGroups:{}},n=this.config.toolGroups),n[e]=t}setDefaultToolStyles(e){this.config.default=e}getStyleProperty(e,t){const{annotationUID:n,viewportId:i,toolGroupId:o,toolName:a}=t;return this._getToolStyle(e,n,i,o,a)}_getToolStyle(e,t,n,i,o){if(t){const n=this.getAnnotationToolStyles(t);if(n&&void 0!==n[e])return n[e]}if(n){const t=this.getViewportToolStyles(n);if(t){if(t[o]&&void 0!==t[o][e])return t[o][e];if(t.global&&void 0!==t.global[e])return t.global[e]}}if(i){const t=this.getToolGroupToolStyles(i);if(t){if(t[o]&&void 0!==t[o][e])return t[o][e];if(t.global&&void 0!==t.global[e])return t.global[e]}}const a=this.getDefaultToolStyles();return a[o]&&void 0!==a[o][e]?a[o][e]:a.global&&void 0!==a.global[e]?a.global[e]:void 0}_initializeConfig(e){const t={};for(const n in e)t[n]=e[n];this.config={default:{global:t}}}};function Br(e,t,n,i){const o=function(e,t,n){const i=["".concat(e)];return t&&i.push("".concat(i[0]).concat(t)),n&&i.push("".concat(i[i.length-1]).concat(n)),i}(e,n,i);for(let e=o.length-1;e>=0;--e){const n=Hr.getStyleProperty(o[e],t);if(void 0!==n)return n}}const Gr=Or.Highlighted,qr=Ge.Active;class jr extends Mr{constructor(e,t,n,i,o){super(e,t,n,i,o)}static getDefinedCursor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;n||(n=Br("color",{},Gr,qr));const i=function(e,t,n){return"".concat(t?"pointer":"cursor",":").concat(e,"/").concat(n)}(e,t,n);let o=super.getDefinedCursor(i);if(!o){const a=function(e){return Ur[e]}(e);a&&(o=function(e,t,n,i,o){const{x:a,y:r}=e.mousePoint;return new jr(function(e,t,n){return URL.createObjectURL(function(e,t,n){const i=(t?Yr:Kr)(e,n);return new Blob([i],{type:"image/svg+xml"})}(e,t,n))}(e,n,{color:i}),a,r,t,o)}(a,i,t,n,super.getDefinedCursor("default")),super.setDefinedCursor(i,o))}return o}}function zr(e,t){const n=Object(t),i=Object.prototype.hasOwnProperty.bind(n);return(e+"").replace(/\{\{(\w+)\}\}/g,((e,t)=>i(t)?n[t]+"":""))}function Kr(e,t){const{iconContent:n,iconSize:i,viewBox:o}=e;return zr('\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="'.concat(i,'" height="').concat(i,'" viewBox="0 0\n      ').concat(o.x," ").concat(o.y,'">\n      ').concat(n,"\n    </svg>"),t)}function Yr(e,t){const{iconContent:n,iconSize:i,viewBox:o,mousePointerGroupString:a}=e,r=i/Math.max(o.x,o.y,1),s=16+i;return zr('\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="'.concat(s,'" height="').concat(s,'" viewBox="0 0 ').concat(s," ").concat(s,'">\n      <g>').concat(a,'</g>\n      <g transform="translate(16, 16) scale(').concat(r,')">').concat(n,"</g>\n    </svg>"),t)}const Xr=Symbol("ElementCursorsMap");function Zr(e,t){es(e)[0]=t,Jr(e,t)}function Jr(e,t){const n=es(e);n[1]=n[0],n[0]=t,e.style.cursor=(t instanceof br?t:br.getDefinedCursor("auto")).getStyleProperty()}function $r(e){Jr(e,es(e)[1])}function Qr(e){Jr(e,br.getDefinedCursor("none"))}function es(e){let t=es[Xr];t instanceof WeakMap||(t=new WeakMap,Object.defineProperty(es,Xr,{value:t}));let n=t.get(e);return n||(n=[null,null],t.set(e,n)),n}const{Active:ts,Passive:ns,Enabled:is,Disabled:os}=Ge;class as{constructor(e){te(this,"id",void 0),te(this,"viewportsInfo",[]),te(this,"toolOptions",{}),te(this,"restoreToolOptions",{}),te(this,"_toolInstances",{}),this.id=e}getViewportIds(){return this.viewportsInfo.map((e=>{let{viewportId:t}=e;return t}))}getViewportsInfo(){return this.viewportsInfo.slice()}getToolInstance(e){const t=this._toolInstances[e];if(t)return t;console.warn("'".concat(e,"' is not registered with this toolGroup (").concat(this.id,")."))}addTool(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=He.tools[e],i=void 0!==e&&""!==e,o=this.toolOptions[e];if(!i)return void console.warn("Tool with configuration did not produce a toolName: ",t);if(!n)return void console.warn("'".concat(e,"' is not registered with the library. You need to use cornerstoneTools.addTool to register it."));if(o)return void console.warn("'".concat(e,"' is already registered for ToolGroup ").concat(this.id,"."));const{toolClass:a}=n,r=new a({name:e,toolGroupId:this.id,configuration:t});this._toolInstances[e]=r}addToolInstance(e,t){var n;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=null===(n=He.tools[e])||void 0===n?void 0:n.toolClass;if(!o){const n=He.tools[t].toolClass;class i extends n{}i.toolName=e,o=i,He.tools[e]={toolClass:i}}this.addTool(o.toolName,i)}addViewport(e,t){const n=(0,J.getRenderingEngines)();if(!t&&n.length>1)throw new Error("You must specify a renderingEngineId when there are multiple rendering engines.");const i=t||n[0].id;this.viewportsInfo.some((t=>{let{viewportId:n}=t;return n===e}))||this.viewportsInfo.push({viewportId:e,renderingEngineId:i});const o=this.getActivePrimaryMouseButtonTool();J.Settings.getRuntimeSettings().get("useCursors")&&this.setViewportsCursorByToolName(o)}removeViewports(e,t){const n=[];if(this.viewportsInfo.forEach(((i,o)=>{let a=!1;i.renderingEngineId===e&&(a=!0,t&&i.viewportId!==t&&(a=!1)),a&&n.push(o)})),n.length)for(let e=n.length-1;e>=0;e--)this.viewportsInfo.splice(n[e],1)}setActiveStrategy(e,t){const n=this._toolInstances[e];void 0!==n?n.setActiveStrategy(t):console.warn("Tool ".concat(e," not added to toolGroup, can't set tool configuration."))}setToolMode(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e?t!==Ge.Active?t!==Ge.Passive?t!==Ge.Enabled?t!==Ge.Disabled?console.warn("setToolMode: mode must be defined"):this.setToolDisabled(e):this.setToolEnabled(e):this.setToolPassive(e):this.setToolActive(e,n||this.restoreToolOptions[e]):console.warn("setToolMode: toolName must be defined")}setToolActive(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=this._toolInstances[e];if(void 0===n)return void console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."));if(!n)return void console.warn("'".concat(e,"' instance ").concat(n," is not registered with this toolGroup, can't set tool mode."));const i={bindings:[...this.toolOptions[e]?this.toolOptions[e].bindings:[],...t.bindings?t.bindings:[]].reduce(((e,t)=>{const n=void 0!==t.numTouchPoints,i=void 0!==t.mouseButton;return e.some((e=>{return i=t,(n=e).mouseButton===i.mouseButton&&n.modifierKey===i.modifierKey;var n,i}))||!n&&!i||e.push(t),e}),[]),mode:ts};this.toolOptions[e]=i,this._toolInstances[e].mode=ts;const o=J.Settings.getRuntimeSettings().get("useCursors");if(this._hasMousePrimaryButtonBinding(t)&&o)this.setViewportsCursorByToolName(e);else if(!this.getActivePrimaryMouseButtonTool()&&o){const e=br.getDefinedCursor("default");this._setCursorForViewports(e)}"function"==typeof n.onSetToolActive&&n.onSetToolActive(),this._renderViewports();const a={toolGroupId:this.id,toolName:e,toolBindingsOptions:t};(0,J.triggerEvent)(J.eventTarget,Q.TOOL_ACTIVATED,a),this._triggerToolModeChangedEvent(e,ts,t)}setToolPassive(e){const t=this._toolInstances[e];if(void 0===t)return void console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."));const n=this.getToolOptions(e),i=Object.assign({bindings:n?n.bindings:[]},n,{mode:ns}),o=this.getDefaultMousePrimary();i.bindings=i.bindings.filter((e=>e.mouseButton!==o||e.modifierKey));let a=ns;0!==i.bindings.length&&(a=ts,i.mode=a),this.toolOptions[e]=i,t.mode=a,"function"==typeof t.onSetToolPassive&&t.onSetToolPassive(),this._renderViewports(),this._triggerToolModeChangedEvent(e,ns)}setToolEnabled(e){const t=this._toolInstances[e];if(void 0===t)return void console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."));const n={bindings:[],mode:is};this.toolOptions[e]=n,t.mode=is,"function"==typeof t.onSetToolEnabled&&t.onSetToolEnabled(),this._renderViewports(),this._triggerToolModeChangedEvent(e,is)}setToolDisabled(e){const t=this._toolInstances[e];if(void 0===t)return void console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."));const n={bindings:[],mode:os};this.restoreToolOptions[e]=this.toolOptions[e],this.toolOptions[e]=n,t.mode=os,"function"==typeof t.onSetToolDisabled&&t.onSetToolDisabled(),this._renderViewports(),this._triggerToolModeChangedEvent(e,os)}getToolOptions(e){const t=this.toolOptions[e];if(void 0!==t)return t}getActivePrimaryMouseButtonTool(){return Object.keys(this.toolOptions).find((e=>{const t=this.toolOptions[e];return t.mode===ts&&this._hasMousePrimaryButtonBinding(t)}))}setViewportsCursorByToolName(e,t){const n=this._getCursor(e,t);this._setCursorForViewports(n)}_getCursor(e,t){let n,i;return t&&(n="".concat(e,".").concat(t),i=jr.getDefinedCursor(n,!0),i)?i:(n="".concat(e),i=jr.getDefinedCursor(n,!0),i||(n=e,i=jr.getDefinedCursor(n,!0),i||br.getDefinedCursor("default")))}_setCursorForViewports(e){this.viewportsInfo.forEach((t=>{let{renderingEngineId:n,viewportId:i}=t;const o=(0,J.getEnabledElementByIds)(i,n);if(!o)return;const{viewport:a}=o;Zr(a.element,e)}))}setToolConfiguration(e,t,n){if(void 0===this._toolInstances[e])return console.warn("Tool ".concat(e," not present, can't set tool configuration.")),!1;let i;return i=n?t:Object.assign(this._toolInstances[e].configuration,t),this._toolInstances[e].configuration=i,this._renderViewports(),!0}getDefaultMousePrimary(){return $i.Primary}getToolConfiguration(e,t){if(void 0===this._toolInstances[e])return void console.warn("Tool ".concat(e," not present, can't set tool configuration."));const n=Cr()(this._toolInstances[e].configuration,t);return ie()(n)}clone(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=zo(e);return i?(console.warn("ToolGroup ".concat(e," already exists")),i):(i=rs(e),n=null!==(t=n)&&void 0!==t?t:()=>!0,Object.keys(this._toolInstances).filter(n).forEach((e=>{var t;const n=this._toolInstances[e],o=this.toolOptions[e],a=n.mode;i.addTool(e),i.setToolMode(e,a,{bindings:null!==(t=o.bindings)&&void 0!==t?t:[]})})),i)}_hasMousePrimaryButtonBinding(e){var t;const n=this.getDefaultMousePrimary();return null==e||null===(t=e.bindings)||void 0===t?void 0:t.some((e=>e.mouseButton===n&&void 0===e.modifierKey))}_renderViewports(){this.viewportsInfo.forEach((e=>{let{renderingEngineId:t,viewportId:n}=e;(0,J.getRenderingEngine)(t).renderViewport(n)}))}_triggerToolModeChangedEvent(e,t,n){const i={toolGroupId:this.id,toolName:e,mode:t,toolBindingsOptions:n};(0,J.triggerEvent)(J.eventTarget,Q.TOOL_MODE_CHANGED,i)}}const rs=function(e){if(He.toolGroups.some((t=>t.id===e)))return void console.warn("'".concat(e,"' already exists."));const t=new as(e);return He.toolGroups.push(t),t},ss=function(){return He.toolGroups};function ls(e,t,n,i){const{camera:o}=i.detail,a=(0,J.getRenderingEngine)(n.renderingEngineId);if(!a)throw new Error("No RenderingEngine for Id: ".concat(n.renderingEngineId));const r=a.getViewport(n.viewportId);r.setCamera(o),r.render()}const{CAMERA_MODIFIED:ds}=J.Enums.Events;function cs(e){return mr(e,ds,ls)}function hs(e,t,n,i,o){const a=i.detail,{volumeId:r,range:s,invertStateChanged:l,invert:d}=a,c=(0,J.getRenderingEngine)(n.renderingEngineId);if(!c)throw new Error("Rendering Engine does not exist: ".concat(n.renderingEngineId));const h=c.getViewport(n.viewportId),u={voiRange:s};if(null!=o&&o.syncInvertState&&l&&(u.invert=d),h instanceof J.BaseVolumeViewport)h.setProperties(u,r);else{if(!(h instanceof J.StackViewport))throw new Error("Viewport type not supported.");h.setProperties(u)}h.render()}function us(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{syncInvertState:!0};return mr(e,J.Enums.Events.VOI_MODIFIED,hs,t)}function gs(e,t,n){const i=(0,J.getRenderingEngine)(n.renderingEngineId);if(!i)throw new Error("No RenderingEngine for Id: ".concat(n.renderingEngineId));const o=e.getOptions(n.viewportId),a=i.getViewport(n.viewportId),r=i.getViewport(t.viewportId);if(!1!==(null==o?void 0:o.syncZoom)){const e=r.getZoom();a.setZoom(e)}if(!1!==(null==o?void 0:o.syncPan)){const e=r.getPan();a.setPan(e)}a.render()}const{CAMERA_MODIFIED:vs}=J.Enums.Events;function ms(e){return mr(e,vs,gs)}var ps=I(976);const fs=function(e,t,n){return Math.min(Math.max(t,e),n)};function Es(e,t){if(!(0,J.getEnabledElement)(e.element))throw new Error("Scroll::Viewport is not enabled (it might be disabled)");if(e instanceof J.StackViewport&&0===e.getImageIds().length)throw new Error("Scroll::Stack Viewport has no images");const{type:n}=e,{volumeId:i,delta:o}=t;if(e instanceof J.StackViewport)e.scroll(o,t.debounceLoading,t.loop);else if(e instanceof J.VolumeViewport)!function(e,t,n){const{numScrollSteps:i,currentStepIndex:o,sliceRangeInfo:a}=J.utilities.getVolumeViewportScrollInfo(e,t);if(!a)return;const{sliceRange:r,spacingInNormalDirection:s,camera:l}=a,{focalPoint:d,viewPlaneNormal:c,position:h}=l,{newFocalPoint:u,newPosition:g}=J.utilities.snapFocalPointToSlice(d,h,r,c,s,n);e.setCamera({focalPoint:u,position:g}),e.render();const v=o+n;if((v>i||v<0)&&e.getCurrentImageId()){const a={volumeId:t,viewport:e,delta:n,desiredStepIndex:v,currentStepIndex:o,numScrollSteps:i,currentImageId:e.getCurrentImageId()};J.utilities.triggerEvent(J.eventTarget,J.EVENTS.VOLUME_SCROLL_OUT_OF_BOUNDS,a)}}(e,i,o);else{if(!(e instanceof J.VideoViewport))throw new Error("Not implemented for Viewport Type: ".concat(n));e.scroll(o)}}const ws=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{imageIndex:n,debounceLoading:i,volumeId:o}=t,a=(0,J.getEnabledElement)(e);if(!a)throw new Error("Element has been disabled");const{viewport:r}=a,{imageIndex:s,numberOfSlices:l}=function(e,t){if(e instanceof J.StackViewport)return{numberOfSlices:e.getImageIds().length,imageIndex:t?e.getTargetImageIdIndex():e.getCurrentImageIdIndex()};if(e instanceof J.VolumeViewport)return J.utilities.getImageSliceDataForVolumeViewport(e);throw new Error("Unsupported viewport type")}(r,i),d=function(e,t){return fs(t,0,e-1)}(l,n);Es(r,{delta:d-s,debounceLoading:i,volumeId:o})},Is=(e,t)=>J.utilities.spatialRegistrationMetadataProvider.get("spatialRegistrationModule",e,t);async function Cs(e,t,n){const i=(0,J.getRenderingEngine)(n.renderingEngineId);if(!i)throw new Error("No RenderingEngine for Id: ".concat(n.renderingEngineId));const o=i.getViewport(t.viewportId),a=e.getOptions(n.viewportId);if(null!=a&&a.disabled)return;const r=i.getViewport(n.viewportId),s=o.getCurrentImageId(),l=J.metaData.get("imagePlaneModule",s).imagePositionPatient,d=r.getImageIds();if(!function(e,t){const{viewPlaneNormal:n}=e.getCamera(),{viewPlaneNormal:i}=t.getCamera(),o=ps.vec3.dot(n,i);return Math.abs(o)>.9}(o,r))return;let c=Is(n.viewportId,t.viewportId);if(!c&&(o.getFrameOfReferenceUID()===r.getFrameOfReferenceUID()&&!1!==(null==a?void 0:a.useInitialPosition)?c=ps.mat4.identity(ps.mat4.create()):(J.utilities.calculateViewportsSpatialRegistration(o,r),c=Is(n.viewportId,t.viewportId)),!c))return;const h=ps.vec3.transformMat4(ps.vec3.create(),l,c),u=(g=h,d.reduce(((e,t,n)=>{const{imagePositionPatient:i}=J.metaData.get("imagePlaneModule",t),o=ps.vec3.distance(i,g);return o<e.distance?{distance:o,index:n}:e}),{distance:1/0,index:-1}));var g;-1!==u.index&&r.getCurrentImageIdIndex()!==u.index&&await ws(r.element,{imageIndex:u.index})}const{STACK_NEW_IMAGE:_s}=J.Enums.Events;function Ts(e){return mr(e,_s,Cs)}const bs=function(e,t,n){return"".concat(e,"::").concat(t,"::").concat(n)},Ds=function(e,t){Object.keys(e).forEach((n=>{const i=t.getAttribute(n),o=e[n];void 0===o||""===o?t.removeAttribute(n):i!==o&&t.setAttribute(n,o)}))},Ss=function(e,t){Object.keys(e).forEach((n=>{const i=e[n];void 0!==i&&""!==i&&t.setAttribute(n,i)}))},ys=function(e,t,n,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";const{color:s,fill:l,width:d,lineWidth:c,lineDash:h,fillOpacity:u,strokeOpacity:g}=Object.assign({color:"dodgerblue",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0,strokeOpacity:1,fillOpacity:1},a),v=c||d,m=bs(t,"circle",n),p=e.getSvgNode(m),f={cx:"".concat(i[0]),cy:"".concat(i[1]),r:"".concat(o),stroke:s,fill:l,"stroke-width":v,"stroke-dasharray":h,"fill-opacity":u,"stroke-opacity":g};if(p)Ds(f,p),e.setNodeTouched(m);else{const t=document.createElementNS("http://www.w3.org/2000/svg","circle");""!==r&&t.setAttribute("data-id",r),Ss(f,t),e.appendNode(t,m)}},Os=function(e,t,n,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";const{color:s,width:l,lineWidth:d,lineDash:c}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),h=d||l,u=bs(t,"ellipse",n),g=e.getSvgNode(u),v=Math.abs(i[0]-o[0]),m=Math.abs(i[1]-o[1]),p=[Math.min(i[0],o[0])+v/2,Math.min(i[1],o[1])+m/2],f=v/2,E=m/2,w={cx:"".concat(p[0]),cy:"".concat(p[1]),rx:"".concat(f),ry:"".concat(E),stroke:s,fill:"transparent","stroke-width":h,"stroke-dasharray":c};if(g)Ds(w,g),e.setNodeTouched(u);else{const t=document.createElementNS("http://www.w3.org/2000/svg","ellipse");""!==r&&t.setAttribute("data-id",r),Ss(w,t),e.appendNode(t,u)}},Ms=function(e,t,n,i){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const{color:a,handleRadius:r,width:s,lineWidth:l,fill:d,type:c,opacity:h}=Object.assign({color:"dodgerblue",handleRadius:"6",width:"2",lineWidth:void 0,fill:"transparent",type:"circle",opacity:1},o),u=l||s;for(let o=0;o<i.length;o++){const s=i[o],l="http://www.w3.org/2000/svg",g=bs(t,"handle","hg-".concat(n,"-index-").concat(o));let v;if("circle"===c)v={cx:"".concat(s[0]),cy:"".concat(s[1]),r,stroke:a,fill:d,"stroke-width":u,opacity:h};else{if("rect"!==c)throw new Error("Unsupported handle type: ".concat(c));{const e=1.5*parseFloat(r),t=s[0]-.5*e,n=s[1]-.5*e;v={x:"".concat(t),y:"".concat(n),width:"".concat(e),height:"".concat(e),stroke:a,fill:d,"stroke-width":u,rx:"".concat(.1*e),opacity:h}}}const m=e.getSvgNode(g);if(m)Ds(v,m),e.setNodeTouched(g);else{const t=document.createElementNS(l,c);Ss(v,t),e.appendNode(t,g)}}};function xs(e,t,n,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";if(isNaN(i[0])||isNaN(i[1])||isNaN(o[0])||isNaN(o[1]))return;const{color:s,width:l,lineWidth:d,lineDash:c,shadow:h}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0,shadow:void 0},a),u=d||l,g=bs(t,"line",n),v=e.getSvgNode(g),m=h?"filter:url(#shadow-".concat(e.svgLayerElement.id,");"):"",p={x1:"".concat(i[0]),y1:"".concat(i[1]),x2:"".concat(o[0]),y2:"".concat(o[1]),stroke:s,style:m,"stroke-width":u,"stroke-dasharray":c};if(v)Ds(p,v),e.setNodeTouched(g);else{const t=document.createElementNS("http://www.w3.org/2000/svg","line");""!==r&&t.setAttribute("data-id",r),Ss(p,t),e.appendNode(t,g)}}function Ns(e,t,n,i,o){if(i.length<2)return;const{fillColor:a,fillOpacity:r,color:s,width:l,lineWidth:d,lineDash:c}=Object.assign({color:"dodgerblue",width:"2",fillColor:"none",fillOpacity:0,lineWidth:void 0,lineDash:void 0,connectLastToFirst:!1},o),h=d||l,u=bs(t,"polyline",n),g=e.getSvgNode(u);let v="";for(const e of i)v+="".concat(e[0],", ").concat(e[1]," ");if(o.connectLastToFirst){const e=i[0];v+="".concat(e[0],", ").concat(e[1])}const m={points:v,stroke:s,fill:a,"fill-opacity":r,"stroke-width":h,"stroke-dasharray":c};if(g)Ds(m,g),e.setNodeTouched(u);else{const t=document.createElementNS("http://www.w3.org/2000/svg","polyline");Ss(m,t),e.appendNode(t,u)}}function ks(e){const t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return t.setAttribute("x","0"),t.setAttribute("dy","1.2em"),t.textContent=e,t}function Rs(e,t){let n=e.querySelector("rect.background");if(!t)return n&&e.removeChild(n),e.getBBox();n||(n=document.createElementNS("http://www.w3.org/2000/svg","rect"),n.setAttribute("class","background"),e.insertBefore(n,e.firstChild));const i=e.getBBox(),o={x:"".concat(i.x),y:"".concat(i.y),width:"".concat(i.width),height:"".concat(i.height),fill:t};return Ds(o,n),i}const Ps=function(e,t,n,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};return function(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[""],o=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0;const{padding:r,color:s,fontFamily:l,fontSize:d,background:c}=a;let h;const[u,g]=[o[0]+r,o[1]+r],v=bs(t,"text",n),m=e.getSvgNode(v);if(m){const t=m.querySelector("text"),n=Array.from(t.children);for(let e=0;e<n.length;e++){const t=n[e],o=i[e]||"";t.textContent=o}if(i.length>n.length){for(let e=0;e<i.length-n.length;e++){const o=ks(i[e+n.length]);t.appendChild(o)}m.appendChild(t),e.appendNode(m,v)}const o={fill:s,"font-size":d,"font-family":l},a={transform:"translate(".concat(u," ").concat(g,")")};Ds(o,t),Ds(a,m),h=Rs(m,c),e.setNodeTouched(v)}else{const t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttribute("transform","translate(".concat(u," ").concat(g,")"));const n=function(e,t){const{color:n,fontFamily:i,fontSize:o}=t,a=document.createElementNS("http://www.w3.org/2000/svg","text"),r="filter:url(#shadow-".concat(e.svgLayerElement.id,");"),s="".concat("user-select: none; pointer-events: none; -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);").concat(r);return a.setAttribute("x","0"),a.setAttribute("y","0"),a.setAttribute("fill",n),a.setAttribute("font-family",i),a.setAttribute("font-size",o),a.setAttribute("style",s),a}(e,a);for(let e=0;e<i.length;e++){const t=ks(i[e]);n.appendChild(t)}t.appendChild(n),e.appendNode(t,v),h=Rs(t,c)}return Object.assign({},h,{x:u,y:g,height:h.height+r,width:h.width+r})}(e,t,n,i,o,Object.assign({fontFamily:"Helvetica, Arial, sans-serif",fontSize:"14px",color:"rgb(255, 255, 0)",background:"",padding:25,centerX:!1,centerY:!0},a))};function Ls(e,t){let n=[0,0],i=Number.MAX_SAFE_INTEGER;return e.forEach((function(e){const o=function(e,t){const[n,i]=e,[o,a]=t;return Math.sqrt(Math.pow(n-o,2)+Math.pow(i-a,2))}(t,e);o<i&&(i=o,n=[...e])})),n}const As=function(e,t,n,i,o,a,r){let s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{};const l=Object.assign({handleRadius:"6",centering:{x:!1,y:!0}},s),d=Ps(e,t,n,i,o,l);return function(e,t,n,i,o,a){let r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{};const s=i.length>0?Ls(i,o):o,l=Ls(function(e){const{x:t,y:n,height:i,width:o}=e,a=o/2,r=i/2;return[[t+a,n],[t,n+r],[t+a,n+i],[t+o,n+r]]}(a),s),d=Object.assign({color:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"2,3"},r);xs(e,t,"link-".concat(n),s,l,d)}(e,t,n,a,o,d,l),d};function Us(e,t,n,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";const{color:s,width:l,lineWidth:d,lineDash:c}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),h=d||l,u=bs(t,"rect",n),g=e.getSvgNode(u),v=[Math.min(i[0],o[0]),Math.min(i[1],o[1])],m=Math.abs(i[0]-o[0]),p=Math.abs(i[1]-o[1]),f={x:"".concat(v[0]),y:"".concat(v[1]),width:"".concat(m),height:"".concat(p),stroke:s,fill:"transparent","stroke-width":h,"stroke-dasharray":c};if(g)Ds(f,g),e.setNodeTouched(u);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");""!==r&&t.setAttribute("data-id",r),Ss(f,t),e.appendNode(t,u)}}function Vs(e,t,n,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};if(isNaN(i[0])||isNaN(i[1])||isNaN(o[0])||isNaN(o[1]))return;const{color:r,width:s,lineWidth:l,lineDash:d}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a);xs(e,t,n,i,o,{color:r,width:s,lineWidth:l,lineDash:d});const c=Math.atan2(o[1]-i[1],o[0]-i[0]),h={start:[o[0]-10*Math.cos(c-Math.PI/7),o[1]-10*Math.sin(c-Math.PI/7)],end:o},u={start:[o[0]-10*Math.cos(c+Math.PI/7),o[1]-10*Math.sin(c+Math.PI/7)],end:o};xs(e,t,"2",h.start,h.end,{color:r,width:s,lineWidth:l}),xs(e,t,"3",u.start,u.end,{color:r,width:s,lineWidth:l})}function Ws(e,t,n,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};const{color:r,width:s,lineWidth:l,lineDash:d}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),c=l||s,h=bs(t,"rect",n),u=e.getSvgNode(h),g=[Math.min(i[0],o[0]),Math.min(i[1],o[1])],v=Math.abs(i[0]-o[0]),m=Math.abs(i[1]-o[1]),p={x:"".concat(g[0]),y:"".concat(g[1]),width:"".concat(v),height:"".concat(m),stroke:r,fill:"black","stroke-width":c,"stroke-dasharray":d};if(u)Ds(p,u),e.setNodeTouched(h);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");Ss(p,t),e.appendNode(t,h)}}function Fs(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5;const i=(0,J.getEnabledElement)(e);if(!i)throw new Error("getAnnotationNearPoint: enabledElement not found");return Hs(i,t,n)}function Hs(e,t,n){const{renderingEngineId:i,viewportId:o}=e,a=Si(o,i);if(!a)return null;const{_toolInstances:r}=a;for(const i in r){const o=Bs(r[i],e,t,n);if(o)return o}return null}function Bs(e,t,n,i){var o;const{viewport:a}=t,r=Ze(e.constructor.toolName,null==a?void 0:a.element),s=null==a||null===(o=a.getCurrentImageId)||void 0===o?void 0:o.call(a);if(null!=r&&r.length){const{element:o}=t.viewport;for(const t of r){var l;const a=null===(l=t.metadata)||void 0===l?void 0:l.referencedImageId;if(!(s&&a&&s!==a||!e.isPointNearTool)&&(e.isPointNearTool(o,t,n,i,"")||e.getHandleNearImagePoint(o,t,n,i)))return t}}return null}const Gs=function(e){const t=typeof e;return null!==e&&("object"===t||"function"===t)},qs=function(e,t,n){let i,o,a,r,s,l,d=0,c=!1,h=!1,u=!0;const g=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;if("function"!=typeof e)throw new TypeError("Expected a function");function v(t){const n=i,a=o;return i=o=void 0,d=t,r=e.apply(a,n),r}function m(e,t){return g?window.requestAnimationFrame(e):setTimeout(e,t)}function p(e){const n=e-l;return void 0===l||n>=t||n<0||h&&e-d>=a}function f(){const e=Date.now();if(p(e))return E(e);s=m(f,function(e){const n=e-d,i=t-(e-l);return h?Math.min(i,a-n):i}(e))}function E(e){return s=void 0,u&&i?v(e):(i=o=void 0,r)}function w(){const e=Date.now(),n=p(e);for(var a=arguments.length,u=new Array(a),g=0;g<a;g++)u[g]=arguments[g];if(i=u,o=this,l=e,n){if(void 0===s)return function(e){return d=e,s=m(f,t),c?v(e):r}(l);if(h)return s=m(f,t),v(l)}return void 0===s&&(s=m(f,t)),r}return t=Number(t)||0,Gs(n)&&(c=Boolean(n.leading),h="maxWait"in n,a=h?Math.max(Number(n.maxWait)||0,t):a,u="trailing"in n?Boolean(n.trailing):u),w.cancel=function(){void 0!==s&&function(e){if(g)return window.cancelAnimationFrame(e);clearTimeout(e)}(s),d=0,i=l=o=s=void 0},w.flush=function(){return void 0===s?r:E(Date.now())},w.pending=function(){return void 0!==s},w},js=function(e,t,n){let i=!0,o=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return Gs(n)&&(i="leading"in n?Boolean(n.leading):i,o="trailing"in n?Boolean(n.trailing):o),qs(e,t,{leading:i,trailing:o,maxWait:t})},{calibratedPixelSpacingMetadataProvider:zs}=J.utilities;function Ks(e,t,n){"number"==typeof n&&(n={type:J.Enums.CalibrationTypes.USER,scale:n}),zs.add(e,n),t.getStackViewports().forEach((t=>{t.getImageIds().includes(e)&&t.calibrateSpacing(e)}))}const{CalibrationTypes:Ys}=J.Enums,Xs="px",Zs=(e,t)=>{const{calibration:n,hasPixelSpacing:i}=t,o=i?"mm":Xs;return n&&n.type?n.type===Ys.UNCALIBRATED?Xs:n.SequenceOfUltrasoundRegions?"US Region":"".concat(o," ").concat(n.type):o},Js=(e,t)=>{const{calibration:n,hasPixelSpacing:i}=t,o=(i?"mm":Xs)+"²";return n&&n.type?n.SequenceOfUltrasoundRegions?"US Region":"".concat(o," ").concat(n.type):o},$s=e=>{var t;return(null===(t=e.calibration)||void 0===t?void 0:t.scale)||1},Qs=e=>{var t;return(null===(t=e.calibration)||void 0===t?void 0:t.aspect)||1},el=Zs;function tl(e,t,n,i){let o,a,r,s,l,d,c;c=e.getScalarData?e.getScalarData():e.getPointData().getScalars().getData();const h=e.getDimensions();i?[[o,a],[r,s],[l,d]]=i:(o=0,a=h[0],r=0,s=h[1],l=0,d=h[2]);const u=ps.vec3.fromValues(o,r,l),g=e.getDirection(),v=g.slice(0,3),m=g.slice(3,6),p=g.slice(6,9),f=e.getSpacing(),[E,w,I]=f,C=e.indexToWorld(u),_=ps.vec3.fromValues(v[0]*E,v[1]*E,v[2]*E),T=ps.vec3.fromValues(m[0]*w,m[1]*w,m[2]*w),b=ps.vec3.fromValues(p[0]*I,p[1]*I,p[2]*I),D=c.length/h[2]/h[1]/h[0],S=h[0]*D,y=h[1]*S,O=[],M=ps.vec3.clone(C);for(let e=l;e<=d;e++){const i=ps.vec3.clone(M);for(let i=r;i<=s;i++){const r=ps.vec3.clone(M);for(let r=o;r<=a;r++){const o=[r,i,e];if(t(M,M)){const t=e*y+i*S+r*D;let a;a=D>2?[c[t],c[t+1],c[t+2]]:c[t],O.push({value:a,index:t,pointIJK:o,pointLPS:M}),n&&n({value:a,index:t,pointIJK:o,pointLPS:M})}ps.vec3.add(M,M,_)}ps.vec3.copy(M,r),ps.vec3.add(M,M,T)}ps.vec3.copy(M,i),ps.vec3.add(M,M,b)}return O}const nl=function(e,t){let n=1/0,i=0,o=1/0,a=0,r=1/0,s=0;if(e.forEach((e=>{n=Math.min(e[0],n),i=Math.max(e[0],i),o=Math.min(e[1],o),a=Math.max(e[1],a),r=Math.min(e[2],r),s=Math.max(e[2],s)})),n=Math.floor(n),i=Math.floor(i),o=Math.floor(o),a=Math.floor(a),r=Math.floor(r),s=Math.floor(s),t){const[e,l,d]=t;n=Math.max(0,n),i=Math.min(e-1,i),o=Math.max(0,o),a=Math.min(l-1,a),r=Math.max(0,r),s=Math.min(d-1,s)}return[[n,i],[o,a],[r,s]]},{transformWorldToIndex:il}=J.utilities;function ol(e,t,n,i){const{boundsIJK:o,centerWorld:a,radiusWorld:r}=function(e,t,n){const[i,o]=e,a=ps.vec3.fromValues((i[0]+o[0])/2,(i[1]+o[1])/2,(i[2]+o[2])/2),r=ps.vec3.distance(i,o)/2;let s;if(!n){const e=il(t,a),n=t.getSpacing(),i=Math.min(...n),o=Math.ceil(r/i);return s=[[e[0]-o,e[0]+o],[e[1]-o,e[1]+o],[e[2]-o,e[2]+o]],{boundsIJK:s,centerWorld:a,radiusWorld:r}}return s=function(e,t,n,i,o){const[a,r]=n,s=e.getDimensions(),l=t.getCamera(),d=ps.vec3.fromValues(l.viewUp[0],l.viewUp[1],l.viewUp[2]),c=ps.vec3.fromValues(l.viewPlaneNormal[0],l.viewPlaneNormal[1],l.viewPlaneNormal[2]),h=ps.vec3.create();ps.vec3.cross(h,d,c);const u=ps.vec3.create(),g=ps.vec3.create();ps.vec3.scaleAndAdd(u,r,c,o),ps.vec3.scaleAndAdd(g,a,c,-o),ps.vec3.scaleAndAdd(u,u,h,-o),ps.vec3.scaleAndAdd(g,g,h,o);const v=[il(e,u),il(e,g)];return nl(v,s)}(t,n,e,0,r),{boundsIJK:s,centerWorld:a,radiusWorld:r}}(t,e,i),s={center:a,radius:r};tl(e,(e=>function(e,t){const{center:n,radius:i}=e;return(t[0]-n[0])*(t[0]-n[0])+(t[1]-n[1])*(t[1]-n[1])+(t[2]-n[2])*(t[2]-n[2])<=i**2}(s,e)),n,o)}const al=function e(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(Array.isArray(t))return t.map((t=>e(t,n))).join(", ");if(null==t||""===t)return"NaN";if((t=Number(t))<1e-4)return"".concat(t);const i=t>=100?n-2:t>=10?n-1:t>=1?n:t>=.1?n+1:t>=.01?n+2:t>=.001?n+3:n+4;return t.toFixed(i)};class rl{static imageIdToFrames(e){const t=e.match(this.frameRangeExtractor);if(!t||!t[2])return null;const n=t[2].split("-").map((e=>Number(e)));return 1===n.length?n[0]:n}static framesToString(e){return Array.isArray(e)?"".concat(e[0],"-").concat(e[1]):String(e)}static framesToImageId(e,t){const n=e.match(this.frameRangeExtractor);if(!n||!n[2])return null;const i=this.framesToString(t);return e.replace(this.frameRangeExtractor,"".concat(n[1]).concat(i))}static setFrameRange(e,t,n){const{referencedImageId:i}=e.metadata;e.metadata.referencedImageId=this.framesToImageId(i,t);const o={...n,annotation:e};(0,J.triggerEvent)(J.eventTarget,Q.ANNOTATION_MODIFIED,o)}static getFrameRange(e){return this.imageIdToFrames(e.metadata.referencedImageId)}}te(rl,"frameRangeExtractor",/(\/frames\/|[&?]frameNumber=)([^/&?]*)/i);const sl=function(e,t,n){const{THRESHOLD_INSIDE_CIRCLE:i}=n,o=t.getScalarData()[e],{threshold:a}=i;return a[0]<=o&&o<=a[1]};function ll(e,t){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const{viewport:i}=e,{volume:o,segmentsLocked:a,segmentIndex:r,imageVolume:s,strategySpecificConfiguration:l,segmentationId:d,points:c}=t,{imageData:h,dimensions:u}=o,g=o.getScalarData(),v=[];let m;m=n?e=>{let{value:t,index:n,pointIJK:i}=e;a.includes(t)||sl(n,s,l)&&(g[n]=r,v.push(n))}:e=>{let{index:t,value:n}=e;a.includes(n)||(g[t]=r,v.push(t))},ol(h,[c[0],c[1]],m,i);const p=u[0]*u[1],f=Math.floor(v[0]/p),E=Math.floor(v[v.length-1]/p);pt(d,Array.from({length:E-f+1},((e,t)=>t+f)))}function dl(e,t){ll(e,t,!0)}function cl(e,t){const{volume:n,imageVolume:i}=t;if(!J.utilities.isEqual(n.dimensions,i.dimensions)||!J.utilities.isEqual(n.direction,i.direction))throw new Error("Only source data the same dimensions/size/orientation as the segmentation currently supported.");ll(e,t,!0,!0)}function hl(e,t){dl(e,Object.assign({},t,{segmentIndex:0}))}function ul(e){const[t,n,i,o]=e;return[[i[0],n[1]],[o[0],t[1]]]}function gl(e,t){const{center:n,xRadius:i,yRadius:o,zRadius:a}=e,[r,s,l]=t,[d,c,h]=n;let u=0;return 0!==i&&(u+=(r-d)*(r-d)/(i*i)),0!==o&&(u+=(s-c)*(s-c)/(o*o)),0!==a&&(u+=(l-h)*(l-h)/(a*a)),u<=1}const{transformWorldToIndex:vl}=J.utilities;function ml(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{volume:i,imageVolume:o,points:a,segmentsLocked:r,segmentIndex:s,segmentationId:l,strategySpecificConfiguration:d}=t,{imageData:c,dimensions:h}=i,u=i.getScalarData(),{viewport:g}=e,v=ps.vec3.fromValues(0,0,0);a.forEach((e=>{ps.vec3.add(v,v,e)})),ps.vec3.scale(v,v,1/a.length);const m=a.map((e=>g.worldToCanvas(e))),[p,f]=ul(m),E=g.canvasToWorld(p),w=g.canvasToWorld(f),I=[vl(c,E),vl(c,w)],C=nl(I,h),_={center:v,xRadius:Math.abs(E[0]-w[0])/2,yRadius:Math.abs(E[1]-w[1])/2,zRadius:Math.abs(E[2]-w[2])/2},T=new Set;let b;b=n?e=>{let{value:t,index:n,pointIJK:i}=e;r.includes(t)||sl(n,o,d)&&(u[n]=s,T.add(i[2]))}:e=>{let{value:t,index:n,pointIJK:i}=e;r.includes(t)||(u[n]=s,T.add(i[2]))},tl(c,((e,t)=>gl(_,e)),b,C),pt(l,Array.from(T))}function pl(e,t){ml(e,t,!1)}function fl(e,t){const{volume:n,imageVolume:i}=t;if(!J.utilities.isEqual(n.dimensions,i.dimensions)||!J.utilities.isEqual(n.direction,i.direction))throw new Error("Only source data the same dimensions/size/orientation as the segmentation currently supported.");ml(e,t,!0)}function El(e,t){pl(e,{...t,segmentIndex:0})}function wl(e){const t=Et().getSegmentationRepresentations(e);if(t)return t.find((e=>e.active))}function Il(e,t){Et().setActiveSegmentationRepresentation(e,t),vt(e,t)}function Cl(e,t){const n=wt(e);if(!n)throw new Error("No segmentation state found for ".concat(e));const{segmentsLocked:i}=n;return i.has(t)}function _l(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=wt(e);if(!i)throw new Error("No segmentation state found for ".concat(e));const{segmentsLocked:o}=i;n?o.add(t):o.delete(t),mt(e)}function Tl(e){const t=wt(e);if(!t)throw new Error("No segmentation state found for ".concat(e));const{segmentsLocked:n}=t;return Array.from(n)}function bl(e,t){const n=wt(e);(null==n?void 0:n.activeSegmentIndex)!==t&&(n.activeSegmentIndex=t,mt(e))}function Dl(e){const t=wt(e);if(t)return t.activeSegmentIndex}function Sl(e,t){if(!e)throw new Error("addColorLUT: colorLUT is required");J.utilities.isEqual(e[0],[0,0,0,0])||(console.warn("addColorLUT: [0, 0, 0, 0] color is not provided for the background color (segmentIndex =0), automatically adding it"),e.unshift([0,0,0,0])),Wt(e,t)}function yl(e,t,n){const i=Pt(e,t);if(!i)throw new Error("setColorLUT: could not find segmentation representation with UID ".concat(t));if(!Vt(n))throw new Error("setColorLUT: could not find colorLUT with index ".concat(n));i.colorLUTIndex=n,vt(e,t)}function Ol(e,t,n){const i=Pt(e,t);if(!i)throw new Error("segmentation representation with UID ".concat(t," does not exist for tool group ").concat(e));const{colorLUTIndex:o}=i;return Vt(o)[n]}function Ml(e,t,n,i){const o=Ol(e,t,n);for(let e=0;e<i.length;e++)o[e]=i[e];vt(e,t)}class xl extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE_CIRCLE:pl,ERASE_INSIDE_CIRCLE:El,FILL_INSIDE_SPHERE:dl,ERASE_INSIDE_SPHERE:hl,THRESHOLD_INSIDE_CIRCLE:fl,THRESHOLD_INSIDE_SPHERE:cl},strategySpecificConfiguration:{THRESHOLD_INSIDE_CIRCLE:{threshold:[-150,-70]}},defaultStrategy:"FILL_INSIDE_CIRCLE",activeStrategy:"FILL_INSIDE_CIRCLE",brushSize:25}}),te(this,"_editData",void 0),te(this,"_hoverData",void 0),te(this,"onSetToolPassive",(()=>{this.disableCursor()})),te(this,"onSetToolEnabled",(()=>{this.disableCursor()})),te(this,"onSetToolDisabled",(()=>{this.disableCursor()})),te(this,"preMouseDownCallback",(e=>{const t=e.detail,{element:n}=t,i=(0,J.getEnabledElement)(n),{viewport:o,renderingEngine:a}=i;if(o instanceof J.StackViewport)throw new Error("Not implemented yet");const r=wl(this.toolGroupId);if(!r)throw new Error("No active segmentation detected, create one before using the brush tool");const{segmentationId:s,type:l}=r,d=Tl(s),{representationData:c}=wt(s),{volumeId:h}=c[l],u=J.cache.getVolume(h),g=o.getActors()[0].uid,v=J.cache.getVolume(g),m=[o.id];return this._editData={segmentation:u,imageVolume:v,segmentsLocked:d},this._activateDraw(n),Qr(n),e.preventDefault(),Bo(a,m),!0})),te(this,"mouseMoveCallback",(e=>{this.mode===Ge.Active&&this.updateCursor(e)})),te(this,"_dragCallback",(e=>{const t=e.detail,{element:n}=t,i=(0,J.getEnabledElement)(n),{renderingEngine:o}=i,{imageVolume:a,segmentation:r,segmentsLocked:s}=this._editData;this.updateCursor(e);const{segmentIndex:l,segmentationId:d,segmentationRepresentationUID:c,brushCursor:h,viewportIdsToRender:u}=this._hoverData,{data:g}=h,{viewPlaneNormal:v,viewUp:m}=h.metadata;Bo(o,u);const p={points:g.handles.points,volume:r,imageVolume:a,segmentIndex:l,segmentsLocked:s,viewPlaneNormal:v,toolGroupId:this.toolGroupId,segmentationId:d,segmentationRepresentationUID:c,viewUp:m,strategySpecificConfiguration:this.configuration.strategySpecificConfiguration};this.applyActiveStrategy(i,p)})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t,{imageVolume:i,segmentation:o,segmentsLocked:a}=this._editData,{segmentIndex:r,segmentationId:s,segmentationRepresentationUID:l,brushCursor:d}=this._hoverData,{data:c}=d,{viewPlaneNormal:h,viewUp:u}=d.metadata;this._deactivateDraw(n),$r(n);const g=(0,J.getEnabledElement)(n),{viewport:v}=g;if(this._editData=null,this.updateCursor(e),v instanceof J.StackViewport)throw new Error("Not implemented yet");const m={points:c.handles.points,volume:o,imageVolume:i,segmentIndex:r,segmentsLocked:a,viewPlaneNormal:h,toolGroupId:this.toolGroupId,segmentationId:s,segmentationRepresentationUID:l,viewUp:u,strategySpecificConfiguration:this.configuration.strategySpecificConfiguration};this.applyActiveStrategy(g,m)})),te(this,"_activateDraw",(e=>{e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback)})),te(this,"_deactivateDraw",(e=>{e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback)}))}disableCursor(){this._hoverData=void 0}updateCursor(e){const t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.canvas,a=(0,J.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.toolGroupId,u=wl(h);if(!u)return void console.warn("No active segmentation detected, create one before using the brush tool");const{segmentationRepresentationUID:g,segmentationId:v}=u,m=Dl(v),p=Ol(h,g,m),f=[s.id],E={metadata:{viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:p},data:{}};this._hoverData={brushCursor:E,centerCanvas:o,segmentIndex:m,segmentationId:v,segmentationRepresentationUID:g,segmentColor:p,viewportIdsToRender:f},this._calculateCursor(n,o),Bo(r,f)}_calculateCursor(e,t){const n=(0,J.getEnabledElement)(e),{viewport:i}=n,{canvasToWorld:o}=i,a=i.getCamera(),{brushSize:r}=this.configuration,s=ps.vec3.fromValues(a.viewUp[0],a.viewUp[1],a.viewUp[2]),l=ps.vec3.fromValues(a.viewPlaneNormal[0],a.viewPlaneNormal[1],a.viewPlaneNormal[2]),d=ps.vec3.create();ps.vec3.cross(d,s,l);const c=o([t[0],t[1]]),h=ps.vec3.create(),u=ps.vec3.create(),g=ps.vec3.create(),v=ps.vec3.create();for(let e=0;e<=2;e++)h[e]=c[e]-s[e]*r,u[e]=c[e]+s[e]*r,g[e]=c[e]-d[e]*r,v[e]=c[e]+d[e]*r;const{brushCursor:m}=this._hoverData,{data:p}=m;void 0===p.handles&&(p.handles={}),p.handles.points=[h,u,g,v],p.invalidated=!1}invalidateBrushCursor(){if(void 0!==this._hoverData){const{data:e}=this._hoverData.brushCursor;e.invalidated=!0}}renderAnnotation(e,t){if(!this._hoverData)return;const{viewport:n}=e;if(!this._hoverData.viewportIdsToRender.includes(n.id))return;const i=this._hoverData.brushCursor;if(!0===i.data.invalidated){const{centerCanvas:e}=this._hoverData,{element:t}=n;this._calculateCursor(t,e)}const o=i.metadata,a=o.brushCursorUID,r=i.data,{points:s}=r.handles,l=s.map((e=>n.worldToCanvas(e))),d=l[0],c=l[1],h=[Math.floor((d[0]+c[0])/2),Math.floor((d[1]+c[1])/2)],u=Math.abs(d[1]-Math.floor((d[1]+c[1])/2)),g="rgb(".concat(o.segmentColor.slice(0,3),")");n.getRenderingEngine()?ys(t,a,"0",h,u,{color:g}):console.warn("Rendering Engine has been destroyed")}}te(xl,"toolName",void 0),xl.toolName="Brush";const Nl=xl;function kl(e,t){const n=zo(e);if(void 0===n)return;const i=n._toolInstances;return Object.keys(i).length?t&&i[t]?[i[t]]:Object.values(i).filter((e=>e instanceof Nl)):void 0}function Rl(e,t,n,i){const o=[];for(let e=0;e<2;e++)for(let t=0;t<2;t++)for(let a=0;a<2;a++){const r=[...i];r[0]=r[0]+(2*e-1)*n[0]/2,r[1]=r[1]+(2*t-1)*n[1]/2,r[2]=r[2]+(2*a-1)*n[2]/2,o.push(r)}const a=o.map((t=>J.utilities.transformWorldToIndex(e,t)));return nl(a,t)}function Pl(e,t){const{spacing:n}=e,i=e.getScalarData(),o=[];let a=0;for(let e=0;e<t.length;e++){const{imageData:l,spacing:d,dimensions:c}=t[e].volume,h=t[e].volume.getScalarData().length;h===i.length&&(r=d,s=n,JSON.stringify(r)===JSON.stringify(s))&&(a=e);const u=l.getPointData().getScalars().getData(),g=t[e].lower,v=t[e].upper;o.push({imageData:l,referenceValues:u,lower:g,upper:v,spacing:d,dimensions:c,volumeSize:h})}var r,s;return{volumeInfoList:o,baseVolumeIdx:a}}const Ll=function(e,t,n){const{imageData:i}=e,o=e.getScalarData(),{overwrite:a,boundsIJK:r}=n,s=(null==n?void 0:n.overlapType)||0;if(a)for(let e=0;e<o.length;e++)o[e]=0;const{baseVolumeIdx:l,volumeInfoList:d}=Pl(e,t);let c,h,u;const g=(e,t,n)=>{const{imageData:i,dimensions:o,lower:a,upper:r}=e,l=Rl(i,o,t,n);h=0,c=0,u={lower:a,upper:r};let d=!1;return tl(i,(()=>!0),(e=>{let{value:t}=e;h+=1,t>=u.lower&&t<=u.upper&&(c+=1)}),l),0===s?d=c>0:1==s&&(d=c===h),d},v=(e,t)=>{const{imageData:n,referenceValues:i,lower:o,upper:a}=e,r=i[n.computeOffsetIndex(t)];return!(r<=o||r>=a)};return tl(i,(()=>!0),(e=>{let{index:t,pointIJK:n,pointLPS:i}=e,a=d.length>0;for(let e=0;e<d.length&&(a=d[e].volumeSize===o.length?v(d[e],n):g(d[e],d[l].spacing,i),a);e++);a&&(o[t]=1)}),r),pt(e.volumeId),e};function Al(e,t){const n=e.length,i=[];for(let o=0;o<n;o++){const n=e[o];n.getFrameOfReferenceUID()===t&&i.push(n)}return i}const{Active:Ul,Passive:Vl,Enabled:Wl}=Ge;function Fl(e,t){const n=e.length,i=[];for(let o=0;o<n;o++){const n=e[o],a=Si(n.id,n.renderingEngineId);a&&(Hl(a,t)&&i.push(n))}return i}function Hl(e,t){const{toolOptions:n}=e,i=n[t];if(!i)return!1;const o=i.mode;return o===Ul||o===Vl||o===Wl}const Bl=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.999;return e.filter((e=>{const i=e.getCamera();return Math.abs(ps.vec3.dot(i.viewPlaneNormal,t.viewPlaneNormal))>n}))};function Gl(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=(0,J.getEnabledElement)(e),{renderingEngine:o,FrameOfReferenceUID:a}=i;let r=o.getViewports();r=Al(r,a),r=Fl(r,t);const s=o.getViewport(i.viewportId);return n&&(r=Bl(r,s.getCamera())),r.map((e=>e.id))}const{EPSILON:ql}=J.CONSTANTS,jl=1-ql;function zl(e,t,n){const{viewPlaneNormal:i}=t,o=e.filter((e=>{let t=e.metadata.viewPlaneNormal;if(!t){const{referencedImageId:n}=e.metadata,{imageOrientationPatient:i}=J.metaData.get("imagePlaneModule",n),o=ps.vec3.fromValues(i[0],i[1],i[2]),a=ps.vec3.fromValues(i[3],i[4],i[5]);t=ps.vec3.create(),ps.vec3.cross(t,o,a),e.metadata.viewPlaneNormal=t}const n=Math.abs(ps.vec3.dot(i,t))>jl;return t&&n}));if(!o.length)return[];const a=n/2,{focalPoint:r}=t,s=[];for(const e of o){const t=e.data.handles.points[0];if(!e.isVisible)continue;const n=ps.vec3.create();ps.vec3.sub(n,r,t);const o=ps.vec3.dot(n,i);Math.abs(o)<a&&s.push(e)}return s}const Kl=/(videoId:|imageId:|volumeId:)([a-zA-Z]*:)/;function Yl(e,t){if(e instanceof J.StackViewport){const n=e.getCurrentImageId(),i=n.indexOf(":"),o=n.substring(i+1);return t.filter((e=>{if(!e.isVisible)return!1;const t=e.metadata.referencedImageId;if(void 0===t)return!1;const n=t.indexOf(":");return t.substring(n+1)===o}))}if(e instanceof J.VideoViewport){const n=e.getFrameOfReferenceUID();return t.filter((t=>{if(!t.isVisible)return!1;if(t.metadata.FrameOfReferenceUID!==n)return!1;const i=t.metadata.referencedImageId.replace(Kl,"");if(!e.hasImageURI(i))return!1;const o=rl.getFrameRange(t),a=e.getFrameNumber();return Array.isArray(o)?a>=o[0]&&a<=o[1]:Math.abs(a-o)<=5}))}if(e instanceof J.VolumeViewport){const n=e.getCamera(),{spacingInNormalDirection:i}=J.utilities.getTargetVolumeAndSpacingInNormalDir(e,n);return zl(t,n,i)}throw new Error("Viewport Type ".concat(e.type," not supported"))}const Xl=function(e){if(e){if(e.data&&e.highlighted)return Or.Highlighted;if(Ce(e.annotationUID))return Or.Selected;if(le(e))return Or.Locked}return Or.Default};class Zl extends la{constructor(){super(...arguments),te(this,"onImageSpacingCalibrated",(e=>{const{element:t,imageId:n}=e.detail,i=J.utilities.imageIdToURI(n),o=Ke();o.getFramesOfReference().forEach((e=>{const n=o.getAnnotations(e)[this.getToolName()];n&&n.length&&(n.forEach((e=>{var t;null!==(t=e.metadata)&&void 0!==t&&t.referencedImageId&&J.utilities.imageIdToURI(e.metadata.referencedImageId)===i&&(e.invalidated=!0,e.data.cachedStats={})})),ki(t))}))}))}filterInteractableAnnotationsForElement(e,t){if(!t||!t.length)return;const n=(0,J.getEnabledElement)(e),{viewport:i}=n;return Yl(i,t)}getReferencedImageId(e,t,n,i){const o=this.getTargetId(e);let a;if(e instanceof J.StackViewport)a=o.split("imageId:")[1];else if(e instanceof J.VideoViewport)a=o.split("videoId:")[1];else{const e=o.split("volumeId:")[1],i=J.cache.getVolume(e);a=J.utilities.getClosestImageId(i,t,n)}return a}getStyle(e,t,n){return Br(e,t,Xl(n),this.mode)}}te(Zl,"toolName",void 0),Zl.toolName="AnnotationDisplayTool";const Jl=Zl;class $l extends Jl{constructor(e,t){var n,i;super(e,t),te(this,"mouseMoveCallback",((e,t)=>{if(!t)return!1;const{element:n,currentPoints:i}=e.detail,o=i.canvas;let a=!1;for(const e of t){if(le(e)||!Me(e.annotationUID))continue;const{data:t}=e,i=t.handles?t.handles.activeHandleIndex:void 0,r=this._imagePointNearToolOrHandle(n,e,o,6),s=r&&!e.highlighted,l=!r&&e.highlighted;s||l?(e.highlighted=!e.highlighted,a=!0):t.handles&&t.handles.activeHandleIndex!==i&&(a=!0)}return a})),null!==(n=e.configuration)&&void 0!==n&&n.getTextLines&&(this.configuration.getTextLines=e.configuration.getTextLines),null!==(i=e.configuration)&&void 0!==i&&i.statsCalculator&&(this.configuration.statsCalculator=e.configuration.statsCalculator)}getHandleNearImagePoint(e,t,n,i){const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{data:r}=t,{points:s,textBox:l}=r.handles;if(l){const{worldBoundingBox:e}=l;if(e){const t={topLeft:a.worldToCanvas(e.topLeft),topRight:a.worldToCanvas(e.topRight),bottomLeft:a.worldToCanvas(e.bottomLeft),bottomRight:a.worldToCanvas(e.bottomRight)};if(n[0]>=t.topLeft[0]&&n[0]<=t.bottomRight[0]&&n[1]>=t.topLeft[1]&&n[1]<=t.bottomRight[1])return r.handles.activeHandleIndex=null,l}}for(let e=0;e<s.length;e++){const t=s[e],o=a.worldToCanvas(t);if(!0==ps.vec2.distance(n,o)<i)return r.handles.activeHandleIndex=e,t}r.handles.activeHandleIndex=null}getLinkedTextBoxStyle(e,t){return{visibility:this.getStyle("textBoxVisibility",e,t),fontFamily:this.getStyle("textBoxFontFamily",e,t),fontSize:this.getStyle("textBoxFontSize",e,t),color:this.getStyle("textBoxColor",e,t),shadow:this.getStyle("textBoxShadow",e,t),background:this.getStyle("textBoxBackground",e,t),lineWidth:this.getStyle("textBoxLinkLineWidth",e,t),lineDash:this.getStyle("textBoxLinkLineDash",e,t)}}isSuvScaled(e,t,n){if(e instanceof J.BaseVolumeViewport){var i;const e=t.split("volumeId:")[1];return void 0!==(null===(i=J.cache.getVolume(e).scaling)||void 0===i?void 0:i.PT)}const o=n&&J.metaData.get("scalingModule",n);return"number"==typeof(null==o?void 0:o.suvbw)}_imagePointNearToolOrHandle(e,t,n,i){return!!this.getHandleNearImagePoint(e,t,n,i)||(!!this.isPointNearTool(e,t,n,i,"mouse")||void 0)}}te($l,"toolName",void 0),$l.toolName="AnnotationTool";const Ql=$l;function ed(e,t){return(e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])}function td(e,t,n){const i=ed(e,t);if(0===i)return ed(n,e);const o=((n[0]-e[0])*(t[0]-e[0])+(n[1]-e[1])*(t[1]-e[1]))/i;return ed(n,o<0?e:o>1?t:[e[0]+o*(t[0]-e[0]),e[1]+o*(t[1]-e[1])])}function nd(e,t,n){if(2!==e.length||2!==t.length||2!==n.length)throw Error("lineStart, lineEnd, and point should have 2 elements of [x, y]");return Math.sqrt(td(e,t,n))}function id(e,t){if(4!==e.length||2!==t.length)throw Error("rectangle:[left, top, width, height] or point: [x,y] not defined correctly");const[n,i,o,a]=e;let r=655535;const s=function(e,t,n,i){return{top:[[e,t],[e+n,t]],right:[[e+n,t],[e+n,t+i]],bottom:[[e+n,t+i],[e,t+i]],left:[[e,t+i],[e,t]]}}(n,i,o,a);return Object.keys(s).forEach((e=>{const[n,i]=s[e],o=nd(n,i,t);o<r&&(r=o)})),r}function od(e){const t=function(e){const t=[e[0],e[1]].sort((function(e,t){return e[0]<t[0]?-1:1})),n=[e[0],e[1]].sort((function(e,t){return e[1]<t[1]?-1:1})),i=t[t.length-1];return{top:n[0],bottom:n[n.length-1],right:i}}(e),n=(t.top[1]+t.bottom[1])/2;return[t.right[0],n]}function ad(e,t,n,i){const o=ps.vec3.create();ps.vec3.cross(o,t,e);const a=ps.vec3.fromValues(...n),r=ps.vec3.fromValues(...i),s=ps.vec3.create();ps.vec3.subtract(s,a,r);const l=ps.vec3.length(s);if(l<1e-4)return{worldWidth:0,worldHeight:0};const d=ps.vec3.dot(s,o)/(l*ps.vec3.length(o));return{worldWidth:Math.sqrt(1-d*d)*l,worldHeight:d*l}}function rd(e,t,n){return"CT"===e?"HU":"PT"===e?function(e,t){if(!t.isPreScaled)return"raw";if(t.isSuvScaled)return"SUV";const n=J.metaData.get("generalSeriesModule",e);if("PT"===(null==n?void 0:n.modality)){const t=J.metaData.get("petSeriesModule",e);return(null==t?void 0:t.units)||"unitless"}}(t,n):""}function sd(e,t){if(e instanceof J.BaseVolumeViewport){const e=t.split("volumeId:"),n=e.length>1?e[1]:e[0],i=J.cache.getVolume(n);return!(null==i||!i.scaling)&&Object.keys(i.scaling).length>0}if(e instanceof J.StackViewport){const{preScale:t}=e.getImageData()||{};return!(null==t||!t.scaled)}return!1}class ld{}te(ld,"run",void 0),te(ld,"getStatistics",void 0);const dd=ld;var cd;class hd extends dd{}function ud(e){return 1===e.length?e[0]:e}cd=hd,te(hd,"max",[-1/0]),te(hd,"sum",[0]),te(hd,"sumSquares",[0]),te(hd,"squaredDiffSum",[0]),te(hd,"count",0),te(hd,"statsCallback",(e=>{let{value:t}=e;Array.isArray(t)&&t.length>1&&1===cd.max.length&&(cd.max.push(cd.max[0],cd.max[0]),cd.sum.push(cd.sum[0],cd.sum[0]),cd.sumSquares.push(cd.sumSquares[0],cd.sumSquares[0]),cd.squaredDiffSum.push(cd.squaredDiffSum[0],cd.squaredDiffSum[0]));const n=Array.isArray(t)?t:[t];cd.count+=1,cd.max.forEach(((e,t)=>cd.max[t]=Math.max(e,n[t]))),cd.sum.map(((e,t)=>cd.sum[t]+=n[t])),cd.sumSquares.map(((e,t)=>cd.sumSquares[t]+=n[t]**2)),cd.squaredDiffSum.map(((e,t)=>cd.squaredDiffSum[t]+=Math.pow(n[t]-cd.sum[t]/cd.count,2)))})),te(hd,"getStatistics",(()=>{const e=cd.sum.map((e=>e/cd.count)),t=cd.squaredDiffSum.map((e=>Math.sqrt(e/cd.count))),n=cd.sumSquares.map(((t,n)=>Math.sqrt(cd.sumSquares[n]/cd.count-e[n]**2))),i=cd.max;return cd.max=[-1/0],cd.sum=[0],cd.sumSquares=[0],cd.squaredDiffSum=[0],cd.count=0,[{name:"max",value:ud(i),unit:null},{name:"mean",value:ud(e),unit:null},{name:"stdDev",value:ud(t),unit:null},{name:"stdDevWithSumSquare",value:ud(n),unit:null}]}));const{transformWorldToIndex:gd}=J.utilities;class vd extends Ql{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:md,statsCalculator:hd}}),te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"addNewAnnotation",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,o,d,c),u=r.getFrameOfReferenceUID(),g={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:u,referencedImageId:h},data:{label:"",handles:{points:[[...o],[...o],[...o],[...o]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},cachedStats:{}}};Je(g,i);const v=Gl(i,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:v,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Qr(i),e.preventDefault(),Bo(s,v),g})),te(this,"isPointNearTool",((e,t,n,i)=>{const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{data:r}=t,{points:s}=r.handles,l=a.worldToCanvas(s[0]),d=a.worldToCanvas(s[3]),c=this._getRectangleImageCoordinates([l,d]),h=[n[0],n[1]],{left:u,top:g,width:v,height:m}=c;return id([u,g,v,m],h)<=i})),te(this,"toolSelectedCallback",((e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Gl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(i),Qr(i);const a=(0,J.getEnabledElement)(i),{renderingEngine:r}=a;Bo(r,o),e.preventDefault()})),te(this,"handleSelectedCallback",((e,t,n)=>{const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=Gl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(o),Qr(o);const d=(0,J.getEnabledElement)(o),{renderingEngine:c}=d;Bo(c,l),e.preventDefault()})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=i;if(a&&!r)return;s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),$r(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Qe(i.annotationUID),Bo(d,o),a){const e=Q.ANNOTATION_COMPLETED,t={annotation:i};(0,J.triggerEvent)(J.eventTarget,e,t)}})),te(this,"_dragCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=s.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world,{points:o}=s.handles;o.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,o=(0,J.getEnabledElement)(n),{worldToCanvas:r,canvasToWorld:l}=o.viewport,d=e.world,{points:c}=s.handles;let h,u,g,v,m,p,f,E;switch(c[a]=[...d],a){case 0:case 3:h=r(c[0]),v=r(c[3]),u=[v[0],h[1]],g=[h[0],v[1]],p=l(u),f=l(g),c[1]=p,c[2]=f;break;case 1:case 2:u=r(c[1]),g=r(c[2]),h=[g[0],u[1]],v=[u[0],g[1]],m=l(h),E=l(v),c[0]=m,c[3]=E}i.invalidated=!0}this.editData.hasMoved=!0;const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;Bo(d,o)})),te(this,"cancel",(e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),$r(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(Bo(r,n),i){const e=Q.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID}})),te(this,"_activateDraw",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_MOVE,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_deactivateDraw",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_MOVE,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_activateModify",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_deactivateModify",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"renderAnnotation",((e,t)=>{var n,i;let o=!1;const{viewport:a}=e,{element:r}=a;let s=Ze(this.getToolName(),r);if(null===(n=s)||void 0===n||!n.length)return o;if(s=this.filterInteractableAnnotationsForElement(r,s),null===(i=s)||void 0===i||!i.length)return o;const l=this.getTargetId(a),d=a.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let n=0;n<s.length;n++){const i=s[n],{annotationUID:r,data:h}=i,{points:u,activeHandleIndex:g}=h.handles,v=u.map((e=>a.worldToCanvas(e)));c.annotationUID=r;const m=this.getStyle("lineWidth",c,i),p=this.getStyle("lineDash",c,i),f=this.getStyle("color",c,i),{viewPlaneNormal:E,viewUp:w}=a.getCamera();if(h.cachedStats[l]&&null!=h.cachedStats[l].areaUnit){if(i.invalidated&&(this._throttledCalculateCachedStats(i,E,w,d,e),a instanceof J.VolumeViewport)){const{referencedImageId:e}=i.metadata;for(const t in h.cachedStats)t.startsWith("imageId")&&d.getStackViewports().find((t=>{const n=J.utilities.imageIdToURI(e),i=t.hasImageURI(n),o=J.utilities.imageIdToURI(t.getCurrentImageId());return i&&o!==n}))&&delete h.cachedStats[t]}}else h.cachedStats[l]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(i,E,w,d,e);if(!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),o;let I;if(!Me(r))continue;le(i)||this.editData||null===g||(I=[v[g]]),I&&Ms(t,r,"0",I,{color:f});const C="".concat(r,"-rect");Us(t,r,"0",v[0],v[3],{color:f,lineDash:p,lineWidth:m},C),o=!0;const _=this.getLinkedTextBoxStyle(c,i);if(!_.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const T=this.configuration.getTextLines(h,l);if(!T||0===T.length)continue;if(!h.handles.textBox.hasMoved){const e=od(v);h.handles.textBox.worldPosition=a.canvasToWorld(e)}const b=a.worldToCanvas(h.handles.textBox.worldPosition),D=As(t,r,"1",T,b,v,{},_),{x:S,y,width:O,height:M}=D;h.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([S,y]),topRight:a.canvasToWorld([S+O,y]),bottomLeft:a.canvasToWorld([S,y+M]),bottomRight:a.canvasToWorld([S+O,y+M])}}return o})),te(this,"_getRectangleImageCoordinates",(e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}})),te(this,"_calculateCachedStats",((e,t,n,i,o)=>{const{data:a}=e,{viewportId:r,renderingEngineId:s,viewport:l}=o,d=a.handles.points[0],c=a.handles.points[3],{cachedStats:h}=a,u=Object.keys(h);for(let o=0;o<u.length;o++){const a=u[o],r=this.getTargetIdImage(a,i);if(!r)continue;const{dimensions:s,imageData:p,metadata:f}=r,E=("getScalarData"in r?r.getScalarData():r.scalarData,gd(p,d));E[0]=Math.floor(E[0]),E[1]=Math.floor(E[1]),E[2]=Math.floor(E[2]);const w=gd(p,c);if(w[0]=Math.floor(w[0]),w[1]=Math.floor(w[1]),w[2]=Math.floor(w[2]),this._isInsideVolume(E,w,s)){var g,v,m;this.isHandleOutsideImage=!1;const i=[[Math.min(E[0],w[0]),Math.max(E[0],w[0])],[Math.min(E[1],w[1]),Math.max(E[1],w[1])],[Math.min(E[2],w[2]),Math.max(E[2],w[2])]],{worldWidth:o,worldHeight:s}=ad(t,n,d,c),u=$s(r),I=Math.abs(o*s)/(u*u),C={isPreScaled:sd(l,a),isSuvScaled:this.isSuvScaled(l,a,e.metadata.referencedImageId)},_=rd(f.Modality,e.metadata.referencedImageId,C),T=tl(p,(()=>!0),this.configuration.statsCalculator.statsCallback,i),b=this.configuration.statsCalculator.getStatistics();h[a]={Modality:f.Modality,area:I,mean:null===(g=b[1])||void 0===g?void 0:g.value,stdDev:null===(v=b[2])||void 0===v?void 0:v.value,max:null===(m=b[0])||void 0===m?void 0:m.value,statsArray:b,pointsInShape:T,areaUnit:Js(0,r),modalityUnit:_}}else this.isHandleOutsideImage=!0,h[a]={Modality:f.Modality}}e.invalidated=!1;const p=Q.ANNOTATION_MODIFIED,f={annotation:e,viewportId:r,renderingEngineId:s};return(0,J.triggerEvent)(J.eventTarget,p,f),h})),te(this,"_isInsideVolume",((e,t,n)=>J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n))),this._throttledCalculateCachedStats=js(this._calculateCachedStats,100,{trailing:!0})}}function md(e,t){const n=e.cachedStats[t],{area:i,mean:o,max:a,stdDev:r,areaUnit:s,modalityUnit:l}=n;if(void 0===o)return;const d=[];return d.push("Area: ".concat(al(i)," ").concat(s)),d.push("Mean: ".concat(al(o)," ").concat(l)),d.push("Max: ".concat(al(a)," ").concat(l)),d.push("Std Dev: ".concat(al(r)," ").concat(l)),d}te(vd,"toolName",void 0),vd.toolName="RectangleROI";const pd=vd;class fd extends pd{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}),te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"addNewAnnotation",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getTargetId(r);let u,g;if(r instanceof J.StackViewport)u=h.split("imageId:")[1];else{g=h.split("volumeId:")[1];const e=J.cache.getVolume(g);u=J.utilities.getClosestImageId(e,o,d)}const v=r.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],enabledElement:a,viewUp:[...c],FrameOfReferenceUID:v,referencedImageId:u,toolName:this.getToolName(),volumeId:g},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},segmentationId:null}};Je(m,i);const p=Gl(i,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:p,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Qr(i),e.preventDefault(),Bo(s,p),m})),te(this,"renderAnnotation",((e,t)=>{var n,i;let o=!1;const{viewport:a,renderingEngineId:r}=e,{element:s}=a;let l=Ze(this.getToolName(),s);if(null===(n=l)||void 0===n||!n.length)return o;if(l=this.filterInteractableAnnotationsForElement(s,l),null===(i=l)||void 0===i||!i.length)return o;const d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<l.length;e++){const n=l[e],{annotationUID:i,data:s}=n,{points:c,activeHandleIndex:h}=s.handles,u=c.map((e=>a.worldToCanvas(e)));d.annotationUID=i;const g=this.getStyle("lineWidth",d,n),v=this.getStyle("lineDash",d,n),m=this.getStyle("color",d,n);if(!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),o;const p=Q.ANNOTATION_MODIFIED,f={annotation:n,viewportId:a.id,renderingEngineId:r};let E;((0,J.triggerEvent)(J.eventTarget,p,f),Me(i))&&(le(n)||this.editData||null===h||(E=[u[h]]),E&&Ms(t,i,"0",E,{color:m}),Us(t,i,"0",u[0],u[3],{color:m,lineDash:v,lineWidth:g}),o=!0)}return o}))}}te(fd,"toolName",void 0),fd.toolName="RectangleROIThreshold";const Ed=fd,{transformWorldToIndex:wd}=J.utilities;class Id extends pd{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{numSlicesToPropagate:10}}),te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"addNewAnnotation",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l;let h,u,g;if(r instanceof J.StackViewport)throw new Error("Stack Viewport Not implemented");if(g=this.getTargetId(r).split("volumeId:")[1],u=J.cache.getVolume(g),h=J.utilities.getClosestImageId(u,o,d),!h)throw new Error("This tool does not work on non-acquisition planes");const v=r.getCurrentImageIdIndex(),m=J.utilities.getSpacingInNormalDirection(u,d),p=this._getEndSliceIndex(u,o,m,d),f=r.getFrameOfReferenceUID(),E={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],enabledElement:a,viewUp:[...c],FrameOfReferenceUID:f,referencedImageId:h,toolName:this.getToolName(),volumeId:g,spacingInNormal:m},data:{label:"",startSlice:v,endSlice:p,cachedStats:{projectionPoints:[],projectionPointsImageIds:[h]},handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},labelmapUID:null}};this._computeProjectionPoints(E,u),Je(E,i);const w=Gl(i,this.getToolName());return this.editData={annotation:E,viewportIdsToRender:w,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Qr(i),e.preventDefault(),Bo(s,w),E})),te(this,"renderAnnotation",((e,t)=>{let n=!1;const{viewport:i}=e,o=Ze(this.getToolName(),i.element);if(null==o||!o.length)return n;const a=i.getCurrentImageIdIndex(),r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let s=0;s<o.length;s++){const l=o[s],{annotationUID:d,data:c}=l,{startSlice:h,endSlice:u}=c,{points:g,activeHandleIndex:v}=c.handles,m=g.map((e=>i.worldToCanvas(e)));r.annotationUID=d;const p=this.getStyle("lineWidth",r,l),f=this.getStyle("lineDash",r,l),E=this.getStyle("color",r,l);if(a<Math.min(h,u)||a>Math.max(h,u))continue;l.invalidated&&this._throttledCalculateCachedStats(l,e);let w,I=!1;if(a!==h&&a!==u||(I=!0),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!Me(d))continue;le(l)||this.editData||null===v||!I||(w=[m[v]]),w&&Ms(t,d,"0",w,{color:E});let C=f;I||(C=2),Us(t,d,"0",m[0],m[3],{color:E,lineDash:C,lineWidth:p}),n=!0}return n})),this._throttledCalculateCachedStats=js(this._calculateCachedStatsTool,100,{trailing:!0})}_computeProjectionPoints(e,t){const{data:n,metadata:i}=e,{viewPlaneNormal:o,spacingInNormal:a}=i,{imageData:r}=t,{startSlice:s,endSlice:l}=n,{points:d}=n.handles,c=wd(r,d[0]);if(c[2]!==s)throw new Error("Start slice does not match");const h=ps.vec3.fromValues(c[0],c[1],l),u=ps.vec3.create();r.indexToWorldVec3(c,u);const g=ps.vec3.create();r.indexToWorldVec3(h,g);const v=ps.vec3.distance(u,g),m=[];for(let e=0;e<v;e+=a)m.push(d.map((t=>{const n=ps.vec3.create();return ps.vec3.scaleAndAdd(n,t,o,e),Array.from(n)})));n.cachedStats.projectionPoints=m;const p=[];for(const e of m){const n=J.utilities.getClosestImageId(t,e[0],o);p.push(n)}n.cachedStats.projectionPointsImageIds=p}_calculateCachedStatsTool(e,t){const n=e.data,{viewportId:i,renderingEngineId:o,viewport:a}=t,{cachedStats:r}=n,s=this.getTargetId(a),l=J.cache.getVolume(s.split("volumeId:")[1]);this._computeProjectionPoints(e,l),e.invalidated=!1;const d=Q.ANNOTATION_MODIFIED,c={annotation:e,viewportId:i,renderingEngineId:o};return(0,J.triggerEvent)(J.eventTarget,d,c),r}_getEndSliceIndex(e,t,n,i){const o=this.configuration.numSlicesToPropagate,a=ps.vec3.create();ps.vec3.scaleAndAdd(a,t,i,o*n);const r=n/2,{imageIds:s}=e;let l;for(let e=0;e<s.length;e++){const t=s[e],{imagePositionPatient:n}=J.metaData.get("imagePlaneModule",t),o=ps.vec3.create();ps.vec3.sub(o,a,n);const d=ps.vec3.dot(o,i);Math.abs(d)<r&&(l=e)}return l}}te(Id,"toolName",void 0),Id.toolName="RectangleROIStartEndThreshold";const Cd=Id,_d=function(e,t){const n=e.findIndex((e=>{let[t,n]=e;return t===n}));if(-1===n)throw new Error("3D bounding boxes not supported in an oblique plane");return e[n][0]-=t,e[n][1]+=t,e},Td=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const i=[];return e.forEach((e=>{var o,a;const{data:r}=e,{points:s}=r.handles,{imageData:l,dimensions:d}=t;let c=s;if(null!==(o=r.cachedStats)&&void 0!==o&&o.projectionPoints){const{projectionPoints:e}=r.cachedStats;c=[].concat(...e)}const h=c.map((e=>J.utilities.transformWorldToIndex(l,e)));let u=nl(h,d);!n.numSlicesToProject||null!==(a=r.cachedStats)&&void 0!==a&&a.projectionPoints||(u=_d(u,n.numSlicesToProject)),i.push(u)})),1===i.length?i[0]:i.reduce(((e,t)=>({iMin:Math.min(e.iMin,t.iMin),jMin:Math.min(e.jMin,t.jMin),kMin:Math.min(e.kMin,t.kMin),iMax:Math.max(e.iMax,t.iMax),jMax:Math.max(e.jMax,t.jMax),kMax:Math.max(e.kMax,t.kMax)})),{iMin:1/0,jMin:1/0,kMin:1/0,iMax:-1/0,jMax:-1/0,kMax:-1/0})},bd=function(e,t,n,i){const o=e.map((e=>et(e)));let a;!function(e){const t=[Ed.toolName,Cd.toolName];for(const n of e){const e=n.metadata.toolName;if(!t.includes(e))throw new Error("rectangleROIThresholdVolumeByRange only supports RectangleROIThreshold and RectangleROIStartEndThreshold annotations")}}(o);for(let e=0;e<n.length;e++)n[e].volume.getScalarData().length!==t.getScalarData().length&&0!==e||(a=Td(o,n[e].volume,i));return Ll(t,n,{...i,boundsIJK:a})},Dd=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"mergedLabelmap";e.forEach((t=>{let{direction:n,dimensions:i,origin:o,spacing:a}=t;if(!(J.utilities.isEqual(i,e[0].dimensions)&&J.utilities.isEqual(n,e[0].direction)&&J.utilities.isEqual(a,e[0].spacing)&&J.utilities.isEqual(o,e[0].origin)))throw new Error("labelmaps must have the same size and shape")}));const i=e[0],o=new(0,i.getScalarData().constructor)(i.getScalarData().length);e.forEach((e=>{const n=e.getScalarData();for(let e=0;e<n.length;e++)n[e]===t&&(o[e]=t)}));const a={scalarData:o,metadata:i.metadata,spacing:i.spacing,origin:i.origin,direction:i.direction,dimensions:i.dimensions};return J.volumeLoader.createLocalVolume(a,n,!0)};function Sd(e,t){if(e===ot.Labelmap)return function(e){return e&&"boolean"==typeof e.renderOutline&&"number"==typeof e.outlineWidthActive&&"number"==typeof e.outlineWidthInactive&&"boolean"==typeof e.renderFill&&"boolean"==typeof e.renderFillInactive&&"number"==typeof e.fillAlpha&&"number"==typeof e.fillAlphaInactive&&"number"==typeof e.outlineOpacity&&"number"==typeof e.outlineOpacityInactive}(t);throw new Error("Unknown representation type: ".concat(e))}function yd(e){const{type:t}=e;if(t===ot.Labelmap)return st();throw new Error("Unknown representation type: ".concat(t))}async function Od(e){const{viewportId:t,renderingEngineId:n,options:i}=e;let{segmentationId:o}=e;const a=(0,J.getEnabledElementByIds)(t,n);if(!a)throw new Error("element disabled");const{viewport:r}=a;if(!(r instanceof J.VolumeViewport))throw new Error("Segmentation only supports VolumeViewport");const{uid:s}=r.getDefaultActor();var l;if(void 0===o&&(o="".concat(s,"-based-segmentation-").concat(null!==(l=null==i?void 0:i.volumeId)&&void 0!==l?l:J.utilities.uuidv4().slice(0,8))),i){const e=(0,ne._cloneDeep)(i);await J.volumeLoader.createLocalVolume(e,o)}else{const{uid:e}=r.getDefaultActor();await J.volumeLoader.createAndCacheDerivedVolume(e,{volumeId:o})}return o}function Md(e,t){return e===t}function xd(e,t,n){return(new Array(n+1).join(t)+e).slice(-n)}const Nd=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const i=n.onFlood,o=n.onBoundary,a=n.equals||Md,r=n.diagonals||!1,s=v(t),l=function(e){const t=[],n=function(e){return e.split("").map((function(e){return parseInt(e,10)-1}))};for(let i=0;i<Math.pow(3,e);i+=1){const o=xd(i.toString(3),"0",e);t.push(n(o))}return t}(t.length).filter((function(e){const t=function(e){let t=0;for(let n=0;n<e.length;n+=1)0!==e[n]&&(t+=1);return t}(e);return 0!==t&&(1===t||r)})),d=[],c=[],h={},u={};for(d.push({currentArgs:t});d.length>0;)g(d.pop());return{flooded:c,boundaries:function(){const e=[];for(const t in u)void 0!==u[t]&&e.unshift(u[t]);return e}()};function g(e){const t=e.currentArgs,n=e.previousArgs;!0!==h[t]&&(h[t]=!0,function(e){const t=m(v,[e]);return m(a,[t,s])}(t)?(function(e){c.push(e),i&&i(...e)}(t),function(e){for(let t=0;t<l.length;t+=1){const n=l[t],i=e.slice(0);for(let t=0;t<e.length;t+=1)i[t]+=n[t];d.push({currentArgs:i,previousArgs:e})}}(t)):function(e){u[e]=e,o&&o(...e)}(n))}function v(t){return e(...t)}function m(e,t){try{return e(...t)}catch(e){return}}};function kd(e,t,n){const i=zo(e);if(void 0===i)return;kl(e,n).forEach((e=>{e.configuration.brushSize=t,e.invalidateBrushCursor()}));const o=i.getViewportsInfo(),a=Object.keys(o).map((e=>o[e]));if(!a.length)return;const{renderingEngineId:r}=a[0],s=i.getViewportIds(),l=(0,J.getRenderingEngine)(r);Bo(l,s)}function Rd(e,t){const n=zo(e);if(void 0===n)return;const i=n._toolInstances;if(!Object.keys(i).length)return;const o=kl(e,t)[0];return o?o.configuration.brushSize:void 0}function Pd(e,t){const n=zo(e);if(void 0===n)return;kl(e).forEach((e=>{e.configuration.strategySpecificConfiguration.THRESHOLD_INSIDE_CIRCLE.threshold=t}));const i=n.getViewportsInfo();if(!i.length)return;const{renderingEngineId:o}=i[0],a=n.getViewportIds(),r=(0,J.getRenderingEngine)(o);Bo(r,a)}function Ld(e){const t=zo(e);if(void 0===t)return;const n=t._toolInstances;if(!Object.keys(n).length)return;const i=kl(e)[0];return i?i.configuration.strategySpecificConfiguration.THRESHOLD_INSIDE_CIRCLE.threshold:void 0}const Ad=function(e,t,n,i){const o=e.getScalarData(),{baseVolumeIdx:a,volumeInfoList:r}=Pl(e,n);return r.forEach((e=>{const{volumeSize:n}=e;n===o.length?function(e,t,n){const{referenceValues:i,lower:o,upper:a}=n;for(let n=0;n<e.length;n++)if(e[n]===t){const r=i[n];e[n]=r>=o&&r<=a?t:0}}(o,t,e):function(e,t,n,i,o,a){const{imageData:r,lower:s,upper:l,dimensions:d}=n;let c,h,u;for(let n=0;n<e.length;n++)if(e[n]===t){const g=Rl(r,d,i[o].spacing,i[o].imageData.getPoint(n)),v=e=>{let{value:t}=e;c+=1,t>=u.lower&&t<=u.upper&&(h+=1)};c=0,h=0,u={lower:s,upper:l};let m=!1;tl(r,(()=>!0),v,g),m=0===a?h>0:h===c,e[n]=m?t:0}}(o,t,e,r,a,i)})),pt(e.volumeId),e},Ud=1e-6,Vd=1,Wd=0;function Fd(e,t,n){const[i,o]=n;if(Math.abs(t)<Ud)return e<0;const a=e/t;if(t>0){if(a>o)return 0;a>i&&(n[0]=a)}else{if(a<i)return 0;a<o&&(n[1]=a)}return 1}function Hd(e,t,n,i,o){const[a,r]=e,[s,l]=t,d=s-a,c=l-r;if(void 0===i||void 0===o?(i=e,o=t):(i[0]=e[0],i[1]=e[1],o[0]=t[0],o[1]=t[1]),Math.abs(d)<Ud&&Math.abs(c)<Ud&&a>=n[0]&&a<=n[2]&&r>=n[1]&&r<=n[3])return Vd;const h=[0,1];if(Fd(n[0]-a,d,h)&&Fd(a-n[2],-d,h)&&Fd(n[1]-r,c,h)&&Fd(r-n[3],-c,h)){const[e,t]=h;return t<1&&(o[0]=a+t*d,o[1]=r+t*c),e>0&&(i[0]+=e*d,i[1]+=e*c),Vd}return Wd}function Bd(e){return"number"==typeof e?e?e<0?-1:1:e==e?0:NaN:NaN}function Gd(e,t,n,i){const[o,a]=e,[r,s]=t,[l,d]=n,[c,h]=i,u=s-a,g=o-r,v=r*a-o*s,m=u*l+g*d+v,p=u*c+g*h+v;if(0!==m&&0!==p&&Bd(m)===Bd(p))return;const f=h-d,E=l-c,w=c*d-l*h,I=f*o+E*a+w,C=f*r+E*s+w;if(0!==I&&0!==C&&Bd(I)===Bd(C))return;const _=u*E-f*g;let T;T=g*w-E*v;const b=T/_;return T=f*v-u*w,[b,T/_]}function qd(e,t,n){const i=[],o=function(e,t,n){let i,o;const a=[];arguments.length>3&&void 0!==arguments[3]&&!arguments[3]?(o=0,i=1):(o=e.length-1,i=0);for(let r=i;r<e.length;r++)Kd(t,n,e[o],e[r])&&a.push([o,r]),o=r;return a}(e,t,n,!(arguments.length>3&&void 0!==arguments[3])||arguments[3]);for(let a=0;a<o.length;a++){const r=Zd(t,n,e[o[a][0]],e[o[a][1]]);i.push(r)}return i}function jd(e,t,n){let i,o;arguments.length>3&&void 0!==arguments[3]&&!arguments[3]?(o=0,i=1):(o=e.length-1,i=0);for(let a=i;a<e.length;a++){if(Kd(t,n,e[o],e[a]))return[o,a];o=a}}function zd(e,t,n){let i,o;arguments.length>3&&void 0!==arguments[3]&&!arguments[3]?(o=0,i=1):(o=e.length-1,i=0);const a=[];for(let r=i;r<e.length;r++){const i=e[o],s=e[r];Kd(t,n,i,s)&&a.push([o,r]),o=r}if(0===a.length)return;const r=[];a.forEach((n=>{const i=[e[n[0]],e[n[1]]],o=[(i[0][0]+i[1][0])/2,(i[0][1]+i[1][1])/2];r.push(ps.vec2.distance(o,t))}));const s=Math.min(...r);return{segment:a[r.indexOf(s)],distance:s}}function Kd(e,t,n,i){let o=!1;const a=[Yd(e,t,n),Yd(e,t,i),Yd(n,i,e),Yd(n,i,t)];return a[0]!==a[1]&&a[2]!==a[3]||((0===a[0]&&Xd(e,n,t)||0===a[1]&&Xd(e,i,t)||0===a[2]&&Xd(n,e,i)||0===a[3]&&Xd(n,t,i))&&(o=!0),o)}function Yd(e,t,n){const i=(t[1]-e[1])*(n[0]-t[0])-(t[0]-e[0])*(n[1]-t[1]);return 0===i?0:i>0?1:2}function Xd(e,t,n){return t[0]<=Math.max(e[0],n[0])&&t[0]>=Math.min(e[0],n[0])&&t[1]<=Math.max(e[1],n[1])&&t[1]>=Math.min(e[1],n[1])}function Zd(e,t,n,i){const o=(i[1]-n[1])*(t[0]-e[0])-(i[0]-n[0])*(t[1]-e[1]);if(0==o)return;let a=e[1]-n[1],r=e[0]-n[0];const s=(i[0]-n[0])*a-(i[1]-n[1])*r,l=(t[0]-e[0])*a-(t[1]-e[1])*r;return a=s/o,r=l/o,[e[0]+a*(t[0]-e[0]),e[1]+a*(t[1]-e[1])]}const Jd=.001,$d=(e,t)=>{let n,i,o;if(e instanceof J.StackViewport){const t=e.getImageData();i=t.direction.slice(0,3),o=t.direction.slice(3,6),n=t.spacing}else{const t=e.getImageData(),{direction:a,spacing:r}=t,{viewPlaneNormal:s,viewUp:l}=e.getCamera(),d=a.slice(0,3),c=a.slice(3,6),h=a.slice(6,9),u=ps.vec3.create();ps.vec3.cross(u,l,s);const g=Math.abs(ps.vec3.dot(u,d)),v=Math.abs(ps.vec3.dot(u,c)),m=Math.abs(ps.vec3.dot(u,h));let p;if(Math.abs(1-g)<Jd)p=r[0],i=d;else if(Math.abs(1-v)<Jd)p=r[1],i=c;else{if(!(Math.abs(1-m)<Jd))throw new Error("No support yet for oblique plane planar contours");p=r[2],i=h}const f=Math.abs(ps.vec3.dot(l,d)),E=Math.abs(ps.vec3.dot(l,c)),w=Math.abs(ps.vec3.dot(l,h));let I;if(Math.abs(1-f)<Jd)I=r[0],o=d;else if(Math.abs(1-E)<Jd)I=r[1],o=c;else{if(!(Math.abs(1-w)<Jd))throw new Error("No support yet for oblique plane planar contours");I=r[2],o=h}n=[p,I]}return{spacing:[n[0]/t,n[1]/t],xDir:i,yDir:o}},Qd=(e,t,n)=>ps.vec2.dist(e,t)<n,ec=(e,t,n,i)=>{const{xDir:o,yDir:a,spacing:r}=i,s=(0,J.getEnabledElement)(e),{viewport:l}=s,d=l.canvasToWorld(t[t.length-1]),c=l.canvasToWorld(n),h=ps.vec3.create();ps.vec3.subtract(h,c,d);const u=Math.abs(ps.vec3.dot(h,o)),g=Math.abs(ps.vec3.dot(h,a)),v=Math.max(Math.floor(u/r[0]),Math.floor(g/r[0]));if(v>1){const e=t[t.length-1],i=ps.vec2.dist(e,n),o=ps.vec2.create();ps.vec2.subtract(o,n,e),ps.vec2.set(o,o[0]/i,o[1]/i);const a=i/v;for(let n=1;n<=v;n++)t.push([e[0]+a*o[0]*n,e[1]+a*o[1]*n])}else t.push(n);return v},tc=(e,t,n,i)=>{const o=[e[0]-t[0],e[1]-t[1]],a=[n[0]-t[0],n[1]-t[1]],r=o[0]*a[0]+o[1]*a[1];if(r<0)return!1;const s=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(0===s)return!1;const l=r/s,d=[a[0]/s,a[1]/s],c=[d[0]*l,d[1]*l],h=[t[0]+c[0],t[1]+c[1]];return!(ps.vec2.distance(e,h)>i||ps.vec2.distance(t,h)>ps.vec2.distance(t,n))};function nc(e){const t=e.length;let n=0,i=t-1;for(let o=0;o<t;o++)n+=(e[i][0]+e[o][0])*(e[i][1]-e[o][1]),i=o;return Math.abs(n/2)}function ic(e,t){if(e.length!==t.length)throw Error("Both points should have the same dimensionality");const[n,i,o=0]=e,[a,r,s=0]=t;return Math.sqrt(Math.pow(n-a,2)+Math.pow(i-r,2)+Math.pow(o-s,2))}var oc=I(807),ac=I.n(oc);function rc(e,t,n,i){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.25;const a=e.getCamera(),{position:r}=a,{spacingInNormalDirection:s}=J.utilities.getTargetVolumeAndSpacingInNormalDir(e,a,n),l=s*o,d=e.getBounds(),c=d[0],h=d[1],u=[0,0,0];let g,v=[0,0,0];ac().subtract(t,r,u);for(let t=c;t<=h;t+=l){v=[t,0,0];const n=(t-r[0])/u[0];if(v[1]=n*u[1]+r[1],v[2]=n*u[2]+r[2],sc(v,d)){const t=i(e.getIntensityFromWorld(v),v);t&&(g=t)}}return g}const sc=function(e,t){const[n,i,o,a,r,s]=t;return e[0]>n&&e[0]<i&&e[1]>o&&e[1]<a&&e[2]>r&&e[2]<s},lc={filterAnnotationsWithinSlice:zl,getWorldWidthAndHeightFromCorners:ad,filterAnnotationsForDisplay:Yl,getPointInLineOfSightWithCriteria:rc};function dc(e){let t="";const n=e[0]<0?"R":"L",i=e[1]<0?"A":"P",o=e[2]<0?"F":"H",a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],r=1e-4;for(let e=0;e<3;e++)if(a[0]>r&&a[0]>a[1]&&a[0]>a[2])t+=n,a[0]=0;else if(a[1]>r&&a[1]>a[0]&&a[1]>a[2])t+=i,a[1]=0;else if(a[2]>r&&a[2]>a[0]&&a[2]>a[1])t+=o,a[2]=0;else if(a[0]>r&&a[1]>r&&a[0]===a[1])t+=n+i,a[0]=0,a[1]=0;else if(a[0]>r&&a[2]>r&&a[0]===a[2])t+=n+o,a[0]=0,a[2]=0;else{if(!(a[1]>r&&a[2]>r&&a[1]===a[2]))break;t+=i+o,a[1]=0,a[2]=0}return t}function cc(e){let t=e.replace("H","f");return t=t.replace("F","h"),t=t.replace("R","l"),t=t.replace("L","r"),t=t.replace("A","p"),t=t.replace("P","a"),t=t.toUpperCase(),t}var hc=function(e){return e.CLIP_STOPPED="CORNERSTONE_CINE_TOOL_STOPPED",e.CLIP_STARTED="CORNERSTONE_CINE_TOOL_STARTED",e}(hc||{});const uc=hc,gc={};function vc(e,t){const n=(0,J.getEnabledElement)(e),{viewportId:i}=n;gc[i]=t}function mc(e){const t=(0,J.getEnabledElement)(e),{viewportId:n}=t;return gc[n]}const{ViewportStatus:pc}=J.Enums,{triggerEvent:fc}=J.utilities,Ec=!0,wc=!0,Ic=new Map;function Cc(e,t){var n;let i,o;if(void 0===e)throw new Error("playClip: element must not be undefined");const a=(0,J.getEnabledElement)(e);if(!a)throw new Error("playClip: element must be a valid Cornerstone enabled element");t.dynamicCineEnabled=null===(n=t.dynamicCineEnabled)||void 0===n||n;const{viewport:r}=a,s=Dc(r),l=function(e,t){var n;if(e instanceof J.StackViewport)return function(e,t){const n=e.getImageIds();return{get numScrollSteps(){return n.length},get currentStepIndex(){return e.getTargetImageIdIndex()},get frameTimeVectorEnabled(){return!0},waitForRenderedCount:0,scroll(n){this.waitForRenderedCount<=t&&e.viewportStatus!==pc.RENDERED?this.waitForRenderedCount++:(this.waitForRenderedCount=0,Es(e,{delta:n,debounceLoading:Ec}))}}}(e,null!==(n=t.waitForRendered)&&void 0!==n?n:30);if(e instanceof J.VolumeViewport){const n=Dc(e);return t.dynamicCineEnabled&&null!=n&&n.isDynamicVolume()?function(e){return{get numScrollSteps(){return e.numTimePoints},get currentStepIndex(){return e.timePointIndex},get frameTimeVectorEnabled(){return!1},scroll(t){e.timePointIndex+=t}}}(n):function(e,t){const{volumeId:n}=t,i={viewPlaneNormal:ps.vec3.create(),scrollInfo:null},o=()=>{const t=e.getCamera();if(!i.scrollInfo||!ps.vec3.equals(t.viewPlaneNormal,i.viewPlaneNormal)){const o=J.utilities.getVolumeViewportScrollInfo(e,n);i.viewPlaneNormal=t.viewPlaneNormal,i.scrollInfo=o}return i.scrollInfo};return{get numScrollSteps(){return o().numScrollSteps},get currentStepIndex(){return o().currentStepIndex},get frameTimeVectorEnabled(){const n=e.getCamera(),i=t.direction.slice(6,9).map((e=>-e)),o=ps.vec3.dot(i,n.viewPlaneNormal);return ps.glMatrix.equals(o,1)},scroll(t){o().currentStepIndex+=t,Es(e,{delta:t})}}}(e,n)}throw new Error("Unknown viewport type")}(r,t);let d=mc(e);const c=t.dynamicCineEnabled&&(null==s?void 0:s.isDynamicVolume());var h,u,g,v;if(c&&bc(e),d?Tc(e,c):(d={intervalId:void 0,framesPerSecond:30,lastFrameTimeStamp:void 0,ignoreFrameTimeVector:!1,usingFrameTimeVector:!1,frameTimeVector:null!==(h=t.frameTimeVector)&&void 0!==h?h:void 0,speed:null!==(u=t.frameTimeVectorSpeedMultiplier)&&void 0!==u?u:1,reverse:null!==(g=t.reverse)&&void 0!==g&&g,loop:null===(v=t.loop)||void 0===v||v},vc(e,d)),d.dynamicCineEnabled=t.dynamicCineEnabled,(t.framesPerSecond<0||t.framesPerSecond>0)&&(d.framesPerSecond=Number(t.framesPerSecond),d.reverse=d.framesPerSecond<0,d.ignoreFrameTimeVector=!0),!0!==d.ignoreFrameTimeVector&&d.frameTimeVector&&d.frameTimeVector.length===l.numScrollSteps&&l.frameTimeVectorEnabled){const{timeouts:e,isTimeVarying:t}=function(e,t){let n,i,o,a=0;const r=e.length,s=[];let l=!1;for(("number"!=typeof t||t<=0)&&(t=1),n=1;n<r;n++)o=Number(e[n])/t|0,s.push(o),1===n?i=o:o!==i&&(l=!0),a+=o;return s.length>0&&(o=l?a/s.length|0:s[0],s.push(o)),{timeouts:s,isTimeVarying:l}}(d.frameTimeVector,d.speed);i=e,o=t}const m=()=>{const{numScrollSteps:t,currentStepIndex:n}=l;let i=n+(d.reverse?-1:1);if(!wc&&(i<0||i>=t)){Tc(e,c);const t={element:e};return void fc(e,uc.CLIP_STOPPED,t)}i>=t?i=0:i<0&&(i=t-1);const o=i-n;o&&l.scroll(o)};c&&Ic.set(s.volumeId,e),i&&i.length>0&&o?(d.usingFrameTimeVector=!0,d.intervalId=window.setTimeout((function e(){d.intervalId=window.setTimeout(e,i[l.currentStepIndex]),m()}),0)):(d.usingFrameTimeVector=!1,d.intervalId=window.setInterval(m,1e3/Math.abs(d.framesPerSecond)));const p={element:e};fc(e,uc.CLIP_STARTED,p)}function _c(e){Tc(e,!0)}function Tc(e,t){const n=(0,J.getEnabledElement)(e);if(!n)return;const{viewport:i}=n,o=mc(i.element);o&&function(e){const t=e.intervalId;void 0!==t&&(e.intervalId=void 0,e.usingFrameTimeVector?clearTimeout(t):clearInterval(t))}(o),t&&i instanceof J.BaseVolumeViewport&&bc(e)}function bc(e){const{viewport:t}=(0,J.getEnabledElement)(e),n=Dc(t);if(null!=n&&n.isDynamicVolume()){const t=Ic.get(n.volumeId);Ic.delete(n.volumeId),t&&t!==e&&_c(t)}}function Dc(e){const t=function(e){return e.getActors().map((e=>J.cache.getVolume(e.uid))).filter((e=>!!e))}(e),n=t.find((e=>e.isDynamicVolume()));return null!=n?n:t[0]}function Sc(e){var t=e.length-1;return function(n){var i=n<=0?n=0:n>=1?(n=1,t-1):Math.floor(n*t),o=e[i],a=e[i+1],r=i>0?e[i-1]:2*o-a,s=i<t-1?e[i+2]:2*a-o;return function(e,t,n,i,o){var a=e*e,r=a*e;return((1-3*e+3*a-r)*t+(4-6*a+3*r)*n+(1+3*e+3*a-3*r)*i+r*o)/6}((n-i/t)*t,r,o,a,s)}}function yc(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e(i/(t-1));return n}function Oc(e){return e.length}function Mc(){return function(e){if(!(o=e.length))return[];for(var t=-1,n=function(e,t){let n;if(void 0===t)for(const t of e)null!=t&&(n>t||void 0===n&&t>=t)&&(n=t);else{let i=-1;for(let o of e)null!=(o=t(o,++i,e))&&(n>o||void 0===n&&o>=o)&&(n=o)}return n}(e,Oc),i=new Array(n);++t<n;)for(var o,a=-1,r=i[t]=new Array(o);++a<o;)r[a]=e[a][t];return i}(arguments)}function xc(e,t,n,i){var o,a;const r=n-t+1,s=null!==(o=Math.floor(i/100*r))&&void 0!==o?o:1,l=null!==(a=Math.floor(r/s))&&void 0!==a?a:1;if(isNaN(r)||!r||!l)return e;if(r/l<2)return e;const d=Math.max(0,t),c=Math.min(e.length-1,n),h=e.slice(0,d),u=e.slice(c+1,e.length);return[...h,...function(e,t){if(!t||0===t.length||t.length===e.length)return e;const n=t[t.length-1]-t[0]+1,i=Sc(t.map((t=>e[t][0]))),o=Sc(t.map((t=>e[t][1])));if(3===(null===(a=e[0])||void 0===a?void 0:a.length)){const a=Sc(t.map((t=>e[t][2])));return Mc(yc(i,n),yc(o,n),yc(a,n))}return Mc(yc(i,n),yc(o,n));var a}(e,function(e,t){const n=[],[i,o]=t,a=o-i+1,r=Math.floor(a/e);let s=0,l=Math.round((a-1)/(r-1)*s)+i;for(;l<=o;)n.push(l),s++,l=Math.round((a-1)/(r-1)*s)+i;return n}(l,[d,c])),...u]}function Nc(e){var t,n;return!0===(null==e||null===(t=e.interpolation)||void 0===t?void 0:t.interpolateOnAdd)||!0===(null==e||null===(n=e.interpolation)||void 0===n?void 0:n.interpolateOnEdit)}function kc(e,t,n){return(e+t+n)%t}function Rc(e,t,n,i){const[,o,a]=e,[,r,s]=t,l=a.length,d=s.length;let c=e[0],h=t[0];if(!(a[c]&&s[h]&&a[o]&&s[r]))return[void 0,void 0];for(;c!==o&&h!==r;){if(n(s[h],a[c]))return[c,h];c=kc(c,l,i),h=kc(h,d,i)}return[void 0,void 0]}function Pc(e,t,n){const{interpolation:i}=e,o=t;if(i){const{knotsRatioPercentageOnAdd:e,knotsRatioPercentageOnEdit:o,interpolateOnAdd:a=!1,interpolateOnEdit:r=!1}=i,s=n?o:e;if(n?r:a){const[e,i]=n?function(e,t){const[n,i]=function(e,t){for(let n=0;n<e.length;n++)for(let i=0;i<t.length;i++)if(0===ic(e[n],t[i]))return[n,i]}(e,t)||[],o=(e,t)=>!1===function(e,t){return ic(e,t)<.001}(e,t),[a,r]=Rc([kc(n,e.length,1),n,e],[kc(i,t.length,1),i,t],o,1),[s]=Rc([kc(a,e.length,-1),a,e],[kc(r,t.length,-1),r,t],o,-1);return[a,s]}(t,n):[0,t.length-1];return t[e]&&t[i]?xc(t,e,i,s):t}}return o}function Lc(e,t){const n=e[0],i=e[e.length-1],o=ps.vec2.create();ps.vec2.set(o,i[0]-n[0],i[1]-n[1]),ps.vec2.normalize(o,o);const a=ps.vec2.create(),r=ps.vec2.create();ps.vec2.set(a,-o[1],o[0]),ps.vec2.set(r,o[1],-o[0]);const s=[(n[0]+i[0])/2,(n[1]+i[1])/2],l={dist:0,index:null};for(let t=0;t<e.length;t++){const n=e[t],i=ps.vec2.dist(n,s);i>l.dist&&(l.dist=i,l.index=t)}return[e[l.index],s].map(t.canvasToWorld)}const{addCanvasPointsToArray:Ac,pointsAreWithinCloseContourProximity:Uc,getFirstIntersectionWithPolyline:Vc,getSubPixelSpacingAndXYDirections:Wc}=S;function Fc(e,t,n){this.isDrawing=!0;const i=e.detail,{currentPoints:o,element:a}=i,r=o.canvas,s=(0,J.getEnabledElement)(a),{viewport:l}=s,{spacing:d,xDir:c,yDir:h}=Wc(l,this.configuration.subPixelResolution);this.drawData={canvasPoints:[r],polylineIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:d,xDir:c,yDir:h,movingTextBox:!1},He.isInteractingWithTool=!0,a.addEventListener(Q.MOUSE_UP,this.mouseUpDrawCallback),a.addEventListener(Q.MOUSE_DRAG,this.mouseDragDrawCallback),a.addEventListener(Q.MOUSE_CLICK,this.mouseUpDrawCallback),a.addEventListener(Q.TOUCH_END,this.mouseUpDrawCallback),a.addEventListener(Q.TOUCH_DRAG,this.mouseDragDrawCallback),a.addEventListener(Q.TOUCH_TAP,this.mouseUpDrawCallback),Qr(a)}function Hc(e){He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this.mouseUpDrawCallback),e.removeEventListener(Q.MOUSE_DRAG,this.mouseDragDrawCallback),e.removeEventListener(Q.MOUSE_CLICK,this.mouseUpDrawCallback),e.removeEventListener(Q.TOUCH_END,this.mouseUpDrawCallback),e.removeEventListener(Q.TOUCH_DRAG,this.mouseDragDrawCallback),e.removeEventListener(Q.TOUCH_TAP,this.mouseUpDrawCallback),$r(e)}function Bc(e){const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=n.canvas,r=(0,J.getEnabledElement)(i),{renderingEngine:s,viewport:l}=r,{annotation:d,viewportIdsToRender:c,xDir:h,yDir:u,spacing:g,movingTextBox:v}=this.commonData,{polylineIndex:m,canvasPoints:p}=this.drawData,f=p[p.length-1],E=l.canvasToWorld(f),w=ps.vec3.create();ps.vec3.subtract(w,o,E);const I=Math.abs(ps.vec3.dot(w,h)),C=Math.abs(ps.vec3.dot(w,u));if(!(I<=g[0]&&C<=g[1])){if(v){this.isDrawing=!1;const{deltaPoints:e}=t,n=e.world,{textBox:i}=d.data.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else{const t=this.findCrossingIndexDuringCreate(e);if(void 0!==t)this.applyCreateOnCross(e,t);else{const e=Ac(i,p,a,this.commonData);this.drawData.polylineIndex=m+e}}Bo(s,c)}}function Gc(e){const{allowOpenContours:t}=this.configuration,{canvasPoints:n}=this.drawData,i=n[0],o=n[n.length-1],a=e.detail,{element:r}=a;t&&!Uc(i,o,this.configuration.closeContourProximity)?this.completeDrawOpenContour(r):this.completeDrawClosedContour(r)}function qc(e){this.removeCrossedLinesOnCompleteDraw();const{canvasPoints:t}=this.drawData;if(this.haltDrawing(e,t))return!1;const{annotation:n,viewportIdsToRender:i}=this.commonData,o=(0,J.getEnabledElement)(e),{viewport:a,renderingEngine:r}=o;Ac(e,t,t[0],this.commonData),t.pop();const s=(Nc(this.configuration)?Pc(this.configuration,t):t).map((e=>a.canvasToWorld(e)));n.data.polyline=s,n.data.isOpenContour=!1;const{textBox:l}=n.data.handles;return l.hasMoved||this.triggerAnnotationCompleted(n),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,Bo(r,i),this.deactivateDraw(e),!0}function jc(){const{canvasPoints:e}=this.drawData,t=e.length,n=[e[0],e[t-1]],i=e.slice(0,-1).slice(1),o=Vc(i,n[0],n[1],!1);if(o){const t=o[1];this.drawData.canvasPoints=e.splice(0,t)}}function zc(e){const{canvasPoints:t}=this.drawData;if(this.haltDrawing(e,t))return!1;const{annotation:n,viewportIdsToRender:i}=this.commonData,o=(0,J.getEnabledElement)(e),{viewport:a,renderingEngine:r}=o,s=(Nc(this.configuration)?Pc(this.configuration,t):t).map((e=>a.canvasToWorld(e)));n.data.polyline=s,n.data.isOpenContour=!0;const{textBox:l}=n.data.handles;return n.data.handles.points=[s[0],s[s.length-1]],n.data.isOpenUShapeContour&&(n.data.openUShapeContourVectorToPeak=Lc(t,a)),l.hasMoved||this.triggerAnnotationCompleted(n),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,Bo(r,i),this.deactivateDraw(e),!0}function Kc(e){const t=e.detail,{currentPoints:n,lastPoints:i}=t,o=n.canvas,a=i.canvas,{canvasPoints:r}=this.drawData,s=r.slice(0,-1),l=Vc(s,o,a,!1);if(void 0!==l)return l[0]}function Yc(e,t){const n=e.detail,{element:i}=n,{canvasPoints:o}=this.drawData,{annotation:a,viewportIdsToRender:r}=this.commonData;Ac(i,o,o[t],this.commonData),o.pop();for(let e=0;e<t;e++)o.shift();this.completeDrawClosedContour(i)&&this.activateClosedContourEdit(e,a,r)}function Xc(e){const{allowOpenContours:t}=this.configuration,{canvasPoints:n}=this.drawData,i=n[0],o=n[n.length-1];t&&!Uc(i,o,this.configuration.closeContourProximity)?this.completeDrawOpenContour(e):this.completeDrawClosedContour(e)}function Zc(e,t){const{subPixelResolution:n}=this.configuration;if(function(e,t){const n=Math.max(3*t,3);return e.length<n}(t,n)){const{annotation:t,viewportIdsToRender:n}=this.commonData,i=(0,J.getEnabledElement)(e),{renderingEngine:o}=i;return Qe(t.annotationUID),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,Bo(o,n),this.deactivateDraw(e),!0}return!1}const Jc=function(e){e.activateDraw=Fc.bind(e),e.deactivateDraw=Hc.bind(e),e.applyCreateOnCross=Yc.bind(e),e.findCrossingIndexDuringCreate=Kc.bind(e),e.completeDrawOpenContour=zc.bind(e),e.removeCrossedLinesOnCompleteDraw=jc.bind(e),e.mouseDragDrawCallback=Bc.bind(e),e.mouseUpDrawCallback=Gc.bind(e),e.completeDrawClosedContour=qc.bind(e),e.cancelDrawing=Xc.bind(e),e.haltDrawing=Zc.bind(e)},{addCanvasPointsToArray:$c,getFirstIntersectionWithPolyline:Qc}=S;function eh(e,t){const n=e.detail,{element:i,currentPoints:o,lastPoints:a}=n,r=o.canvas,s=a.canvas,{editCanvasPoints:l,prevCanvasPoints:d}=this.editData,c=Qc(d,r,s,t);if(c)this.editData.startCrossingIndex=c[0],this.removePointsUpUntilFirstCrossing(t);else if(d.length>=2)if(l.length>this.configuration.checkCanvasEditFallbackProximity){const e=l[0],t=[];for(let n=0;n<d.length;n++){const i=d[n],o=ps.vec2.distance(i,e);t.push({distance:o,index:n})}t.sort(((e,t)=>e.distance-t.distance));const n=[t[0],t[1]],i=Math.min(n[0].index,n[1].index);this.editData.startCrossingIndex=i}else{const e=ps.vec2.create();ps.vec2.subtract(e,l[1],l[0]),ps.vec2.normalize(e,e);const n=6,o=[l[0][0]-e[0]*n,l[0][1]-e[1]*n],a=Qc(d,o,l[0],t);if(a){const e=[o];$c(i,e,l[0],this.commonData),l.unshift(...e),this.removePointsUpUntilFirstCrossing(t),this.editData.editIndex=l.length-1,this.editData.startCrossingIndex=a[0]}}}function th(e){const{editCanvasPoints:t,prevCanvasPoints:n}=this.editData;let i=0;for(let o=0;o<t.length-1;o++){const a=[t[o],t[o+1]];if(i++,Qc(n,a[0],a[1],e))break}t.splice(0,i),this.editData.editIndex=t.length-1}function nh(e,t){const n=e.detail,{currentPoints:i,lastPoints:o}=n,a=i.canvas,r=o.canvas,{prevCanvasPoints:s}=this.editData;return!!Qc(s,a,r,t)}function ih(e){const{prevCanvasPoints:t,editCanvasPoints:n}=this.editData;for(let i=n.length-1;i>0;i--){const o=[n[i],n[i-1]],a=!!Qc(t,o[0],o[1],e);if(n.pop(),a)break}}function oh(){const{editCanvasPoints:e,prevCanvasPoints:t,startCrossingIndex:n}=this.editData;if(void 0===n)return;const i=e[e.length-1],o=[];for(let e=0;e<t.length;e++){const n=t[e],a=ps.vec2.distance(n,i);o.push({distance:a,index:e})}o.sort(((e,t)=>e.distance-t.distance));const a=e.slice(0,-1);for(let n=0;n<o.length;n++){const{index:i}=o[n],r=t[i],s=e[e.length-1];if(!Qc(a,r,s,!1))return i}return-1}function ah(e){const t=e.detail,{currentPoints:n,lastPoints:i}=t,o=n.canvas,a=i.canvas,{editCanvasPoints:r}=this.editData,s=r.slice(0,-2),l=Qc(s,o,a,!1);if(!l)return;const d=l[0],c=r.length-d;for(let e=0;e<c;e++)r.pop()}const rh=function(e){e.checkForFirstCrossing=eh.bind(e),e.removePointsUpUntilFirstCrossing=th.bind(e),e.checkForSecondCrossing=nh.bind(e),e.findSnapIndex=oh.bind(e),e.removePointsAfterSecondCrossing=ih.bind(e),e.checkAndRemoveCrossesOnEditLine=ah.bind(e)},{getSubPixelSpacingAndXYDirections:sh,addCanvasPointsToArray:lh,calculateAreaOfPoints:dh}=S;function ch(e,t,n){this.isEditingClosed=!0;const i=e.detail,{currentPoints:o,element:a}=i,r=o.canvas,s=(0,J.getEnabledElement)(a),{viewport:l}=s,d=t.data.polyline.map(l.worldToCanvas),{spacing:c,xDir:h,yDir:u}=sh(l,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:d,editCanvasPoints:[r],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:c,xDir:h,yDir:u,movingTextBox:!1},He.isInteractingWithTool=!0,a.addEventListener(Q.MOUSE_UP,this.mouseUpClosedContourEditCallback),a.addEventListener(Q.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),a.addEventListener(Q.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),a.addEventListener(Q.TOUCH_END,this.mouseUpClosedContourEditCallback),a.addEventListener(Q.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),a.addEventListener(Q.TOUCH_TAP,this.mouseUpClosedContourEditCallback),Qr(a)}function hh(e){He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this.mouseUpClosedContourEditCallback),e.removeEventListener(Q.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(Q.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),e.removeEventListener(Q.TOUCH_END,this.mouseUpClosedContourEditCallback),e.removeEventListener(Q.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(Q.TOUCH_TAP,this.mouseUpClosedContourEditCallback),$r(e)}function uh(e){const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=n.canvas,r=(0,J.getEnabledElement)(i),{renderingEngine:s,viewport:l}=r,{viewportIdsToRender:d,xDir:c,yDir:h,spacing:u}=this.commonData,{editIndex:g,editCanvasPoints:v,startCrossingIndex:m}=this.editData,p=v[v.length-1],f=l.canvasToWorld(p),E=ps.vec3.create();ps.vec3.subtract(E,o,f);const w=Math.abs(ps.vec3.dot(E,c)),I=Math.abs(ps.vec3.dot(E,h));if(w<=u[0]&&I<=u[1])return;void 0!==m&&this.checkAndRemoveCrossesOnEditLine(e);const C=g+lh(i,v,a,this.commonData);this.editData.editIndex=C,void 0===m&&v.length>1&&this.checkForFirstCrossing(e,!0),this.editData.snapIndex=this.findSnapIndex(),-1!==this.editData.snapIndex?(this.editData.fusedCanvasPoints=this.fuseEditPointsWithClosedContour(e),void 0!==m&&this.checkForSecondCrossing(e,!0)&&(this.removePointsAfterSecondCrossing(!0),this.finishEditAndStartNewEdit(e)),Bo(s,d)):this.finishEditAndStartNewEdit(e)}function gh(e){const t=e.detail,{element:n}=t,i=(0,J.getEnabledElement)(n),{viewport:o,renderingEngine:a}=i,{annotation:r,viewportIdsToRender:s}=this.commonData,{fusedCanvasPoints:l,editCanvasPoints:d}=this.editData,c=l.map((e=>o.canvasToWorld(e)));r.data.polyline=c,r.data.isOpenContour=!1,this.triggerAnnotationModified(r,i);const h=d.pop();this.editData={prevCanvasPoints:l,editCanvasPoints:[h],startCrossingIndex:void 0,editIndex:0,snapIndex:void 0},Bo(a,s)}function vh(e){const{prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:i,snapIndex:o}=this.editData;if(void 0===i||void 0===o)return;const a=e.detail,{element:r}=a,s=[...n];let l,d;lh(r,s,t[o],this.commonData),s.length>n.length&&s.pop(),i>o?(l=o,d=i):(l=i,d=o);const c=ps.vec2.distance(t[l],s[0]),h=ps.vec2.distance(t[l],s[s.length-1]),u=ps.vec2.distance(t[d],s[0]),g=ps.vec2.distance(t[d],s[s.length-1]),v=[];for(let e=0;e<l;e++){const n=t[e];v.push([n[0],n[1]])}let m=c+g,p=h+u;if(m<p)for(let e=0;e<s.length;e++){const t=s[e];v.push([t[0],t[1]])}else for(let e=s.length-1;e>=0;e--){const t=s[e];v.push([t[0],t[1]])}for(let e=d;e<t.length;e++){const n=t[e];v.push([n[0],n[1]])}const f=[];for(let e=l;e<d;e++){const n=t[e];f.push([n[0],n[1]])}if(m=u+h,p=g+c,m<p)for(let e=0;e<s.length;e++){const t=s[e];f.push([t[0],t[1]])}else for(let e=s.length-1;e>=0;e--){const t=s[e];f.push([t[0],t[1]])}return dh(v)>dh(f)?v:f}function mh(e){const t=e.detail,{element:n}=t;this.completeClosedContourEdit(n)}function ph(e){const t=(0,J.getEnabledElement)(e),{viewport:n,renderingEngine:i}=t,{annotation:o,viewportIdsToRender:a}=this.commonData,{fusedCanvasPoints:r,prevCanvasPoints:s}=this.editData;if(r){const e=(Nc(this.configuration)?Pc(this.configuration,r,s):r).map((e=>n.canvasToWorld(e)));o.data.polyline=e,o.data.isOpenContour=!1,o.invalidated=!0,this.triggerAnnotationModified(o,t)}this.isEditingClosed=!1,this.editData=void 0,this.commonData=void 0,Bo(i,a),this.deactivateClosedContourEdit(e)}function fh(e){this.completeClosedContourEdit(e)}const Eh=function(e){e.activateClosedContourEdit=ch.bind(e),e.deactivateClosedContourEdit=hh.bind(e),e.mouseDragClosedContourEditCallback=uh.bind(e),e.mouseUpClosedContourEditCallback=mh.bind(e),e.finishEditAndStartNewEdit=gh.bind(e),e.fuseEditPointsWithClosedContour=vh.bind(e),e.cancelClosedContourEdit=fh.bind(e),e.completeClosedContourEdit=ph.bind(e)},{addCanvasPointsToArray:wh,getSubPixelSpacingAndXYDirections:Ih}=S;function Ch(e,t,n){this.isEditingOpen=!0;const i=e.detail,{currentPoints:o,element:a}=i,r=o.canvas,s=(0,J.getEnabledElement)(a),{viewport:l}=s,d=t.data.polyline.map(l.worldToCanvas),{spacing:c,xDir:h,yDir:u}=Ih(l,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:d,editCanvasPoints:[r],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:c,xDir:h,yDir:u,movingTextBox:!1},He.isInteractingWithTool=!0,a.addEventListener(Q.MOUSE_UP,this.mouseUpOpenContourEditCallback),a.addEventListener(Q.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),a.addEventListener(Q.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),a.addEventListener(Q.TOUCH_END,this.mouseUpOpenContourEditCallback),a.addEventListener(Q.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),a.addEventListener(Q.TOUCH_TAP,this.mouseUpOpenContourEditCallback),Qr(a)}function _h(e){He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this.mouseUpOpenContourEditCallback),e.removeEventListener(Q.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(Q.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),e.removeEventListener(Q.TOUCH_END,this.mouseUpOpenContourEditCallback),e.removeEventListener(Q.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(Q.TOUCH_TAP,this.mouseUpOpenContourEditCallback),$r(e)}function Th(e){const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=n.canvas,r=(0,J.getEnabledElement)(i),{renderingEngine:s,viewport:l}=r,{viewportIdsToRender:d,xDir:c,yDir:h,spacing:u}=this.commonData,{editIndex:g,editCanvasPoints:v,startCrossingIndex:m}=this.editData,p=v[v.length-1],f=l.canvasToWorld(p),E=ps.vec3.create();ps.vec3.subtract(E,o,f);const w=Math.abs(ps.vec3.dot(E,c)),I=Math.abs(ps.vec3.dot(E,h));if(w<=u[0]&&I<=u[1])return;void 0!==m&&this.checkAndRemoveCrossesOnEditLine(e);const C=g+wh(i,v,a,this.commonData);this.editData.editIndex=C,void 0===m&&v.length>1&&this.checkForFirstCrossing(e,!1),this.editData.snapIndex=this.findSnapIndex(),this.editData.fusedCanvasPoints=this.fuseEditPointsWithOpenContour(e),void 0!==m&&this.checkForSecondCrossing(e,!1)?(this.removePointsAfterSecondCrossing(!1),this.finishEditOpenOnSecondCrossing(e)):this.checkIfShouldOverwriteAnEnd(e)&&this.openContourEditOverwriteEnd(e),Bo(s,d)}function bh(e){const t=e.detail,{element:n}=t,i=(0,J.getEnabledElement)(n),{viewport:o}=i,{annotation:a,viewportIdsToRender:r}=this.commonData,s=this.fuseEditPointsForOpenContourEndEdit().map((e=>o.canvasToWorld(e)));a.data.polyline=s,a.data.isOpenContour=!0,a.data.handles.points=[s[0],s[s.length-1]],a.data.handles.activeHandleIndex=1,this.triggerAnnotationModified(a,i),this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,this.deactivateOpenContourEdit(n),this.activateOpenContourEndEdit(e,a,r,null)}function Dh(e){const t=e.detail,{currentPoints:n,lastPoints:i}=t,o=n.canvas,a=i.canvas,{snapIndex:r,prevCanvasPoints:s,startCrossingIndex:l}=this.editData;if(void 0===l||void 0===r)return!1;if(-1===r)return!0;if(0!==r&&r!==s.length-1)return!1;const d=o,c=a,h=s[r],u=ps.vec2.create(),g=ps.vec2.create();ps.vec2.set(u,d[0]-c[0],d[1]-c[1]),ps.vec2.set(g,d[0]-h[0],d[1]-h[1]);const v=ps.vec2.dot(u,g),m=Math.sqrt(u[0]*u[0]+u[1]*u[1]),p=Math.sqrt(g[0]*g[0]+g[1]*g[1]);return Math.acos(v/(m*p))<Math.PI/2}function Sh(){const{snapIndex:e,prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:i}=this.editData,o=[];if(0===e)for(let e=t.length-1;e>=i;e--){const n=t[e];o.push([n[0],n[1]])}else for(let e=0;e<i;e++){const n=t[e];o.push([n[0],n[1]])}if(ps.vec2.distance(t[i],n[0])<ps.vec2.distance(t[i],n[n.length-1]))for(let e=0;e<n.length;e++){const t=n[e];o.push([t[0],t[1]])}else for(let e=n.length-1;e>=0;e--){const t=n[e];o.push([t[0],t[1]])}return o}function yh(e){const{prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:i,snapIndex:o}=this.editData;if(void 0===i||void 0===o)return;const a=e.detail,{element:r}=a,s=[...n];let l,d;wh(r,s,t[o],this.commonData),s.length>n.length&&s.pop(),i>o?(l=o,d=i):(l=i,d=o);const c=ps.vec2.distance(t[l],s[0]),h=ps.vec2.distance(t[l],s[s.length-1]),u=ps.vec2.distance(t[d],s[0]),g=ps.vec2.distance(t[d],s[s.length-1]),v=[];for(let e=0;e<l;e++){const n=t[e];v.push([n[0],n[1]])}if(c+g<h+u)for(let e=0;e<s.length;e++){const t=s[e];v.push([t[0],t[1]])}else for(let e=s.length-1;e>=0;e--){const t=s[e];v.push([t[0],t[1]])}for(let e=d;e<t.length;e++){const n=t[e];v.push([n[0],n[1]])}return v}function Oh(e){const t=e.detail,{element:n}=t,i=(0,J.getEnabledElement)(n),{viewport:o,renderingEngine:a}=i,{annotation:r,viewportIdsToRender:s}=this.commonData,{fusedCanvasPoints:l,editCanvasPoints:d}=this.editData,c=l.map((e=>o.canvasToWorld(e)));r.data.polyline=c,r.data.isOpenContour=!0,r.data.handles.points=[c[0],c[c.length-1]],this.triggerAnnotationModified(r,i);const h=d.pop();this.editData={prevCanvasPoints:l,editCanvasPoints:[h],startCrossingIndex:void 0,editIndex:0},Bo(a,s)}function Mh(e){const t=e.detail,{element:n}=t;this.completeOpenContourEdit(n)}function xh(e){const t=(0,J.getEnabledElement)(e),{viewport:n,renderingEngine:i}=t,{annotation:o,viewportIdsToRender:a}=this.commonData,{fusedCanvasPoints:r,prevCanvasPoints:s}=this.editData;if(r){const e=(Nc(this.configuration)?Pc(this.configuration,r,s):r).map((e=>n.canvasToWorld(e)));o.data.polyline=e,o.data.isOpenContour=!0,o.data.handles.points=[e[0],e[e.length-1]],o.data.isOpenUShapeContour&&(o.data.openUShapeContourVectorToPeak=Lc(r,n)),o.invalidated=!0,this.triggerAnnotationModified(o,t)}this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,Bo(i,a),this.deactivateOpenContourEdit(e)}function Nh(e){this.completeOpenContourEdit(e)}const kh=function(e){e.activateOpenContourEdit=Ch.bind(e),e.deactivateOpenContourEdit=_h.bind(e),e.mouseDragOpenContourEditCallback=Th.bind(e),e.mouseUpOpenContourEditCallback=Mh.bind(e),e.fuseEditPointsWithOpenContour=yh.bind(e),e.finishEditOpenOnSecondCrossing=Oh.bind(e),e.checkIfShouldOverwriteAnEnd=Dh.bind(e),e.fuseEditPointsForOpenContourEndEdit=Sh.bind(e),e.openContourEditOverwriteEnd=bh.bind(e),e.cancelOpenContourEdit=Nh.bind(e),e.completeOpenContourEdit=xh.bind(e)},{getSubPixelSpacingAndXYDirections:Rh}=S;function Ph(e,t,n,i){this.isDrawing=!0;const o=e.detail,{element:a}=o,r=(0,J.getEnabledElement)(a),{viewport:s}=r,{spacing:l,xDir:d,yDir:c}=Rh(s,this.configuration.subPixelResolution),h=t.data.polyline.map(s.worldToCanvas);0===t.data.handles.activeHandleIndex&&h.reverse();let u=!1;i.worldPosition&&(u=!0),this.drawData={canvasPoints:h,polylineIndex:h.length-1},this.commonData={annotation:t,viewportIdsToRender:n,spacing:l,xDir:d,yDir:c,movingTextBox:u},He.isInteractingWithTool=!0,a.addEventListener(Q.MOUSE_UP,this.mouseUpDrawCallback),a.addEventListener(Q.MOUSE_DRAG,this.mouseDragDrawCallback),a.addEventListener(Q.MOUSE_CLICK,this.mouseUpDrawCallback),a.addEventListener(Q.TOUCH_END,this.mouseUpDrawCallback),a.addEventListener(Q.TOUCH_DRAG,this.mouseDragDrawCallback),a.addEventListener(Q.TOUCH_TAP,this.mouseUpDrawCallback),Qr(a)}const Lh=function(e){e.activateOpenContourEndEdit=Ph.bind(e)},{pointsAreWithinCloseContourProximity:Ah}=S;function Uh(e,t){const n={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id,annotationUID:t.annotationUID},i=this.getStyle("lineWidth",n,t),o=this.getStyle("lineDash",n,t),a=this.getStyle("color",n,t);return{color:void 0===a?void 0:a,width:void 0===i?void 0:i,lineDash:void 0===o?void 0:o,connectLastToFirst:!t.data.isOpenContour}}function Vh(e,t,n){var i;null!=e&&null!==(i=e.viewport)&&void 0!==i&&i.getImageData()&&(n.data.isOpenContour?n.data.isOpenUShapeContour?(function(e,t){t.data.openUShapeContourVectorToPeak||(t.data.openUShapeContourVectorToPeak=function(e,t){const{viewport:n}=e;return Lc(t.data.polyline.map(n.worldToCanvas),n)}(e,t))}(e,n),this.renderOpenUShapedContour(e,t,n)):this.renderOpenContour(e,t,n):this.renderClosedContour(e,t,n))}function Wh(e,t,n){const{viewport:i}=e,o=this._getRenderingOptions(e,n),a=n.data.polyline.map((e=>i.worldToCanvas(e)));Ns(t,n.annotationUID,"1",a,o)}function Fh(e,t,n){var i;const{viewport:o}=e,a=this._getRenderingOptions(e,n),r=n.data.polyline.map((e=>o.worldToCanvas(e)));Ns(t,n.annotationUID,"1",r,a);const s=n.data.handles.activeHandleIndex;if(!0===(null===(i=this.configuration.alwaysRenderOpenContourHandles)||void 0===i?void 0:i.enabled)){const e=this.configuration.alwaysRenderOpenContourHandles.radius,i="0",o=[r[0],r[r.length-1]];0===s?o.shift():1===s&&o.pop(),Ms(t,n.annotationUID,i,o,{color:a.color,handleRadius:e})}if(null!==s){const e="1",i=r[0===s?0:r.length-1];Ms(t,n.annotationUID,e,[i],{color:a.color})}}function Hh(e,t,n){const{viewport:i}=e,{polyline:o,openUShapeContourVectorToPeak:a}=n.data;if(this.renderOpenContour(e,t,n),!a)return;const r=i.worldToCanvas(o[0]),s=i.worldToCanvas(o[o.length-1]),l=[i.worldToCanvas(a[0]),i.worldToCanvas(a[1])],d=this._getRenderingOptions(e,n);Ns(t,n.annotationUID,"first-to-last",[r,s],{color:d.color,width:d.width,connectLastToFirst:!1,lineDash:"2,2"}),Ns(t,n.annotationUID,"midpoint-to-open-contour",[l[0],l[1]],{color:d.color,width:d.width,connectLastToFirst:!1,lineDash:"2,2"})}function Bh(e,t,n){const i=this._getRenderingOptions(e,n),{allowOpenContours:o}=this.configuration,{canvasPoints:a}=this.drawData;if(i.connectLastToFirst=!1,Ns(t,n.annotationUID,"1",a,i),o){const e=a[0],o=a[a.length-1];if(Ah(e,o,this.configuration.closeContourProximity))Ns(t,n.annotationUID,"2",[o,e],i);else{const o="0";Ms(t,n.annotationUID,o,[e],{color:i.color,handleRadius:2})}}}function Gh(e,t,n){const{fusedCanvasPoints:i}=this.editData;if(void 0===i)return void this.renderClosedContour(e,t,n);const o=this._getRenderingOptions(e,n);Ns(t,n.annotationUID,"preview-1",i,o)}function qh(e,t,n){const{fusedCanvasPoints:i}=this.editData;if(void 0===i)return void this.renderOpenContour(e,t,n);const o=this._getRenderingOptions(e,n);Ns(t,n.annotationUID,"preview-1",i,o)}const jh=function(e){e.renderContour=Vh.bind(e),e.renderClosedContour=Wh.bind(e),e.renderOpenContour=Fh.bind(e),e.renderOpenUShapedContour=Hh.bind(e),e.renderContourBeingDrawn=Bh.bind(e),e.renderClosedContourBeingEdited=Gh.bind(e),e.renderOpenContourBeingEdited=qh.bind(e),e._getRenderingOptions=Uh.bind(e)},{pointCanProjectOnLine:zh}=S,{EPSILON:Kh}=J.CONSTANTS,Yh=1-Kh;class Xh extends Ql{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,alwaysRenderOpenContourHandles:{enabled:!1,radius:2},allowOpenContours:!0,closeContourProximity:10,checkCanvasEditFallbackProximity:6,subPixelResolution:4,interpolation:{interpolateOnAdd:!1,interpolateOnEdit:!1,knotsRatioPercentageOnAdd:40,knotsRatioPercentageOnEdit:40},calculateStats:!1,getTextLines:Zh,statsCalculator:hd}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"_throttledCalculateCachedStats",void 0),te(this,"commonData",void 0),te(this,"isDrawing",!1),te(this,"isEditingClosed",!1),te(this,"isEditingOpen",!1),te(this,"activateDraw",void 0),te(this,"activateClosedContourEdit",void 0),te(this,"activateOpenContourEdit",void 0),te(this,"activateOpenContourEndEdit",void 0),te(this,"cancelDrawing",void 0),te(this,"cancelClosedContourEdit",void 0),te(this,"cancelOpenContourEdit",void 0),te(this,"renderContour",void 0),te(this,"renderContourBeingDrawn",void 0),te(this,"renderClosedContourBeingEdited",void 0),te(this,"renderOpenContourBeingEdited",void 0),te(this,"addNewAnnotation",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a,l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,o,d,c),u=Gl(i,this.getToolName()),g=r.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h,toolName:this.getToolName()},data:{handles:{points:[],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},polyline:[[...o]],label:"",cachedStats:{}}};return Je(v,i),this.activateDraw(e,v,u),e.preventDefault(),Bo(s,u),v})),te(this,"handleSelectedCallback",((e,t,n)=>{const i=e.detail,{element:o}=i,a=Gl(o,this.getToolName());this.activateOpenContourEndEdit(e,t,a,n)})),te(this,"toolSelectedCallback",((e,t)=>{const n=e.detail,{element:i}=n,o=Gl(i,this.getToolName());t.data.isOpenContour?this.activateOpenContourEdit(e,t,o):this.activateClosedContourEdit(e,t,o)})),te(this,"isPointNearTool",((e,t,n,i)=>{const o=(0,J.getEnabledElement)(e),{viewport:a}=o,r=t.data.polyline;let s=a.worldToCanvas(r[0]);for(let e=1;e<r.length;e++){const t=s,o=a.worldToCanvas(r[e]);if(!0===zh(n,t,o,i))return!0;s=o}if(t.data.isOpenContour)return!1;const l=a.worldToCanvas(r[0]),d=a.worldToCanvas(r[r.length-1]);return!0===zh(n,l,d,i)})),te(this,"cancel",(e=>{const t=this.isDrawing,n=this.isEditingOpen,i=this.isEditingClosed;t?this.cancelDrawing(e):n?this.cancelOpenContourEdit(e):i&&this.cancelClosedContourEdit(e)})),te(this,"triggerAnnotationModified",((e,t)=>{const{viewportId:n,renderingEngineId:i}=t,o=Q.ANNOTATION_MODIFIED,a={annotation:e,viewportId:n,renderingEngineId:i};(0,J.triggerEvent)(J.eventTarget,o,a)})),te(this,"triggerAnnotationCompleted",(e=>{const t=Q.ANNOTATION_COMPLETED,n={annotation:e};(0,J.triggerEvent)(J.eventTarget,t,n)})),te(this,"renderAnnotation",((e,t)=>{var n,i;let o=!1;const{viewport:a,renderingEngine:r}=e,{element:s}=a,l=this.getTargetId(a);let d=Ze(this.getToolName(),s);if(null===(n=d)||void 0===n||!n.length)return o;if(d=this.filterInteractableAnnotationsForElement(s,d),null===(i=d)||void 0===i||!i.length)return o;const c=this.isDrawing,h=this.isEditingOpen,u=this.isEditingClosed;if(c||h||u){const n=this.commonData.annotation.annotationUID;d.forEach((i=>{if(i.annotationUID===n)if(c)this.renderContourBeingDrawn(e,t,i);else if(u)this.renderClosedContourBeingEdited(e,t,i);else{if(!h)throw new Error("Unknown ".concat(this.getToolName()," annotation rendering state"));this.renderOpenContourBeingEdited(e,t,i)}else this.renderContour(e,t,i)})),o=!0}else d.forEach((n=>{this.renderContour(e,t,n)}));return this.configuration.calculateStats?(d.forEach((n=>{var i,o,s;const d=null===(i=this.commonData)||void 0===i?void 0:i.annotation.annotationUID;if(n.annotationUID!==d||null!==(o=this.commonData)&&void 0!==o&&o.movingTextBox){if(null===(s=this.commonData)||void 0===s||!s.movingTextBox){const{data:t}=n;t.cachedStats[l]&&null!=t.cachedStats[l].areaUnit?n.invalidated&&this._throttledCalculateCachedStats(n,a,r,e):(t.cachedStats[l]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(n,a,r,e))}this._renderStats(n,a,e,t)}})),o):void 0})),te(this,"_calculateCachedStats",((e,t,n,i)=>{const o=e.data,{cachedStats:a,polyline:r}=o,s=Object.keys(a);for(let i=0;i<s.length;i++){var l,d,c;const o=s[i],h=this.getTargetIdImage(o,n);if(!h)continue;const{imageData:u,metadata:g}=h,v=r.map((e=>t.worldToCanvas(e))),m=v[0],p=t.canvasToWorld(m),f=t.canvasToWorld([m[0]+1,m[1]]),E=t.canvasToWorld([m[0],m[1]+1]),w=ps.vec3.distance(p,f),I=ps.vec3.distance(p,E),C=$s(h);let _=nc(v)/C/C;_*=w*I;const T=J.utilities.transformWorldToIndex(u,r[0]);T[0]=Math.floor(T[0]),T[1]=Math.floor(T[1]),T[2]=Math.floor(T[2]);let b=T[0],D=T[0],S=T[1],y=T[1],O=T[2],M=T[2];for(let e=1;e<r.length;e++){const t=J.utilities.transformWorldToIndex(u,r[e]);t[0]=Math.floor(t[0]),t[1]=Math.floor(t[1]),t[2]=Math.floor(t[2]),b=Math.min(b,t[0]),D=Math.max(D,t[0]),S=Math.min(S,t[1]),y=Math.max(y,t[1]),O=Math.min(O,t[2]),M=Math.max(M,t[2])}const x=.01*(D-b),N=.01*(y-S),k=.01*(M-O);b=Math.floor(b-x),D=Math.ceil(D+x),S=Math.floor(S-N),y=Math.ceil(y+N),O=Math.floor(O-k),M=Math.ceil(M+k);const R=[[b,D],[S,y],[O,M]],P=u.indexToWorld([D,y,M]),L=t.worldToCanvas(P);let A=0,U=[],V=0;const W=tl(u,((e,n)=>{let i=!0;const o=t.worldToCanvas(e);return o[1]!=A&&(V=0,A=o[1],U=qd(v,o,[L[0],o[1]]),U.sort((function(e,t){return e[0]===t[0]?0:e[0]<t[0]?-1:1}))),U.length&&o[0]>U[0][0]&&(U.shift(),V++),V%2==0&&(i=!1),i}),this.configuration.statsCalculator.statsCallback,R),F={isPreScaled:sd(t,o),isSuvScaled:this.isSuvScaled(t,o,e.metadata.referencedImageId)},H=rd(g.Modality,e.metadata.referencedImageId,F),B=this.configuration.statsCalculator.getStatistics();a[o]={Modality:g.Modality,area:_,mean:null===(l=B[1])||void 0===l?void 0:l.value,max:null===(d=B[0])||void 0===d?void 0:d.value,stdDev:null===(c=B[3])||void 0===c?void 0:c.value,statsArray:B,pointsInShape:W,areaUnit:Js(0,h),modalityUnit:H}}return this.triggerAnnotationModified(e,i),e.invalidated=!1,a})),te(this,"_renderStats",((e,t,n,i)=>{var o;const a=e.data,r=this.getTargetId(t),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:n.viewport.id},l=this.getLinkedTextBoxStyle(s,e);if(!l.visibility)return;const d=this.configuration.getTextLines(a,r);if(!d||0===d.length)return;const c=a.polyline.map((e=>t.worldToCanvas(e)));if(!a.handles.textBox.hasMoved){const e=od(c);a.handles.textBox.worldPosition=t.canvasToWorld(e)}const h=t.worldToCanvas(a.handles.textBox.worldPosition),u=As(i,null!==(o=e.annotationUID)&&void 0!==o?o:"","1",d,h,c,{},l),{x:g,y:v,width:m,height:p}=u;a.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([g,v]),topRight:t.canvasToWorld([g+m,v]),bottomLeft:t.canvasToWorld([g,v+p]),bottomRight:t.canvasToWorld([g+m,v+p])}})),Jc(this),rh(this),Eh(this),kh(this),Lh(this),jh(this),this._throttledCalculateCachedStats=js(this._calculateCachedStats,100,{trailing:!0})}filterInteractableAnnotationsForElement(e,t){if(!t||!t.length)return;const n=(0,J.getEnabledElement)(e),{viewport:i}=n;let o;if(i instanceof J.VolumeViewport){const e=i.getCamera(),{spacingInNormalDirection:n}=J.utilities.getTargetVolumeAndSpacingInNormalDir(i,e);o=this.filterAnnotationsWithinSlice(t,e,n)}else o=Yl(i,t);return o}filterAnnotationsWithinSlice(e,t,n){const{viewPlaneNormal:i}=t,o=e.filter((e=>{const t=e.metadata.viewPlaneNormal,n=Math.abs(ps.vec3.dot(i,t))>Yh;return t&&n}));if(!o.length)return[];const a=n/2,{focalPoint:r}=t,s=[];for(const e of o){const t=e.data.polyline[0];if(!e.isVisible)continue;const n=ps.vec3.create();ps.vec3.sub(n,r,t);const o=ps.vec3.dot(n,i);Math.abs(o)<a&&s.push(e)}return s}}function Zh(e,t){const n=e.cachedStats[t],{area:i,mean:o,stdDev:a,max:r,isEmptyArea:s,areaUnit:l,modalityUnit:d}=n,c=[];if(i){const e=s?"Area: Oblique not supported":"Area: ".concat(al(i)," ").concat(l);c.push(e)}return o&&c.push("Mean: ".concat(al(o)," ").concat(d)),r&&c.push("Max: ".concat(al(r)," ").concat(d)),a&&c.push("Std Dev: ".concat(al(a)," ").concat(d)),c}te(Xh,"toolName",void 0),Xh.toolName="PlanarFreehandROI";const Jh=Xh;function $h(e,t,n){if(function(e,t,n){var i;if(null==t||null===(i=t.data)||void 0===i||!i.polyline||n<=0)return!0;if(!e.viewport)return!0;const{renderingEngineId:o,viewportId:a,FrameOfReferenceUID:r}=e,s=Si(a,o);if(t.metadata.FrameOfReferenceUID!==r)return!0;if(!s)return!0;const l=s.getToolInstance(t.metadata.toolName);return!(l instanceof Jh)||l.isDrawing||l.isEditingOpen||l.isEditingClosed}(e,t,n))return!1;const{viewport:i}=e,o=t.data.polyline.map(i.worldToCanvas),a=xc(o,0,o.length,n);return a!==o&&(t.data.polyline=a.map(i.canvasToWorld),!0)}const Qh={interpolateAnnotation:$h},eu={};function tu(e,t){const n=(0,J.getEnabledElement)(e),{viewportId:i}=n;eu[i]=t}function nu(e){const t=(0,J.getEnabledElement)(e),{viewportId:n}=t;return eu[n]}const iu=J.Enums.RequestType.Prefetch,ou=0;function au(e,t){e=Math.round(e)||0;const n=[];let i=(t=Math.round(t)||0)-e+1;if(i<=0)return n;for(;i--;)n[i]=t--;return n}function ru(e){const t=(0,J.getEnabledElement)(e);if(!t)return null;const{viewport:n}=t;if(!(n instanceof J.StackViewport))throw new Error("stackPrefetch: element must be a StackViewport, VolumeViewport stackPrefetch not yet implemented");return{currentImageIdIndex:n.getCurrentImageIdIndex(),imageIds:n.getImageIds()}}function su(e){return function(t){const n=t.detail;let i;try{i=ru(e)}catch(e){return}if(!i||!i.imageIds||0===i.imageIds.length)return;const o=i.imageIds.indexOf(n.imageId);if(o<0)return;const a=nu(e);a&&a.data&&a.data.length&&a.indicesToRequest.push(o)}}const lu=e=>{const t=new Set(e.imageIds);return e=>e.type!==iu||!t.has(e.additionalDetails.imageId)};let du,cu={maxImagesToPrefetch:1/0,preserveExistingPool:!0};function hu(e){var t,n;const i=nu(e);if(!i)return;const o=i||{},a=ru(e);if(null==a||null===(t=a.imageIds)||void 0===t||!t.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const{currentImageIdIndex:r}=a;if(o.enabled&&(o.enabled=null===(n=o.indicesToRequest)||void 0===n?void 0:n.length),!1===o.enabled)return;if(i.indicesToRequest.sort(((e,t)=>e-t)),o.indicesToRequest.slice().forEach((function(e){const t=a.imageIds[e];t&&(Math.abs(r-e)<6?J.cache.getImageLoadObject(t):J.cache.isLoaded(t))&&function(e){const t=o.indicesToRequest.indexOf(e);t>-1&&o.indicesToRequest.splice(t,1)}(e)})),!o.indicesToRequest.length)return;cu.preserveExistingPool||J.imageLoadPoolManager.clearRequestStack(iu);const s=function(e,t){let n=0,i=e.length-1;return e.forEach(((e,o)=>{e<t?n=Math.max(o,n):e>t&&(i=Math.min(o,i))})),{low:n,high:i}}(o.indicesToRequest,a.currentImageIdIndex);let l,d,c=s.low,h=s.high;const u=[];for(;c>=0||h<o.indicesToRequest.length;){const e=a.currentImageIdIndex,t=!(e-o.indicesToRequest[c]>cu.maxImagesToPrefetch)&&c>=0,n=!(o.indicesToRequest[h]-e>cu.maxImagesToPrefetch)&&h<o.indicesToRequest.length;if(!n&&!t)break;t&&(d=o.indicesToRequest[c--],l=a.imageIds[d],u.push(l)),n&&(d=o.indicesToRequest[h++],l=a.imageIds[d],u.push(l))}const g=(e,t)=>J.imageLoader.loadAndCacheImage(e,t),{useNorm16Texture:v}=(0,J.getConfiguration)().rendering;u.forEach((e=>{const t={targetBuffer:{type:v?void 0:"Float32Array"},preScale:{enabled:!0},requestType:iu};J.imageLoadPoolManager.addRequest(g.bind(null,e,t),iu,{imageId:e},ou)}))}function uu(e){clearTimeout(du),du=setTimeout((function(){const t=e.target;try{hu(t)}catch(e){return}}),10)}const gu={enable:function(e){const t=ru(e);if(!t||!t.imageIds||0===t.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const n={indicesToRequest:au(0,t.imageIds.length-1),enabled:!0,direction:1},i=n.indicesToRequest.indexOf(t.currentImageIdIndex);n.indicesToRequest.splice(i,1),tu(e,n),hu(e),e.removeEventListener(J.Enums.Events.STACK_NEW_IMAGE,uu),e.addEventListener(J.Enums.Events.STACK_NEW_IMAGE,uu);const o=su(e);J.eventTarget.removeEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,o),J.eventTarget.addEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,o)},disable:function(e){clearTimeout(du),e.removeEventListener(J.Enums.Events.STACK_NEW_IMAGE,uu);const t=su(e);J.eventTarget.removeEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);const n=nu(e);n&&n.indicesToRequest.length&&(n.enabled=!1,J.imageLoadPoolManager.clearRequestStack(iu))},getConfiguration:function(){return cu},setConfiguration:function(e){cu=e}};let vu,mu={maxImagesToPrefetch:1/0,minBefore:2,maxAfter:2,directionExtraImages:10,preserveExistingPool:!1};function pu(e){var t,n;const i=ru(e);if(null==i||null===(t=i.imageIds)||void 0===t||!t.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const o=nu(e);if(!o)return;const a=o||{};if(a.enabled&&(a.enabled=null===(n=a.indicesToRequest)||void 0===n?void 0:n.length),!1===a.enabled)return;function r(e){const t=a.indicesToRequest.indexOf(e);t>-1&&a.indicesToRequest.splice(t,1)}const s=a.indicesToRequest.slice(),{currentImageIdIndex:l}=i;if(s.forEach((e=>{const t=i.imageIds[e];t&&(Math.abs(l-e)<6?J.cache.getImageLoadObject(t):J.cache.isLoaded(t))&&r(e)})),!a.indicesToRequest.length)return;mu.preserveExistingPool||J.imageLoadPoolManager.filterRequests(lu(i));const d=(t,n)=>J.imageLoader.loadAndCacheImage(t,n).then((()=>function(t){var n;r(i.imageIds.indexOf(t));const o=J.cache.getCachedImageBasedOnImageURI(t),{stats:s}=a,l=(null==o||null===(n=o.image)||void 0===n?void 0:n.decodeTimeInMS)||0;if(l){var d;s.imageIds.set(t,l),s.decodeTimeInMS+=l;const e=(null==o||null===(d=o.image)||void 0===d?void 0:d.loadTimeInMS)||0;s.loadTimeInMS+=e}if(!a.indicesToRequest.length&&null!=o&&o.sizeInBytes){const{sizeInBytes:t}=o,n=J.cache.getMaxCacheSize()/4/t;if(a.cacheFill){if(s.imageIds.size){s.fillTime=Date.now()-s.start;const{size:e}=s.imageIds;s.fillSize=e,console.log("Done cache fill",s.fillTime,"ms",e,"items","average total time",al(s.fillTime/e),"ms","average load",al(s.loadTimeInMS/e),"ms","average decode",al(s.decodeTimeInMS/e),"ms")}}else s.initialTime=Date.now()-s.start,s.initialSize=s.imageIds.size,Eu(e,n),pu(e)}}(t))),{useNorm16Texture:c}=(0,J.getConfiguration)().rendering;s.forEach((e=>{const t=i.imageIds[e],n={targetBuffer:{type:c?void 0:"Float32Array"},preScale:{enabled:!0},requestType:iu};J.imageLoadPoolManager.addRequest(d.bind(null,t,n),iu,{imageId:t},ou)}))}function fu(e){clearTimeout(vu),vu=setTimeout((function(){const t=e.target;try{Eu(t),pu(t)}catch(e){return}}),5)}const Eu=(e,t)=>{const n=ru(e);if(!n||!n.imageIds||0===n.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const{currentImageIdIndex:i}=n;let{maxAfter:o=2,minBefore:a=2}=mu;const{directionExtraImages:r=10}=mu,s=nu(e)||{indicesToRequest:[],currentImageIdIndex:i,stackCount:0,enabled:!0,direction:1,stats:{start:Date.now(),imageIds:new Map,decodeTimeInMS:0,loadTimeInMS:0,totalBytes:0}},l=i-s.currentImageIdIndex;if(s.direction=l<0?-1:1,s.currentImageIdIndex=i,s.enabled=!0,s.stackCount<100&&(s.stackCount+=r),Math.abs(l)>o||!l)if(s.stackCount=0,t){const e=i/n.imageIds.length;a=Math.ceil(t*e),o=Math.ceil(t*(1-e)),s.cacheFill=!0}else s.cacheFill=!1;else l<0?(a+=s.stackCount,o=0):(o+=s.stackCount,a=0);const d=Math.max(0,i-a),c=Math.min(n.imageIds.length-1,i+o),h=[];for(let e=i+1;e<=c;e++)h.push(e);for(let e=i-1;e>=d;e--)h.push(e);s.indicesToRequest=h,tu(e,s)},wu={enable:e=>{const t=ru(e);if(!t||!t.imageIds||0===t.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");Eu(e),pu(e),e.removeEventListener(J.Enums.Events.STACK_NEW_IMAGE,fu),e.addEventListener(J.Enums.Events.STACK_NEW_IMAGE,fu);const n=su(e);J.eventTarget.removeEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,n),J.eventTarget.addEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,n)},disable:function(e){clearTimeout(vu),e.removeEventListener(J.Enums.Events.STACK_NEW_IMAGE,fu);const t=su(e);J.eventTarget.removeEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);const n=nu(e);n&&n.data.length&&(n.enabled=!1)},getConfiguration:function(){return mu},setConfiguration:function(e){mu=e}};function Iu(e,t){if(!(e instanceof J.VolumeViewport))return;const{focalPoint:n}=e.getCamera(),i=[0,0,0];return ps.vec3.sub(i,t,n),function(e,t){const n=e.getCamera(),i=n.viewPlaneNormal,o=ps.vec3.dot(t,i),a=ps.vec3.fromValues(i[0],i[1],i[2]);if(ps.vec3.scale(a,a,o),Math.abs(a[0])>.001||Math.abs(a[1])>.001||Math.abs(a[2])>.001){const t=[0,0,0],i=[0,0,0];ps.vec3.add(t,n.focalPoint,a),ps.vec3.add(i,n.position,a),e.setCamera({focalPoint:t,position:i}),e.render()}}(e,i),!0}const Cu=function(e,t){const n=t.frameNumbers||[...Array(e.numTimePoints).keys()];if(!t.maskVolumeId&&!t.imageCoordinate)throw new Error("You should provide either maskVolumeId or imageCoordinate");if(t.maskVolumeId&&t.imageCoordinate)throw new Error("You can only use one of maskVolumeId or imageCoordinate");if(t.maskVolumeId){const i=J.cache.getVolume(t.maskVolumeId),[o,a]=function(e,t,n){const{imageData:i}=n,o=n.getScalarData(),a=o.length,r=[];r.length=a;const s=[],l=n.dimensions;let d=0;for(let e=0,t=o.length;e<t;e++)0!==o[e]&&(s.push([e%l[0],Math.floor(e/l[0]%l[1]),Math.floor(e/(l[0]*l[1]))]),r[d++]=e);r.length=d;const c=t.getScalarDataArrays(),h=[];if(c[0].length===a&&JSON.stringify(t.spacing)===JSON.stringify(n.spacing)){for(let t=0;t<r.length;t++){const n=[];e.forEach((e=>{const i=c[e];n.push(i[r[t]])})),h.push(n)}return[h,s]}return tl(i,(()=>!0),(n=>{let{pointLPS:i,value:o,pointIJK:a}=n;if(0===o)return;const r=Rl(t.imageData,t.dimensions,t.spacing,i);let l=0;const d=new Map;e.forEach((e=>d.set(e,0)));tl(t.imageData,(()=>!0),(t=>{let{index:n}=t;for(let t=0;t<e.length;t++){const i=c[t][n],o=e[t];d.set(o,d.get(o)+i)}l++}),r);const u=[];d.forEach((e=>{u.push(e/l)})),s.push(a),h.push(u)})),[h,s]}(n,e,i);return[o,a]}if(t.imageCoordinate){const i=function(e,t,n){const{dimensions:i,imageData:o}=n,a=o.worldToIndex(t);if(a[0]=Math.floor(a[0]),a[1]=Math.floor(a[1]),a[2]=Math.floor(a[2]),!J.utilities.indexWithinDimensions(a,i))throw new Error("outside bounds");const r=i[0],s=i[0]*i[1],l=n.getScalarDataArrays(),d=[];return e.forEach((e=>{const t=l[e],n=a[2]*s+a[1]*r+a[0];d.push(t[n])})),d}(n,t.imageCoordinate,e);return i}},_u=function(e,t,n){const i=n||[...Array(e.numTimePoints).keys()],o=i.length;if(i.length<=1)throw new Error("Please provide two or more time points");const a=e.getScalarDataArrays(),r=a[0].length,s=new Float32Array(r);if(t===J.Enums.DynamicOperatorType.SUM){for(let e=0;e<o;e++){const t=a[i[e]];for(let e=0;e<r;e++)s[e]+=t[e]}return s}if(t===J.Enums.DynamicOperatorType.SUBTRACT){if(i.length>2)throw new Error("Please provide only 2 time points for subtraction.");for(let e=0;e<r;e++)s[e]+=a[i[0]][e]-a[i[1]][e];return s}if(t===J.Enums.DynamicOperatorType.AVERAGE){for(let e=0;e<o;e++){const t=a[i[e]];for(let e=0;e<r;e++)s[e]+=t[e]}for(let e=0;e<r;e++)s[e]=s[e]/o;return s}};function Tu(e,t){if(t<e.length/3)return[e[3*t],e[3*t+1],e[3*t+2]]}function bu(e){const t=e.getLines().getData();let n=0;const i=new Map;for(;n<t.length;){const e=t[n++],o=[];for(let i=0;i<e;i++)o.push(t[n+i]);i.set(o[0],o),n+=e}const o=[],a=e=>{for(const[t,n]of e.entries())if(void 0!==n)return t;return-1};let r=a(i);for(;-1!==r;){const e=[r];for(;i.has(r);){const t=i.get(r)[1];i.has(t)&&e.push(t),i.delete(r),r=t}o.push(e),r=a(i)}return o.length?o:void 0}function Du(e){const t=bu(e);if(!t)return;const n=e.getPoints().getData();return t.map((e=>e.map((e=>Tu(n,e)))))}let Su=function(e){return e.Top="top",e.Left="left",e.Bottom="bottom",e.Right="right",e}({});const yu=e=>e&&e.upper>e.lower,Ou=(e,t)=>!!e&&!!t&&e.lower===t.lower&&e.upper===t.upper,Mu=e=>!!e&&e.width>0&&e.height>0,xu=(e,t)=>!!e&&!!t&&e.width===t.width&&e.height===t.height,{clamp:Nu}=J.utilities;class ku{constructor(e){te(this,"_canvas",void 0),te(this,"_imageRange",void 0),te(this,"_voiRange",void 0),te(this,"_colormap",void 0),te(this,"_showFullImageRange",void 0),ku.validateProps(e);const{colormap:t,size:n={width:20,height:100},imageRange:i={lower:0,upper:1},voiRange:o={lower:0,upper:1},container:a,showFullPixelValueRange:r=!1}=e;this._colormap=t,this._imageRange=i,this._voiRange=o,this._showFullImageRange=r,this._canvas=this._createRootElement(n),a&&this.appendTo(a)}get colormap(){return this._colormap}set colormap(e){this._colormap=e,this.render()}get size(){const{width:e,height:t}=this._canvas;return{width:e,height:t}}set size(e){const{_canvas:t}=this;Mu(e)&&!xu(t,e)&&(this._setCanvasSize(t,e),this.render())}get imageRange(){return{...this._imageRange}}set imageRange(e){yu(e)&&!Ou(e,this._imageRange)&&(this._imageRange=e,this.render())}get voiRange(){return{...this._voiRange}}set voiRange(e){yu(e)&&!Ou(e,this._voiRange)&&(this._voiRange=e,this.render())}get showFullImageRange(){return this._showFullImageRange}set showFullImageRange(e){e!==this._showFullImageRange&&(this._showFullImageRange=e,this.render())}appendTo(e){e.appendChild(this._canvas),this.render()}dispose(){const{_canvas:e}=this,{parentElement:t}=e;null==t||t.removeChild(e)}static validateProps(e){const{size:t,imageRange:n,voiRange:i}=e;if(t&&!Mu(t))throw new Error('Invalid "size"');if(n&&!yu(n))throw new Error('Invalid "imageRange"');if(i&&!yu(i))throw new Error('Invalid "voiRange"')}_setCanvasSize(e,t){const{width:n,height:i}=t;e.width=n,e.height=i,Object.assign(e.style,{width:"".concat(n,"px"),height:"".concat(i,"px")})}_createRootElement(e){const t=document.createElement("canvas");return Object.assign(t.style,{position:"absolute",top:"0",left:"0",pointerEvents:"none",boxSizing:"border-box"}),this._setCanvasSize(t,e),t}render(){if(!this._canvas.isConnected)return;const{_colormap:e}=this,{RGBPoints:t}=e,n=t.length/4,i=e=>{const i=4*e;if(!(e<0||e>=n))return{index:e,position:t[i],color:[t[i+1],t[i+2],t[i+3]]}},{width:o,height:a}=this._canvas,r=this._canvas.getContext("2d"),s=o>a,l=s?o:a,{_voiRange:d}=this,c=this._showFullImageRange?this._imageRange:{...d},{windowWidth:h}=J.utilities.windowLevel.toWindowLevel(d.lower,d.upper);let u,g=i(0);const v=(c.upper-c.lower)/(l-1);let m=c.lower;for(let e=0;e<l;e++){const t=(m-d.lower)/h;if(g)for(let e=g.index;e<n&&!(t<=g.position);e++)u=g,g=i(e+1);let l;if(u)if(g){const e=(t-u.position)/(g.position-u.position);p=u.color,f=g.color,E=e,l=[p[0]*(1-E)+f[0]*E,p[1]*(1-E)+f[1]*E,p[2]*(1-E)+f[2]*E]}else l=[...u.color];else l=[...g.color];const c=l.map((e=>Nu(Math.round(255*e),0,255)));r.fillStyle="rgb(".concat(c[0],", ").concat(c[1],", ").concat(c[2],")"),s?r.fillRect(e,0,1,a):r.fillRect(0,a-e-1,o,1),m+=v}var p,f,E}}const Ru={FONT:"10px Arial",COLOR:"white",TICK_SIZE:5,TICK_WIDTH:1,TICK_LABEL_MARGIN:3,MAX_NUM_TICKS:8,TICKS_STEPS:[1,2.5,5,10]};class Pu{constructor(e){var t,n,i,o,a,r;te(this,"_canvas",void 0),te(this,"_imageRange",void 0),te(this,"_voiRange",void 0),te(this,"_color",void 0),te(this,"_tickSize",void 0),te(this,"_tickWidth",void 0),te(this,"_labelMargin",void 0),te(this,"_maxNumTicks",void 0),te(this,"_rangeTextPosition",void 0),te(this,"_showFullPixelValueRange",void 0),te(this,"_font",void 0),Pu.validateProps(e);const{top:s=0,left:l=0,size:d={width:20,height:100},imageRange:c={lower:0,upper:1},voiRange:h={lower:0,upper:1},ticks:u,container:g,showFullPixelValueRange:v=!1}=e,{style:m,position:p}=null!=u?u:{};this._imageRange=c,this._voiRange=h,this._font=null!==(t=null==m?void 0:m.font)&&void 0!==t?t:Ru.FONT,this._color=null!==(n=null==m?void 0:m.color)&&void 0!==n?n:Ru.COLOR,this._tickSize=null!==(i=null==m?void 0:m.tickSize)&&void 0!==i?i:Ru.TICK_SIZE,this._tickWidth=null!==(o=null==m?void 0:m.tickWidth)&&void 0!==o?o:Ru.TICK_WIDTH,this._labelMargin=null!==(a=null==m?void 0:m.labelMargin)&&void 0!==a?a:Ru.TICK_LABEL_MARGIN,this._maxNumTicks=null!==(r=null==m?void 0:m.maxNumTicks)&&void 0!==r?r:Ru.MAX_NUM_TICKS,this._rangeTextPosition=null!=p?p:Su.Right,this._showFullPixelValueRange=v,this._canvas=this._createCanvasElement(d,s,l),g&&this.appendTo(g)}get size(){const{width:e,height:t}=this._canvas;return{width:e,height:t}}set size(e){const{_canvas:t}=this;Mu(e)&&!xu(t,e)&&(this._setCanvasSize(t,e),this.render())}get top(){return Number.parseInt(this._canvas.style.top)}set top(e){const{_canvas:t}=this;e!==this.top&&(t.style.top="".concat(e,"px"),this.render())}get left(){return Number.parseInt(this._canvas.style.left)}set left(e){const{_canvas:t}=this;e!==this.left&&(t.style.left="".concat(e,"px"),this.render())}get imageRange(){return{...this._imageRange}}set imageRange(e){yu(e)&&!Ou(e,this._imageRange)&&(this._imageRange=e,this.render())}get voiRange(){return{...this._voiRange}}set voiRange(e){yu(e)&&!Ou(e,this._voiRange)&&(this._voiRange=e,this.render())}get tickSize(){return this._tickSize}set tickSize(e){e!==this._tickSize&&(this._tickSize=e,this.render())}get tickWidth(){return this._tickWidth}set tickWidth(e){e!==this._tickWidth&&(this._tickWidth=e,this.render())}get color(){return this._color}set color(e){e!==this._color&&(this._color=e,this.render())}get showFullPixelValueRange(){return this._showFullPixelValueRange}set showFullPixelValueRange(e){e!==this._showFullPixelValueRange&&(this._showFullPixelValueRange=e,this.render())}get visible(){return"block"===this._canvas.style.display}set visible(e){e!==this.visible&&(this._canvas.style.display=e?"block":"none",e&&this.render())}appendTo(e){e.appendChild(this._canvas),this.render()}static validateProps(e){const{size:t,imageRange:n,voiRange:i}=e;if(t&&!Mu(t))throw new Error('Invalid "size"');if(n&&!yu(n))throw new Error('Invalid "imageRange"');if(i&&!yu(i))throw new Error('Invalid "voiRange"')}_setCanvasSize(e,t){const{width:n,height:i}=t;e.width=n,e.height=i,Object.assign(e.style,{width:"".concat(n,"px"),height:"".concat(i,"px")})}_createCanvasElement(e,t,n){const i=document.createElement("canvas");return Object.assign(i.style,{display:"none",position:"absolute",boxSizing:"border-box",top:"".concat(t,"px"),left:"".concat(n,"px")}),this._setCanvasSize(i,e),i}_getTicks(e){const{lower:t,upper:n}=e,i=(n-t)/(this._maxNumTicks-1),o=Math.pow(10,-Math.floor(Math.log10(Math.abs(i)))),a=i*o,r=Ru.TICKS_STEPS.find((e=>e>=a))/o,s=Math.ceil(n/r)*r,l=Math.floor(t/r)*r,d=Math.round((s-l)/r)+1,c=[];for(let e=0;e<d;e++)c.push(l+e*r);return{scaleMin:l,scaleMax:s,step:r,ticks:c}}_getLeftTickInfo(e){let{position:t,labelMeasure:n}=e;const{width:i}=this._canvas;return{labelPoint:[i-this.tickSize-n.width-this._labelMargin,t],tickPoints:{start:[i-this._tickSize,t],end:[i,t]}}}_getRightTickInfo(e){let{position:t}=e;return{labelPoint:[this._tickSize+this._labelMargin,t],tickPoints:{start:[0,t],end:[this._tickSize,t]}}}_getTopTickInfo(e){let{position:t,labelMeasure:n}=e;throw new Error("Not implemented")}_getBottomTickInfo(e){let{position:t,labelMeasure:n}=e;throw new Error("Not implemented")}render(){const{_canvas:e}=this;if(!e.isConnected||!this.visible)return;const{width:t,height:n}=e,i=t>=n,o=i?t:n,a=e.getContext("2d"),{_voiRange:r}=this,s=this._showFullPixelValueRange?this._imageRange:{...r},l=s.upper-s.lower,{ticks:d}=this._getTicks(s);a.clearRect(0,0,t,n),a.font=this._font,a.textBaseline="middle",a.fillStyle=this._color,a.strokeStyle=this._color,a.lineWidth=this.tickWidth,d.forEach((e=>{let t=Math.round(o*((e-s.lower)/l));if(i||(t=n-t),t<0||t>o)return;const r=e.toString(),d=a.measureText(r);let c;c=i?this._rangeTextPosition===Su.Top?this._getTopTickInfo({position:t,labelMeasure:d}):this._getBottomTickInfo({position:t,labelMeasure:d}):this._rangeTextPosition===Su.Left?this._getLeftTickInfo({position:t,labelMeasure:d}):this._getRightTickInfo({position:t});const{labelPoint:h,tickPoints:u}=c,{start:g,end:v}=u;return a.beginPath(),a.moveTo(g[0],g[1]),a.lineTo(v[0],v[1]),a.fillText(r,h[0],h[1]),a.stroke(),t}))}}class Lu{constructor(e){let{id:t,container:n}=e;te(this,"_id",void 0),te(this,"_rootElement",void 0),te(this,"_containerSize",void 0),te(this,"_containerResizeObserver",void 0),te(this,"_containerResizeCallback",(e=>{let t,n;const{contentRect:i,contentBoxSize:o}=e[0];i?(t=i.width,n=i.height):null!=o&&o.length&&(t=o[0].inlineSize,n=o[0].blockSize),this._containerSize={width:t,height:n},this.onContainerResize()})),this._id=t,this._containerSize={width:0,height:0},this._rootElement=this.createRootElement(t),this._containerResizeObserver=new ResizeObserver(this._containerResizeCallback),n&&this.appendTo(n)}get id(){return this._id}get rootElement(){return this._rootElement}appendTo(e){const{_rootElement:t,_containerResizeObserver:n}=this,{parentElement:i}=t;e&&e!==i&&(i&&n.unobserve(i),e.appendChild(t),n.observe(e))}destroy(){const{_rootElement:e,_containerResizeObserver:t}=this,{parentElement:n}=e;null==n||n.removeChild(e),t.disconnect()}get containerSize(){return{...this._containerSize}}createRootElement(e){const t=document.createElement("div");return t.id=e,t.classList.add("widget"),Object.assign(t.style,{width:"100%",height:"100%"}),t}onContainerResize(){}}const Au={MULTIPLIER:1,RANGE_TEXT_POSITION:Su.Right,TICKS_BAR_SIZE:50};class Uu extends Lu{constructor(e){var t,n;super(e),te(this,"_colormaps",void 0),te(this,"_activeColormapName",void 0),te(this,"_eventListenersManager",void 0),te(this,"_canvas",void 0),te(this,"_ticksBar",void 0),te(this,"_rangeTextPosition",void 0),te(this,"_isMouseOver",!1),te(this,"_isInteracting",!1),te(this,"_mouseOverCallback",(e=>{this._isMouseOver=!0,this.showTicks(),e.stopPropagation()})),te(this,"_mouseOutCallback",(e=>{this._isMouseOver=!1,this.hideTicks(),e.stopPropagation()})),te(this,"_mouseDownCallback",(e=>{this._isInteracting=!0,this.showTicks(),this._addVOIEventListeners(e),e.stopPropagation()})),te(this,"_mouseDragCallback",((e,t)=>{const n=this.getVOIMultipliers(),i=this._getPointsFromMouseEvent(e),{points:o,voiRange:a}=t,r=ps.vec2.sub(ps.vec2.create(),i.local,o.local),s=r[0]*n[0],l=r[1]*n[1];if(!s&&!l)return;const{lower:d,upper:c}=a;let{windowWidth:h,windowCenter:u}=J.utilities.windowLevel.toWindowLevel(d,c);h=Math.max(h+s,1),u+=l;const g=J.utilities.windowLevel.toLowHighRange(h,u);this.voiRange=g,e.stopPropagation(),e.preventDefault()})),te(this,"_mouseUpCallback",(e=>{this._isInteracting=!1,this.hideTicks(),this._removeVOIEventListeners(),e.stopPropagation()})),this._eventListenersManager=new J.utilities.eventListener.MultiTargetEventListenerManager,this._colormaps=Uu.getColormapsMap(e),this._activeColormapName=Uu.getInitialColormapName(e),this._canvas=this._createCanvas(e),this._ticksBar=this._createTicksBar(e),this._rangeTextPosition=null!==(t=null===(n=e.ticks)||void 0===n?void 0:n.position)&&void 0!==t?t:Au.RANGE_TEXT_POSITION,this._canvas.appendTo(this.rootElement),this._ticksBar.appendTo(this.rootElement),this._addRootElementEventListeners()}get activeColormapName(){return this._activeColormapName}set activeColormapName(e){if(e===this._activeColormapName)return;const t=this._colormaps.get(e);t?(this._activeColormapName=e,this._canvas.colormap=t):console.warn("Invalid colormap name (".concat(e,")"))}get imageRange(){return this._canvas.imageRange}set imageRange(e){this._canvas.imageRange=e,this._ticksBar.imageRange=e}get voiRange(){return this._canvas.voiRange}set voiRange(e){const{voiRange:t}=this._canvas;yu(e)&&!Ou(e,t)&&(this._canvas.voiRange=e,this._ticksBar.voiRange=e,this.onVoiChange(e))}get showFullImageRange(){return this._canvas.showFullImageRange}set showFullImageRange(e){this._canvas.showFullImageRange=e,this._ticksBar.showFullPixelValueRange=e}destroy(){super.destroy(),this._eventListenersManager.reset()}createRootElement(){const e=document.createElement("div");return Object.assign(e.style,{position:"relative",fontSize:"0",width:"100%",height:"100%"}),e}onContainerResize(){super.onContainerResize(),this.updateTicksBar(),this._canvas.size=this.containerSize}getVOIMultipliers(){return[Au.MULTIPLIER,Au.MULTIPLIER]}onVoiChange(e){}showTicks(){this.updateTicksBar(),this._ticksBar.visible=!0}hideTicks(){this._isInteracting||this._isMouseOver||(this._ticksBar.visible=!1)}static getColormapsMap(e){const{colormaps:t}=e;return t.reduce(((e,t)=>e.set(t.Name,t)),new Map)}static getInitialColormapName(e){const{activeColormapName:t,colormaps:n}=e;return t&&n.some((e=>e.Name===t))?t:n[0].Name}_createCanvas(e){const{imageRange:t,voiRange:n,showFullPixelValueRange:i}=e,o=this._colormaps.get(this._activeColormapName);return new ku({colormap:o,imageRange:t,voiRange:n,showFullPixelValueRange:i})}_createTicksBar(e){const t=e.ticks;return new Pu({imageRange:e.imageRange,voiRange:e.voiRange,ticks:t,showFullPixelValueRange:e.showFullPixelValueRange})}_getPointsFromMouseEvent(e){const{rootElement:t}=this,n=[e.clientX,e.clientY],i=[e.pageX,e.pageY],o=t.getBoundingClientRect();return{client:n,page:i,local:[i[0]-o.left-window.pageXOffset,i[1]-o.top-window.pageYOffset]}}updateTicksBar(){const{width:e,height:t}=this.containerSize;if(0===e&&0===t)return;const{_ticksBar:n,_rangeTextPosition:i}=this,o=e>=t,a=o?e:Au.TICKS_BAR_SIZE,r=o?Au.TICKS_BAR_SIZE:t;if(!function(e,t,n){return(e>=t?[Su.Top,Su.Bottom]:[Su.Left,Su.Right]).includes(n)}(e,t,i))throw new Error("Invalid rangeTextPosition value for the current colobar orientation");let s,l;n.size={width:a,height:r},o?(l=0,s=i===Su.Top?-r:t):(s=0,l=i===Su.Left?-a:e),n.top=s,n.left=l}_addRootElementEventListeners(){const{_eventListenersManager:e}=this,{rootElement:t}=this;e.addEventListener(t,"mouseover",this._mouseOverCallback),e.addEventListener(t,"mouseout",this._mouseOutCallback),e.addEventListener(t,"mousedown",this._mouseDownCallback)}_addVOIEventListeners(e){const{_eventListenersManager:t}=this,n={points:this._getPointsFromMouseEvent(e),voiRange:{...this._canvas.voiRange}};this._removeVOIEventListeners(),t.addEventListener(document,"voi.mouseup",this._mouseUpCallback),t.addEventListener(document,"voi.mousemove",(e=>this._mouseDragCallback(e,n)))}_removeVOIEventListeners(){const{_eventListenersManager:e}=this;e.removeEventListener(document,"voi.mouseup"),e.removeEventListener(document,"voi.mousemove")}}const{Events:Vu}=J.Enums,Wu={lower:-1e3,upper:1e3};class Fu extends Uu{constructor(e){const{element:t,volumeId:n}=e,i=Fu._getImageRange(t,n),o=Fu._getVOIRange(t,n);super({...e,imageRange:i,voiRange:o}),te(this,"_element",void 0),te(this,"_volumeId",void 0),te(this,"_hideTicksTime",void 0),te(this,"_hideTicksTimeoutId",void 0),te(this,"autoHideTicks",(()=>{if(this._hideTicksTimeoutId)return;const e=this._hideTicksTime-Date.now();e<=0?this.hideTicks():this._hideTicksTimeoutId=window.setTimeout((()=>{this._hideTicksTimeoutId=0,this.autoHideTicks()}),e)})),te(this,"_stackNewImageCallback",(()=>{this.imageRange=Fu._getImageRange(this._element)})),te(this,"_imageVolumeModifiedCallback",(e=>{const{volumeId:t}=e.detail.imageVolume;if(t!==this._volumeId)return;const{_element:n}=this;this.imageRange=Fu._getImageRange(n,t)})),te(this,"_viewportVOIModifiedCallback",(e=>{const{viewportId:t,volumeId:n,range:i}=e.detail,{viewport:o}=this.enabledElement;t===o.id&&n===this._volumeId&&(this.voiRange=i,this.showAndAutoHideTicks())})),this._element=t,this._volumeId=n,this._addCornerstoneEventListener()}get element(){return this._element}get enabledElement(){return(0,J.getEnabledElement)(this._element)}getVOIMultipliers(){const{viewport:e}=this.enabledElement;return function(e,t,n){if("PT"===J.utilities.getViewportModality(e,t)){const{clientWidth:n,clientHeight:i}=e.element,o=5/Math.max(n,i),a=sd(e,t),{fixedPTWindowWidth:r=!0}={},s=r?0:o;return a?[s,o]:[s,4]}return[4,4]}(e,this._volumeId)}onVoiChange(e){super.onVoiChange(e);const{viewport:t}=this.enabledElement;if(t instanceof J.StackViewport)t.setProperties({voiRange:e}),t.render();else if(t instanceof J.VolumeViewport){const{_volumeId:n}=this,i=J.utilities.getViewportsWithVolumeId(n,t.renderingEngineId);t.setProperties({voiRange:e},n),i.forEach((e=>e.render()))}}static _getImageRange(e,t){const n=(0,J.getEnabledElement)(e),{viewport:i}=n,o=t?i.getActor(t):i.getDefaultActor();if(!o)return Wu;const a=o.actor.getMapper().getInputData().getPointData().getScalars().getRange();return 0===a[0]&&0===a[1]?Wu:{lower:a[0],upper:a[1]}}static _getVOIRange(e,t){const n=(0,J.getEnabledElement)(e),{viewport:i}=n,o=t?i.getActor(t):i.getDefaultActor();if(!o||!J.utilities.isImageActor(o))return Wu;const a=o.actor.getProperty().getRGBTransferFunction(0).getRange();return 0===a[0]&&0===a[1]?Wu:{lower:a[0],upper:a[1]}}showAndAutoHideTicks(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;this._hideTicksTime=Date.now()+e,this.showTicks(),this.autoHideTicks()}_addCornerstoneEventListener(){const{_element:e}=this;J.eventTarget.addEventListener(Vu.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedCallback),e.addEventListener(Vu.STACK_NEW_IMAGE,this._stackNewImageCallback),e.addEventListener(Vu.VOI_MODIFIED,this._viewportVOIModifiedCallback)}}const Hu=function(e,t){let n=jr.getDefinedCursor(t,!0);n||(n=br.getDefinedCursor(t)),n||(console.log("Cursor ".concat(t," is not defined either as SVG or as a standard cursor.")),n=br.getDefinedCursor(t)),Jr(e,n)},Bu=[...Fr,...Sr],Gu=function(e,t,n){const i=Br("textBoxFontSize",e,t,n),o=Br("textBoxFontFamily",e,t,n);return"".concat(i,"px ").concat(o)};class qu{constructor(){te(this,"annotationUIDs",new Set),te(this,"_isVisible",!0),te(this,"visibleFilter",void 0),this.visibleFilter=this.unboundVisibleFilter.bind(this)}unboundVisibleFilter(e){return!this._isVisible||!this.annotationUIDs.has(e)}has(e){return this.annotationUIDs.has(e)}setVisible(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;this._isVisible!==e&&(this._isVisible=e,this.annotationUIDs.forEach((i=>{const o=et(i);if(!o)return void this.annotationUIDs.delete(i);if(o.isVisible===e)return;if(!e&&!1===(null==n?void 0:n(i)))return;o.isVisible=e;const a={...t,annotation:o};(0,J.triggerEvent)(J.eventTarget,Q.ANNOTATION_MODIFIED,a)})))}get isVisible(){return this._isVisible}findNearby(e,t){const n=[...this.annotationUIDs];if(0===n.length)return null;if(!e)return n[1===t?0:n.length-1];const i=n.indexOf(e);return-1===i||i+t<0||i+t>=n.length?null:n[i+t]}add(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];t.forEach((e=>this.annotationUIDs.add(e)))}remove(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];t.forEach((e=>this.annotationUIDs.delete(e)))}clear(){this.annotationUIDs.clear()}}const ju=function(e){if(!e||!e.length)throw new Error("The segmentationInputArray is undefined or empty array");e.forEach((e=>{if(void 0===e.segmentationId)throw new Error("The segmentationInput.segmentationId is undefined, please provide a valid segmentationId");if(void 0===e.representation)throw new Error("The segmentationInput.representation is undefined, please provide a valid representation");e.representation.type===ot.Labelmap&&function(e){if(!e.representation.data)throw new Error("The segmentationInput.representationData.data is undefined, please provide a valid representationData.data");const t=e.representation.data;if(!t.volumeId)throw new Error("The segmentationInput.representationData.volumeId is undefined, please provide a valid representationData.volumeId");if(!J.cache.getVolume(t.volumeId))throw new Error("volumeId of ".concat(t.volumeId," not found in cache, you should load and cache volume before adding segmentation"))}(e)}))},zu=function(e){ju(e),e.map((e=>{Ct(ie()(e))}))},Ku=async function(e,t,n){if(!zo(e))throw new Error("No tool group found for toolGroupId: ".concat(e));const i=t.map((t=>async function(e,t,n){let i;if(t.type===ot.Labelmap)i=await za.addSegmentationRepresentation(e,t,n);else if(t.type===ot.Contour)i=await Ua.addSegmentationRepresentation(e,t,n);else{if(t.type!==ot.Surface)throw new Error("The representation type ".concat(t.type," is not supported"));i=await Ta.addSegmentationRepresentation(e,t,n)}return i}(e,t,n)));return await Promise.all(i)};class Yu extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]})}touchDragCallback(e){this._dragCallback(e)}mouseDragCallback(e){this._dragCallback(e)}_dragCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,J.getEnabledElement)(t),o=n.world,a=i.viewport.getCamera(),{focalPoint:r,position:s}=a,l=[s[0]-o[0],s[1]-o[1],s[2]-o[2]],d=[r[0]-o[0],r[1]-o[1],r[2]-o[2]];i.viewport.setCamera({focalPoint:d,position:l}),i.viewport.render()}}te(Yu,"toolName",void 0),Yu.toolName="Pan";const Xu=Yu;class Zu extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{rotateIncrementDegrees:2}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"rotateCamera",((e,t,n,i)=>{const o=e.getVtkActiveCamera(),a=o.getViewUp(),r=o.getFocalPoint(),s=o.getPosition(),l=[0,0,0],d=[0,0,0],c=[0,0,0],h=ps.mat4.identity(new Float32Array(16));ps.mat4.translate(h,h,t),ps.mat4.rotate(h,h,i,n),ps.mat4.translate(h,h,[-t[0],-t[1],-t[2]]),ps.vec3.transformMat4(l,s,h),ps.vec3.transformMat4(d,r,h),ps.mat4.identity(h),ps.mat4.rotate(h,h,i,n),ps.vec3.transformMat4(c,a,h),e.setCamera({position:l,viewUp:c,focalPoint:d})})),this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,lastPoints:i}=e.detail,o=n.canvas,a=i.canvas,{rotateIncrementDegrees:r}=this.configuration,s=(0,J.getEnabledElement)(t),{viewport:l}=s,d=l.getCamera(),c=t.clientWidth,h=t.clientHeight,u=[o[0]/c,o[1]/h],g=[a[0]/c,a[1]/h],v=[.5*c,.5*h],m=l.canvasToWorld(v),p=(1+Math.abs(.5))**2,f=[g[0],0,0],E=[u[0],0,0],w=f[0]**2,I=E[0]**2,C=w>p?0:Math.sqrt(p-w),_=I>p?0:Math.sqrt(p-I),T=[f[0],0,C];ac().normalize(T);const b=[E[0],0,_];ac().normalize(b);const D=ac().dot(T,b);if(Math.abs(D)>1e-4){const e=-2*Math.acos(ac().clampValue(D,-1,1))*Math.sign(u[0]-g[0])*r,t=d.viewUp,n=d.viewPlaneNormal,i=[0,0,0],o=[0,0,0];ac().cross(t,n,i),ac().normalize(i),ac().cross(n,i,o),ac().normalize(o),ac().normalize(t),this.rotateCamera(l,m,o,e);const a=(g[1]-u[1])*r;this.rotateCamera(l,m,i,a),l.render()}}}te(Zu,"toolName",void 0),Zu.toolName="TrackballRotate";const Ju=Zu,{transformWorldToIndex:$u}=J.utilities;class Qu extends Ql{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:eg}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"editData",void 0),te(this,"eventDispatchDetail",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"addNewAnnotation",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,o,d,c),u=r.getFrameOfReferenceUID(),g={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:u,referencedImageId:h},data:{label:"",handles:{points:[[...o]]},cachedStats:{}}};Je(g,i);const v=Gl(i,this.getToolName());return this.editData={annotation:g,newAnnotation:!0,viewportIdsToRender:v},this._activateModify(i),Qr(i),e.preventDefault(),Bo(s,v),g})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a}=this.editData,r=(0,J.getEnabledElement)(n),{renderingEngine:s}=r,{viewportId:l}=r;if(this.eventDispatchDetail={viewportId:l,renderingEngineId:s.id},this._deactivateModify(n),$r(n),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Qe(i.annotationUID),Bo(s,o),a){const e=Q.ANNOTATION_COMPLETED,t={annotation:i};(0,J.triggerEvent)(J.eventTarget,e,t)}})),te(this,"_dragCallback",(e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,{annotation:a,viewportIdsToRender:r}=this.editData,{data:s}=a;s.handles.points[0]=[...o],a.invalidated=!0;const l=(0,J.getEnabledElement)(i),{renderingEngine:d}=l;Bo(d,r)})),te(this,"cancel",(e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),$r(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(Bo(r,n),i){const e=Q.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID}})),te(this,"_activateModify",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_deactivateModify",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"renderAnnotation",((e,t)=>{var n,i;let o=!1;const{viewport:a}=e,{element:r}=a;let s=Ze(this.getToolName(),r);if(null===(n=s)||void 0===n||!n.length)return o;if(s=this.filterInteractableAnnotationsForElement(r,s),null===(i=s)||void 0===i||!i.length)return o;const l=this.getTargetId(a),d=a.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let n=0;n<s.length;n++){const i=s[n],r=i.annotationUID,h=i.data,u=h.handles.points[0],g=a.worldToCanvas(u);c.annotationUID=r;const v=this.getStyle("color",c,i);if(h.cachedStats[l]&&null!=h.cachedStats[l].value){if(i.invalidated&&(this._calculateCachedStats(i,d,e),a instanceof J.VolumeViewport)){const{referencedImageId:e}=i.metadata;for(const t in h.cachedStats)t.startsWith("imageId")&&d.getStackViewports().find((t=>{const n=J.utilities.imageIdToURI(e),i=t.hasImageURI(n),o=J.utilities.imageIdToURI(t.getCurrentImageId());return i&&o!==n}))&&delete h.cachedStats[t]}}else h.cachedStats[l]={Modality:null,index:null,value:null},this._calculateCachedStats(i,d,e);if(!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),o;Ms(t,r,"0",[g],{color:v}),o=!0;const m=this.getLinkedTextBoxStyle(c,i);if(!m.visibility)continue;const p=this.configuration.getTextLines(h,l);if(p){const e=[g[0]+6,g[1]-6];Ps(t,r,"0",p,[e[0],e[1]],m)}}return o}))}isPointNearTool(){return!1}toolSelectedCallback(){}getHandleNearImagePoint(e,t,n,i){const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{data:r}=t,s=r.handles.points[0],l=a.worldToCanvas(s);if(!0==ps.vec2.distance(n,l)<i)return s}handleSelectedCallback(e,t){const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Gl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o},this._activateModify(i),Qr(i);const a=(0,J.getEnabledElement)(i),{renderingEngine:r}=a;Bo(r,o),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{viewportId:o,renderingEngineId:a,viewport:r}=n,s=i.handles.points[0],{cachedStats:l}=i,d=Object.keys(l);for(let n=0;n<d.length;n++){const i=d[n],c={isPreScaled:sd(r,i),isSuvScaled:this.isSuvScaled(r,i,e.metadata.referencedImageId)},h=this.getTargetIdImage(i,t);if(!h)continue;const{dimensions:u,imageData:g,metadata:v}=h,m="getScalarData"in h?h.getScalarData():h.scalarData,p=v.Modality,f=$u(g,s);f[0]=Math.round(f[0]),f[1]=Math.round(f[1]),f[2]=Math.round(f[2]);const E=m.length/u[2]/u[1]/u[0];if(J.utilities.indexWithinDimensions(f,u)){this.isHandleOutsideImage=!1;const t=u[0]*E,n=u[0]*u[1]*E,o=f[2]*n+f[1]*t+f[0]*E,r=E>2?[m[o],m[o+1],m[o+2]]:m[o];if(i.startsWith("imageId:")){const e=i.split("imageId:")[1],t=J.utilities.imageIdToURI(e),n=J.utilities.getViewportsWithImageURI(t,a)[0];f[2]=n.getCurrentImageIdIndex()}const s=rd(p,e.metadata.referencedImageId,c);l[i]={index:f,value:r,Modality:p,modalityUnit:s}}else this.isHandleOutsideImage=!0,l[i]={index:f,Modality:p};e.invalidated=!1;const w=Q.ANNOTATION_MODIFIED,I={annotation:e,viewportId:o,renderingEngineId:a};(0,J.triggerEvent)(J.eventTarget,w,I)}return l}}function eg(e,t){const n=e.cachedStats[t],{index:i,value:o,modalityUnit:a}=n;if(void 0===o)return;const r=[];return r.push("(".concat(i[0],", ").concat(i[1],", ").concat(i[2],")")),r.push("".concat(al(o)," ").concat(a)),r}te(Qu,"toolName",void 0),Qu.toolName="Probe";const tg=Qu;class ng extends tg{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:ig}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"editData",void 0),te(this,"eventDispatchDetail",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"postMouseDownCallback",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,o,d,c),u={invalidated:!0,highlighted:!0,isVisible:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:h},data:{label:"",handles:{points:[[...o]]},cachedStats:{}}},g=Gl(i,this.getToolName());return this.editData={annotation:u,newAnnotation:!0,viewportIdsToRender:g},this._activateModify(i),Qr(i),e.preventDefault(),Bo(s,g),u})),te(this,"postTouchStartCallback",(e=>this.postMouseDownCallback(e))),te(this,"renderAnnotation",((e,t)=>{let n=!1;const{viewport:i}=e;if(!this.editData)return n;const o=this.filterInteractableAnnotationsForElement(i.element,[this.editData.annotation]);if(null==o||!o.length)return n;const a=this.getTargetId(i),r=i.getRenderingEngine(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},l=this.editData.annotation,d=l.annotationUID,c=l.data,h=c.handles.points[0],u=i.worldToCanvas(h);s.annotationUID=d;const g=this.getStyle("color",s,l);if(sd(i,a),this.isSuvScaled(i,a,l.metadata.referencedImageId),c.cachedStats[a]&&null!=c.cachedStats[a].value?l.invalidated&&this._calculateCachedStats(l,r,e):(c.cachedStats[a]={Modality:null,index:null,value:null},this._calculateCachedStats(l,r,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;Ms(t,d,"0",[u],{color:g}),n=!0;const v=this.configuration.getTextLines(c,a);if(v){const e=[u[0]+6,u[1]-6];Ps(t,d,"0",v,[e[0],e[1]],this.getLinkedTextBoxStyle(s,l))}return n}))}}function ig(e,t){const n=e.cachedStats[t],{index:i,value:o,modalityUnit:a}=n;if(void 0===o)return;const r=[];return r.push("(".concat(i[0],", ").concat(i[1],", ").concat(i[2],")")),r.push("".concat(o.toFixed(2)," ").concat(a)),r}te(ng,"toolName",void 0),ng.toolName="DragProbe";const og=ng;class ag extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]}),te(this,"_getImageDynamicRangeFromMiddleSlice",((e,t)=>{const n=Math.floor(t[2]/2),i=t[0]*t[1];let o,a;e instanceof Float32Array?(o=4,a=Float32Array):e instanceof Uint8Array?(o=1,a=Uint8Array):e instanceof Uint16Array?(o=2,a=Uint16Array):e instanceof Int16Array&&(o=2,a=Int16Array);const r=new a(e.buffer,n*i*o,i),{max:s,min:l}=this._getMinMax(r,i);return s-l}))}touchDragCallback(e){this.mouseDragCallback(e)}mouseDragCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,J.getEnabledElement)(t),{renderingEngine:o,viewport:a}=i;let r,s,l,d,c,h,u=!1;const g=a.getProperties();if(a instanceof J.VolumeViewport){r=this.getTargetId(a).split("volumeId:")[1],h=J.utilities.getViewportsWithVolumeId(r,o.id),({lower:s,upper:l}=g.voiRange);const e=J.cache.getVolume(r);if(!e)throw new Error("Volume not found "+r);d=e.metadata.Modality,u=e.scaling&&Object.keys(e.scaling).length>0}else{if(!g.voiRange)throw new Error("Viewport is not a valid type");{var v,m;d=a.modality,({lower:s,upper:l}=g.voiRange);const{preScale:e={scaled:!1}}=(null===(v=a.getImageData)||void 0===v?void 0:v.call(a))||{};u=e.scaled&&void 0!==(null===(m=e.scalingParameters)||void 0===m?void 0:m.suvbw)}}c="PT"===d?this.getPTScaledNewRange({deltaPointsCanvas:n.canvas,lower:s,upper:l,clientHeight:t.clientHeight,isPreScaled:u,viewport:a,volumeId:r}):this.getNewRange({viewport:a,deltaPointsCanvas:n.canvas,volumeId:r,lower:s,upper:l}),a.setProperties({voiRange:c}),a.render(),a instanceof J.VolumeViewport&&h.forEach((e=>{a!==e&&e.render()}))}getPTScaledNewRange(e){let{deltaPointsCanvas:t,lower:n,upper:i,clientHeight:o,viewport:a,volumeId:r,isPreScaled:s}=e,l=4;return l=s?5/o:this._getMultiplierFromDynamicRange(a,r)||4,i-=t[1]*l,i=s?Math.max(i,.1):i,{lower:n,upper:i}}getNewRange(e){let{viewport:t,deltaPointsCanvas:n,volumeId:i,lower:o,upper:a}=e;const r=this._getMultiplierFromDynamicRange(t,i)||4,s=n[0]*r,l=n[1]*r;let{windowWidth:d,windowCenter:c}=J.utilities.windowLevel.toWindowLevel(o,a);return d+=s,c+=l,d=Math.max(d,1),J.utilities.windowLevel.toLowHighRange(d,c)}_getMultiplierFromDynamicRange(e,t){let n;if(t){var i;const e=J.cache.getVolume(t),{dimensions:o}=e,a=e.getScalarData(),r=this._getImageDynamicRangeFromMiddleSlice(a,o),s=null==e||null===(i=e.metadata)||void 0===i?void 0:i.BitsStored,l=s?2**s:1/0;n=Math.min(r,l)}else n=this._getImageDynamicRangeFromViewport(e);const o=n/1024;let a=4;return o>1&&(a=Math.round(o)),a}_getImageDynamicRangeFromViewport(e){const{imageData:t}=e.getImageData(),n=t.getDimensions();if(t.getRange)return t.getRange();let i,o;if(i=t.getScalarData?t.getScalarData():t.getPointData().getScalars(),1!==n[2])return this._getImageDynamicRangeFromMiddleSlice(i,n);if(i.getRange)o=i.getRange();else{const{min:e,max:t}=this._getMinMax(i,i.length);o=[e,t]}return o[1]-o[0]}_getMinMax(e,t){let n=1/0,i=-1/0;for(let o=0;o<t;o++){const t=e[o];t<n&&(n=t),t>i&&(i=t)}return{max:i,min:n}}}te(ag,"toolName",void 0),ag.toolName="WindowLevel";const rg=ag;class sg extends la{constructor(){var e;super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{zoomToCenter:!1,minZoomScale:.1,maxZoomScale:30,pinchToZoom:!0,pan:!0,invert:!1}}),e=this,te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"initialMousePosWorld",void 0),te(this,"dirVec",void 0),te(this,"preMouseDownCallback",(e=>{const t=e.detail,{element:n,currentPoints:i}=t,o=i.world,a=(0,J.getEnabledElement)(n).viewport.getCamera(),{focalPoint:r}=a;this.initialMousePosWorld=o;let s=ps.vec3.fromValues(r[0]-o[0],r[1]-o[1],r[2]-o[2]);return s=ps.vec3.normalize(ps.vec3.create(),s),this.dirVec=s,!1})),te(this,"preTouchStartCallback",(e=>{if(!this.configuration.pinchToZoom)return this.preMouseDownCallback(e)})),te(this,"_dragParallelProjection",(function(t,n,i){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const{element:a,deltaPoints:r}=t.detail,s=o?t.detail.deltaDistance.canvas:r.canvas[1],l=[a.clientWidth,a.clientHeight],{parallelScale:d,focalPoint:c,position:h}=i,u=s*(5/l[1])*(e.configuration.invert?-1:1),g=(1-u)*d;let v=c,m=h;if(!e.configuration.zoomToCenter){const t=ps.vec3.distance(c,e.initialMousePosWorld);m=ps.vec3.scaleAndAdd(ps.vec3.create(),h,e.dirVec,-t*u),v=ps.vec3.scaleAndAdd(ps.vec3.create(),c,e.dirVec,-t*u)}const p=n.getImageData();let f=[1,1,1];p&&(f=p.spacing);const{minZoomScale:E,maxZoomScale:w}=e.configuration,I=a.clientHeight*f[1]*.5,C=I/g;let _=g,T=!1;p&&(C<E?(_=I/E,T=!0):C>=w&&(_=I/w,T=!0)),n.setCamera({parallelScale:_,focalPoint:T?c:v,position:T?h:m})})),te(this,"_dragPerspectiveProjection",(function(t,n,i){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const{element:a,deltaPoints:r}=t.detail,s=o?t.detail.deltaDistance.canvas:r.canvas[1],l=[a.clientWidth,a.clientHeight],{position:d,focalPoint:c,viewPlaneNormal:h}=i,u=ac().distance2BetweenPoints(d,c),g=Math.sqrt(u)/l[1],v=[-h[0],-h[1],-h[2]],m=e.configuration.invert?s/g:s*g;let p=m*v[0];d[0]+=p,c[0]+=p,p=m*v[1],d[1]+=p,c[1]+=p,p=m*v[2],d[2]+=p,c[2]+=p,n.setCamera({position:d,focalPoint:c})})),this.initialMousePosWorld=[0,0,0],this.dirVec=[0,0,0],this.configuration.pinchToZoom?this.touchDragCallback=this._pinchCallback.bind(this):this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_pinchCallback(e){if(e.detail.currentPointsList.length>1){const{element:t,currentPoints:n}=e.detail,i=(0,J.getEnabledElement)(t),{viewport:o}=i,a=o.getCamera(),r=n.world,{focalPoint:s}=a;this.initialMousePosWorld=r;let l=ps.vec3.fromValues(s[0]-r[0],s[1]-r[1],s[2]-r[2]);l=ps.vec3.normalize(ps.vec3.create(),l),this.dirVec=l,a.parallelProjection?this._dragParallelProjection(e,o,a,!0):this._dragPerspectiveProjection(e,o,a,!0),o.render()}this.configuration.pan&&this._panCallback(e)}_dragCallback(e){const{element:t}=e.detail,n=(0,J.getEnabledElement)(t),{viewport:i}=n,o=i.getCamera();o.parallelProjection?this._dragParallelProjection(e,i,o):this._dragPerspectiveProjection(e,i,o),i.render()}_panCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,J.getEnabledElement)(t),o=n.world,a=i.viewport.getCamera(),{focalPoint:r,position:s}=a,l=[s[0]-o[0],s[1]-o[1],s[2]-o[2]],d=[r[0]-o[0],r[1]-o[1],r[2]-o[2]];i.viewport.setCamera({focalPoint:d,position:l}),i.viewport.render()}}te(sg,"toolName",void 0),sg.toolName="Zoom";const lg=sg;class dg extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}}),te(this,"deltaY",void 0),this.deltaY=1}mouseDragCallback(e){this._dragCallback(e)}touchDragCallback(e){this._dragCallback(e)}_dragCallback(e){const{deltaPoints:t,viewportId:n,renderingEngineId:i}=e.detail,{viewport:o}=(0,J.getEnabledElementByIds)(n,i),a=this.getTargetId(o),{debounceIfNotLoaded:r,invert:s,loop:l}=this.configuration,d=t.canvas[1];let c;o instanceof J.VolumeViewport&&(c=a.split("volumeId:")[1]);const h=this._getPixelPerImage(o),u=d+this.deltaY;if(h)if(Math.abs(u)>=h){const e=Math.round(u/h);Es(o,{delta:s?-e:e,volumeId:c,debounceLoading:r,loop:l}),this.deltaY=u%h}else this.deltaY=u}_getPixelPerImage(e){const{element:t}=e,n=e.getNumberOfSlices();return Math.max(2,t.offsetHeight/Math.max(n,8))}}te(dg,"toolName",void 0),dg.toolName="StackScroll";const cg=dg;function hg(e,t){return 3===e[0].length?function(e,t){const[n,i]=e,[o,a]=t,r=ps.vec3.sub(ps.vec3.create(),i,n),s=ps.vec3.sub(ps.vec3.create(),o,a),l=ps.vec3.dot(r,s)/(ps.vec3.length(r)*ps.vec3.length(s));return 180*Math.acos(l)/Math.PI}(e,t):function(e,t){const[n,i]=e,[o,a]=t,r=ps.vec2.sub(ps.vec2.create(),i,n),s=ps.vec2.sub(ps.vec2.create(),o,a),l=ps.vec2.dot(r,s)/(ps.vec2.length(r)*ps.vec2.length(s));return Math.acos(l)*(180/Math.PI)}(e,t)}class ug extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,startPoints:i}=e.detail,o=n.world,a=i.world,r=(0,J.getEnabledElement)(t),{viewport:s}=r,l=s.getCamera(),d=[.5*t.clientWidth,.5*t.clientHeight],c=s.canvasToWorld(d);let h=hg([a,c],[c,o]);const{viewPlaneNormal:u,viewUp:g}=l,v=ps.vec3.sub(ps.vec3.create(),c,a),m=ps.vec3.sub(ps.vec3.create(),c,o),p=ps.vec3.cross(ps.vec3.create(),v,m);if(ps.vec3.dot(u,p)>0&&(h=-h),!Number.isNaN(h)){if(s instanceof J.BaseVolumeViewport){const e=h*Math.PI/180,t=ps.mat4.identity(new Float32Array(16));ps.mat4.rotate(t,t,e,u);const n=ps.vec3.transformMat4(ps.vec3.create(),g,t);s.setCamera({viewUp:n})}else{const{rotation:e}=s.getProperties();s.setProperties({rotation:e+h})}s.render()}}}te(ug,"toolName",void 0),ug.toolName="PlanarRotate";const gg=ug;class vg extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}}),te(this,"_configuration",void 0)}mouseWheelCallback(e){const{wheel:t,element:n}=e.detail,{direction:i}=t,{invert:o}=this.configuration,{viewport:a}=(0,J.getEnabledElement)(n),r=i*(o?-1:1),s=this.getTargetId(a).split("volumeId:")[1];Es(a,{delta:r,debounceLoading:this.configuration.debounceIfNotLoaded,loop:this.configuration.loop,volumeId:s})}}te(vg,"toolName",void 0),vg.toolName="StackScrollMouseWheel";const mg=vg,pg={X:[1,0,0],Y:[0,1,0],Z:[0,0,1],CUSTOM:[]};class fg extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{direction:pg.Z,rotateIncrementDegrees:.5}}),te(this,"_configuration",void 0)}mouseWheelCallback(e){const{element:t,wheel:n}=e.detail,i=(0,J.getEnabledElement)(t),{viewport:o}=i,{direction:a,rotateIncrementDegrees:r}=this.configuration,s=o.getCamera(),{viewUp:l,position:d,focalPoint:c}=s,{direction:h}=n,[u,g,v]=c,[m,p,f]=a,E=h*r,w=[0,0,0],I=[0,0,0],C=[0,0,0],_=ps.mat4.identity(new Float32Array(16));ps.mat4.translate(_,_,[u,g,v]),ps.mat4.rotate(_,_,E,[m,p,f]),ps.mat4.translate(_,_,[-u,-g,-v]),ps.vec3.transformMat4(w,d,_),ps.vec3.transformMat4(I,c,_),ps.mat4.identity(_),ps.mat4.rotate(_,_,E,[m,p,f]),ps.vec3.transformMat4(C,l,_),o.setCamera({position:w,viewUp:C,focalPoint:I}),o.render()}}te(fg,"toolName",void 0),fg.toolName="VolumeRotateMouseWheel";const Eg=fg;class wg extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{targetViewportIds:[]}}),te(this,"_bounds",void 0)}mouseClickCallback(e){const{element:t,currentPoints:n}=e.detail,i=(0,J.getEnabledElement)(t),{viewport:o,renderingEngine:a}=i,r=this.getTargetId(o);if(!r.startsWith("volumeId"))throw new Error("MIPJumpToClickTool: targetId is not a volumeId, you should only use MIPJumpToClickTool with a volumeId as the targetId");const s=r.split("volumeId:")[1];let l=-1/0;const d=rc(o,n.world,s,((e,t)=>{if(e>l)return l=e,t}));if(!d||!d.length)return;const{targetViewportIds:c,toolGroupId:h}=this.configuration;a.getViewports().filter((e=>{if((null==c?void 0:c.indexOf(e.id))>=0)return!0;const t=Si(e.id,a.id);return!(!h||h!==(null==t?void 0:t.id))})).forEach((e=>{e instanceof J.VolumeViewport?Iu(e,d):console.warn("Cannot jump to specified world coordinates for a viewport that is not a VolumeViewport")}))}}te(wg,"toolName",void 0),wg.toolName="MIPJumpToClickTool";const Ig=wg,{transformWorldToIndex:Cg}=J.utilities;class _g extends Ql{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:Tg}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"addNewAnnotation",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a;Qr(i),this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,o,d,c),u=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:u,referencedImageId:h},data:{handles:{points:[[...o],[...o]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};Je(g,i);const v=Gl(i,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:v,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),Bo(s,v),g})),te(this,"isPointNearTool",((e,t,n,i)=>{const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{data:r}=t,[s,l]=r.handles.points,d=a.worldToCanvas(s),c=a.worldToCanvas(l),h={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}};return nd([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]])<=i})),te(this,"toolSelectedCallback",((e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Gl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(i),Qr(i);const a=(0,J.getEnabledElement)(i),{renderingEngine:r}=a;Bo(r,o),e.preventDefault()})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=i;if(a&&!r)return;s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),$r(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Qe(i.annotationUID),Bo(d,o),a){const e=Q.ANNOTATION_COMPLETED,t={annotation:i};(0,J.triggerEvent)(J.eventTarget,e,t)}this.editData=null,this.isDrawing=!1})),te(this,"_dragCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=s.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;s.handles.points[a]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;Bo(d,o)})),te(this,"cancel",(e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),$r(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(Bo(r,n),i){const e=Q.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID}})),te(this,"_activateModify",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_deactivateModify",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_activateDraw",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_MOVE,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_deactivateDraw",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_MOVE,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"renderAnnotation",((e,t)=>{var n,i;let o=!1;const{viewport:a}=e,{element:r}=a;let s=Ze(this.getToolName(),r);if(null===(n=s)||void 0===n||!n.length)return o;if(s=this.filterInteractableAnnotationsForElement(r,s),null===(i=s)||void 0===i||!i.length)return o;const l=this.getTargetId(a),d=a.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let n=0;n<s.length;n++){const i=s[n],{annotationUID:r,data:h}=i,{points:u,activeHandleIndex:g}=h.handles;c.annotationUID=r;const v=this.getStyle("lineWidth",c,i),m=this.getStyle("lineDash",c,i),p=this.getStyle("color",c,i),f=this.getStyle("shadow",c,i),E=u.map((e=>a.worldToCanvas(e)));let w;if(h.cachedStats[l]&&null!=h.cachedStats[l].unit?i.invalidated&&this._throttledCalculateCachedStats(i,d,e):(h.cachedStats[l]={length:null,unit:null},this._calculateCachedStats(i,d,e)),!Me(r))continue;le(i)||this.editData||null===g||(w=[E[g]]),w&&Ms(t,r,"0",E,{color:p,lineDash:m,lineWidth:v});const I="".concat(r,"-line");if(xs(t,r,"1",E[0],E[1],{color:p,width:v,lineDash:m,shadow:f},I),o=!0,!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),o;const C=this.getLinkedTextBoxStyle(c,i);if(!C.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const _=this.configuration.getTextLines(h,l);if(!h.handles.textBox.hasMoved){const e=od(E);h.handles.textBox.worldPosition=a.canvasToWorld(e)}const T=a.worldToCanvas(h.handles.textBox.worldPosition),b=As(t,r,"1",_,T,E,{},C),{x:D,y:S,width:y,height:O}=b;h.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([D,S]),topRight:a.canvasToWorld([D+y,S]),bottomLeft:a.canvasToWorld([D,S+O]),bottomRight:a.canvasToWorld([D+y,S+O])}}return o})),this._throttledCalculateCachedStats=js(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=Gl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(o),Qr(o);const d=(0,J.getEnabledElement)(o),{renderingEngine:c}=d;Bo(c,l),e.preventDefault()}_calculateLength(e,t){const n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+i*i+o*o)}_calculateCachedStats(e,t,n){const i=e.data,{viewportId:o,renderingEngineId:a}=n,r=i.handles.points[0],s=i.handles.points[1],{cachedStats:l}=i,d=Object.keys(l);for(let e=0;e<d.length;e++){const n=d[e],i=this.getTargetIdImage(n,t);if(!i)continue;const{imageData:o,dimensions:a}=i,c=$s(i),h=this._calculateLength(r,s)/c,u=Cg(o,r),g=Cg(o,s);this._isInsideVolume(u,g,a)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,l[n]={length:h,unit:Zs(0,i)}}e.invalidated=!1;const c=Q.ANNOTATION_MODIFIED,h={annotation:e,viewportId:o,renderingEngineId:a};return(0,J.triggerEvent)(J.eventTarget,c,h),l}_isInsideVolume(e,t,n){return J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n)}}function Tg(e,t){const n=e.cachedStats[t],{length:i,unit:o}=n;if(null!=i&&!isNaN(i))return["".concat(al(i)," ").concat(o)]}te(_g,"toolName",void 0),_g.toolName="Length";const bg=_g;var Dg=I(847),Sg=I.n(Dg);const{RENDERING_DEFAULTS:yg}=J.CONSTANTS;function Og(){return"rgb(0, 200, 0)"}function Mg(){return!0}function xg(){return!0}function Ng(){return!0}class kg extends Ql{constructor(){var e,t,n,i;let o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(o,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse"],configuration:{shadow:!0,viewportIndicators:!0,autoPan:{enabled:!1,panSize:10},referenceLinesCenterGapRadius:20,filterActorUIDsToSetSlabThickness:[],slabThicknessBlendMode:J.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,mobile:{enabled:!1,opacity:.8,handleRadius:9}}}),te(this,"toolCenter",[0,0,0]),te(this,"_getReferenceLineColor",void 0),te(this,"_getReferenceLineControllable",void 0),te(this,"_getReferenceLineDraggableRotatable",void 0),te(this,"_getReferenceLineSlabThicknessControlsOn",void 0),te(this,"editData",void 0),te(this,"initializeViewport",(e=>{let{renderingEngineId:t,viewportId:n}=e;const i=(0,J.getEnabledElementByIds)(n,t),{FrameOfReferenceUID:o,viewport:a}=i,{element:r}=a,{position:s,focalPoint:l,viewPlaneNormal:d}=a.getCamera();let c=this._getAnnotations(i);return c=this.filterInteractableAnnotationsForElement(r,c),c.length&&Qe(c[0].annotationUID),Je({highlighted:!1,metadata:{cameraPosition:[...s],cameraFocalPoint:[...l],FrameOfReferenceUID:o,toolName:this.getToolName()},data:{handles:{rotationPoints:[],slabThicknessPoints:[],toolCenter:this.toolCenter},activeOperation:null,activeViewportIds:[],viewportId:n}},r),{normal:d,point:a.canvasToWorld([a.canvas.clientWidth/2,a.canvas.clientHeight/2])}})),te(this,"_getViewportsInfo",(()=>zo(this.toolGroupId).viewportsInfo)),te(this,"computeToolCenter",(e=>{if(!e.length||1===e.length)throw new Error("For crosshairs to operate, at least two viewports must be given.");const[t,n,i]=e,{normal:o,point:a}=this.initializeViewport(t),{normal:r,point:s}=this.initializeViewport(n);let l=[0,0,0],d=ps.vec3.create();i?({normal:l,point:d}=this.initializeViewport(i)):(ps.vec3.add(d,a,s),ps.vec3.scale(d,d,.5),ps.vec3.cross(l,o,r));const c=J.utilities.planar.planeEquation(o,a),h=J.utilities.planar.planeEquation(r,s),u=J.utilities.planar.planeEquation(l,d);this.toolCenter=J.utilities.planar.threePlaneIntersection(c,h,u);const{renderingEngine:g}=(0,J.getEnabledElementByIds)(e[0].viewportId,e[0].renderingEngineId);Bo(g,e.map((e=>{let{viewportId:t}=e;return t})))})),te(this,"addNewAnnotation",(e=>{const t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.world,a=(0,J.getEnabledElement)(n),{viewport:r}=a;this._jump(a,o);const s=this._getAnnotations(a),l=this.filterInteractableAnnotationsForElement(r.element,s),{data:d}=l[0],{rotationPoints:c}=d.handles,h=[];for(let e=0;e<c.length-1;++e){const t=c[e][1],n=this._getReferenceLineControllable(t.id),i=this._getReferenceLineDraggableRotatable(t.id);n&&i&&(h.push(t.id),e++)}return d.activeViewportIds=[...h],d.handles.activeOperation=1,e.preventDefault(),Qr(n),this._activateModify(n),l[0]})),te(this,"cancel",(()=>{console.log("Not implemented yet")})),te(this,"handleSelectedCallback",((e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0,this._activateModify(i),Qr(i),e.preventDefault()})),te(this,"isPointNearTool",((e,t,n,i)=>!!this._pointNearTool(e,t,n,6))),te(this,"toolSelectedCallback",((e,t,n)=>{const i=e.detail,{element:o}=i;t.highlighted=!0,this._activateModify(o),Qr(o),e.preventDefault()})),te(this,"onCameraModified",(e=>{var t;const n=e.detail,{element:i}=n,o=(0,J.getEnabledElement)(i),{renderingEngine:a}=o,r=o.viewport,s=this._getAnnotations(o),l=this.filterInteractableAnnotationsForElement(i,s)[0];if(!l)return;const d=r.getCamera(),c=l.metadata.cameraPosition,h=[0,0,0];ac().subtract(d.position,c,h);const u=l.metadata.cameraFocalPoint,g=[0,0,0];ac().subtract(d.focalPoint,u,g),l.metadata.cameraPosition=[...d.position],l.metadata.cameraFocalPoint=[...d.focalPoint];const v=this._getReferenceLineControllable(r.id),m=this._getReferenceLineDraggableRotatable(r.id);if(!J.utilities.isEqual(d.position,c,.001)&&v&&m){let e=!1;J.utilities.isEqual(h,g,.001)||(e=!0);const t=Math.abs(ac().dot(h,d.viewPlaneNormal))<.01;e||t||(this.toolCenter[0]+=h[0],this.toolCenter[1]+=h[1],this.toolCenter[2]+=h[2])}null!==(t=this.configuration.autoPan)&&void 0!==t&&t.enabled&&Si(r.id,a.id).getViewportIds().filter((e=>e!==r.id)).forEach((e=>{this._autoPanViewportIfNecessary(e,a)}));const p=Gl(i,this.getToolName(),!1);Bo(a,p)})),te(this,"mouseMoveCallback",((e,t)=>{const{element:n,currentPoints:i}=e.detail,o=i.canvas;let a=!1;for(let e=0;e<t.length;e++){const i=t[e];if(le(i))continue;const{data:r,highlighted:s}=i;if(!r.handles)continue;const l=r.handles.activeOperation,d=r.activeViewportIds&&r.activeViewportIds.length>0?[...r.activeViewportIds]:[];r.activeViewportIds=[],r.handles.activeOperation=null;let c=!1;c=!!this.getHandleNearImagePoint(n,i,o,6)||this._pointNearTool(n,i,o,6),c&&!s||!c&&s?(i.highlighted=!s,a=!0):r.handles.activeOperation===l&&this._areViewportIdArraysEqual(r.activeViewportIds,d)||(a=!0)}return a})),te(this,"filterInteractableAnnotationsForElement",((e,t)=>{if(!t||!t.length)return[];const n=(0,J.getEnabledElement)(e),{viewportId:i}=n;return t.filter((e=>e.data.viewportId===i))})),te(this,"renderAnnotation",((e,t)=>{let n=!1;const{viewport:i,renderingEngine:o}=e,{element:a}=i,r=this._getAnnotations(e),s=i.getCamera(),l=this.filterInteractableAnnotationsForElement(a,r)[0];if(null==r||!r.length||null==l||!l.data)return n;const d=l.annotationUID,{clientWidth:c,clientHeight:h}=i.canvas,u=Math.sqrt(c*c+h*h),g=Math.min(c,h),v=l.data,m=i.worldToCanvas(this.toolCenter),p=this._filterAnnotationsByUniqueViewportOrientations(e,r),f=[],E=[0,0,c,h];p.forEach((e=>{const{data:t}=e;t.handles.toolCenter=this.toolCenter;const n=o.getViewport(t.viewportId),a=n.getCamera(),r=this._getReferenceLineControllable(n.id),l=this._getReferenceLineDraggableRotatable(n.id),d=this._getReferenceLineSlabThicknessControlsOn(n.id),{clientWidth:c,clientHeight:h}=n.canvas,v=Math.sqrt(c*c+h*h),w=[.5*c,.5*h],I=n.canvasToWorld(w),C=[0,0,0];ac().cross(s.viewPlaneNormal,a.viewPlaneNormal,C),ac().normalize(C),ac().multiplyScalar(C,v);const _=[0,0,0];ac().add(I,C,_);const T=[0,0,0];ac().subtract(I,C,T);const b=i.worldToCanvas(_),D=i.worldToCanvas(I),S=ps.vec2.create();ps.vec2.subtract(S,b,D),ps.vec2.normalize(S,S);const y=ps.vec2.create();ps.vec2.scale(y,S,100*u);const O=ps.vec2.create();ps.vec2.scale(O,S,.4*g);const M=ps.vec2.create();ps.vec2.scale(M,S,.2*g);const x=ps.vec2.create(),N=this.configuration.referenceLinesCenterGapRadius;ps.vec2.scale(x,S,2===p.length?N:0);const k=ps.vec2.create(),R=ps.vec2.create(),P=ps.vec2.create(),L=ps.vec2.create();let A=ps.vec2.clone(m);l&&r||(A=ps.vec2.clone(D)),ps.vec2.add(k,A,x),ps.vec2.add(R,A,y),ps.vec2.subtract(P,A,x),ps.vec2.subtract(L,A,y),Hd(k,R,E),Hd(P,L,E);const U=ps.vec2.create();ps.vec2.subtract(U,m,O);const V=ps.vec2.create();ps.vec2.add(V,m,O);let W=ps.vec2.clone(m);!l&&d&&(W=ps.vec2.clone(D));let F=[...this.toolCenter];!l&&d&&(F=[...I]);const H=[0,0,0];ac().subtract(_,T,H),ac().normalize(H);const{viewPlaneNormal:B}=s,{matrix:G}=Sg().buildFromDegree().rotate(90,B),q=[0,0,0];ps.vec3.transformMat4(q,H,G);const j=n.getSlabThickness(),z=[...q];ac().multiplyScalar(z,j);const K=[0,0,0];ac().add(F,z,K);const Y=i.worldToCanvas(K),X=ps.vec2.create();ps.vec2.subtract(X,W,Y);const Z=ps.vec2.create();ps.vec2.subtract(Z,W,y),ps.vec2.add(Z,Z,X);const J=ps.vec2.create();ps.vec2.add(J,W,y),ps.vec2.add(J,J,X),Hd(Z,J,E);const $=ps.vec2.create();ps.vec2.add($,W,y),ps.vec2.subtract($,$,X);const Q=ps.vec2.create();ps.vec2.subtract(Q,W,y),ps.vec2.subtract(Q,Q,X),Hd($,Q,E);const ee=ps.vec2.create(),te=ps.vec2.create(),ne=ps.vec2.create(),ie=ps.vec2.create();ps.vec2.subtract(ee,W,M),ps.vec2.add(ee,ee,X),ps.vec2.add(te,W,M),ps.vec2.add(te,te,X),ps.vec2.subtract(ne,W,M),ps.vec2.subtract(ne,ne,X),ps.vec2.add(ie,W,M),ps.vec2.subtract(ie,ie,X),f.push([n,k,R,P,L,Z,J,$,Q,U,V,ee,te,ne,ie])}));const w=[],I=[],C=this._getReferenceLineColor(i.id),_=void 0!==C?C:"rgb(200, 200, 200)";return f.forEach(((e,n)=>{var o,a;const r=e[0],s=this._getReferenceLineColor(r.id),l=this._getReferenceLineControllable(r.id),c=this._getReferenceLineDraggableRotatable(r.id)||(null===(o=this.configuration.mobile)||void 0===o?void 0:o.enabled),h=this._getReferenceLineSlabThicknessControlsOn(r.id)||(null===(a=this.configuration.mobile)||void 0===a?void 0:a.enabled),u=v.activeViewportIds.find((e=>e===r.id));let g=void 0!==s?s:"rgb(200, 200, 200)",m=1;const p=null!==v.handles.activeOperation&&1===v.handles.activeOperation&&u;p&&(m=2.5);let f="".concat(n);if(l&&c?(f="".concat(n,"One"),xs(t,d,f,e[1],e[2],{color:g,lineWidth:m}),f="".concat(n,"Two"),xs(t,d,f,e[3],e[4],{color:g,lineWidth:m})):xs(t,d,f,e[2],e[4],{color:g,lineWidth:m}),l){var E;g=void 0!==s?s:"rgb(200, 200, 200)";const o=2===v.handles.activeOperation,a=[e[9],e[10]],l=[i.canvasToWorld(e[9]),r,e[1],e[2]],m=[i.canvasToWorld(e[10]),r,e[3],e[4]];w.push(l,m);const U=3===v.handles.activeOperation,V=[e[11],e[12],e[13],e[14]],W=[i.canvasToWorld(e[11]),r,e[5],e[6]],F=[i.canvasToWorld(e[12]),r,e[5],e[6]],H=[i.canvasToWorld(e[13]),r,e[7],e[8]],B=[i.canvasToWorld(e[14]),r,e[7],e[8]];if(I.push(W,F,H,B),(p||null!==(E=this.configuration.mobile)&&void 0!==E&&E.enabled)&&!o&&!U&&c&&h){var C,_,T,b,D,S,y,O;let e="".concat(n,"One");Ms(t,d,e,a,{color:g,handleRadius:null!==(C=this.configuration.mobile)&&void 0!==C&&C.enabled?null===(_=this.configuration.mobile)||void 0===_?void 0:_.handleRadius:3,opacity:null!==(T=this.configuration.mobile)&&void 0!==T&&T.enabled?null===(b=this.configuration.mobile)||void 0===b?void 0:b.opacity:1,type:"circle"}),e="".concat(n,"Two"),Ms(t,d,e,V,{color:g,handleRadius:null!==(D=this.configuration.mobile)&&void 0!==D&&D.enabled?null===(S=this.configuration.mobile)||void 0===S?void 0:S.handleRadius:3,opacity:null!==(y=this.configuration.mobile)&&void 0!==y&&y.enabled?null===(O=this.configuration.mobile)||void 0===O?void 0:O.opacity:1,type:"rect"})}else if(p&&!o&&!U&&c){var M,x,N,k;const e="".concat(n);Ms(t,d,e,a,{color:g,handleRadius:null!==(M=this.configuration.mobile)&&void 0!==M&&M.enabled?null===(x=this.configuration.mobile)||void 0===x?void 0:x.handleRadius:3,opacity:null!==(N=this.configuration.mobile)&&void 0!==N&&N.enabled?null===(k=this.configuration.mobile)||void 0===k?void 0:k.opacity:1,type:"circle"})}else if(u&&!o&&!U&&h){var R,P,L,A;const e="".concat(n);Ms(t,d,e,V,{color:g,handleRadius:null!==(R=this.configuration.mobile)&&void 0!==R&&R.enabled?null===(P=this.configuration.mobile)||void 0===P?void 0:P.handleRadius:3,opacity:null!==(L=this.configuration.mobile)&&void 0!==L&&L.enabled?null===(A=this.configuration.mobile)||void 0===A?void 0:A.opacity:1,type:"rect"})}else if(o&&c){const e="".concat(n);Ms(t,d,e,a,{color:g,handleRadius:2,fill:g,type:"circle"})}else U&&u&&h&&Ms(t,d,f,V,{color:g,handleRadius:2,fill:g,type:"rect"});r.getSlabThickness()>.5&&h&&(f="".concat(n,"STOne"),xs(t,d,f,e[5],e[6],{color:g,width:1,lineDash:[2,3]}),f="".concat(n,"STTwo"),xs(t,d,f,e[7],e[8],{color:g,width:e,lineDash:[2,3]}))}})),n=!0,v.handles.rotationPoints=w,v.handles.slabThicknessPoints=I,this.configuration.viewportIndicators&&ys(t,d,"0",[.95*c,.05*h],.01*u,{color:_,fill:_}),n})),te(this,"_getAnnotations",(e=>{const{viewport:t}=e,n=Ze(this.getToolName(),t.element)||[],i=this._getViewportsInfo().map((e=>{let{viewportId:t}=e;return t}));return n.filter((e=>{const{data:t}=e;return i.includes(t.viewportId)}))})),te(this,"_onNewVolume",(e=>{const t=this._getViewportsInfo();this.computeToolCenter(t)})),te(this,"_areViewportIdArraysEqual",((e,t)=>e.length===t.length&&(e.forEach((e=>{let n=!1;for(let i=0;i<t.length;++i)if(e===t[i]){n=!0;break}if(!1===n)return!1})),!0))),te(this,"_getAnnotationsForViewportsWithDifferentCameras",((e,t)=>{const{viewportId:n,renderingEngine:i,viewport:o}=e,a=t.filter((e=>e.data.viewportId!==n));if(!a||!a.length)return[];const r=o.getCamera(),{viewPlaneNormal:s,position:l}=r,d=a.filter((e=>{const{viewportId:t}=e.data,n=i.getViewport(t).getCamera();return!(J.utilities.isEqual(n.viewPlaneNormal,s,.01)&&J.utilities.isEqual(n.position,l,1))}));return d})),te(this,"_filterViewportWithSameOrientation",((e,t,n)=>{const{renderingEngine:i}=e,{data:o}=t,a=i.getViewport(o.viewportId),r=n.filter((e=>{const{data:t}=e,n=i.getViewport(t.viewportId);return!0===this._getReferenceLineControllable(n.id)}));if(!r||!r.length)return[];const s=a.getCamera(),l=s.viewPlaneNormal;return ac().normalize(l),r.filter((e=>{const{viewportId:t}=e.data,n=i.getViewport(t).getCamera(),o=n.viewPlaneNormal;return ac().normalize(o),J.utilities.isEqual(l,o,.01)&&J.utilities.isEqual(s.viewUp,n.viewUp,.01)}))})),te(this,"_filterAnnotationsByUniqueViewportOrientations",((e,t)=>{const{renderingEngine:n,viewport:i}=e,o=i.getCamera().viewPlaneNormal;ac().normalize(o);const a=t.filter((e=>{const{data:t}=e,o=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(o.id);return i!==o&&!0===a})),r=[];for(let e=0;e<a.length;++e){const t=a[e],{viewportId:i}=t.data,s=n.getViewport(i).getCamera(),l=s.viewPlaneNormal;if(ac().normalize(l),J.utilities.isEqual(o,l,.01)||J.utilities.isOpposite(o,l,.01))continue;let d=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:i}=t.data,o=n.getViewport(i).getCamera();J.utilities.isEqual(o.viewPlaneNormal,s.viewPlaneNormal,.01)&&J.utilities.isEqual(o.position,s.position,1)&&(d=!0)}d||r.push(t)}const s=t.filter((e=>{const{data:t}=e,o=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(o.id);return i!==o&&!0!==a}));for(let e=0;e<s.length;++e){const t=s[e],{viewportId:i}=t.data,a=n.getViewport(i).getCamera(),l=a.viewPlaneNormal;if(ac().normalize(l),J.utilities.isEqual(o,l,.01)||J.utilities.isOpposite(o,l,.01))continue;let d=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:i}=t.data,o=n.getViewport(i).getCamera();J.utilities.isEqual(o.viewPlaneNormal,a.viewPlaneNormal,.01)&&J.utilities.isEqual(o.position,a.position,1)&&(d=!0)}d||r.push(t)}const l=this._getAnnotationsForViewportsWithDifferentCameras(e,t);for(let e=0;e<l.length;++e){const t=l[e];if(r.some((e=>e===t)))continue;const{viewportId:i}=t.data,a=n.getViewport(i).getCamera(),s=a.viewPlaneNormal;if(ac().normalize(s),J.utilities.isEqual(o,s,.01)||J.utilities.isOpposite(o,s,.01))continue;let d=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:i}=t.data,o=n.getViewport(i).getCamera();J.utilities.isEqual(o.viewPlaneNormal,a.viewPlaneNormal,.01)&&J.utilities.isEqual(o.position,a.position,1)&&(d=!0)}d||r.push(t)}return r})),te(this,"_checkIfViewportsRenderingSameScene",((e,t)=>{const n=e.getActors(),i=t.getActors();let o=!0;return n.forEach((e=>{n.length===i.length&&void 0!==i.find((t=>{let{uid:n}=t;return n===e.uid}))||(o=!1)})),o})),te(this,"_jump",((e,t)=>{He.isInteractingWithTool=!0;const{viewport:n,renderingEngine:i}=e,o=this._getAnnotations(e),a=[0,0,0];ac().subtract(t,this.toolCenter,a);const r=this._getAnnotationsForViewportsWithDifferentCameras(e,o).filter((e=>{const{data:t}=e,o=i.getViewport(t.viewportId),a=this._checkIfViewportsRenderingSameScene(n,o);return this._getReferenceLineControllable(o.id)&&this._getReferenceLineDraggableRotatable(o.id)&&a}));return 0===r.length?(He.isInteractingWithTool=!1,!1):(this._applyDeltaShiftToSelectedViewportCameras(i,r,a),He.isInteractingWithTool=!1,!0)})),te(this,"_activateModify",(e=>{var t;He.isInteractingWithTool=!(null!==(t=this.configuration.mobile)&&void 0!==t&&t.enabled),e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_deactivateModify",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t;this.editData.annotation.data.handles.activeOperation=null,this.editData.annotation.data.activeViewportIds=[],this._deactivateModify(n),$r(n),this.editData=null;const i=(0,J.getEnabledElement)(n),{renderingEngine:o}=i,a=Gl(n,this.getToolName(),!1);Bo(o,a)})),te(this,"_dragCallback",(e=>{const t=e.detail,n=t.deltaPoints.world;if(Math.abs(n[0])<.001&&Math.abs(n[1])<.001&&Math.abs(n[2])<.001)return;const{element:i}=t,o=(0,J.getEnabledElement)(i),{renderingEngine:a,viewport:r}=o,s=this._getAnnotations(o),l=this.filterInteractableAnnotationsForElement(i,s)[0];if(!l)return;const{handles:d}=l.data,{currentPoints:c}=e.detail,h=c.canvas;if(1===d.activeOperation){const e=this._getAnnotationsForViewportsWithDifferentCameras(o,s).filter((e=>{const{data:t}=e,n=a.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineDraggableRotatable(n.id);return!0===i&&!0===o&&l.data.activeViewportIds.find((e=>e===n.id))}));this._applyDeltaShiftToSelectedViewportCameras(a,e,n)}else if(2===d.activeOperation){const e=this._getAnnotationsForViewportsWithDifferentCameras(o,s).filter((e=>{const{data:t}=e,n=a.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineDraggableRotatable(n.id);return!0===i&&!0===o})),n=ps.vec2.create(),i=ps.vec2.create(),l=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]],d=r.worldToCanvas(l),c=t.currentPoints.canvas,h=ps.vec2.create();ps.vec2.sub(h,c,t.deltaPoints.canvas),ps.vec2.sub(n,h,d),ps.vec2.sub(i,c,d);let u=ps.vec2.angle(n,i);this._isClockWise(d,h,c)&&(u*=-1),u=Math.round(100*u)/100;const g=r.getCamera().viewPlaneNormal,{matrix:v}=Sg().buildFromRadian().translate(l[0],l[1],l[2]).rotate(u,g).translate(-l[0],-l[1],-l[2]),m=[];e.forEach((e=>{const{data:t}=e;t.handles.toolCenter=l;const n=a.getViewport(t.viewportId),i=n.getCamera(),{viewUp:o,position:r,focalPoint:s}=i;o[0]+=r[0],o[1]+=r[1],o[2]+=r[2],ps.vec3.transformMat4(s,s,v),ps.vec3.transformMat4(r,r,v),ps.vec3.transformMat4(o,o,v),o[0]-=r[0],o[1]-=r[1],o[2]-=r[2],n.setCamera({position:r,viewUp:o,focalPoint:s}),m.push(n.id)})),a.renderViewports(m)}else if(3===d.activeOperation){const e=this._getAnnotationsForViewportsWithDifferentCameras(o,s).filter((e=>{const{data:t}=e,n=a.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineSlabThicknessControlsOn(n.id);return!0===i&&!0===o&&l.data.activeViewportIds.find((e=>e===n.id))}));if(0===e.length)return;const i=this._filterViewportWithSameOrientation(o,e[0],s),d=[];d.push(r.id),i.forEach((e=>{const{data:i}=e,o=a.getViewport(i.viewportId),s=o.getCamera().viewPlaneNormal,c=ac().dot(n,s),u=[...s];if(ac().multiplyScalar(u,c),Math.abs(u[0])>.001||Math.abs(u[1])>.001||Math.abs(u[2])>.001){const e=Math.sqrt(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]),n=t.lastPoints.world,i=[0,0,0],c=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]];if(!this._getReferenceLineDraggableRotatable(o.id)){const{rotationPoints:e}=this.editData.annotation.data.handles,t=e.filter((e=>e[1].uid===o.id));if(2===t.length){const e=r.canvasToWorld(t[0][3]),n=r.canvasToWorld(t[1][3]);ac().add(e,n,c),ac().multiplyScalar(c,.5)}}ac().subtract(n,c,i);const g=ac().dot(i,s),v=[...s];ac().multiplyScalar(v,g);const m=[v[0],v[1],v[2]];ps.vec3.normalize(m,m);const p=[u[0],u[1],u[2]];ps.vec3.normalize(p,p);let f=o.getSlabThickness();J.utilities.isOpposite(m,p,.001)?f-=e:f+=e,f=Math.abs(f),f=Math.max(yg.MINIMUM_SLAB_THICKNESS,f),this._pointNearReferenceLine(l,h,6,o)&&(f=yg.MINIMUM_SLAB_THICKNESS),Si(o.id,a.id).getToolInstance(this.getToolName()).setSlabThickness(o,f),d.push(o.id)}})),a.renderViewports(d)}})),te(this,"_pointNearReferenceLine",((e,t,n,i)=>{const{data:o}=e,{rotationPoints:a}=o.handles;for(let e=0;e<a.length-1;++e){const o=a[e][1];if(o.id!==i.id)continue;if(!this._getReferenceLineControllable(o.id))continue;const r={start:{x:a[e][2][0],y:a[e][2][1]},end:{x:a[e][3][0],y:a[e][3][1]}},s=nd([r.start.x,r.start.y],[r.end.x,r.end.y],[t[0],t[1]]),l={start:{x:a[e+1][2][0],y:a[e+1][2][1]},end:{x:a[e+1][3][0],y:a[e+1][3][1]}},d=nd([l.start.x,l.start.y],[l.end.x,l.end.y],[t[0],t[1]]);if(s<=n||d<=n)return!0;e++}return!1})),this._getReferenceLineColor=(null===(e=o.configuration)||void 0===e?void 0:e.getReferenceLineColor)||Og,this._getReferenceLineControllable=(null===(t=o.configuration)||void 0===t?void 0:t.getReferenceLineControllable)||Mg,this._getReferenceLineDraggableRotatable=(null===(n=o.configuration)||void 0===n?void 0:n.getReferenceLineDraggableRotatable)||xg,this._getReferenceLineSlabThicknessControlsOn=(null===(i=o.configuration)||void 0===i?void 0:i.getReferenceLineSlabThicknessControlsOn)||Ng}onSetToolActive(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),this._subscribeToViewportNewVolumeSet(e),this.computeToolCenter(e)}onSetToolPassive(){const e=this._getViewportsInfo();this.computeToolCenter(e)}onSetToolEnabled(){const e=this._getViewportsInfo();this.computeToolCenter(e)}onSetToolDisabled(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),e.forEach((e=>{let{renderingEngineId:t,viewportId:n}=e;const i=(0,J.getEnabledElementByIds)(n,t);if(!i)return;const o=this._getAnnotations(i);null!=o&&o.length&&o.forEach((e=>{Qe(e.annotationUID)}))}))}getHandleNearImagePoint(e,t,n,i){const o=(0,J.getEnabledElement)(e),{viewport:a}=o;let r=this._getRotationHandleNearImagePoint(a,t,n,i);return null!==r?r:(r=this._getSlabThicknessHandleNearImagePoint(a,t,n,i),null!==r?r:void 0)}_unsubscribeToViewportNewVolumeSet(e){e.forEach((e=>{let{viewportId:t,renderingEngineId:n}=e;const{viewport:i}=(0,J.getEnabledElementByIds)(t,n),{element:o}=i;o.removeEventListener(J.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)}))}_subscribeToViewportNewVolumeSet(e){e.forEach((e=>{let{viewportId:t,renderingEngineId:n}=e;const{viewport:i}=(0,J.getEnabledElementByIds)(t,n),{element:o}=i;o.addEventListener(J.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)}))}_autoPanViewportIfNecessary(e,t){const n=t.getViewport(e),{clientWidth:i,clientHeight:o}=n.canvas,a=n.worldToCanvas(this.toolCenter),r=this.configuration.autoPan.panSize,s=[a[0],a[1]];if(a[0]<0?s[0]=r:a[0]>i&&(s[0]=i-r),a[1]<0?s[1]=r:a[1]>o&&(s[1]=o-r),s[0]===a[0]&&s[1]===a[1])return;const l=n.canvasToWorld(s),d=[l[0]-this.toolCenter[0],l[1]-this.toolCenter[1],l[2]-this.toolCenter[2]],c=n.getCamera(),{focalPoint:h,position:u}=c,g=[u[0]-d[0],u[1]-d[1],u[2]-d[2]],v=[h[0]-d[0],h[1]-d[1],h[2]-d[2]];n.setCamera({focalPoint:v,position:g}),n.render()}setSlabThickness(e,t){let n;const{filterActorUIDsToSetSlabThickness:i}=this.configuration;i&&i.length>0&&(n=i);let o=this.configuration.slabThicknessBlendMode;t===yg.MINIMUM_SLAB_THICKNESS&&(o=J.Enums.BlendModes.COMPOSITE),e.setBlendMode(o,n,!1),e.setSlabThickness(t,n)}_isClockWise(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])>0}_applyDeltaShiftToSelectedViewportCameras(e,t,n){t.forEach((t=>{this._applyDeltaShiftToViewportCamera(e,t,n)}))}_applyDeltaShiftToViewportCamera(e,t,n){const{data:i}=t,o=e.getViewport(i.viewportId),a=o.getCamera(),r=a.viewPlaneNormal,s=ac().dot(n,r),l=[...r];if(ac().multiplyScalar(l,s),Math.abs(l[0])>.001||Math.abs(l[1])>.001||Math.abs(l[2])>.001){const e=[0,0,0],t=[0,0,0];ac().add(a.focalPoint,l,e),ac().add(a.position,l,t),o.setCamera({focalPoint:e,position:t}),o.render()}}_getRotationHandleNearImagePoint(e,t,n,i){const{data:o}=t,{rotationPoints:a}=o.handles;for(let r=0;r<a.length;r++){const s=a[r][0],l=a[r][1];if(!this._getReferenceLineControllable(l.id))continue;if(!this._getReferenceLineDraggableRotatable(l.id))continue;const d=e.worldToCanvas(s);if(ps.vec2.distance(n,d)<i)return o.handles.activeOperation=2,this.editData={annotation:t},s}return null}_getSlabThicknessHandleNearImagePoint(e,t,n,i){const{data:o}=t,{slabThicknessPoints:a}=o.handles;for(let r=0;r<a.length;r++){const s=a[r][0],l=a[r][1];if(!this._getReferenceLineControllable(l.id))continue;if(!this._getReferenceLineSlabThicknessControlsOn(l.id))continue;const d=e.worldToCanvas(s);if(ps.vec2.distance(n,d)<i)return o.handles.activeOperation=3,o.activeViewportIds=[l.id],this.editData={annotation:t},s}return null}_pointNearTool(e,t,n,i){const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{clientWidth:r,clientHeight:s}=a.canvas,l=Math.sqrt(r*r+s*s),{data:d}=t,{rotationPoints:c}=d.handles,{slabThicknessPoints:h}=d.handles,u=[];for(let e=0;e<c.length-1;++e){const t=c[e][1],o=this._getReferenceLineControllable(t.id),a=this._getReferenceLineDraggableRotatable(t.id);if(!o||!a)continue;const r={start:{x:c[e][2][0],y:c[e][2][1]},end:{x:c[e][3][0],y:c[e][3][1]}},s=nd([r.start.x,r.start.y],[r.end.x,r.end.y],[n[0],n[1]]),l={start:{x:c[e+1][2][0],y:c[e+1][2][1]},end:{x:c[e+1][3][0],y:c[e+1][3][1]}},h=nd([l.start.x,l.start.y],[l.end.x,l.end.y],[n[0],n[1]]);(s<=i||h<=i)&&(u.push(t.id),d.handles.activeOperation=1),e++}for(let e=0;e<h.length-1;++e){const t=h[e][1];if(u.find((e=>e===t.id)))continue;const o=this._getReferenceLineControllable(t.id),a=this._getReferenceLineSlabThicknessControlsOn(t.id);if(!o||!a)continue;const r=h[e][2],s=h[e][3],c=ps.vec2.create();ps.vec2.add(c,r,s),ps.vec2.scale(c,c,.5);const g=ps.vec2.create();ps.vec2.subtract(g,r,c),ps.vec2.normalize(g,g);const v=ps.vec2.create();ps.vec2.scale(v,g,.05*l);const m=ps.vec2.create(),p=ps.vec2.create();ps.vec2.add(m,c,v),ps.vec2.subtract(p,c,v);const f={start:{x:m[0],y:m[1]},end:{x:r[0],y:r[1]}},E=nd([f.start.x,f.start.y],[f.end.x,f.end.y],[n[0],n[1]]),w={start:{x:p[0],y:p[1]},end:{x:s[0],y:s[1]}},I=nd([w.start.x,w.start.y],[w.end.x,w.end.y],[n[0],n[1]]);(E<=i||I<=i)&&(u.push(t.id),d.handles.activeOperation=null),e++}return d.activeViewportIds=[...u],this.editData={annotation:t},1===d.handles.activeOperation}}te(kg,"toolName",void 0),kg.toolName="Crosshairs";const Rg=kg,{EPSILON:Pg}=J.CONSTANTS;class Lg extends Jl{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceViewportId:"",showFullDimension:!1}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",{}),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"_init",(()=>{const e=(0,J.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=Fl(t,this.getToolName());const n=e.getViewport(this.configuration.sourceViewportId);if(!n||!n.getImageData())return;const{element:i}=n,{viewUp:o,viewPlaneNormal:a}=n.getCamera(),r=J.utilities.getViewportImageCornersInWorld(n);let s=this.editData.annotation;const l=n.getFrameOfReferenceUID();if(s)this.editData.annotation.data.handles.points=r;else{const e={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...a],viewUp:[...o],FrameOfReferenceUID:l,referencedImageId:null},data:{handles:{points:r}}};Je(e,i),s=e}this.editData={sourceViewport:n,renderingEngine:e,annotation:s},Bo(e,t.filter((e=>e.id!==n.id)).map((e=>e.id)))})),te(this,"onSetToolEnabled",(()=>{this._init()})),te(this,"onCameraModified",(e=>{this._init()})),te(this,"renderAnnotation",((e,t)=>{var n;const{viewport:i}=e,{annotation:o,sourceViewport:a}=this.editData;let r=!1;if(!a)return r;if(a.id===i.id)return r;if(!o||null==o||null===(n=o.data)||void 0===n||null===(n=n.handles)||void 0===n||!n.points)return r;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},l=o.data.handles.points[0],d=o.data.handles.points[1],c=o.data.handles.points[2],h=o.data.handles.points[3],{focalPoint:u,viewPlaneNormal:g,viewUp:v}=i.getCamera(),{viewPlaneNormal:m}=a.getCamera();if(this.isParallel(g,m))return r;const p=J.utilities.planar.planeEquation(g,u),f=[l,c,d,h],E=[l,d,c,h];let w=f,I=ps.vec3.subtract(ps.vec3.create(),f[0],f[1]);I=ps.vec3.normalize(ps.vec3.create(),I);let C=ps.vec3.subtract(ps.vec3.create(),f[2],f[0]);C=ps.vec3.normalize(ps.vec3.create(),C);const _=ps.vec3.cross(ps.vec3.create(),I,C);if(this.isParallel(_,g))return r;this.isPerpendicular(I,g)&&(w=E);const T=J.utilities.planar.linePlaneIntersection(w[0],w[1],p),b=J.utilities.planar.linePlaneIntersection(w[2],w[3],p),{annotationUID:D}=o;s.annotationUID=D;const S=this.getStyle("lineWidth",s,o),y=this.getStyle("lineDash",s,o),O=this.getStyle("color",s,o),M=this.getStyle("shadow",s,o);let x=[T,b].map((e=>i.worldToCanvas(e)));this.configuration.showFullDimension&&(x=this.handleFullDimension(i,T,g,v,b,x));const N="".concat(D,"-line");return xs(t,D,"1",x[0],x[1],{color:O,width:S,lineDash:y,shadow:M},N),r=!0,r})),te(this,"isPerpendicular",((e,t)=>{const n=ps.vec3.dot(e,t);return Math.abs(n)<Pg}))}handleFullDimension(e,t,n,i,o,a){const r=e.getRenderingEngine(),s=this.getTargetId(e),l=this.getTargetIdImage(s,r),d=this.getReferencedImageId(e,t,n,i);if(d&&l)try{const{imageData:n,dimensions:i}=l,[r,s,c,h]=[n.indexToWorld([0,0,0]),n.indexToWorld([i[0]-1,0,0]),n.indexToWorld([i[0]-1,i[1]-1,0]),n.indexToWorld([0,i[1]-1,0])].map((e=>J.utilities.worldToImageCoords(d,e))),[u,g]=[t,o].map((e=>J.utilities.worldToImageCoords(d,e)));a=[[r,s],[s,c],[h,c],[r,h]].map((e=>{let[t,n]=e;return this.intersectInfiniteLines(t,n,u,g)})).filter((e=>e&&this.isInBound(e,i))).map((t=>{const n=J.utilities.imageToWorldCoords(d,t);return e.worldToCanvas(n)}))}catch(e){console.log(e)}return a}intersectInfiniteLines(e,t,n,i){const[o,a]=e,[r,s]=t,[l,d]=n,[c,h]=i,u=s-a,g=o-r,v=r*a-o*s,m=h-d,p=l-c,f=c*d-l*h;if(!(Math.abs(u*p-m*g)<Pg))return[(g*f-p*v)/(u*p-m*g),(m*v-u*f)/(u*p-m*g)]}isParallel(e,t){return Math.abs(ps.vec3.dot(e,t))>1-Pg}isInBound(e,t){return e[0]>=0&&e[0]<=t[0]&&e[1]>=0&&e[1]<=t[1]}}te(Lg,"toolName",void 0),Lg.toolName="ReferenceLines";const Ag=Lg,{EPSILON:Ug}=J.CONSTANTS;class Vg extends Jl{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceImageIds:[]}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"_throttledCalculateCachedStats",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"onSetToolEnabled",(()=>{this._init()})),te(this,"onSetToolActive",(()=>{this._init()})),te(this,"_init",(()=>{const e=this.configuration.sourceImageIds;if(null==e||!e.length)return void console.warn("OverlayGridTool: No sourceImageIds provided in configuration");const t=J.metaData.get("imagePlaneModule",e[0]);if(!t)return void console.warn("OverlayGridTool: No imagePlaneModule found for sourceImageIds");const{frameOfReferenceUID:n}=t,i=zo(this.toolGroupId).viewportsInfo;if(null==i||!i.length)return void console.warn("OverlayGridTool: No viewports found");const o=Ze(this.getToolName(),n);if(null==o||!o.length){const t=e.map((e=>this.calculateImageIdPointSets(e)));Je({highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{viewportData:new Map,pointSets:t}},n)}Bo((0,J.getRenderingEngine)(i[0].renderingEngineId),i.map((e=>{let{viewportId:t}=e;return t})))})),te(this,"calculateImageIdPointSets",(e=>{const{imagePositionPatient:t,rows:n,columns:i,rowCosines:o,columnCosines:a,rowPixelSpacing:r,columnPixelSpacing:s}=J.metaData.get("imagePlaneModule",e),l=[...t],d=[...t],c=[...t],h=[...t];return ps.vec3.scaleAndAdd(d,t,a,i*s),ps.vec3.scaleAndAdd(c,t,o,n*r),ps.vec3.scaleAndAdd(h,c,a,i*s),{pointSet1:[l,c,d,h],pointSet2:[l,d,c,h]}})),te(this,"renderAnnotation",((e,t)=>{const n=this.configuration.sourceImageIds;let i=!1;if(null==n||!n.length)return i;const{viewport:o,FrameOfReferenceUID:a}=e;if(o.getImageIds().length<2)return i;const r=Ze(this.getToolName(),a);if(null==r||!r.length)return i;const s=r[0],{annotationUID:l}=s,{focalPoint:d,viewPlaneNormal:c}=o.getCamera(),h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},u=this.getImageIdNormal(n[0]);if(this.isParallel(c,u))return i;const g=J.utilities.planar.planeEquation(c,d),v=s.data.pointSets,m=s.data.viewportData;for(let e=0;e<n.length;e++){const{pointSet1:n,pointSet2:i}=v[e],a=m.get(o.id)||this.initializeViewportData(m,o.id);if(!a.pointSetsToUse[e]){let t=n,o=ps.vec3.subtract(ps.vec3.create(),n[0],n[1]);o=ps.vec3.normalize(ps.vec3.create(),o),this.isPerpendicular(o,c)&&(t=i),a.pointSetsToUse[e]=t,a.lineStartsWorld[e]=J.utilities.planar.linePlaneIntersection(t[0],t[1],g),a.lineEndsWorld[e]=J.utilities.planar.linePlaneIntersection(t[2],t[3],g)}const r=a.lineStartsWorld[e],d=a.lineEndsWorld[e];h.annotationUID=l;const u=this.getStyle("lineWidth",h,s),p=this.getStyle("lineDash",h,s),f=this.getStyle("color",h,s),E=this.getStyle("shadow",h,s),w=[r,d].map((e=>o.worldToCanvas(e))),I="".concat(l,"-line");xs(t,l,"".concat(e),w[0],w[1],{color:f,width:u,lineDash:p,shadow:E},I)}return i=!0,i})),te(this,"initializeViewportData",((e,t)=>(e.set(t,{pointSetsToUse:[],lineStartsWorld:[],lineEndsWorld:[]}),e.get(t)))),te(this,"isPerpendicular",((e,t)=>{const n=ps.vec3.dot(e,t);return Math.abs(n)<Ug}))}isParallel(e,t){return Math.abs(ps.vec3.dot(e,t))>1-Ug}getImageIdNormal(e){const{imageOrientationPatient:t}=J.metaData.get("imagePlaneModule",e),n=ps.vec3.fromValues(t[0],t[1],t[2]),i=ps.vec3.fromValues(t[3],t[4],t[5]);return ps.vec3.cross(ps.vec3.create(),n,i)}}te(Vg,"toolName",void 0),Vg.toolName="OverlayGrid";const Wg=Vg;class Fg extends Jl{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{opacity:.5}}),te(this,"_init",(()=>{var e;const t=zo(this.toolGroupId).viewportsInfo;if(null==t||!t.length)return void console.warn(this.getToolName()+"Tool: No viewports found");const n=null===(e=(0,J.getRenderingEngine)(t[0].renderingEngineId))||void 0===e?void 0:e.getViewport(t[0].viewportId);if(!n)return;const i=n.getFrameOfReferenceUID(),o=Ze(this.getToolName(),i);if(null==o||!o.length){const e=new Map;!function(e,t){t.forEach((t=>{var n;let{viewportId:i,renderingEngineId:o}=t;const a=null===(n=(0,J.getRenderingEngine)(o))||void 0===n?void 0:n.getViewport(i);Hg(e,a)}))}(e,t),Je({highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:i,referencedImageId:null},data:{actorsWorldPointsMap:e}},i)}Bo((0,J.getRenderingEngine)(t[0].renderingEngineId),t.map((e=>{let{viewportId:t}=e;return t})))})),te(this,"onSetToolEnabled",(()=>{this._init()})),te(this,"onCameraModified",(e=>{this._init()})),te(this,"renderAnnotation",((e,t)=>{const{viewport:n,FrameOfReferenceUID:i}=e;let o=!1;const a=Ze(this.getToolName(),i);if(null==a||!a.length)return o;const r=a[0],{annotationUID:s}=r,l=r.data.actorsWorldPointsMap;Hg(l,n);const d=n.getActors(),c=Bg(n);return d.forEach((e=>{if(null==e||!e.clippingFilter)return;const i=l.get(e.uid);if(!i)return;if(!i.get(c))return;let o=1;const{worldPointsSet:a,color:r}=i.get(c);for(let i=0;i<a.length;i++){const l=a[i].map((e=>n.worldToCanvas(e))),d={color:r,fillColor:r,fillOpacity:this.configuration.opacity,connectLastToFirst:!0},c=e.uid+"#"+o;Ns(t,s,c,l,d),o++}})),o=!0,o}))}}function Hg(e,t){const n=t.getActors(),i=Bg(t);n.forEach((t=>{if(null==t||!t.clippingFilter)return;let n=e.get(t.uid);if(n||(n=new Map,e.set(t.uid,n)),!n.get(i)){const e=Du(t.clippingFilter.getOutputData());if(!e)return;const o=function(e){function t(e){let t=Math.floor(255*e).toString(16);return 1===t.length&&(t="0"+t),t}return"#"+t(e[0])+t(e[1])+t(e[2])}(t.actor.getProperty().getColor());n.set(i,{worldPointsSet:e,color:o})}}))}function Bg(e){const{viewPlaneNormal:t}=e.getCamera(),n=e.getCurrentImageIdIndex();return"".concat(e.id,"-").concat(Ia(t),"-").concat(n)}te(Fg,"toolName",void 0),Fg.toolName="SegmentationIntersection";const Gg=Fg;function qg(e,t,n,i){const o=ps.vec3.create();ps.vec3.cross(o,t,e);const a=ps.vec3.fromValues(...n),r=ps.vec3.fromValues(...i),s=ps.vec3.create();ps.vec3.subtract(s,a,r);const l=ps.vec3.length(s);if(l<1e-4)return{worldWidth:0,worldHeight:0};const d=ps.vec3.dot(s,o)/(l*ps.vec3.length(o));return{worldWidth:Math.sqrt(1-d*d)*l,worldHeight:d*l}}const{transformWorldToIndex:jg}=J.utilities;class zg extends Ql{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0,getTextLines:Kg,statsCalculator:hd}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",!1),te(this,"addNewAnnotation",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(n.canvas,(0,J.getEnabledElement)(i)),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,o,d,c),u=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:u,referencedImageId:h},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},cachedStats:{},initialRotation:r.getRotation()}};Je(g,i);const v=Gl(i,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:v,centerWorld:o,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Qr(i),e.preventDefault(),Bo(s,v),g})),te(this,"isPointNearTool",((e,t,n,i)=>{const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{data:r}=t,{points:s}=r.handles,l=ul(s.map((e=>a.worldToCanvas(e)))),[d,c]=l,h={left:Math.min(d[0],c[0])+i/2,top:Math.min(d[1],c[1])+i/2,width:Math.abs(d[0]-c[0])-i,height:Math.abs(d[1]-c[1])-i},u={left:Math.min(d[0],c[0])-i/2,top:Math.min(d[1],c[1])-i/2,width:Math.abs(d[0]-c[0])+i,height:Math.abs(d[1]-c[1])+i},g=this._pointInEllipseCanvas(h,n);return!(!this._pointInEllipseCanvas(u,n)||g)})),te(this,"toolSelectedCallback",((e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Gl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},Qr(i),this._activateModify(i);const a=(0,J.getEnabledElement)(i),{renderingEngine:r}=a;Bo(r,o),e.preventDefault()})),te(this,"handleSelectedCallback",((e,t,n)=>{const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;let r,s,l,d,c,h,u=!1;if(n.worldPosition)u=!0;else{const{points:e}=a.handles,{viewport:t}=(0,J.getEnabledElement)(o),{worldToCanvas:i,canvasToWorld:u}=t;r=e.findIndex((e=>e===n));const g=e.map(i);h=g[r],d=Math.abs(g[2][0]-g[3][0]),c=Math.abs(g[0][1]-g[1][1]),s=[(g[2][0]+g[3][0])/2,(g[0][1]+g[1][1])/2],l=u(s)}const g=Gl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:g,handleIndex:r,canvasWidth:d,canvasHeight:c,centerWorld:l,originalHandleCanvas:h,movingTextBox:u},this._activateModify(o),Qr(o);const v=(0,J.getEnabledElement)(o),{renderingEngine:m}=v;Bo(m,g),e.preventDefault()})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=i;if(a&&!r)return;i.highlighted=!1,s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),$r(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Qe(i.annotationUID),Bo(d,o),a){const e=Q.ANNOTATION_COMPLETED,t={annotation:i};(0,J.triggerEvent)(J.eventTarget,e,t)}})),te(this,"_dragDrawCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.canvas,a=(0,J.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,{canvasToWorld:l}=s,{annotation:d,viewportIdsToRender:c,centerWorld:h}=this.editData,u=s.worldToCanvas(h),{data:g}=d,v=Math.abs(o[0]-u[0]),m=Math.abs(o[1]-u[1]),p=[u[0],u[1]-m],f=[u[0],u[1]+m],E=[u[0]-v,u[1]],w=[u[0]+v,u[1]];g.handles.points=[l(p),l(f),l(E),l(w)],d.invalidated=!0,this.editData.hasMoved=!0,Bo(r,c)})),te(this,"_dragModifyCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=s.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;Bo(d,o)})),te(this,"_dragHandle",(e=>{const t=e.detail,{element:n}=t,{viewport:i}=(0,J.getEnabledElement)(n),{canvasToWorld:o,worldToCanvas:a}=i,{annotation:r,canvasWidth:s,canvasHeight:l,handleIndex:d,centerWorld:c,originalHandleCanvas:h}=this.editData,u=i.worldToCanvas(c),{data:g}=r,{points:v}=g.handles,{currentPoints:m}=t,p=m.canvas;if(0===d||1===d){const e=Math.abs(p[1]-u[1]),t=[u[0],u[1]-e],n=[u[0],u[1]+e];v[0]=o(t),v[1]=o(n);const i=s/2+(p[0]-h[0]),a=[u[0]-i,u[1]],r=[u[0]+i,u[1]];v[2]=o(a),v[3]=o(r)}else{const e=Math.abs(p[0]-u[0]),t=[u[0]-e,u[1]],n=[u[0]+e,u[1]];v[2]=o(t),v[3]=o(n);const i=l/2+(p[1]-h[1]),a=[u[0],u[1]-i],r=[u[0],u[1]+i];v[0]=o(a),v[1]=o(r)}})),te(this,"cancel",(e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),$r(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(Bo(r,n),i){const e=Q.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID}})),te(this,"_activateModify",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_deactivateModify",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_activateDraw",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(Q.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_deactivateDraw",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(Q.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"renderAnnotation",((e,t)=>{var n,i;let o=!1;const{viewport:a}=e,{element:r}=a;let s=Ze(this.getToolName(),r);if(null===(n=s)||void 0===n||!n.length)return o;if(s=this.filterInteractableAnnotationsForElement(r,s),null===(i=s)||void 0===i||!i.length)return o;const l=this.getTargetId(a),d=a.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let n=0;n<s.length;n++){const i=s[n],{annotationUID:r,data:h}=i,{handles:u}=h,{points:g,activeHandleIndex:v}=u;c.annotationUID=r;const m=this.getStyle("lineWidth",c,i),p=this.getStyle("lineDash",c,i),f=this.getStyle("color",c,i),E=g.map((e=>a.worldToCanvas(e))),w=Math.abs(a.getRotation()-(h.initialRotation||0));let I;I=ul(90==w||270==w?[E[2],E[3],E[0],E[1]]:E);const{centerPointRadius:C}=this.configuration;if(h.cachedStats[l]&&null!=h.cachedStats[l].areaUnit){if(i.invalidated&&(this._throttledCalculateCachedStats(i,a,d,e),a instanceof J.VolumeViewport)){const{referencedImageId:e}=i.metadata;for(const t in h.cachedStats)t.startsWith("imageId")&&d.getStackViewports().find((t=>{const n=J.utilities.imageIdToURI(e),i=t.hasImageURI(n),o=J.utilities.imageIdToURI(t.getCurrentImageId());return i&&o!==n}))&&delete h.cachedStats[t]}}else h.cachedStats[l]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(i,a,d,e);if(!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),o;let _;if(!Me(r))continue;le(i)||this.editData||null===v||(_=[E[v]]),_&&Ms(t,r,"0",_,{color:f});const T="".concat(r,"-ellipse"),b="0";if(Os(t,r,b,I[0],I[1],{color:f,lineDash:p,lineWidth:m},T),C>0&&Math.min(Math.abs(I[0][0]-I[1][0])/2,Math.abs(I[0][1]-I[1][1])/2)>3*C){const e=this._getCanvasEllipseCenter(E);ys(t,r,"".concat(b,"-center"),e,C,{color:f,lineDash:p,lineWidth:m})}o=!0;const D=this.getLinkedTextBoxStyle(c,i);if(!D.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const S=this.configuration.getTextLines(h,l);if(!S||0===S.length)continue;let y;h.handles.textBox.hasMoved||(y=od(I),h.handles.textBox.worldPosition=a.canvasToWorld(y));const O=a.worldToCanvas(h.handles.textBox.worldPosition),M=As(t,r,"1",S,O,E,{},D),{x,y:N,width:k,height:R}=M;h.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([x,N]),topRight:a.canvasToWorld([x+k,N]),bottomLeft:a.canvasToWorld([x,N+R]),bottomRight:a.canvasToWorld([x+k,N+R])}}return o})),te(this,"_calculateCachedStats",((e,t,n,i)=>{const o=e.data,{viewportId:a,renderingEngineId:r}=i,{points:s}=o.handles,l=s.map((e=>t.worldToCanvas(e))),{viewPlaneNormal:d,viewUp:c}=t.getCamera(),[h,u]=ul(l),g=t.canvasToWorld(h),v=t.canvasToWorld(u),{cachedStats:m}=o,p=Object.keys(m),f=g,E=v;for(let i=0;i<p.length;i++){const o=p[i],a=this.getTargetIdImage(o,n);if(!a)continue;const{dimensions:r,imageData:s,metadata:l,hasPixelSpacing:h}=a,u=jg(s,f);u[0]=Math.floor(u[0]),u[1]=Math.floor(u[1]),u[2]=Math.floor(u[2]);const _=jg(s,E);if(_[0]=Math.floor(_[0]),_[1]=Math.floor(_[1]),_[2]=Math.floor(_[2]),this._isInsideVolume(u,_,r)){var w,I,C;const n=[[Math.min(u[0],_[0]),Math.max(u[0],_[0])],[Math.min(u[1],_[1]),Math.max(u[1],_[1])],[Math.min(u[2],_[2]),Math.max(u[2],_[2])]],i={center:[(g[0]+v[0])/2,(g[1]+v[1])/2,(g[2]+v[2])/2],xRadius:Math.abs(g[0]-v[0])/2,yRadius:Math.abs(g[1]-v[1])/2,zRadius:Math.abs(g[2]-v[2])/2},{worldWidth:r,worldHeight:h}=qg(d,c,f,E),p=0===r&&0===h,T=$s(a),b=Math.abs(Math.PI*(r/2)*(h/2))/T/T,D={isPreScaled:sd(t,o),isSuvScaled:this.isSuvScaled(t,o,e.metadata.referencedImageId)},S=rd(l.Modality,e.metadata.referencedImageId,D),y=tl(s,((e,t)=>gl(i,e)),this.configuration.statsCalculator.statsCallback,n),O=this.configuration.statsCalculator.getStatistics();m[o]={Modality:l.Modality,area:b,mean:null===(w=O[1])||void 0===w?void 0:w.value,max:null===(I=O[0])||void 0===I?void 0:I.value,stdDev:null===(C=O[2])||void 0===C?void 0:C.value,statsArray:O,pointsInShape:y,isEmptyArea:p,areaUnit:Js(0,a),modalityUnit:S}}else this.isHandleOutsideImage=!0,m[o]={Modality:l.Modality}}e.invalidated=!1;const _=Q.ANNOTATION_MODIFIED,T={annotation:e,viewportId:a,renderingEngineId:r};return(0,J.triggerEvent)(J.eventTarget,_,T),m})),te(this,"_isInsideVolume",((e,t,n)=>J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n))),this._throttledCalculateCachedStats=js(this._calculateCachedStats,100,{trailing:!0})}_pointInEllipseCanvas(e,t){const n=e.width/2,i=e.height/2;if(n<=0||i<=0)return!1;const o=[e.left+n,e.top+i],a=[t[0]-o[0],t[1]-o[1]];return a[0]*a[0]/(n*n)+a[1]*a[1]/(i*i)<=1}_getCanvasEllipseCenter(e){const[t,n,i,o]=e,a=[i[0],n[1]],r=[o[0],t[1]];return[(a[0]+r[0])/2,(a[1]+r[1])/2]}}function Kg(e,t){const n=e.cachedStats[t],{area:i,mean:o,stdDev:a,max:r,isEmptyArea:s,areaUnit:l,modalityUnit:d}=n,c=[];if(i){const e=s?"Area: Oblique not supported":"Area: ".concat(al(i)," ").concat(l);c.push(e)}return o&&c.push("Mean: ".concat(al(o)," ").concat(d)),r&&c.push("Max: ".concat(al(r)," ").concat(d)),a&&c.push("Std Dev: ".concat(al(a)," ").concat(d)),c}te(zg,"toolName",void 0),zg.toolName="EllipticalROI";const Yg=zg;function Xg(e){const[t,n]=e;return ic(t,n)}function Zg(e){const[t,n]=e,i=ic(t,n);return[[t[0]-i,t[1]-i],[t[0]+i,t[1]+i]]}const{transformWorldToIndex:Jg}=J.utilities;class $g extends Ql{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0,getTextLines:Qg,statsCalculator:hd}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",!1),te(this,"addNewAnnotation",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(n.canvas,(0,J.getEnabledElement)(i)),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,o,d,c),u=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:u,referencedImageId:h},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...o],[...o]],activeHandleIndex:null},cachedStats:{}}};Je(g,i);const v=Gl(i,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:v,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Qr(i),e.preventDefault(),Bo(s,v),g})),te(this,"isPointNearTool",((e,t,n,i)=>{const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{data:r}=t,{points:s}=r.handles,l=s.map((e=>a.worldToCanvas(e))),d=Xg(l),c=Xg([l[0],n]);return Math.abs(c-d)<i/2})),te(this,"toolSelectedCallback",((e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Gl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},Qr(i),this._activateModify(i);const a=(0,J.getEnabledElement)(i),{renderingEngine:r}=a;Bo(r,o),e.preventDefault()})),te(this,"handleSelectedCallback",((e,t,n)=>{const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;let r,s=!1;if(n.worldPosition)s=!0;else{const{points:e}=a.handles;r=e.findIndex((e=>e===n))}const l=Gl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(o),Qr(o);const d=(0,J.getEnabledElement)(o),{renderingEngine:c}=d;Bo(c,l),e.preventDefault()})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=i;if(a&&!r)return;i.highlighted=!1,s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),$r(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Qe(i.annotationUID),Bo(d,o),a){const e=Q.ANNOTATION_COMPLETED,t={annotation:i};(0,J.triggerEvent)(J.eventTarget,e,t)}})),te(this,"_dragDrawCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.canvas,a=(0,J.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,{canvasToWorld:l}=s,{annotation:d,viewportIdsToRender:c}=this.editData,{data:h}=d;h.handles.points=[h.handles.points[0],l(o)],d.invalidated=!0,this.editData.hasMoved=!0,Bo(r,c)})),te(this,"_dragModifyCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=s.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;Bo(d,o)})),te(this,"_dragHandle",(e=>{const t=e.detail,{element:n}=t,i=(0,J.getEnabledElement)(n),{canvasToWorld:o,worldToCanvas:a}=i.viewport,{annotation:r,handleIndex:s}=this.editData,{data:l}=r,{points:d}=l.handles,c=d.map((e=>a(e))),{currentPoints:h}=t,u=h.canvas;if(0===s){const e=u[0]-c[0][0],t=u[1]-c[0][1],n=u,i=[c[1][0]+e,c[1][1]+t];d[0]=o(n),d[1]=o(i)}else d[1]=o(u)})),te(this,"cancel",(e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),$r(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(Bo(r,n),i){const e=Q.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID}})),te(this,"_activateModify",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_deactivateModify",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_activateDraw",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(Q.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_deactivateDraw",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(Q.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"renderAnnotation",((e,t)=>{var n,i;let o=!1;const{viewport:a}=e,{element:r}=a;let s=Ze(this.getToolName(),r);if(null===(n=s)||void 0===n||!n.length)return o;if(s=this.filterInteractableAnnotationsForElement(r,s),null===(i=s)||void 0===i||!i.length)return o;const l=this.getTargetId(a),d=a.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let n=0;n<s.length;n++){const i=s[n],{annotationUID:r,data:h}=i,{handles:u}=h,{points:g,activeHandleIndex:v}=u;c.annotationUID=r;const m=this.getStyle("lineWidth",c,i),p=this.getStyle("lineDash",c,i),f=this.getStyle("color",c,i),E=g.map((e=>a.worldToCanvas(e))),w=E[0],I=Xg(E),C=Zg(E),{centerPointRadius:_}=this.configuration;if(h.cachedStats[l]&&null!=h.cachedStats[l].areaUnit){if(i.invalidated&&(this._throttledCalculateCachedStats(i,a,d,e),a instanceof J.VolumeViewport)){const{referencedImageId:e}=i.metadata;for(const t in h.cachedStats)t.startsWith("imageId")&&d.getStackViewports().find((t=>{const n=J.utilities.imageIdToURI(e),i=t.hasImageURI(n),o=J.utilities.imageIdToURI(t.getCurrentImageId());return i&&o!==n}))&&delete h.cachedStats[t]}}else h.cachedStats[l]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},this._calculateCachedStats(i,a,d,e);if(!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),o;let T;if(!Me(r))continue;le(i)||this.editData||null===v||(T=[E[v]]),T&&Ms(t,r,"0",T,{color:f});const b="".concat(r,"-circle"),D="0";ys(t,r,D,w,I,{color:f,lineDash:p,lineWidth:m},b),_>0&&I>3*_&&ys(t,r,"".concat(D,"-center"),w,_,{color:f,lineDash:p,lineWidth:m}),o=!0;const S=this.getLinkedTextBoxStyle(c,i);if(!S.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const y=this.configuration.getTextLines(h,l);if(!y||0===y.length)continue;let O;h.handles.textBox.hasMoved||(O=od(C),h.handles.textBox.worldPosition=a.canvasToWorld(O));const M=a.worldToCanvas(h.handles.textBox.worldPosition),x=As(t,r,"1",y,M,E,{},S),{x:N,y:k,width:R,height:P}=x;h.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([N,k]),topRight:a.canvasToWorld([N+R,k]),bottomLeft:a.canvasToWorld([N,k+P]),bottomRight:a.canvasToWorld([N+R,k+P])}}return o})),te(this,"_calculateCachedStats",((e,t,n,i)=>{const o=e.data,{viewportId:a,renderingEngineId:r}=i,{points:s}=o.handles,l=s.map((e=>t.worldToCanvas(e))),{viewPlaneNormal:d,viewUp:c}=t.getCamera(),[h,u]=Zg(l),g=t.canvasToWorld(h),v=t.canvasToWorld(u),{cachedStats:m}=o,p=Object.keys(m),f=g,E=v;for(let i=0;i<p.length;i++){const o=p[i],a=this.getTargetIdImage(o,n);if(!a)continue;const{dimensions:r,imageData:s,metadata:l,hasPixelSpacing:h}=a,u=Jg(s,f);u[0]=Math.floor(u[0]),u[1]=Math.floor(u[1]),u[2]=Math.floor(u[2]);const _=Jg(s,E);if(_[0]=Math.floor(_[0]),_[1]=Math.floor(_[1]),_[2]=Math.floor(_[2]),this._isInsideVolume(u,_,r)){var w,I,C;const n=[[Math.min(u[0],_[0]),Math.max(u[0],_[0])],[Math.min(u[1],_[1]),Math.max(u[1],_[1])],[Math.min(u[2],_[2]),Math.max(u[2],_[2])]],i={center:[(g[0]+v[0])/2,(g[1]+v[1])/2,(g[2]+v[2])/2],xRadius:Math.abs(g[0]-v[0])/2,yRadius:Math.abs(g[1]-v[1])/2,zRadius:Math.abs(g[2]-v[2])/2},{worldWidth:r,worldHeight:h}=qg(d,c,f,E),p=0===r&&0===h,T=$s(a),b=Qs(a),D=Math.abs(Math.PI*(r/T/2)*(h/b/T/2)),S={isPreScaled:sd(t,o),isSuvScaled:this.isSuvScaled(t,o,e.metadata.referencedImageId)},y=rd(l.Modality,e.metadata.referencedImageId,S),O=tl(s,((e,t)=>gl(i,e)),this.configuration.statsCalculator.statsCallback,n),M=this.configuration.statsCalculator.getStatistics();m[o]={Modality:l.Modality,area:D,mean:null===(w=M[1])||void 0===w?void 0:w.value,max:null===(I=M[0])||void 0===I?void 0:I.value,stdDev:null===(C=M[2])||void 0===C?void 0:C.value,statsArray:M,pointsInShape:O,isEmptyArea:p,areaUnit:Js(0,a),radius:r/2/T,radiusUnit:Zs(0,a),perimeter:2*Math.PI*(r/2)/T,modalityUnit:y}}else this.isHandleOutsideImage=!0,m[o]={Modality:l.Modality}}e.invalidated=!1;const _=Q.ANNOTATION_MODIFIED,T={annotation:e,viewportId:a,renderingEngineId:r};return(0,J.triggerEvent)(J.eventTarget,_,T),m})),te(this,"_isInsideVolume",((e,t,n)=>J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n))),this._throttledCalculateCachedStats=js(this._calculateCachedStats,100,{trailing:!0})}}function Qg(e,t){const n=e.cachedStats[t],{radius:i,radiusUnit:o,area:a,mean:r,stdDev:s,max:l,isEmptyArea:d,Modality:c,areaUnit:h,modalityUnit:u}=n,g=[];if(i){const e=d?"Radius: Oblique not supported":"Radius: ".concat(al(i)," ").concat(o);g.push(e)}if(a){const e=d?"Area: Oblique not supported":"Area: ".concat(al(a)," ").concat(h);g.push(e)}return r&&g.push("Mean: ".concat(al(r)," ").concat(u)),l&&g.push("Max: ".concat(al(l)," ").concat(u)),s&&g.push("Std Dev: ".concat(al(s)," ").concat(u)),g}te($g,"toolName",void 0),$g.toolName="CircleROI";const ev=$g,{transformWorldToIndex:tv}=J.utilities;class nv extends Ql{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:iv}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"preventHandleOutsideImage",void 0),te(this,"isPointNearTool",((e,t,n,i)=>{const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{data:r}=t,{points:s}=r.handles;let l=a.worldToCanvas(s[0]),d=a.worldToCanvas(s[1]),c={start:{x:l[0],y:l[1]},end:{x:d[0],y:d[1]}},h=nd([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]);return h<=i||(l=a.worldToCanvas(s[2]),d=a.worldToCanvas(s[3]),c={start:{x:l[0],y:l[1]},end:{x:d[0],y:d[1]}},h=nd([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]),h<=i)})),te(this,"toolSelectedCallback",((e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Gl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(i);const a=(0,J.getEnabledElement)(i),{renderingEngine:r}=a;Bo(r,o),Qr(i),e.preventDefault()})),te(this,"handleSelectedCallback",((e,t,n)=>{const i=e.detail,{element:o}=i,a=t.data;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=Gl(o,this.getToolName());Qr(o),this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(o);const d=(0,J.getEnabledElement)(o),{renderingEngine:c}=d;Bo(c,l),e.preventDefault()})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=i;if(a&&!r)return;s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),$r(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;if(void 0!==this.editData.handleIndex){const{points:e}=s.handles,t=ps.vec3.distance(e[0],e[1]);if(ps.vec3.distance(e[2],e[3])>t){const t=[[...e[2]],[...e[3]]],n=[...e[0]],i=[...e[1]],o=ps.vec2.create();ps.vec2.set(o,t[1][0]-t[0][0],t[1][1]-t[1][0]);const a=ps.vec2.create();ps.vec2.set(a,-o[1],o[0]);const r=ps.vec2.create();let l;ps.vec2.set(r,i[0]-n[0],i[1]-n[0]),l=ps.vec2.dot(r,a)>0?[n,i]:[i,n],s.handles.points=[t[0],t[1],l[0],l[1]]}}if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Qe(i.annotationUID),Bo(d,o),a){const e=Q.ANNOTATION_COMPLETED,t={annotation:i};(0,J.triggerEvent)(J.eventTarget,e,t)}this.editData=null,this.isDrawing=!1})),te(this,"_dragDrawCallback",(e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:i}=t,o=(0,J.getEnabledElement)(i),{renderingEngine:a,viewport:r}=o,{worldToCanvas:s}=r,{annotation:l,viewportIdsToRender:d,handleIndex:c}=this.editData,{data:h}=l,u=n.world;h.handles.points[c]=[...u];const g=h.handles.points.map(s),v={x:g[0][0],y:g[0][1]},m={x:g[1][0],y:g[1][1]},p=(g[2][0],g[2][1],g[3][0],g[3][1],ps.vec2.distance(g[0],g[1])/3),f=v.x-m.x,E=v.y-m.y,w=Math.sqrt(f*f+E*E),I=f/w,C=E/w,_=(v.x+m.x)/2,T=(v.y+m.y)/2,b=_+p*C,D=T-p*I,S=_-p*C,y=T+p*I;h.handles.points[2]=r.canvasToWorld([b,D]),h.handles.points[3]=r.canvasToWorld([S,y]),l.invalidated=!0,Bo(a,d),this.editData.hasMoved=!0})),te(this,"_dragModifyCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,i=(0,J.getEnabledElement)(n),{renderingEngine:o}=i,{annotation:a,viewportIdsToRender:r,handleIndex:s,movingTextBox:l}=this.editData,{data:d}=a;if(l){const{deltaPoints:e}=t,n=e.world,{textBox:i}=d.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;d.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),a.invalidated=!0}else this._dragModifyHandle(e),a.invalidated=!0;Bo(o,r)})),te(this,"_dragModifyHandle",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=(0,J.getEnabledElement)(i),{viewport:a}=o,{annotation:r,handleIndex:s}=this.editData,{data:l}=r,d=n.world,c=[a.worldToCanvas(l.handles.points[0]),a.worldToCanvas(l.handles.points[1]),a.worldToCanvas(l.handles.points[2]),a.worldToCanvas(l.handles.points[3])],h={start:{x:c[0][0],y:c[0][1]},end:{x:c[1][0],y:c[1][1]}},u={start:{x:c[2][0],y:c[2][1]},end:{x:c[3][0],y:c[3][1]}},g=[...d],v=a.worldToCanvas(g);if(0===s||1===s){const e=c[0===s?1:0],t=ps.vec2.set(ps.vec2.create(),v[0]-e[0],v[1]-e[1]),n=ps.vec2.set(ps.vec2.create(),c[s][0]-e[0],c[s][1]-e[1]);ps.vec2.normalize(t,t),ps.vec2.normalize(n,n);const i={start:{x:e[0],y:e[1]},end:{x:v[0],y:v[1]}};if(this._movingLongAxisWouldPutItThroughShortAxis(i,u))return;const o=e,r=this._getSignedAngle(n,t);let d=c[2][0],h=c[2][1],m=c[3][0],p=c[3][1];d-=o[0],h-=o[1],m-=o[0],p-=o[1];const f=d*Math.cos(r)-h*Math.sin(r),E=d*Math.sin(r)+h*Math.cos(r),w=m*Math.cos(r)-p*Math.sin(r),I=m*Math.sin(r)+p*Math.cos(r);d=f+o[0],h=E+o[1],m=w+o[0],p=I+o[1];const C=a.canvasToWorld([d,h]),_=a.canvasToWorld([m,p]);l.handles.points[s]=g,l.handles.points[2]=C,l.handles.points[3]=_}else{const e=2===s?3:2,t={longLineSegment:{start:h.start,end:h.end},shortLineSegment:{start:u.start,end:u.end}},n=ps.vec2.subtract(ps.vec2.create(),[t.longLineSegment.end.x,t.longLineSegment.end.y],[t.longLineSegment.start.x,t.longLineSegment.start.y]),i=ps.vec2.normalize(ps.vec2.create(),n),o=ps.vec2.subtract(ps.vec2.create(),[v[0],v[1]],[c[s][0],c[s][1]]),r=ps.vec2.length(o),d=this._getSignedAngle(i,o),m=Math.cos(d)*r,p=ps.vec2.scaleAndAdd(ps.vec2.create(),[c[e][0],c[e][1]],i,m);if(this._movingLongAxisWouldPutItThroughShortAxis({start:{x:v[0],y:v[1]},end:{x:p[0],y:p[1]}},{start:{x:t.longLineSegment.start.x,y:t.longLineSegment.start.y},end:{x:t.longLineSegment.end.x,y:t.longLineSegment.end.y}}))return;if(!Gd([v[0],v[1]],[p[0],p[1]],[h.start.x,h.start.y],[h.end.x,h.end.y]))return;l.handles.points[e]=a.canvasToWorld(p),l.handles.points[s]=g}})),te(this,"cancel",(e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),$r(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(Bo(r,n),i){const e=Q.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID}})),te(this,"_activateDraw",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(Q.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragDrawCallback)})),te(this,"_deactivateDraw",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(Q.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragDrawCallback)})),te(this,"_activateModify",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_deactivateModify",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"renderAnnotation",((e,t)=>{var n,i;let o=!0;const{viewport:a}=e,{element:r}=a;let s=Ze(this.getToolName(),r);if(null===(n=s)||void 0===n||!n.length)return o;if(s=this.filterInteractableAnnotationsForElement(r,s),null===(i=s)||void 0===i||!i.length)return o;const l=this.getTargetId(a),d=a.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let n=0;n<s.length;n++){const i=s[n],{annotationUID:r,data:h}=i,{points:u,activeHandleIndex:g}=h.handles,v=u.map((e=>a.worldToCanvas(e)));c.annotationUID=r;const m=this.getStyle("lineWidth",c,i),p=this.getStyle("lineDash",c,i),f=this.getStyle("color",c,i),E=this.getStyle("shadow",c,i);if(h.cachedStats[l]&&null!=h.cachedStats[l].unit?i.invalidated&&this._throttledCalculateCachedStats(i,d,e):(h.cachedStats[l]={length:null,width:null,unit:null},this._calculateCachedStats(i,d,e)),!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),o;let w;if(!Me(r))continue;le(i)||this.editData||null===g||(w=[v[g]]),w&&Ms(t,r,"0",w,{color:f});const I="".concat(r,"-line-1"),C="".concat(r,"-line-2");xs(t,r,"0",v[0],v[1],{color:f,lineDash:p,lineWidth:m,shadow:E},I),xs(t,r,"1",v[2],v[3],{color:f,lineDash:p,lineWidth:m,shadow:E},C),o=!0;const _=this.getLinkedTextBoxStyle(c,i);if(!_.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const T=this.configuration.getTextLines(h,l);if(!T||0===T.length)continue;let b;h.handles.textBox.hasMoved||(b=od(v),h.handles.textBox.worldPosition=a.canvasToWorld(b));const D=a.worldToCanvas(h.handles.textBox.worldPosition),S=As(t,r,"1",T,D,v,{},_),{x:y,y:O,width:M,height:x}=S;h.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([y,O]),topRight:a.canvasToWorld([y+M,O]),bottomLeft:a.canvasToWorld([y,O+x]),bottomRight:a.canvasToWorld([y+M,O+x])}}return o})),te(this,"_movingLongAxisWouldPutItThroughShortAxis",((e,t)=>{const n=ps.vec2.create();ps.vec2.set(n,t.end.x-t.start.x,t.end.y-t.start.y),ps.vec2.normalize(n,n);const i={start:{x:t.start.x-10*n[0],y:t.start.y-10*n[1]},end:{x:t.end.x+10*n[0],y:t.end.y+10*n[1]}};return!Gd([i.start.x,i.start.y],[i.end.x,i.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y])})),te(this,"_calculateCachedStats",((e,t,n)=>{const{data:i}=e,{viewportId:o,renderingEngineId:a}=n,r=i.handles.points[0],s=i.handles.points[1],l=i.handles.points[2],d=i.handles.points[3],{cachedStats:c}=i,h=Object.keys(c);for(let e=0;e<h.length;e++){const n=h[e],i=this.getTargetIdImage(n,t);if(!i)continue;const{imageData:o,dimensions:a}=i,u=$s(i),g=this._calculateLength(r,s)/u,v=this._calculateLength(l,d)/u,m=g>v?g:v,p=g>v?v:g,f=tv(o,r),E=tv(o,s),w=tv(o,l),I=tv(o,d);this._isInsideVolume(f,E,w,I,a)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,c[n]={length:m,width:p,unit:Zs(0,i)}}e.invalidated=!1;const u=Q.ANNOTATION_MODIFIED,g={annotation:e,viewportId:o,renderingEngineId:a};return(0,J.triggerEvent)(J.eventTarget,u,g),c})),te(this,"_isInsideVolume",((e,t,n,i,o)=>J.utilities.indexWithinDimensions(e,o)&&J.utilities.indexWithinDimensions(t,o)&&J.utilities.indexWithinDimensions(n,o)&&J.utilities.indexWithinDimensions(i,o))),te(this,"_getSignedAngle",((e,t)=>Math.atan2(e[0]*t[1]-e[1]*t[0],e[0]*t[0]+e[1]*t[1]))),this._throttledCalculateCachedStats=js(this._calculateCachedStats,100,{trailing:!0})}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,o,d,c),u=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:u,referencedImageId:h},data:{handles:{points:[[...o],[...o],[...o],[...o]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};Je(g,i);const v=Gl(i,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:v,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Qr(i),e.preventDefault(),Bo(s,v),g}_calculateLength(e,t){const n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+i*i+o*o)}}function iv(e,t){const{cachedStats:n}=e,{length:i,width:o,unit:a}=n[t];if(void 0!==i)return["L: ".concat(al(i)," ").concat(a),"W: ".concat(al(o)," ").concat(a)]}te(nv,"toolName",void 0),nv.toolName="Bidirectional";const ov=nv;class av extends Ql{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:rv,changeTextCallback:sv,preventHandleOutsideImage:!1,arrowFirst:!0}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"addNewAnnotation",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a;Qr(i),this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,o,d,c),{arrowFirst:u}=this.configuration,g=r.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{text:"",handles:{points:[[...o],[...o]],activeHandleIndex:null,arrowFirst:u,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};Je(v,i);const m=Gl(i,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),Bo(s,m),v})),te(this,"isPointNearTool",((e,t,n,i)=>{const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{data:r}=t,[s,l]=r.handles.points,d=a.worldToCanvas(s),c=a.worldToCanvas(l),h={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}};return nd([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]])<=i})),te(this,"toolSelectedCallback",((e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Gl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(i),Qr(i);const a=(0,J.getEnabledElement)(i),{renderingEngine:r}=a;Bo(r,o),e.preventDefault()})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=i;if(a&&!r)return;s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),$r(n);const l=(0,J.getEnabledElement)(n),{viewportId:d,renderingEngineId:c,renderingEngine:h}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Qe(i.annotationUID),a)this.configuration.getTextCallback((e=>{if(!e)return Qe(i.annotationUID),Bo(h,o),this.editData=null,void(this.isDrawing=!1);i.data.text=e;const t=Q.ANNOTATION_COMPLETED,n={annotation:i};(0,J.triggerEvent)(J.eventTarget,t,n),Bo(h,o)}));else{const e=Q.ANNOTATION_MODIFIED,t={annotation:i,viewportId:d,renderingEngineId:c};(0,J.triggerEvent)(J.eventTarget,e,t)}this.editData=null,this.isDrawing=!1})),te(this,"_dragCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=s.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;s.handles.points[a]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;Bo(d,o)})),te(this,"touchTapCallback",(e=>{2==e.detail.taps&&this.doubleClickCallback(e)})),te(this,"doubleClickCallback",(e=>{var t;const n=e.detail,{element:i}=n;let o=Ze(this.getToolName(),i);if(o=this.filterInteractableAnnotationsForElement(i,o),null===(t=o)||void 0===t||!t.length)return;const a=o.find((e=>this.isPointNearTool(i,e,n.currentPoints.canvas,6)));if(!a)return;const r=a;this.configuration.changeTextCallback(a,e.detail,this._doneChangingTextCallback.bind(this,i,r)),this.editData=null,this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()})),te(this,"cancel",(e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),$r(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(Bo(r,n),i){const e=Q.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID}})),te(this,"_activateModify",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragCallback)})),te(this,"_deactivateModify",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback)})),te(this,"_activateDraw",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_MOVE,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragCallback)})),te(this,"_deactivateDraw",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_MOVE,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragCallback)})),te(this,"renderAnnotation",((e,t)=>{var n,i;let o=!1;const{viewport:a}=e,{element:r}=a;let s=Ze(this.getToolName(),r);if(null===(n=s)||void 0===n||!n.length)return o;if(s=this.filterInteractableAnnotationsForElement(r,s),null===(i=s)||void 0===i||!i.length)return o;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<s.length;e++){const n=s[e],{annotationUID:i,data:r}=n,{handles:d,text:c}=r,{points:h,activeHandleIndex:u}=d;l.annotationUID=i;const g=this.getStyle("lineWidth",l,n),v=this.getStyle("lineDash",l,n),m=this.getStyle("color",l,n),p=h.map((e=>a.worldToCanvas(e)));let f;le(n)||this.editData||null===u||(f=[p[u]]),f&&Ms(t,i,"0",p,{color:m,lineWidth:g});const E="1";if(this.configuration.arrowFirst?Vs(t,i,E,p[1],p[0],{color:m,width:g,lineDash:v}):Vs(t,i,E,p[0],p[1],{color:m,width:g,lineDash:v}),o=!0,!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),o;if(!c)continue;const w=this.getLinkedTextBoxStyle(l,n);if(!w.visibility){r.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}if(!r.handles.textBox.hasMoved){const e=p[1];r.handles.textBox.worldPosition=a.canvasToWorld(e)}const I=a.worldToCanvas(r.handles.textBox.worldPosition),C=As(t,i,"1",[c],I,p,{},w),{x:_,y:T,width:b,height:D}=C;r.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([_,T]),topRight:a.canvasToWorld([_+b,T]),bottomLeft:a.canvasToWorld([_,T+D]),bottomRight:a.canvasToWorld([_+b,T+D])}}return o}))}handleSelectedCallback(e,t,n){const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=Gl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(o),Qr(o);const d=(0,J.getEnabledElement)(o),{renderingEngine:c}=d;Bo(c,l),e.preventDefault()}_doneChangingTextCallback(e,t,n){t.data.text=n;const{renderingEngine:i,viewportId:o,renderingEngineId:a}=(0,J.getEnabledElement)(e),r=Gl(e,this.getToolName());Bo(i,r);const s=Q.ANNOTATION_MODIFIED;(0,J.triggerEvent)(J.eventTarget,s,{annotation:t,viewportId:o,renderingEngineId:a})}_isInsideVolume(e,t,n){return J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n)}}function rv(e){return e(prompt("Enter your annotation:"))}function sv(e,t,n){return n(prompt("Enter your annotation:"))}te(av,"toolName",void 0),av.toolName="ArrowAnnotate";const lv=av;class dv extends Ql{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:cv}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"angleStartedNotYetCompleted",void 0),te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"addNewAnnotation",(e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a;Qr(i),this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,o,d,c),u=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:u,referencedImageId:h},data:{handles:{points:[[...o],[...o]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};Je(g,i);const v=Gl(i,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:v,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),Bo(s,v),g})),te(this,"isPointNearTool",((e,t,n,i)=>{const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{data:r}=t,[s,l,d]=r.handles.points,c=a.worldToCanvas(s),h=a.worldToCanvas(l),u={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}};if(nd([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=i)return!0;if(!d)return!1;const g=a.worldToCanvas(d),v={start:{x:h[0],y:h[1]},end:{x:g[0],y:g[1]}};return nd([v.start.x,v.start.y],[v.end.x,v.end.y],[n[0],n[1]])<=i})),te(this,"toolSelectedCallback",((e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Gl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(i),Qr(i);const a=(0,J.getEnabledElement)(i),{renderingEngine:r}=a;Bo(r,o),e.preventDefault()})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=i;if(a&&!r)return;if(this.angleStartedNotYetCompleted&&2===s.handles.points.length)return void(this.editData.handleIndex=2);this.angleStartedNotYetCompleted=!1,s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),$r(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Qe(i.annotationUID),Bo(d,o),a){const e=Q.ANNOTATION_COMPLETED,t={annotation:i};(0,J.triggerEvent)(J.eventTarget,e,t)}this.editData=null,this.isDrawing=!1})),te(this,"_dragCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=s.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;s.handles.points[a]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;Bo(d,o)})),te(this,"cancel",(e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),$r(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(Bo(r,n),i){const e=Q.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID}})),te(this,"_activateModify",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragCallback)})),te(this,"_deactivateModify",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragCallback)})),te(this,"_activateDraw",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_MOVE,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragCallback)})),te(this,"_deactivateDraw",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_MOVE,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragCallback)})),te(this,"renderAnnotation",((e,t)=>{var n,i;let o=!1;const{viewport:a}=e,{element:r}=a;let s=Ze(this.getToolName(),r);if(null===(n=s)||void 0===n||!n.length)return o;if(s=this.filterInteractableAnnotationsForElement(r,s),null===(i=s)||void 0===i||!i.length)return o;const l=this.getTargetId(a),d=a.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let n=0;n<s.length;n++){var h;const i=s[n],{annotationUID:r,data:u}=i,{points:g,activeHandleIndex:v}=u.handles;c.annotationUID=r;const m=this.getStyle("lineWidth",c,i),p=this.getStyle("lineDash",c,i),f=this.getStyle("color",c,i),E=g.map((e=>a.worldToCanvas(e)));let w;if(u.cachedStats[l]&&null!=u.cachedStats[l].angle?i.invalidated&&this._throttledCalculateCachedStats(i,d,e):(u.cachedStats[l]={angle:null},this._calculateCachedStats(i,d,e)),le(i)||this.editData||null===v||(w=[E[v]]),!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),o;w&&Ms(t,r,"0",E,{color:f,lineDash:p,lineWidth:m});let I="1";if(xs(t,r,I,E[0],E[1],{color:f,width:m,lineDash:p}),o=!0,3!==E.length)return o;if(I="2",xs(t,r,I,E[1],E[2],{color:f,width:m,lineDash:p}),null===(h=u.cachedStats[l])||void 0===h||!h.angle)continue;const C=this.getLinkedTextBoxStyle(c,i);if(!C.visibility){u.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const _=this.configuration.getTextLines(u,l);if(!u.handles.textBox.hasMoved){const e=E[1];u.handles.textBox.worldPosition=a.canvasToWorld(e)}const T=a.worldToCanvas(u.handles.textBox.worldPosition),b=As(t,r,"1",_,T,E,{},C),{x:D,y:S,width:y,height:O}=b;u.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([D,S]),topRight:a.canvasToWorld([D+y,S]),bottomLeft:a.canvasToWorld([D,S+O]),bottomRight:a.canvasToWorld([D+y,S+O])}}return o})),this._throttledCalculateCachedStats=js(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=Gl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(o),Qr(o);const d=(0,J.getEnabledElement)(o),{renderingEngine:c}=d;Bo(c,l),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{viewportId:o,renderingEngineId:a}=n;if(3!==i.handles.points.length)return;const r=i.handles.points[0],s=i.handles.points[1],l=i.handles.points[2],{cachedStats:d}=i,c=Object.keys(d);for(let e=0;e<c.length;e++){const t=c[e],n=hg([r,s],[s,l]);d[t]={angle:isNaN(n)?"Incomplete Angle":n}}e.invalidated=!1;const h=Q.ANNOTATION_MODIFIED,u={annotation:e,viewportId:o,renderingEngineId:a};return(0,J.triggerEvent)(J.eventTarget,h,u),d}}function cv(e,t){const n=e.cachedStats[t],{angle:i}=n;if(void 0!==i)return["".concat(al(i)," ").concat(String.fromCharCode(176))]}te(dv,"toolName",void 0),dv.toolName="Angle";const hv=dv,uv=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=2===t[0].length?[0,0]:[0,0,0],o=t.length;for(const e of t)i[0]+=e[0]/o,i[1]+=e[1]/o,3===i.length&&(i[2]+=e[2]/o);return i};class gv extends Ql{constructor(){var e;super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:vv}}),e=this,te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"angleStartedNotYetCompleted",void 0),te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"addNewAnnotation",(e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a;Qr(i),this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,o,d,c),u=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:u,referencedImageId:h},data:{handles:{points:[[...o],[...o]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};Je(g,i);const v=Gl(i,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:v,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),Bo(s,v),g})),te(this,"isPointNearTool",((e,t,n,i)=>{const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{data:r}=t,{distanceToPoint:s,distanceToPoint2:l}=this.distanceToLines({viewport:a,points:r.handles.points,canvasCoords:n,proximity:i});return s<=i||l<=i})),te(this,"toolSelectedCallback",(function(t,n,i,o){let a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:6;const r=t.detail,{element:s}=r;n.highlighted=!0;const l=Gl(s,e.getToolName()),d=(0,J.getEnabledElement)(s),{renderingEngine:c,viewport:h}=d,{isNearFirstLine:u,isNearSecondLine:g}=e.distanceToLines({viewport:h,points:n.data.handles.points,canvasCoords:o,proximity:a});e.editData={annotation:n,viewportIdsToRender:l,movingTextBox:!1,isNearFirstLine:u,isNearSecondLine:g},e._activateModify(s),Qr(s),Bo(c,l),t.preventDefault()})),te(this,"_mouseUpCallback",(e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=i;if(a&&!r)return;if(this.angleStartedNotYetCompleted&&s.handles.points.length<4)return $r(n),void(this.editData.handleIndex=s.handles.points.length);this.angleStartedNotYetCompleted=!1,s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),$r(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Qe(i.annotationUID),Bo(d,o),a){const e=Q.ANNOTATION_COMPLETED,t={annotation:i};(0,J.triggerEvent)(J.eventTarget,e,t)}this.editData=null,this.isDrawing=!1})),te(this,"_mouseDownCallback",(e=>{const{annotation:t,handleIndex:n}=this.editData,i=e.detail,{element:o,currentPoints:a}=i,r=a.world,{data:s}=t;return 1===n?(s.handles.points[1]=r,void(this.editData.hasMoved=s.handles.points[1][0]!==s.handles.points[0][0]||s.handles.points[1][1]!==s.handles.points[0][0])):3===n?(s.handles.points[3]=r,this.editData.hasMoved=s.handles.points[3][0]!==s.handles.points[2][0]||s.handles.points[3][1]!==s.handles.points[2][0],void(this.angleStartedNotYetCompleted=!1)):(this.editData.hasMoved=!1,Qr(o),s.handles.points[2]=s.handles.points[3]=r,void(this.editData.handleIndex=s.handles.points.length-1))})),te(this,"_mouseDragCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:r,isNearFirstLine:s,isNearSecondLine:l}=this.editData,{data:d}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=d.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a&&(s||l)){const{deltaPoints:e}=t,n=e.world,o=d.handles.points;s?[o[0],o[1]].forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})):l&&[o[2],o[3]].forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;d.handles.points[a]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const c=(0,J.getEnabledElement)(n),{renderingEngine:h}=c;Bo(h,o)})),te(this,"cancel",(e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),$r(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;o.handles.points.length<4&&Qe(t.annotationUID),t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(Bo(r,n),i){const e=Q.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID})),te(this,"_activateModify",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._mouseUpCallback),e.addEventListener(Q.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(Q.MOUSE_CLICK,this._mouseUpCallback)})),te(this,"_deactivateModify",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(Q.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._mouseUpCallback)})),te(this,"_activateDraw",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._mouseUpCallback),e.addEventListener(Q.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(Q.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(Q.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(Q.MOUSE_DOWN,this._mouseDownCallback)})),te(this,"_deactivateDraw",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(Q.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(Q.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(Q.MOUSE_DOWN,this._mouseDownCallback)})),te(this,"renderAnnotation",((e,t)=>{var n,i;let o=!1;const{viewport:a}=e,{element:r}=a;let s=Ze(this.getToolName(),r);if(null===(n=s)||void 0===n||!n.length)return o;if(s=this.filterInteractableAnnotationsForElement(r,s),null===(i=s)||void 0===i||!i.length)return o;const l=this.getTargetId(a),d=a.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let n=0;n<s.length;n++){var h;const i=s[n],{annotationUID:r,data:u}=i,{points:g,activeHandleIndex:v}=u.handles;c.annotationUID=r;const m=this.getStyle("lineWidth",c,i),p=this.getStyle("lineDash",c,i),f=this.getStyle("color",c,i),E=g.map((e=>a.worldToCanvas(e)));let w;if(u.cachedStats[l]&&null!=u.cachedStats[l].angle?i.invalidated&&this._throttledCalculateCachedStats(i,d,e):(u.cachedStats[l]={angle:null,arc1Angle:null,arc2Angle:null,points:{world:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null},canvas:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null}}},this._calculateCachedStats(i,d,e)),le(i)||this.editData||null===v||(w=[E[v]]),!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),o;w&&Ms(t,r,"0",E,{color:f,lineDash:p,lineWidth:m});const I=[E[0],E[1]],C=[E[2],E[3]];let _="line1";if(xs(t,r,_,I[0],I[1],{color:f,width:m,lineDash:p}),o=!0,E.length<4)return o;_="line2",xs(t,r,_,C[0],C[1],{color:f,width:m,lineDash:p}),_="linkLine",xs(t,r,_,uv(I[0],I[1]),uv(C[0],C[1]),{color:f,lineWidth:"1",lineDash:"1,4"});const{arc1Start:T,arc1End:b,arc2End:D,arc2Start:S}=u.cachedStats[l].points.canvas,{arc1Angle:y,arc2Angle:O}=u.cachedStats[l];if(_="arc1",xs(t,r,_,T,b,{color:f,lineWidth:"1"}),_="arc2",xs(t,r,_,S,D,{color:f,lineWidth:"1"}),null===(h=u.cachedStats[l])||void 0===h||!h.angle)continue;const M=this.getLinkedTextBoxStyle(c,i);if(!M.visibility){u.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const x=this.configuration.getTextLines(u,l);if(!u.handles.textBox.hasMoved){const e=od(E);u.handles.textBox.worldPosition=a.canvasToWorld(e)}const N=a.worldToCanvas(u.handles.textBox.worldPosition),k=As(t,r,"cobbAngleText",x,N,E,{},M),{x:R,y:P,width:L,height:A}=k;u.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([R,P]),topRight:a.canvasToWorld([R+L,P]),bottomLeft:a.canvasToWorld([R,P+A]),bottomRight:a.canvasToWorld([R+L,P+A])};const U="arcAngle1",V=["".concat(y.toFixed(2)," ").concat(String.fromCharCode(176))],W=uv(T,b);Ps(t,r,U,V,W,{...M,padding:3});const F="arcAngle2",H=["".concat(O.toFixed(2)," ").concat(String.fromCharCode(176))],B=uv(S,D);Ps(t,r,F,H,B,{...M,padding:3})}return o})),te(this,"distanceToLines",(e=>{let{viewport:t,points:n,canvasCoords:i,proximity:o}=e;const[a,r,s,l]=n,d=t.worldToCanvas(a),c=t.worldToCanvas(r),h=t.worldToCanvas(s),u=t.worldToCanvas(l),g={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}},v={start:{x:h[0],y:h[1]},end:{x:u[0],y:u[1]}},m=nd([g.start.x,g.start.y],[g.end.x,g.end.y],[i[0],i[1]]),p=nd([v.start.x,v.start.y],[v.end.x,v.end.y],[i[0],i[1]]);let f=!1,E=!1;return m<=o?f=!0:p<=o&&(E=!0),{distanceToPoint:m,distanceToPoint2:p,isNearFirstLine:f,isNearSecondLine:E}})),te(this,"getArcsStartEndPoints",(e=>{let{firstLine:t,secondLine:n,mid1:i,mid2:o}=e;const a=[i,o],r=hg(t,a),s=hg(n,a),l=r>90?1:0,d=s>90?0:1,c=uv(a[0],a[1]),h=Math.sqrt((a[1][0]-a[0][0])**2+(a[1][1]-a[0][1])**2),u=.1,g=uv(t[0],t[1]),v=uv(n[0],n[1]),m=[t[l][0]-g[0],t[l][1]-g[1]],p=Math.sqrt(m[0]**2+m[1]**2),f=[m[0]/p,m[1]/p],E=[g[0]+f[0]*h*u,g[1]+f[1]*h*u],w=[c[0]-i[0],c[1]-i[1]],I=Math.sqrt(w[0]**2+w[1]**2),C=[w[0]/I,w[1]/I],_=[i[0]+C[0]*h*u,i[1]+C[1]*h*u],T=[n[d][0]-v[0],n[d][1]-v[1]],b=Math.sqrt(T[0]**2+T[1]**2),D=[T[0]/b,T[1]/b],S=[v[0]+D[0]*h*u,v[1]+D[1]*h*u],y=[c[0]-o[0],c[1]-o[1]],O=Math.sqrt(y[0]**2+y[1]**2),M=[y[0]/O,y[1]/O];return{arc1Start:E,arc1End:_,arc2Start:S,arc2End:[o[0]+M[0]*h*u,o[1]+M[1]*h*u],arc1Angle:r>90?180-r:r,arc2Angle:s>90?180-s:s}})),this._throttledCalculateCachedStats=js(this._calculateCachedStats,25,{trailing:!0})}handleSelectedCallback(e,t,n){const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=Gl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(o),Qr(o);const d=(0,J.getEnabledElement)(o),{renderingEngine:c}=d;Bo(c,l),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{viewportId:o,renderingEngineId:a}=n;if(4!==i.handles.points.length)return;const r=[null,null],s=[null,null];let l=Number.MAX_VALUE;for(let e=0;e<2;e+=1)for(let t=2;t<4;t+=1){const n=ps.vec3.distance(i.handles.points[e],i.handles.points[t]);n<l&&(l=n,r[1]=i.handles.points[e],r[0]=i.handles.points[(e+1)%2],s[0]=i.handles.points[t],s[1]=i.handles.points[2+(t-1)%2])}const{viewport:d}=n,c=i.handles.points.map((e=>d.worldToCanvas(e))),h=[c[0],c[1]],u=[c[2],c[3]],g=uv(h[0],h[1]),v=uv(u[0],u[1]),{arc1Start:m,arc1End:p,arc2End:f,arc2Start:E,arc1Angle:w,arc2Angle:I}=this.getArcsStartEndPoints({firstLine:h,secondLine:u,mid1:g,mid2:v}),{cachedStats:C}=i,_=Object.keys(C);for(let e=0;e<_.length;e++)C[_[e]]={angle:hg(r,s),arc1Angle:w,arc2Angle:I,points:{canvas:{arc1Start:m,arc1End:p,arc2End:f,arc2Start:E},world:{arc1Start:d.canvasToWorld(m),arc1End:d.canvasToWorld(p),arc2End:d.canvasToWorld(f),arc2Start:d.canvasToWorld(E)}}};e.invalidated=!1;const T=Q.ANNOTATION_MODIFIED,b={annotation:e,viewportId:o,renderingEngineId:a};return(0,J.triggerEvent)(J.eventTarget,T,b),C}}function vv(e,t){const n=e.cachedStats[t],{angle:i}=n;if(void 0!==i)return["".concat(i.toFixed(2)," ").concat(String.fromCharCode(176))]}te(gv,"toolName",void 0),gv.toolName="CobbAngle";const mv=gv;class pv extends Ql{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{getTextCallback:fv,changeTextCallback:Ev,canvasPosition:[10,10],canvasSize:10}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"addNewAnnotation",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a,l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,o,d,c),u=r.getFrameOfReferenceUID(),g={annotationUID:null,highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:u,referencedImageId:h},data:{text:"",handles:{points:new Array,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};Je(g,i);const v=Gl(i,this.getToolName());return e.preventDefault(),Bo(s,v),this.configuration.getTextCallback((e=>{if(!e)return Qe(g.annotationUID),Bo(s,v),void(this.isDrawing=!1);g.data.text=e;const t=Q.ANNOTATION_COMPLETED,n={annotation:g};(0,J.triggerEvent)(J.eventTarget,t,n),Bo(s,v)})),g})),te(this,"isPointNearTool",((e,t,n,i)=>{const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{data:r}=t,{canvasPosition:s,canvasSize:l}=this.configuration;return!(null==s||!s.length)&&Math.abs(n[0]-s[0]+l/2)<=l/2&&Math.abs(n[1]-s[1]+l/2)<=l/2})),te(this,"toolSelectedCallback",((e,t)=>{t.highlighted=!0,e.preventDefault()})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t;this._deactivateModify(n),$r(n)})),te(this,"doubleClickCallback",(e=>{var t;const n=e.detail,{element:i}=n;let o=Ze(this.getToolName(),i);if(o=this.filterInteractableAnnotationsForElement(i,o),null===(t=o)||void 0===t||!t.length)return;const a=o.find((e=>this.isPointNearTool(i,e,n.currentPoints.canvas,6)));if(!a)return;const r=a;this.configuration.changeTextCallback(a,e.detail,this._doneChangingTextCallback.bind(this,i,r)),this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()})),te(this,"_activateModify",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback)})),te(this,"_deactivateModify",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback)})),te(this,"renderAnnotation",((e,t)=>{var n,i;let o=!1;const{viewport:a}=e,{element:r}=a;let s=Ze(this.getToolName(),r);if(null===(n=s)||void 0===n||!n.length)return o;if(s=this.filterInteractableAnnotationsForElement(r,s),null===(i=s)||void 0===i||!i.length)return o;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<s.length;e++){const n=s[e],{annotationUID:i}=n;l.annotationUID=i;const r=this.getStyle("color",l,n),{canvasPosition:d,canvasSize:c}=this.configuration;if(null!=d&&d.length&&Vs(t,i,"1",d.map((e=>e+c)),d,{color:r,width:1}),o=!0,!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),o}return o}))}cancel(){}handleSelectedCallback(e,t,n){}_doneChangingTextCallback(e,t,n){t.data.text=n;const{renderingEngine:i,viewportId:o,renderingEngineId:a}=(0,J.getEnabledElement)(e),r=Gl(e,this.getToolName());Bo(i,r);const s=Q.ANNOTATION_MODIFIED;(0,J.triggerEvent)(J.eventTarget,s,{annotation:t,viewportId:o,renderingEngineId:a})}_isInsideVolume(e,t,n){return J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n)}}function fv(e){return e(prompt("Enter your annotation:"))}function Ev(e,t,n){return n(prompt("Enter your annotation:"))}te(pv,"toolName",void 0),pv.toolName="KeyImage";const wv=pv,Iv="magnify-viewport";class Cv extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:10,magnifyWidth:250,magnifyHeight:250}}),te(this,"_bounds",void 0),te(this,"editData",void 0),te(this,"preMouseDownCallback",(e=>{const t=e.detail,{element:n,currentPoints:i}=t,o=(0,J.getEnabledElement)(n),{viewport:a,renderingEngine:r}=o;if(!(a instanceof J.StackViewport))throw new Error("MagnifyTool only works on StackViewports");const s=this._getReferencedImageId(a);if(!s)throw new Error("MagnifyTool: No referenced image id found, reconstructed planes not supported yet");const l=Gl(n,this.getToolName());return this.editData={referencedImageId:s,viewportIdsToRender:l,enabledElement:o,renderingEngine:r,currentPoints:i},this._createMagnificationViewport(),this._activateDraw(n),Qr(n),e.preventDefault(),Bo(r,l),!0})),te(this,"preTouchStartCallback",(e=>{this.preMouseDownCallback(e)})),te(this,"_createMagnificationViewport",(()=>{const{enabledElement:e,referencedImageId:t,viewportIdsToRender:n,renderingEngine:i,currentPoints:o}=this.editData,{viewport:a}=e,{element:r}=a,s=a.getProperties(),{canvas:l,world:d}=o;let c;if(c=r.querySelector(".magnifyTool"),null===c){const e=document.createElement("div");e.classList.add("magnifyTool"),e.style.display="block",e.style.width="".concat(this.configuration.magnifyWidth,"px"),e.style.height="".concat(this.configuration.magnifyHeight,"px"),e.style.position="absolute",c=e,r.querySelector(".viewport-element").appendChild(e);const t={viewportId:Iv,type:J.Enums.ViewportType.STACK,element:c};i.enableElement(t)}c.style.top="".concat(l[1]-this.configuration.magnifyHeight/2,"px"),c.style.left="".concat(l[0]-this.configuration.magnifyWidth/2,"px");const h=i.getViewport(Iv);h.setStack([t]).then((()=>{h.setProperties(s);const{parallelScale:e}=a.getCamera(),{focalPoint:t,position:n,viewPlaneNormal:i}=h.getCamera(),o=Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)+Math.pow(t[2]-n[2],2)),r=[d[0],d[1],d[2]],l=[r[0]+o*i[0],r[1]+o*i[1],r[2]+o*i[2]];h.setCamera({parallelScale:e*(1/this.configuration.magnifySize),focalPoint:r,position:l}),h.render()})),c.style.display="block",Bo(i,n)})),te(this,"_dragCallback",(e=>{const t=e.detail,{deltaPoints:n,element:i,currentPoints:o}=t,a=n.world,r=o.canvas,s=(0,J.getEnabledElement)(i),{renderingEngine:l}=s,d=l.getViewport(Iv),c=i.querySelector(".magnifyTool");if(!c)return;c.style.top="".concat(r[1]-this.configuration.magnifyHeight/2,"px"),c.style.left="".concat(r[0]-this.configuration.magnifyWidth/2,"px");const{focalPoint:h,position:u}=d.getCamera(),g=[u[0]+a[0],u[1]+a[1],u[2]+a[2]],v=[h[0]+a[0],h[1]+a[1],h[2]+a[2]];d.setCamera({focalPoint:v,position:g}),d.render()})),te(this,"_dragEndCallback",(e=>{const{element:t}=e.detail,n=(0,J.getEnabledElement)(t),{renderingEngine:i}=n;i.disableElement(Iv);const o=t.querySelector(".viewport-element"),a=o.querySelector(".magnifyTool");o.removeChild(a),this._deactivateDraw(t),$r(t)})),te(this,"_activateDraw",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._dragEndCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._dragEndCallback),e.addEventListener(Q.TOUCH_END,this._dragEndCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragCallback)})),te(this,"_deactivateDraw",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._dragEndCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._dragEndCallback),e.removeEventListener(Q.TOUCH_END,this._dragEndCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragCallback)}))}_getReferencedImageId(e){const t=this.getTargetId(e);let n;return e instanceof J.StackViewport&&(n=t.split("imageId:")[1]),n}}te(Cv,"toolName",void 0),Cv.toolName="Magnify";const _v=Cv,Tv=125,bv=e=>e.uid!==e.referenceId;class Dv{constructor(e){let{magnifyViewportId:t,sourceEnabledElement:n,radius:i=Tv,position:o=[0,0],zoomFactor:a,autoPan:r}=e;te(this,"_viewportId",void 0),te(this,"_sourceEnabledElement",void 0),te(this,"_enabledElement",null),te(this,"_sourceToolGroup",null),te(this,"_magnifyToolGroup",null),te(this,"_isViewportReady",!1),te(this,"_radius",0),te(this,"_resized",!1),te(this,"_resizeViewportAsync",void 0),te(this,"_canAutoPan",!1),te(this,"_autoPan",void 0),te(this,"position",void 0),te(this,"zoomFactor",void 0),te(this,"visible",void 0),this._viewportId=null!=t?t:J.utilities.uuidv4(),this._sourceEnabledElement=n,this._autoPan=r,this.radius=i,this.position=o,this.zoomFactor=a,this.visible=!0,this._browserMouseDownCallback=this._browserMouseDownCallback.bind(this),this._browserMouseUpCallback=this._browserMouseUpCallback.bind(this),this._handleToolModeChanged=this._handleToolModeChanged.bind(this),this._mouseDragCallback=this._mouseDragCallback.bind(this),this._resizeViewportAsync=qs(this._resizeViewport.bind(this),1),this._initialize()}get sourceEnabledElement(){return this._sourceEnabledElement}get viewportId(){return this._viewportId}get radius(){return this._radius}set radius(e){Math.abs(this._radius-e)>1e-5&&(this._radius=e,this._resized=!0)}update(){const{radius:e,position:t,visible:n}=this,{viewport:i}=this._enabledElement,{element:o}=i,a=2*e,[r,s]=t;this._resized&&(this._resizeViewportAsync(),this._resized=!1),Object.assign(o.style,{display:n?"block":"hidden",width:"".concat(a,"px"),height:"".concat(a,"px"),left:"".concat(-e,"px"),top:"".concat(-e,"px"),transform:"translate(".concat(r,"px, ").concat(s,"px)")}),this._isViewportReady&&(this._syncViewports(),i.render())}dispose(){const{viewport:e}=this._enabledElement,{element:t}=e,n=e.getRenderingEngine();this._removeEventListeners(t),n.disableElement(e.id),t.parentNode&&t.parentNode.removeChild(t)}_handleToolModeChanged(e){var t;const{_magnifyToolGroup:n}=this,{toolGroupId:i,toolName:o,mode:a,toolBindingsOptions:r}=e.detail;if((null===(t=this._sourceToolGroup)||void 0===t?void 0:t.id)===i)switch(a){case Ge.Active:n.setToolActive(o,r);break;case Ge.Passive:n.setToolPassive(o);break;case Ge.Enabled:n.setToolEnabled(o);break;case Ge.Disabled:n.setToolDisabled(o);break;default:throw new Error("Unknow tool mode (".concat(a,")"))}}_inheritBorderRadius(e){const t=e.querySelector(".viewport-element"),n=e.querySelector(".cornerstone-canvas");t.style.borderRadius="inherit",n.style.borderRadius="inherit"}_createViewportNode(){const e=document.createElement("div"),{radius:t}=this,n=2*t;return e.classList.add("advancedMagnifyTool"),Object.assign(e.style,{display:"block",width:"".concat(n,"px"),height:"".concat(n,"px"),position:"absolute",overflow:"hidden",borderRadius:"50%",boxSizing:"border-box",left:"".concat(-t,"px"),top:"".concat(-t,"px"),transform:"translate(-1000px, -1000px)"}),e}_convertZoomFactorToParalellScale(e,t,n){const{parallelScale:i}=e.getCamera();return i*(1/n)*(t.canvas.offsetWidth/e.canvas.offsetWidth)}_isStackViewport(e){return"setStack"in e}_isVolumeViewport(e){return"addVolumes"in e}_cloneToolGroups(e,t){const n=e.getActors(),i="".concat(t.id,"-toolGroup"),o=Si(e.id,e.renderingEngineId),a=o.clone(i,(e=>{const t=o.getToolInstance(e);return t instanceof Ql&&!(t instanceof Mv)||e===Ya.toolName}));return a.addViewport(t.id,t.renderingEngineId),n.filter(bv).forEach((e=>{Ku(i,[{segmentationId:e.referenceId,type:ot.Labelmap}])})),{sourceToolGroup:o,magnifyToolGroup:a}}_cloneStack(e,t){const n=e.getImageIds();t.setStack(n).then((()=>{this._isViewportReady=!0,this.update()}))}_cloneVolumes(e,t){const n=e.getActors().filter((e=>!bv(e))).map((e=>({volumeId:e.uid})));return t.setVolumes(n).then((()=>{this._isViewportReady=!0,this.update()})),t}_cloneViewport(e,t){const{viewportId:n}=this,i=e.getRenderingEngine(),{options:o}=e,a={element:t,viewportId:n,type:e.type,defaultOptions:{...o}};i.enableElement(a);const r=i.getViewport(n);this._isStackViewport(e)?this._cloneStack(e,r):this._isVolumeViewport(e)&&this._cloneVolumes(e,r),this._inheritBorderRadius(t);const s=this._cloneToolGroups(e,r);this._sourceToolGroup=s.sourceToolGroup,this._magnifyToolGroup=s.magnifyToolGroup}_cancelMouseEventCallback(e){e.stopPropagation(),e.preventDefault()}_browserMouseUpCallback(e){const{element:t}=this._enabledElement.viewport;document.removeEventListener("mouseup",this._browserMouseUpCallback),t.addEventListener("mouseup",this._cancelMouseEventCallback),t.addEventListener("mousemove",this._cancelMouseEventCallback)}_browserMouseDownCallback(e){var t;const{element:n}=this._enabledElement.viewport;this._canAutoPan=!(null===(t=e.target)||void 0===t||!t.closest(".advancedMagnifyTool")),document.addEventListener("mouseup",this._browserMouseUpCallback),n.removeEventListener("mouseup",this._cancelMouseEventCallback),n.removeEventListener("mousemove",this._cancelMouseEventCallback)}_mouseDragCallback(e){if(!He.isInteractingWithTool)return;const{_autoPan:t}=this;if(!t.enabled||!this._canAutoPan)return;const{currentPoints:n}=e.detail,{viewport:i}=this._enabledElement,{canvasToWorld:o}=i,{canvas:a}=n,{radius:r}=this,s=[r,r],l=ic(s,a),d=r-t.padding;if(l<=d)return;const c=l-d,h=ps.vec2.sub(ps.vec2.create(),a,s);ps.vec2.normalize(h,h),ps.vec2.scale(h,h,c);const u=ps.vec2.add(ps.vec2.create(),this.position,h),g=o(this.position),v=o(u),m=ps.vec3.sub(ps.vec3.create(),v,g),p={points:{currentPosition:{canvas:this.position,world:g},newPosition:{canvas:u,world:v}},delta:{canvas:h,world:m}};t.callback(p)}_addBrowserEventListeners(e){document.addEventListener("mousedown",this._browserMouseDownCallback,!0),e.addEventListener("mousedown",this._cancelMouseEventCallback),e.addEventListener("mouseup",this._cancelMouseEventCallback),e.addEventListener("mousemove",this._cancelMouseEventCallback),e.addEventListener("dblclick",this._cancelMouseEventCallback)}_removeBrowserEventListeners(e){document.removeEventListener("mousedown",this._browserMouseDownCallback,!0),document.removeEventListener("mouseup",this._browserMouseUpCallback),e.removeEventListener("mousedown",this._cancelMouseEventCallback),e.removeEventListener("mouseup",this._cancelMouseEventCallback),e.removeEventListener("mousemove",this._cancelMouseEventCallback),e.removeEventListener("dblclick",this._cancelMouseEventCallback)}_addEventListeners(e){J.eventTarget.addEventListener(Q.TOOL_MODE_CHANGED,this._handleToolModeChanged),e.addEventListener(Q.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(Q.MOUSE_DRAG,this._mouseDragCallback),this._addBrowserEventListeners(e)}_removeEventListeners(e){J.eventTarget.removeEventListener(Q.TOOL_MODE_CHANGED,this._handleToolModeChanged),e.addEventListener(Q.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(Q.MOUSE_DRAG,this._mouseDragCallback),this._removeBrowserEventListeners(e)}_initialize(){const{_sourceEnabledElement:e}=this,{viewport:t}=e,{canvas:n}=t,i=this._createViewportNode();n.parentNode.appendChild(i),this._addEventListeners(i),this._cloneViewport(t,i),this._enabledElement=(0,J.getEnabledElement)(i)}_syncViewportsCameras(e,t){const n=e.canvasToWorld(this.position),i=this._convertZoomFactorToParalellScale(e,t,this.zoomFactor),{focalPoint:o,position:a,viewPlaneNormal:r}=t.getCamera(),s=Math.sqrt(Math.pow(o[0]-a[0],2)+Math.pow(o[1]-a[1],2)+Math.pow(o[2]-a[2],2)),l=[n[0],n[1],n[2]],d=[l[0]+s*r[0],l[1]+s*r[1],l[2]+s*r[2]];t.setCamera({parallelScale:i,focalPoint:l,position:d})}_syncStackViewports(e,t){t.setImageIdIndex(e.getCurrentImageIdIndex())}_syncViewports(){const{viewport:e}=this._sourceEnabledElement,{viewport:t}=this._enabledElement,n=e.getProperties();t.setProperties(n),this._syncViewportsCameras(e,t),this._isStackViewport(e)&&this._syncStackViewports(e,t)}_resizeViewport(){const{viewport:e}=this._enabledElement;e.getRenderingEngine().resize()}}const Sv=1-J.CONSTANTS.EPSILON,{Events:yv}=J.Enums;class Ov{constructor(){te(this,"_magnifyViewportsMap",void 0),te(this,"createViewport",((e,t)=>{const{magnifyViewportId:n,sourceEnabledElement:i,position:o,radius:a,zoomFactor:r,autoPan:s}=t,{viewport:l}=i,{element:d}=l,c=new Dv({magnifyViewportId:n,sourceEnabledElement:i,radius:a,position:o,zoomFactor:r,autoPan:s});return this._addSourceElementEventListener(d),this._magnifyViewportsMap.set(c.viewportId,{annotation:e,magnifyViewport:c}),c})),te(this,"_annotationRemovedCallback",(e=>{const{annotation:t}=e.detail;"AdvancedMagnify"===t.metadata.toolName&&this._destroyViewport(t.data.magnifyViewportId)})),te(this,"_newStackImageCallback",(e=>{const{viewportId:t,imageId:n}=e.detail;this._getMagnifyViewportsMapEntriesBySourceViewportId(t).forEach((e=>{let{annotation:t}=e;t.metadata.referencedImageId=n,t.invalidated=!0}))})),te(this,"_newVolumeImageCallback",(e=>{const{renderingEngineId:t,viewportId:n}=e.detail,i=(0,J.getRenderingEngine)(t).getViewport(n),{viewPlaneNormal:o}=i.getCamera();this._getMagnifyViewportsMapEntriesBySourceViewportId(n).forEach((e=>{let{annotation:t}=e;const{viewPlaneNormal:n}=t.metadata;if(!(Math.abs(ps.vec3.dot(n,o))>Sv))return;const{handles:a}=t.data,r=i.canvasToWorld([0,0]),s=ps.vec3.sub(ps.vec3.create(),r,a.points[0]),l=ps.vec3.dot(s,o),d=ps.vec3.scale(ps.vec3.create(),o,l);for(let e=0,t=a.points.length;e<t;e++){const t=a.points[e];t[0]+=d[0],t[1]+=d[1],t[2]+=d[2]}t.invalidated=!0}))})),this._magnifyViewportsMap=new Map,this._initialize()}static getInstance(){var e;return Ov._singleton=null!==(e=Ov._singleton)&&void 0!==e?e:new Ov,Ov._singleton}getViewport(e){var t;return null===(t=this._magnifyViewportsMap.get(e))||void 0===t?void 0:t.magnifyViewport}dispose(){this._removeEventListeners(),this._destroyViewports()}_destroyViewport(e){const t=this._magnifyViewportsMap.get(e);if(t){const{magnifyViewport:n}=t,{viewport:i}=n.sourceEnabledElement,{element:o}=i;this._removeSourceElementEventListener(o),n.dispose(),this._magnifyViewportsMap.delete(e)}}_destroyViewports(){Array.from(this._magnifyViewportsMap.keys()).forEach((e=>this._destroyViewport(e)))}_getMagnifyViewportsMapEntriesBySourceViewportId(e){return Array.from(this._magnifyViewportsMap.values()).filter((t=>{let{magnifyViewport:n}=t;const{viewport:i}=n.sourceEnabledElement;return i.id===e}))}_addEventListeners(){J.eventTarget.addEventListener(Q.ANNOTATION_REMOVED,this._annotationRemovedCallback)}_removeEventListeners(){J.eventTarget.removeEventListener(Q.ANNOTATION_REMOVED,this._annotationRemovedCallback)}_addSourceElementEventListener(e){e.addEventListener(yv.STACK_NEW_IMAGE,this._newStackImageCallback),e.addEventListener(yv.VOLUME_NEW_IMAGE,this._newVolumeImageCallback)}_removeSourceElementEventListener(e){e.removeEventListener(yv.STACK_NEW_IMAGE,this._newStackImageCallback),e.removeEventListener(yv.VOLUME_NEW_IMAGE,this._newVolumeImageCallback)}_initialize(){this._addEventListeners()}}te(Ov,"_singleton",void 0);class Mv extends Ql{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,magnifyingGlass:{radius:125,zoomFactor:2.5,zoomFactorList:[2.5,3,3.5,4,4.5,5],autoPan:{enabled:!0,padding:10}},actions:[{method:"showZoomFactorsList",bindings:[{mouseButton:$i.Secondary,modifierKey:Qi.Shift}]}]}}),te(this,"magnifyViewportManager",void 0),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"addNewAnnotation",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=(0,J.getEnabledElement)(i),{viewport:a,renderingEngine:r}=o,s=n.world,l=n.canvas,{magnifyingGlass:d}=this.configuration,{radius:c,zoomFactor:h,autoPan:u}=d,g=this._getWorldHandlesPoints(a,l,c),v=a.getCamera(),{viewPlaneNormal:m,viewUp:p}=v,f=this.getReferencedImageId(a,s,m,p),E=J.utilities.uuidv4(),w=J.utilities.uuidv4(),I=a.getFrameOfReferenceUID(),C={annotationUID:E,highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...m],viewUp:[...p],FrameOfReferenceUID:I,referencedImageId:f},data:{sourceViewportId:a.id,magnifyViewportId:w,zoomFactor:h,handles:{points:g,activeHandleIndex:null}}};this.magnifyViewportManager.createViewport(C,{magnifyViewportId:w,sourceEnabledElement:o,position:l,radius:c,zoomFactor:h,autoPan:{enabled:u.enabled,padding:u.padding,callback:e=>{const t=C.data.handles.points,{world:n}=e.delta;for(let e=0,i=t.length;e<i;e++)t[e][0]+=n[0],t[e][1]+=n[1],t[e][2]+=n[2]}}}),Je(C,i);const _=Gl(i,this.getToolName());return e.preventDefault(),Bo(r,_),C})),te(this,"isPointNearTool",((e,t,n,i)=>{const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{data:r}=t,{points:s}=r.handles,l=s.map((e=>a.worldToCanvas(e))),d=l[0],c=l[2],h=l[3],u=.5*Math.abs(c[1]-d[1]),g=Xg([[h[0]+u,d[1]+u],n]);return Math.abs(g-u)<1.5*i})),te(this,"toolSelectedCallback",((e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Gl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o},Qr(i),this._activateModify(i);const a=(0,J.getEnabledElement)(i),{renderingEngine:r}=a;Bo(r,o),e.preventDefault()})),te(this,"handleSelectedCallback",((e,t,n)=>{const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;const{points:r}=a.handles,s=r.findIndex((e=>e===n)),l=Gl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s},this._activateModify(o),Qr(o);const d=(0,J.getEnabledElement)(o),{renderingEngine:c}=d;Bo(c,l),e.preventDefault()})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a}=this.editData,{data:r}=i;r.handles.activeHandleIndex=null,this._deactivateModify(n),$r(n);const s=(0,J.getEnabledElement)(n),{renderingEngine:l}=s;if(this.editData=null,this.isDrawing=!1,Bo(l,o),a){const e=Q.ANNOTATION_COMPLETED,t={annotation:i};(0,J.triggerEvent)(J.eventTarget,e,t)}})),te(this,"_dragDrawCallback",(e=>{var t;this.isDrawing=!0;const n=e.detail,{element:i,deltaPoints:o}=n,a=null!==(t=null==o?void 0:o.world)&&void 0!==t?t:[0,0,0],r=(0,J.getEnabledElement)(i),{renderingEngine:s}=r,{annotation:l,viewportIdsToRender:d}=this.editData,{points:c}=l.data.handles;c.forEach((e=>{e[0]+=a[0],e[1]+=a[1],e[2]+=a[2]})),l.invalidated=!0,this.editData.hasMoved=!0,Bo(s,d)})),te(this,"_dragModifyCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a}=this.editData,{data:r}=i;if(void 0===a){const{deltaPoints:e}=t,n=e.world;r.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;const s=(0,J.getEnabledElement)(n),{renderingEngine:l}=s;Bo(l,o)})),te(this,"_dragHandle",(e=>{const t=e.detail,{element:n}=t,i=(0,J.getEnabledElement)(n),{viewport:o}=i,{worldToCanvas:a}=o,{annotation:r}=this.editData,{data:s}=r,{points:l}=s.handles,d=l.map((e=>a(e))),c=d[0],h=d[2],u=d[3],g=.5*Math.abs(h[1]-c[1]),v=[u[0]+g,c[1]+g],{currentPoints:m}=t,p=Xg([v,m.canvas]),f=this._getWorldHandlesPoints(o,v,p);l[0]=f[0],l[1]=f[1],l[2]=f[2],l[3]=f[3]})),te(this,"cancel",(e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateModify(e),$r(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(Bo(r,n),i){const e=Q.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID})),te(this,"_activateModify",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_deactivateModify",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"renderAnnotation",((e,t)=>{var n,i,o;let a=!1;const{viewport:r}=e,{element:s}=r;let l=Ze(this.getToolName(),s);if(null===(n=l)||void 0===n||!n.length)return a;if(l=this.filterInteractableAnnotationsForElement(s,l),l=null===(i=l)||void 0===i?void 0:i.filter((e=>e.data.sourceViewportId===r.id)),null===(o=l)||void 0===o||!o.length)return a;const d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<l.length;e++){const n=l[e],{annotationUID:i,data:o}=n,{magnifyViewportId:s,zoomFactor:c,handles:h}=o,{points:u,activeHandleIndex:g}=h;d.annotationUID=i;const v=this.getStyle("lineWidth",d,n),m=this.getStyle("lineDash",d,n),p=this.getStyle("color",d,n),f=u.map((e=>r.worldToCanvas(e))),E=f[0],w=f[2],I=f[3],C=.5*Math.abs(w[1]-E[1]),_=[I[0]+C,E[1]+C];if(!r.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;let T;if(!Me(i))continue;le(n)||this.editData||null===g||(T=[f[g]]),T&&Ms(t,i,"0",T,{color:p});const b="".concat(i,"-advancedMagnify");ys(t,i,"0",_,C,{color:p,lineDash:m,lineWidth:v},b);const D=this.magnifyViewportManager.getViewport(s);D.position=_,D.radius=C,D.zoomFactor=c,D.update(),a=!0}return a})),te(this,"_getWorldHandlesPoints",((e,t,n)=>[[t[0],t[1]-n],[t[0]+n,t[1]],[t[0],t[1]+n],[t[0]-n,t[1]]].map((t=>e.canvasToWorld(t))))),this.magnifyViewportManager=Ov.getInstance()}showZoomFactorsList(e,t){const{element:n,currentPoints:i}=e.detail,o=(0,J.getEnabledElement)(n),{viewport:a}=o,{canvas:r}=i,s=n.querySelector(":scope .viewport-element"),l=t.data.zoomFactor,d=this._getZoomFactorsListDropdown(l,(e=>{void 0!==e&&(t.data.zoomFactor=Number.parseFloat(e),t.invalidated=!0),d.parentElement.removeChild(d),a.render()}));Object.assign(d.style,{left:"".concat(r[0],"px"),top:"".concat(r[1],"px")}),s.appendChild(d),d.focus()}_getZoomFactorsListDropdown(e,t){const{zoomFactorList:n}=this.configuration.magnifyingGlass,i=document.createElement("select");return i.size=5,Object.assign(i.style,{width:"50px",position:"absolute"}),["mousedown","mouseup","mousemove","click"].forEach((e=>{i.addEventListener(e,(e=>e.stopPropagation()))})),i.addEventListener("change",(e=>{e.stopPropagation(),t(i.value)})),i.addEventListener("keydown",(e=>{var n,i;((null!==(n=e.keyCode)&&void 0!==n?n:27===e.which)||"escape"===(null===(i=e.key)||void 0===i?void 0:i.toLowerCase()))&&(e.stopPropagation(),t())})),n.forEach((t=>{const n=document.createElement("option");n.label=t,n.title="Zoom factor ".concat(t.toFixed(1)),n.value=t,n.defaultSelected=t===e,i.add(n)})),i}}te(Mv,"toolName",void 0),Mv.toolName="AdvancedMagnify";class xv extends Jl{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,displayThreshold:5,positionSync:!0,disableCursor:!1}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"_throttledCalculateCachedStats",void 0),te(this,"isDrawing",!1),te(this,"isHandleOutsideImage",!1),te(this,"_elementWithCursor",null),te(this,"_currentCursorWorldPosition",null),te(this,"_currentCanvasPosition",null),te(this,"_disableCursorEnabled",!1),te(this,"mouseMoveCallback",(e=>{const{detail:t}=e,{element:n,currentPoints:i}=t;this._currentCursorWorldPosition=i.world,this._currentCanvasPosition=i.canvas,this._elementWithCursor=n;const o=this.getActiveAnnotation(n);return null===o?(this.createInitialAnnotation(i.world,n),!1):(this.updateAnnotationPosition(n,o),!1)})),te(this,"createInitialAnnotation",((e,t)=>{const n=(0,J.getEnabledElement)(t);if(!n)throw new Error("No enabled element found");const{viewport:i,renderingEngine:o}=n;this.isDrawing=!0;const a=i.getCamera(),{viewPlaneNormal:r,viewUp:s}=a;if(!r||!s)throw new Error("Camera not found");const l=this.getReferencedImageId(i,e,r,s),d=i.getFrameOfReferenceUID(),c={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...r],viewUp:[...s],FrameOfReferenceUID:d,referencedImageId:l},data:{label:"",handles:{points:[[...e]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}};if(Ze(this.getToolName(),t).length>0)return null;if(null===Je(c,t))return;const h=Gl(t,this.getToolName(),!1);Bo(o,h)})),te(this,"onCameraModified",(e=>{const t=e.detail,{element:n,previousCamera:i,camera:o}=t,a=(0,J.getEnabledElement)(n).viewport;if(n!==this._elementWithCursor)return;const r=i.focalPoint,s=o.viewPlaneNormal,l=o.focalPoint,d=[0,0,0];if(ac().subtract(l,r,d),0===d.reduce(((e,t)=>e+t),0))return;const c=ac().dot(d,s);if(Math.abs(c)<.01)return;if(!this._currentCanvasPosition)return;const h=a.canvasToWorld(this._currentCanvasPosition);this._currentCursorWorldPosition=h,this.updateAnnotationPosition(n,this.getActiveAnnotation(n))})),te(this,"renderAnnotation",((e,t)=>{var n,i;let o=!1;const{viewport:a,FrameOfReferenceUID:r}=e,s=this._elementWithCursor===a.element;this.configuration.positionSync&&!s&&this.updateViewportImage(a);const{element:l}=a;let d=Ze(this.getToolName(),l);if(null===(n=d)||void 0===n||!n.length)return o;if(d=this.filterInteractableAnnotationsForElement(l,d),null===(i=d)||void 0===i||!i.length)return o;const c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<d.length;e++){const n=d[e],{annotationUID:i,data:r}=n,{handles:l}=r,{points:h}=l;if(!i)return o;c.annotationUID=i;const u=parseFloat(this.getStyle("lineWidth",c,n)),g=this.getStyle("lineDash",c,n),v=this.getStyle("color",c,n);if(h[0].some((e=>isNaN(e))))return o;const m=h.map((e=>a.worldToCanvas(e)));if(!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),o;if(!Me(i))continue;const p={upper:"upper",right:"right",lower:"lower",left:"left"},[f,E]=m[0],w=s?20:7,I=s?5:7;xs(t,i,p.upper,[f,E-(w/2+I)],[f,E-w/2],{color:v,lineDash:g,lineWidth:u}),xs(t,i,p.lower,[f,E+(w/2+I)],[f,E+w/2],{color:v,lineDash:g,lineWidth:u}),xs(t,i,p.right,[f+(w/2+I),E],[f+w/2,E],{color:v,lineDash:g,lineWidth:u}),xs(t,i,p.left,[f-(w/2+I),E],[f-w/2,E],{color:v,lineDash:g,lineWidth:u}),o=!0}return o})),this._disableCursorEnabled=this.configuration.disableCursor}onSetToolActive(){if(this._disableCursorEnabled=this.configuration.disableCursor,!this._disableCursorEnabled)return;const e=zo(this.toolGroupId).viewportsInfo;e&&e.map((e=>(0,J.getEnabledElementByIds)(e.viewportId,e.renderingEngineId))).forEach((e=>{e&&Qr(e.viewport.element)}))}onSetToolDisabled(){if(!this._disableCursorEnabled)return;const e=zo(this.toolGroupId).viewportsInfo;e&&e.map((e=>(0,J.getEnabledElementByIds)(e.viewportId,e.renderingEngineId))).forEach((e=>{e&&$r(e.viewport.element)}))}getActiveAnnotation(e){const t=Ze(this.getToolName(),e);return t.length?t[0]:null}updateAnnotationPosition(e,t){var n;const i=this._currentCursorWorldPosition;if(!i)return;if(null===(n=t.data)||void 0===n||null===(n=n.handles)||void 0===n||!n.points)return;t.data.handles.points=[[...i]],t.invalidated=!0;const o=Gl(e,this.getToolName(),!1),a=(0,J.getEnabledElement)(e);if(!a)return;const{renderingEngine:r}=a;Bo(r,o)}filterInteractableAnnotationsForElement(e,t){var n,i;if(!(t instanceof Array)||0===t.length)return[];const o=t[0],a=null===(n=(0,J.getEnabledElement)(e))||void 0===n?void 0:n.viewport;if(!a)return[];const r=a.getCamera(),{viewPlaneNormal:s,focalPoint:l}=r;if(!s||!l)return[];const d=null===(i=o.data)||void 0===i||null===(i=i.handles)||void 0===i?void 0:i.points;if(!(d instanceof Array)||1!==d.length)return[];const c=d[0],h=J.utilities.planar.planeEquation(s,l);return J.utilities.planar.planeDistanceToPoint(h,c)<this.configuration.displayThreshold?[o]:[]}updateViewportImage(e){const t=this._currentCursorWorldPosition;if(t&&!t.some((e=>isNaN(e))))if(e instanceof J.StackViewport){const n=J.utilities.getClosestStackImageIndexForPoint(t,e);if(null===n)return;n!==e.getCurrentImageIdIndex()&&e.setImageIdIndex(n)}else if(e instanceof J.VolumeViewport){const{focalPoint:n,viewPlaneNormal:i}=e.getCamera();if(!n||!i)return;const o=J.utilities.planar.planeEquation(i,n),a=J.utilities.planar.planeDistanceToPoint(o,t,!0);if(Math.abs(a)<.5)return;const r=ps.vec3.normalize(ps.vec3.create(),ps.vec3.fromValues(...i)),s=ps.vec3.scale(ps.vec3.create(),r,a),l=ps.vec3.add(ps.vec3.create(),ps.vec3.fromValues(...n),s);{e.setCamera({focalPoint:l});const t=e.getRenderingEngine();t&&t.renderViewport(e.id)}}}}te(xv,"toolName",void 0),xv.toolName="ReferenceCursors";const Nv=xv,kv=[];class Rv extends Jl{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{viewportId:"",scaleLocation:"bottom"}}),te(this,"touchDragCallback",void 0),te(this,"mouseDragCallback",void 0),te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",{}),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"_init",(()=>{const e=(0,J.getRenderingEngines)()[0];if(!e)return;const t=zo(this.toolGroupId).viewportsInfo;if(!t)return;const n=t.map((e=>(0,J.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)));let{viewport:i}=n[0];const{FrameOfReferenceUID:o}=n[0];if(this.configuration.viewportId&&n.forEach((e=>{e.viewport.id==this.configuration.viewportId&&(i=e.viewport)})),!i)return;const{viewUp:a,viewPlaneNormal:r}=i.getCamera(),s=J.utilities.getViewportImageCornersInWorld(i);let l=this.editData.annotation;const d=Ze(this.getToolName(),i.element);if(d.length&&(l=d.filter((e=>e.data.viewportId==i.id))[0]),kv.includes(i.id))this.editData.annotation.data.viewportId==i.id&&(this.editData.annotation.data.handles.points=s,this.editData.annotation.data.viewportId=i.id);else{const e={metadata:{toolName:this.getToolName(),viewPlaneNormal:[...r],viewUp:[...a],FrameOfReferenceUID:o,referencedImageId:null},data:{handles:{points:s},viewportId:i.id}};kv.push(i.id),Je(e,i.element),l=e}this.editData={viewport:i,renderingEngine:e,annotation:l}})),te(this,"onSetToolEnabled",(()=>{this._init()})),te(this,"onCameraModified",(e=>{this.configuration.viewportId=e.detail.viewportId,this._init()})),te(this,"computeScaleSize",((e,t,n)=>{const i=[16e3,8e3,4e3,2e3,1e3,500,250,100,50,25,10,5,2];let o;return o="top"==n||"bottom"==n?i.filter((t=>t<.6*e&&t>.2*e)):i.filter((e=>e<.6*t&&e>.2*t)),o[0]})),te(this,"computeEndScaleTicks",((e,t)=>{const n={bottom:[[0,-10],[0,-10]],top:[[0,10],[0,10]],left:[[0,0],[10,0]],right:[[0,0],[-10,0]]};return{endTick1:[[e[1][0]+n[t][0][0],e[1][1]+n[t][0][0]],[e[1][0]+n[t][1][0],e[1][1]+n[t][1][1]]],endTick2:[[e[0][0]+n[t][0][0],e[0][1]+n[t][0][0]],[e[0][0]+n[t][1][0],e[0][1]+n[t][1][1]]]}})),te(this,"computeInnerScaleTicks",((e,t,n,i,o)=>{let a;"bottom"==t||"top"==t?a=o[0][0]-i[0][0]:"left"!=t&&"right"!=t||(a=o[0][1]-i[0][1]);const r=[],s=[],l=[];let d=e;e>=50&&(d=e/10);const c=a/d;for(let e=0;e<d-1;e++){const o={bottom:[[c*(e+1),0],[c*(e+1),5]],top:[[c*(e+1),0],[c*(e+1),-5]],left:[[0,c*(e+1)],[-5,c*(e+1)]],right:[[0,c*(e+1)],[5,c*(e+1)]]};r.push("".concat(n,"-tick").concat(e)),s.push("tick".concat(e)),(e+1)%5==0?l.push([[i[0][0]+o[t][0][0],i[0][1]+o[t][0][1]],[i[1][0]+o[t][0][0],i[1][1]+o[t][0][1]]]):l.push([[i[0][0]+o[t][0][0],i[0][1]+o[t][0][1]],[i[1][0]+o[t][1][0],i[1][1]+o[t][1][1]]])}return{tickIds:r,tickUIDs:s,tickCoordinates:l}})),te(this,"computeWorldScaleCoordinates",((e,t,n)=>{let i,o=ps.vec3.subtract(ps.vec3.create(),n[0],n[1]);o=ps.vec3.normalize(ps.vec3.create(),o);let a=ps.vec3.subtract(ps.vec3.create(),n[2],n[0]);a=ps.vec3.normalize(ps.vec3.create(),a);const r={bottom:[n[1],n[2]],top:[n[0],n[3]],right:[n[2],n[3]],left:[n[0],n[1]]},s=ps.vec3.add(ps.vec3.create(),r[t][0],r[t][0]).map((e=>e/2)),l=e/2/Math.sqrt(Math.pow(o[0],2)+Math.pow(o[1],2)+Math.pow(o[2],2));return"top"==t||"bottom"==t?i=[ps.vec3.subtract(ps.vec3.create(),s,a.map((e=>e*l))),ps.vec3.add(ps.vec3.create(),s,a.map((e=>e*l)))]:"left"!=t&&"right"!=t||(i=[ps.vec3.add(ps.vec3.create(),s,o.map((e=>e*l))),ps.vec3.subtract(ps.vec3.create(),s,o.map((e=>e*l)))]),i})),te(this,"computeCanvasScaleCoordinates",((e,t,n,i,o)=>{let a;if("top"==o||"bottom"==o){const i=t[0][0]-t[1][0];a=[[e.width/2-i/2,n.height],[e.width/2+i/2,n.height]]}else if("left"==o||"right"==o){const n=t[0][1]-t[1][1];a=[[i.width,e.height/2-n/2],[i.width,e.height/2+n/2]]}return a})),te(this,"computeScaleBounds",((e,t,n,i)=>{const o=t*Math.min(1e3,e.width),a=n*Math.min(1e3,e.height),r={bottom:[-a,-o],top:[a,o],left:[a,o],right:[-a,-o]},s={bottom:[e.height,e.width],top:[0,e.width],left:[e.height,0],right:[e.height,e.width]};return{height:s[i][0]+r[i][0],width:s[i][1]+r[i][1]}}))}renderAnnotation(e,t){if(!this.editData.viewport)return;const n=this.configuration.scaleLocation,{viewport:i}=e,o=Ze(this.getToolName(),i.element).filter((e=>e.data.viewportId==i.id))[0],a=e.viewport.canvas;if(!i)return!1;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},s={width:a.width,height:a.height},l=o.data.handles.points[0],d=o.data.handles.points[1],c=o.data.handles.points[2],h=o.data.handles.points[3],u=[l,c,d,h],g=ps.vec3.distance(c,h),v=ps.vec3.distance(l,c),m=this.computeScaleBounds(s,.05,.05,n),p=this.computeScaleBounds(s,.05,.05,n),f=this.computeScaleSize(g,v,n),E=this.computeWorldScaleCoordinates(f,n,u).map((e=>i.worldToCanvas(e))),w=this.computeCanvasScaleCoordinates(s,E,p,m,n),I=this.computeEndScaleTicks(w,n),{annotationUID:C}=o;r.annotationUID=C;const _=this.getStyle("lineWidth",r,o),T=this.getStyle("lineDash",r,o),b=this.getStyle("color",r,o),D=this.getStyle("shadow",r,o),S="".concat(C,"-scaleline");xs(t,C,"1",w[0],w[1],{color:b,width:_,lineDash:T,shadow:D},S);const y="".concat(C,"-left");xs(t,C,"2",I.endTick1[0],I.endTick1[1],{color:b,width:_,lineDash:T,shadow:D},y);const O="".concat(C,"-right");xs(t,C,"3",I.endTick2[0],I.endTick2[1],{color:b,width:_,lineDash:T,shadow:D},O);const M={bottom:[-10,-42],top:[-12,-35],left:[-40,-20],right:[-50,-20]},x=[w[0][0]+M[n][0],w[0][1]+M[n][1]],N=this._getTextLines(f),{tickIds:k,tickUIDs:R,tickCoordinates:P}=this.computeInnerScaleTicks(f,n,C,I.endTick1,I.endTick2);for(let e=0;e<R.length;e++)xs(t,C,R[e],P[e][0],P[e][1],{color:b,width:_,lineDash:T,shadow:D},k[e]);return Ps(t,C,"text0",N,[x[0],x[1]],{fontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",fontSize:"14px",lineDash:"2,3",lineWidth:"1",shadow:!0,color:b}),!1}_getTextLines(e){let t,n;return e>=50?(t=e/10,n=" cm"):(t=e,n=" mm"),[t.toString().concat(n)]}}te(Rv,"toolName",void 0),Rv.toolName="ScaleOverlay";const Pv=Rv,{transformWorldToIndex:Lv}=J.utilities;function Av(e,t){!function(e,t){const{volume:n,points:i,segmentsLocked:o,segmentIndex:a,segmentationId:r,constraintFn:s}=t,{imageData:l,dimensions:d}=n,c=n.getScalarData();let h=i.map((e=>Lv(l,e)));h=h.map((e=>e.map((e=>Math.round(e)))));const u=nl(h,d);tl(l,(()=>!0),(e=>{let{value:t,index:n,pointIJK:i}=e;o.includes(t)||(s?s(i)&&(c[n]=a):c[n]=a)}),u),pt(r)}(0,t)}const{transformWorldToIndex:Uv}=J.utilities;function Vv(e,t){!function(e,t){const{volume:n,points:i,segmentsLocked:o,segmentationId:a}=t,{imageData:r,dimensions:s}=n,l=n.getScalarData(),d=i.map((e=>Uv(r,e))),c=nl(d,s);tl(r,(()=>!0),(e=>{let{value:t,index:n}=e;o.includes(t)||(l[n]=0)}),c),pt(a)}(0,t)}class Wv extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:Av,ERASE_INSIDE:Vv},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}),te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"preMouseDownCallback",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.toolGroupId,u=wl(h);if(!u)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:g,segmentationId:v,type:m}=u,p=Dl(v),f=Tl(v),E=Ol(h,g,p),{representationData:w}=wt(v),{volumeId:I}=w[m],C=J.cache.getVolume(I),_={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:E},data:{handles:{points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null}}},T=Gl(i,this.getToolName());return this.editData={annotation:_,segmentation:C,segmentIndex:p,segmentsLocked:f,segmentColor:E,segmentationId:v,viewportIdsToRender:T,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Qr(i),e.preventDefault(),Bo(s,T),!0})),te(this,"_dragCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a}=this.editData,{data:r}=i,{currentPoints:s}=t,l=(0,J.getEnabledElement)(n),{worldToCanvas:d,canvasToWorld:c}=l.viewport,h=s.world,{points:u}=r.handles;let g,v,m,p,f,E,w,I;switch(u[a]=[...h],a){case 0:case 3:g=d(u[0]),p=d(u[3]),v=[p[0],g[1]],m=[g[0],p[1]],E=c(v),w=c(m),u[1]=E,u[2]=w;break;case 1:case 2:v=d(u[1]),m=d(u[2]),g=[m[0],v[1]],p=[v[0],m[1]],f=c(g),I=c(p),u[0]=f,u[3]=I}i.invalidated=!0,this.editData.hasMoved=!0;const{renderingEngine:C}=l;Bo(C,o)})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:o,hasMoved:a,segmentation:r,segmentationId:s,segmentIndex:l,segmentsLocked:d}=this.editData,{data:c}=i;if(o&&!a)return;c.handles.activeHandleIndex=null,this._deactivateDraw(n),$r(n);const h=(0,J.getEnabledElement)(n),{viewport:u}=h;if(this.editData=null,this.isDrawing=!1,u instanceof J.StackViewport)throw new Error("Not implemented yet");const g={points:c.handles.points,volume:r,segmentationId:s,segmentIndex:l,segmentsLocked:d};this.applyActiveStrategy(h,g)})),te(this,"_activateDraw",(e=>{e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"_deactivateDraw",(e=>{e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragCallback)})),te(this,"renderAnnotation",((e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{annotation:o}=this.editData,a=o.metadata,r=o.annotationUID,s=o.data,{points:l}=s.handles,d=l.map((e=>i.worldToCanvas(e))),c="rgb(".concat(a.segmentColor.slice(0,3),")");return i.getRenderingEngine()?(Us(t,r,"0",d[0],d[3],{color:c}),n=!0,n):(console.warn("Rendering Engine has been destroyed"),n)}))}}te(Wv,"toolName",void 0),Wv.toolName="RectangleScissor";const Fv=Wv;class Hv extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:pl},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"preMouseDownCallback",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=n.canvas,r=(0,J.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,u=this.toolGroupId,g=wl(u);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:v,segmentationId:m,type:p}=g,f=Dl(m),E=Tl(m),w=Ol(u,v,f),{representationData:I}=wt(m),{volumeId:C}=I[p],_=J.cache.getVolume(C),T={invalidated:!0,highlighted:!0,metadata:{viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:w},data:{handles:{points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},isDrawing:!0,cachedStats:{}}},b=[s.id];return this.editData={annotation:T,segmentation:_,centerCanvas:a,segmentIndex:f,segmentationId:m,segmentsLocked:E,segmentColor:w,viewportIdsToRender:b,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Qr(i),e.preventDefault(),Bo(l,b),!0})),te(this,"_dragCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.canvas,a=(0,J.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,{canvasToWorld:l}=s,{annotation:d,viewportIdsToRender:c,centerCanvas:h}=this.editData,{data:u}=d,g=Math.abs(o[0]-h[0]),v=Math.abs(o[1]-h[1]),m=Math.sqrt(g*g+v*v),p=[h[0],h[1]+m],f=[h[0],h[1]-m],E=[h[0]-m,h[1]],w=[h[0]+m,h[1]];u.handles.points=[l(p),l(f),l(E),l(w)],d.invalidated=!0,this.editData.hasMoved=!0,Bo(r,c)})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:o,hasMoved:a,segmentation:r,segmentIndex:s,segmentsLocked:l,segmentationId:d}=this.editData,{data:c}=i,{viewPlaneNormal:h,viewUp:u}=i.metadata;if(o&&!a)return;c.handles.activeHandleIndex=null,this._deactivateDraw(n),$r(n);const g=(0,J.getEnabledElement)(n),{viewport:v}=g;if(this.editData=null,this.isDrawing=!1,v instanceof J.StackViewport)throw new Error("Not implemented yet");const m={points:c.handles.points,volume:r,segmentIndex:s,segmentsLocked:l,viewPlaneNormal:h,segmentationId:d,viewUp:u};this.applyActiveStrategy(g,m)})),te(this,"_activateDraw",(e=>{e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragCallback),e.addEventListener(Q.TOUCH_END,this._endCallback)})),te(this,"_deactivateDraw",(e=>{e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"renderAnnotation",((e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{viewportIdsToRender:o}=this.editData;if(!o.includes(i.id))return n;const{annotation:a}=this.editData,r=a.metadata,s=a.annotationUID,l=a.data,{points:d}=l.handles,c=d.map((e=>i.worldToCanvas(e))),h=c[0],u=c[1],g=[Math.floor((h[0]+u[0])/2),Math.floor((h[1]+u[1])/2)],v=Math.abs(h[1]-Math.floor((h[1]+u[1])/2)),m="rgb(".concat(r.segmentColor.slice(0,3),")");return i.getRenderingEngine()?(ys(t,s,"0",g,v,{color:m}),n=!0,n):(console.warn("Rendering Engine has been destroyed"),n)}))}}te(Hv,"toolName",void 0),Hv.toolName="CircleScissor";const Bv=Hv;class Gv extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:dl},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}),te(this,"editData",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"preMouseDownCallback",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=n.canvas,r=(0,J.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,u=this.toolGroupId,g=wl(u);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:v,segmentationId:m,type:p}=g,f=Dl(m),E=Tl(m),w=Ol(u,v,f),{representationData:I}=wt(m),{volumeId:C}=I[p],_=J.cache.getVolume(C);this.isDrawing=!0;const T={metadata:{viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:w},data:{invalidated:!0,handles:{points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},cachedStats:{},highlighted:!0}},b=[s.id];return this.editData={annotation:T,segmentation:_,centerCanvas:a,segmentIndex:f,segmentsLocked:E,segmentColor:w,segmentationId:m,toolGroupId:u,viewportIdsToRender:b,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Qr(i),e.preventDefault(),Bo(l,b),!0})),te(this,"_dragCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.canvas,a=(0,J.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,{canvasToWorld:l}=s,{annotation:d,viewportIdsToRender:c,centerCanvas:h}=this.editData,{data:u}=d,g=Math.abs(o[0]-h[0]),v=Math.abs(o[1]-h[1]),m=Math.sqrt(g*g+v*v),p=[h[0],h[1]+m],f=[h[0],h[1]-m],E=[h[0]-m,h[1]],w=[h[0]+m,h[1]];u.handles.points=[l(p),l(f),l(E),l(w)],d.invalidated=!0,this.editData.hasMoved=!0,Bo(r,c)})),te(this,"_endCallback",(e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:o,hasMoved:a,segmentation:r,segmentIndex:s,segmentsLocked:l,segmentationId:d}=this.editData,{data:c}=i,{viewPlaneNormal:h,viewUp:u}=i.metadata;if(o&&!a)return;i.highlighted=!1,c.handles.activeHandleIndex=null,this._deactivateDraw(n),$r(n);const g=(0,J.getEnabledElement)(n),{viewport:v}=g;if(this.editData=null,this.isDrawing=!1,v instanceof J.StackViewport)throw new Error("Not implemented yet");const m={points:c.handles.points,volume:r,segmentIndex:s,segmentsLocked:l,segmentationId:d,viewPlaneNormal:h,viewUp:u};this.applyActiveStrategy(g,m)})),te(this,"_activateDraw",(e=>{e.addEventListener(Q.MOUSE_UP,this._endCallback),e.addEventListener(Q.MOUSE_DRAG,this._dragCallback),e.addEventListener(Q.MOUSE_CLICK,this._endCallback),e.addEventListener(Q.TOUCH_END,this._endCallback),e.addEventListener(Q.TOUCH_TAP,this._endCallback),e.addEventListener(Q.TOUCH_DRAG,this._dragCallback)})),te(this,"_deactivateDraw",(e=>{e.removeEventListener(Q.MOUSE_UP,this._endCallback),e.removeEventListener(Q.MOUSE_DRAG,this._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._endCallback),e.removeEventListener(Q.TOUCH_END,this._endCallback),e.removeEventListener(Q.TOUCH_DRAG,this._dragCallback),e.removeEventListener(Q.TOUCH_TAP,this._endCallback)})),te(this,"renderAnnotation",((e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{viewportIdsToRender:o}=this.editData;if(!o.includes(i.id))return n;const{annotation:a}=this.editData,r=a.metadata,s=a.annotationUID,l=a.data,{points:d}=l.handles,c=d.map((e=>i.worldToCanvas(e))),h=c[0],u=c[1],g=[Math.floor((h[0]+u[0])/2),Math.floor((h[1]+u[1])/2)],v=Math.abs(h[1]-Math.floor((h[1]+u[1])/2)),m="rgb(".concat(r.segmentColor.slice(0,3),")");return i.getRenderingEngine()?(ys(t,s,"0",g,v,{color:m}),n=!0,n):(console.warn("Rendering Engine has been destroyed"),n)}))}}te(Gv,"toolName",void 0),Gv.toolName="SphereScissor";const qv=Gv;var jv=I(518),zv=I.n(jv),Kv=I(744),Yv=I.n(Kv),Xv=I(424),Zv=I.n(Xv),Jv=I(614),$v=I.n(Jv);const Qv={ANNOTATED_CUBE:1,AXES:2,CUSTOM:3};class em extends la{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{orientationWidget:{enabled:!0,viewportCorner:zv().Corners.BOTTOM_RIGHT,viewportSize:.15,minPixelSize:100,maxPixelSize:300},overlayMarkerType:em.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE,overlayConfiguration:{[em.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE]:{faceProperties:{xPlus:{text:"R",faceColor:"#ffff00",faceRotation:90},xMinus:{text:"L",faceColor:"#ffff00",faceRotation:270},yPlus:{text:"P",faceColor:"#00ffff",fontColor:"white",faceRotation:180},yMinus:{text:"A",faceColor:"#00ffff",fontColor:"white"},zPlus:{text:"S"},zMinus:{text:"I"}},defaultStyle:{fontStyle:"bold",fontFamily:"Arial",fontColor:"black",fontSizeScale:e=>e/2,faceColor:"#0000ff",edgeThickness:.1,edgeColor:"black",resolution:400}},[em.OVERLAY_MARKER_TYPES.AXES]:{},[em.OVERLAY_MARKER_TYPES.CUSTOM]:{polyDataURL:"https://raw.githubusercontent.com/Slicer/Slicer/80ad0a04dacf134754459557bf2638c63f3d1d1b/Base/Logic/Resources/OrientationMarkers/Human.vtp"}}}}),te(this,"orientationMarkers",void 0),te(this,"polyDataURL",void 0),te(this,"configuration_invalidated",!0),te(this,"onSetToolEnabled",(()=>{this.initViewports(),this.configuration_invalidated=!0})),te(this,"onSetToolActive",(()=>{this.initViewports()})),te(this,"onSetToolDisabled",(()=>{this.cleanUpData()})),this.orientationMarkers={},this.configuration_invalidated=!0}cleanUpData(){(0,J.getRenderingEngines)()[0].getViewports().forEach((e=>{const t=this.orientationMarkers[e.id];if(!t)return;const{actor:n,orientationWidget:i}=t;null==i||i.setEnabled(!1),null==i||i.delete(),null==n||n.delete(),e.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow().render(),e.getRenderingEngine().render(),delete this.orientationMarkers[e.id]}))}initViewports(){const e=(0,J.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=Fl(t,this.getToolName()),t.forEach((e=>this.addAxisActorInViewport(e)))}async addAxisActorInViewport(e){const t=e.id,n=this.configuration.overlayMarkerType,i=this.configuration.overlayConfiguration[n];if(this.orientationMarkers[t]){const{actor:n,orientationWidget:i}=this.orientationMarkers[t];e.getRenderer().removeActor(n),i.setEnabled(!1)}let o;1===n?o=this.createAnnotationCube(i):2===n?o=Zv().newInstance():3===n&&(o=await this.createCustomActor());const a=e.getRenderer(),r=e.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow(),{enabled:s,viewportCorner:l,viewportSize:d,minPixelSize:c,maxPixelSize:h}=this.configuration.orientationWidget,u=zv().newInstance({actor:o,interactor:r.getInteractor(),parentRenderer:a});u.setEnabled(s),u.setViewportCorner(l),u.setViewportSize(d),u.setMinPixelSize(c),u.setMaxPixelSize(h),u.updateMarkerOrientation(),this.orientationMarkers[t]={orientationWidget:u,actor:o},r.render(),e.getRenderingEngine().render(),this.configuration_invalidated=!1}async createCustomActor(){const e=this.configuration.overlayConfiguration[Qv.CUSTOM].polyDataURL,t=await fetch(e),n=await t.arrayBuffer(),i=$v().newInstance();i.parseAsArrayBuffer(n),i.update();const o=fa().newInstance();o.shallowCopy(i.getOutputData()),o.getPointData().setActiveScalars("Color");const a=ha().newInstance();a.setInputData(o),a.setColorModeToDirectScalars();const r=ga().newInstance();return r.setMapper(a),r.rotateZ(180),r}createAnnotationCube(e){const t=Yv().newInstance();return t.setDefaultStyle({...e.defaultStyle}),t.setXPlusFaceProperty({...e.faceProperties.xPlus}),t.setXMinusFaceProperty({...e.faceProperties.xMinus}),t.setYPlusFaceProperty({...e.faceProperties.yPlus}),t.setYMinusFaceProperty({...e.faceProperties.yMinus}),t.setZPlusFaceProperty({...e.faceProperties.zPlus}),t.setZMinusFaceProperty({...e.faceProperties.zMinus}),t}async createAnnotatedCubeActor(){const e=Yv().newInstance(),{faceProperties:t,defaultStyle:n}=this.configuration.annotatedCube;return e.setDefaultStyle(n),Object.keys(t).forEach((n=>{const i="set".concat(n.charAt(0).toUpperCase()+n.slice(1),"FaceProperty");e[i](t[n])})),e}}te(em,"toolName",void 0),te(em,"CUBE",1),te(em,"AXIS",2),te(em,"VTPFILE",3),te(em,"OVERLAY_MARKER_TYPES",Qv),em.toolName="OrientationMarker";const tm=em,{transformWorldToIndex:nm,isEqual:im}=J.utilities;class om extends la{constructor(){var e;super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]}),e=this,te(this,"preMouseDownCallback",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r}=a,s=r.getCamera(),{viewPlaneNormal:l}=s,d=wl(this.toolGroupId);if(!d)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:c,type:h}=d,u=Dl(c),g=Tl(c),{representationData:v}=wt(c),{volumeId:m}=v[h],p=J.cache.getVolume(m),{dimensions:f,direction:E}=p,w=p.getScalarData(),I=nm(p.imageData,o),C=this.getFixedDimension(l,E);if(void 0===C)return void console.warn("Oblique paint fill not yet supported");const{floodFillGetter:_,getLabelValue:T,getScalarDataPositionFromPlane:b,inPlaneSeedPoint:D,fixedDimensionValue:S}=this.generateHelpers(w,f,I,C);if(I[0]<0||I[0]>=f[0]||I[1]<0||I[1]>=f[1]||I[2]<0||I[2]>=f[2])return;const y=T(I[0],I[1],I[2]);if(g.includes(y))return;const O=Nd(_,D),{flooded:M}=O;return M.forEach((e=>{const t=b(e[0],e[1]);w[t]=u})),pt(c,this.getFramesModified(C,S,O)),!0})),te(this,"getFramesModified",((e,t,n)=>{const{boundaries:i}=n;if(2===e)return[t];let o=1/0,a=-1/0;for(let e=0;e<i.length;e++){const t=i[e][1];t<o&&(o=t),t>a&&(a=t)}const r=[];for(let e=o;e<=a;e++)r.push(e);return r})),te(this,"generateHelpers",(function(t,n,i){let o,a,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2;switch(r){case 0:o=i[0],a=[i[1],i[2]];break;case 1:o=i[1],a=[i[0],i[2]];break;case 2:o=i[2],a=[i[0],i[1]];break;default:throw new Error("Invalid fixedDimension: ".concat(r))}const s=(e,t,i)=>i*n[1]*n[0]+t*n[0]+e,l=(e,n,i)=>t[s(e,n,i)],d=e.generateFloodFillGetter(n,r,o,l);return{getScalarDataPositionFromPlane:e.generateGetScalarDataPositionFromPlane(s,r,o),getLabelValue:l,floodFillGetter:d,inPlaneSeedPoint:a,fixedDimensionValue:o}})),te(this,"generateFloodFillGetter",((e,t,n,i)=>{let o;switch(t){case 0:o=(t,o)=>{if(!(t>=e[1]||t<0||o>=e[2]||o<0))return i(n,t,o)};break;case 1:o=(t,o)=>{if(!(t>=e[0]||t<0||o>=e[2]||o<0))return i(t,n,o)};break;case 2:o=(t,o)=>{if(!(t>=e[0]||t<0||o>=e[1]||o<0))return i(t,o,n)};break;default:throw new Error("Invalid fixedDimension: ".concat(t))}return o})),te(this,"generateGetScalarDataPositionFromPlane",((e,t,n)=>{let i;switch(t){case 0:i=(t,i)=>e(n,t,i);break;case 1:i=(t,i)=>e(t,n,i);break;case 2:i=(t,i)=>e(t,i,n);break;default:throw new Error("Invalid fixedDimension: ".concat(t))}return i}))}getFixedDimension(e,t){const n=t.slice(0,3),i=t.slice(3,6),o=t.slice(6,9),a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],r=[Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2])];if(im(a,r))return 0;const s=[Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])];if(im(a,s))return 1;const l=[Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2])];return im(a,l)?2:void 0}}te(om,"toolName",void 0),om.toolName="PaintFill";const am=om;class rm extends Ql{constructor(){var e;super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}),e=this,te(this,"_throttledCalculateCachedStats",void 0),te(this,"editData",void 0),te(this,"_configuration",void 0),te(this,"isDrawing",void 0),te(this,"isHandleOutsideImage",void 0),te(this,"addNewAnnotation",(e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,J.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,o,d,c),u={metadata:{viewPlaneNormal:[0,0,1],viewUp:[0,1,0],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:h,toolName:this.getToolName()},data:{invalidated:!0,handles:{points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},cachedStats:{},active:!0}};Je(u,i);const g=Gl(i,this.getToolName(),!1);return this.editData={annotation:u,viewportUIDsToRender:g,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Qr(i),e.preventDefault(),Bo(s,g),u})),te(this,"getHandleNearImagePoint",((e,t,n,i)=>{const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{data:r}=t,{points:s}=r.handles;for(let e=0;e<s.length;e++){const t=s[e],o=a.worldToCanvas(t);if(!0==ps.vec2.distance(n,o)<i)return r.handles.activeHandleIndex=e,t}r.handles.activeHandleIndex=null})),te(this,"isPointNearTool",((e,t,n,i)=>{const o=(0,J.getEnabledElement)(e),{viewport:a}=o,{data:r}=t,{points:s}=r.handles,l=a.worldToCanvas(s[0]),d=a.worldToCanvas(s[3]),c=this._getRectangleImageCoordinates([l,d]),h=[n[0],n[1]],{left:u,top:g,width:v,height:m}=c;if(id([u,g,v,m],h)<=i)return!0})),te(this,"toolSelectedCallback",(function(t,n){const i=t.detail,{element:o}=i,{data:a}=n;a.active=!0;const r=Gl(o,e.getToolName(),!1);e.editData={annotation:n,viewportUIDsToRender:r},e._activateModify(o),Qr(o);const s=(0,J.getEnabledElement)(o),{renderingEngine:l}=s;Bo(l,r),t.preventDefault()})),te(this,"handleSelectedCallback",(function(t,n,i){const o=t.detail,{element:a}=o,{data:r}=n;r.active=!0;let s,l=!1;i.worldPosition||(s=r.handles.points.findIndex((e=>e===i)));const d=Gl(a,e.getToolName(),!1);e.editData={annotation:n,viewportUIDsToRender:d,handleIndex:s},e._activateModify(a),Qr(a);const c=(0,J.getEnabledElement)(a),{renderingEngine:h}=c;Bo(h,d),t.preventDefault()})),te(this,"_mouseUpCallback",(e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportUIDsToRender:o,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=i;if(a&&!r)return;s.active=!1,s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),$r(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Qe(i.annotationUID),Bo(d,o)})),te(this,"_mouseDragCallback",(e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportUIDsToRender:o,handleIndex:a}=this.editData,{data:r}=i;if(void 0===a){const{deltaPoints:e}=t,n=e.world,{points:i}=r.handles;i.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),r.invalidated=!0}else{const{currentPoints:e}=t,i=(0,J.getEnabledElement)(n),{worldToCanvas:o,canvasToWorld:s}=i.viewport,l=e.world,{points:d}=r.handles;let c,h,u,g,v,m,p,f;switch(d[a]=[...l],a){case 0:case 3:c=o(d[0]),g=o(d[3]),h=[g[0],c[1]],u=[c[0],g[1]],m=s(h),p=s(u),d[1]=m,d[2]=p;break;case 1:case 2:h=o(d[1]),u=o(d[2]),c=[u[0],h[1]],g=[h[0],u[1]],v=s(c),f=s(g),d[0]=v,d[3]=f}r.invalidated=!0}this.editData.hasMoved=!0;const s=(0,J.getEnabledElement)(n),{renderingEngine:l}=s;Bo(l,o)})),te(this,"_activateDraw",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._mouseUpCallback),e.addEventListener(Q.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(Q.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(Q.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(Q.TOUCH_END,this._mouseUpCallback),e.addEventListener(Q.TOUCH_DRAG,this._mouseDragCallback)})),te(this,"_deactivateDraw",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(Q.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(Q.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(Q.TOUCH_END,this._mouseUpCallback),e.removeEventListener(Q.TOUCH_DRAG,this._mouseDragCallback)})),te(this,"_activateModify",(e=>{He.isInteractingWithTool=!0,e.addEventListener(Q.MOUSE_UP,this._mouseUpCallback),e.addEventListener(Q.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(Q.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(Q.TOUCH_END,this._mouseUpCallback),e.addEventListener(Q.TOUCH_DRAG,this._mouseDragCallback)})),te(this,"_deactivateModify",(e=>{He.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(Q.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(Q.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(Q.TOUCH_END,this._mouseUpCallback),e.removeEventListener(Q.TOUCH_DRAG,this._mouseDragCallback)})),te(this,"renderAnnotation",((e,t)=>{var n,i;const{viewport:o}=e,{element:a}=o;let r=Ze(this.getToolName(),a);if(null===(n=r)||void 0===n||!n.length)return!1;if(r=this.filterInteractableAnnotationsForElement(a,r),null===(i=r)||void 0===i||!i.length)return!1;this.getTargetId(o),o.getRenderingEngine();const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<r.length;e++){const n=r[e],{annotationUID:i}=n,a=(n.metadata,n.data),{points:l,activeHandleIndex:d}=a.handles,c=l.map((e=>o.worldToCanvas(e))),h=this.getStyle("lineWidth",s,n),u=this.getStyle("lineDash",s,n),g=this.getStyle("color",s,n);if(!o.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");let v;this.editData||null===d||(v=[c[d]]),v&&Ms(t,i,"0",v,{color:g}),Ws(t,i,"0",c[0],c[3],{color:"black",lineDash:u,lineWidth:h})}})),te(this,"_getRectangleImageCoordinates",(e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}})),te(this,"_calculateCachedStats",((e,t,n,i,o)=>{const{data:a}=e,{viewportUID:r,renderingEngineUID:s,sceneUID:l}=o,d=a.handles.points[0],c=a.handles.points[3],{cachedStats:h}=a,u=Object.keys(h);for(let e=0;e<u.length;e++){const o=u[e],{imageVolume:a}=this._getImageVolumeFromTargetUID(o,i),{dimensions:r,scalarData:s,vtkImageData:l,metadata:g}=a,v=ps.vec3.fromValues(0,0,0),m=ps.vec3.fromValues(0,0,0);if(l.worldToIndexVec3(d,v),v[0]=Math.floor(v[0]),v[1]=Math.floor(v[1]),v[2]=Math.floor(v[2]),l.worldToIndexVec3(c,m),m[0]=Math.floor(m[0]),m[1]=Math.floor(m[1]),m[2]=Math.floor(m[2]),this._isInsideVolume(v,m,r)){this.isHandleOutsideImage=!1;const e=Math.min(v[0],m[0]),i=Math.max(v[0],m[0]),a=Math.min(v[1],m[1]),l=Math.max(v[1],m[1]),u=Math.min(v[2],m[2]),p=Math.max(v[2],m[2]),{worldWidth:f,worldHeight:E}=qg(t,n,d,c),w=f*E;let I=0,C=0,_=0;const T=r[0],b=r[0]*r[1];for(let t=u;t<=p;t++)for(let n=a;n<=l;n++)for(let o=e;o<=i;o++)I++,C+=s[t*b+n*T+o];C/=I;for(let t=u;t<=p;t++)for(let n=a;n<=l;n++)for(let o=e;o<=i;o++){const e=s[t*b+n*T+o]-C;_+=e*e}_/=I,_=Math.sqrt(_),h[o]={Modality:g.Modality,area:w,mean:C,stdDev:_}}else this.isHandleOutsideImage=!0,h[o]={Modality:g.Modality}}a.invalidated=!1;const g=Q.ANNOTATION_MODIFIED,v={annotation:e,viewportUID:r,renderingEngineUID:s,sceneUID:l};return(0,J.triggerEvent)(J.eventTarget,g,v),h})),te(this,"_isInsideVolume",((e,t,n)=>J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n))),te(this,"_getTargetVolumeUID",(e=>{if(this.configuration.volumeUID)return this.configuration.volumeUID;const t=e.getVolumeActors();return t||t.length?t[0].uid:void 0})),this._throttledCalculateCachedStats=js(this._calculateCachedStats,100,{trailing:!0})}cancel(e){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),$r(e);const{annotation:t,viewportUIDsToRender:n}=this.editData,{data:i}=t;i.active=!1,i.handles.activeHandleIndex=null;const o=(0,J.getEnabledElement)(e),{renderingEngine:a}=o;return Bo(a,n),this.editData=null,t.metadata.annotationUID}_getImageVolumeFromTargetUID(e,t){let n;if(e.startsWith("stackTarget")){const i=e.indexOf(":"),o=e.substring(i+1);n=t.getViewport(o).getImageData()}else n=J.cache.getVolume(e);return{imageVolume:n,viewport:void 0}}_getTargetStackUID(e){return"stackTarget:".concat(e.uid)}}rm.toolName="VideoRedaction";const sm=rm})(),C})()));
//# sourceMappingURL=index.js.map